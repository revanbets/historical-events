<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Events Database v2.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Karla:wght@400;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Karla', sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); color: #e0e6ed; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(96,165,250,0.05) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(167,139,250,0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .app { min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }
    .fullscreen { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: #0a0e27; padding: 2rem; }
    .header { background: linear-gradient(135deg, rgba(26,31,58,0.95), rgba(45,53,97,0.95)); padding: 2rem 3rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-bottom: 3px solid rgba(96,165,250,0.3); backdrop-filter: blur(10px); }
    .header h1 { font-family: 'Space Mono', monospace; font-size: 2.5rem; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; letter-spacing: -1px; font-weight: 700; }
    .stats { display: flex; gap: 3rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .stat { display: flex; flex-direction: column; gap: 0.25rem; position: relative; padding-left: 1rem; }
    .stat::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 80%; background: linear-gradient(180deg, #60a5fa, #a78bfa); border-radius: 2px; }
    .stat-label { font-size: 0.75rem; color: #8b92b0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-value { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: bold; color: #60a5fa; }
    .breadcrumb-bar { padding: 0.6rem 3rem; background: rgba(10,14,39,0.5); border-bottom: 1px solid rgba(61,69,99,0.4); display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; min-height: 36px; }
    .bc-item { color: #60a5fa; cursor: pointer; transition: all 0.15s; padding: 0.2rem 0.4rem; border-radius: 4px; }
    .bc-item:hover { background: rgba(96,165,250,0.15); text-decoration: underline; }
    .bc-sep { color: #3d4563; font-size: 0.75rem; }
    .bc-current { color: #e0e6ed; font-weight: 600; padding: 0.2rem 0.4rem; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 3rem; background: rgba(21,25,50,0.6); border-bottom: 1px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .save-btn { padding: 0.75rem 2rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Space Mono', monospace; text-transform: uppercase; letter-spacing: 1px; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.5); }
    .save-status { font-size: 0.875rem; color: #10b981; font-weight: 600; }
    .nav { display: flex; gap: 0.75rem; padding: 1.5rem 3rem; background: rgba(21,25,50,0.4); border-bottom: 1px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(5px); }
    .nav-btn { padding: 0.875rem 1.75rem; background: rgba(26,31,58,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 600; color: #8b92b0; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-btn:hover { background: rgba(37,43,74,0.9); border-color: #60a5fa; color: #e0e6ed; transform: translateY(-2px); }
    .nav-btn.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: #0a0e27; border-color: #60a5fa; box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .content { flex: 1; padding: 2rem 3rem; }
    .filters { background: rgba(26,31,58,0.6); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 2px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .filters-title { font-size: 1.25rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 1px; }
    .filter-row { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .filter-group { flex: 1; min-width: 220px; }
    .filter-label { display: block; font-size: 0.875rem; color: #8b92b0; margin-bottom: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.875rem; transition: all 0.2s; font-family: 'Karla', sans-serif; }
    input:focus, select:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .search-row { display: flex; gap: 0.5rem; }
    .search-row input { flex: 1; width: auto; }
    .search-btn { padding: 0.875rem 1.5rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 0.875rem; white-space: nowrap; transition: all 0.2s; }
    .search-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: rgba(10,14,39,0.4); border-radius: 8px; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(45,53,97,0.4); border: 1px solid rgba(61,69,99,0.5); border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; user-select: none; }
    .checkbox-label:hover { background: rgba(96,165,250,0.1); border-color: #60a5fa; }
    .checkbox-label input[type="checkbox"] { margin: 0; cursor: pointer; width: 16px; height: 16px; flex-shrink: 0; }
    .checkbox-label.checked { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .btn { padding: 0.875rem 2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; box-shadow: 0 4px 12px rgba(96,165,250,0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.5); }
    .btn-secondary { background: rgba(45,53,97,0.6); color: #e0e6ed; border: 2px solid rgba(96,165,250,0.3); }
    .btn-secondary:hover { background: rgba(96,165,250,0.15); }
    .btn-danger { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .btn-cancel { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .fullscreen-btn { position: absolute; top: 1rem; right: 1rem; z-index: 100; }
    .timeline-wrapper { background: rgba(26,31,58,0.6); border-radius: 12px; padding: 3rem 2rem; border: 2px solid rgba(61,69,99,0.5); min-height: 400px; position: relative; overflow-x: auto; overflow-y: visible; }
    .timeline-container { position: relative; min-width: max-content; padding: 3rem 1rem; }
    .timeline-line { position: absolute; left: 0; right: 0; top: 50%; height: 4px; background: linear-gradient(90deg, #60a5fa, #a78bfa); border-radius: 2px; transform: translateY(-50%); }
    .timeline-events { position: relative; display: flex; align-items: center; gap: 4rem; min-width: 100%; }
    .timeline-event { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s; z-index: 10; }
    .timeline-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #60a5fa, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; border: 3px solid #0a0e27; box-shadow: 0 4px 12px rgba(96,165,250,0.4); transition: all 0.3s; }
    .timeline-event:hover .timeline-icon { transform: scale(1.2); box-shadow: 0 6px 20px rgba(96,165,250,0.6); }
    .timeline-event.major .timeline-icon { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
    .timeline-label { position: absolute; top: 62px; font-size: 0.68rem; color: #8b92b0; text-align: center; width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .timeline-year { position: absolute; top: -32px; font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; color: #60a5fa; white-space: nowrap; }
    .network { background: rgba(26,31,58,0.6); border-radius: 16px; border: 2px solid rgba(61,69,99,0.5); height: 700px; position: relative; backdrop-filter: blur(10px); }
    #network-graph { width: 100%; height: 100%; border-radius: 16px; }
    .spreadsheet { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 1.5rem; border: 2px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(10px); }
    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th { background: rgba(37,43,74,0.8); padding: 1.25rem; text-align: left; font-weight: 700; color: #60a5fa; border-bottom: 3px solid rgba(61,69,99,0.8); position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .table td { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(45,53,97,0.3); }
    .table tr:hover td { background: rgba(37,43,74,0.4); }
    .table a { color: #60a5fa; text-decoration: none; }
    .table a:hover { text-decoration: underline; }
    .copy-link { margin-left: 0.5rem; cursor: pointer; color: #10b981; font-weight: bold; opacity: 0.6; }
    .copy-link:hover { opacity: 1; }
    .upload { background: linear-gradient(135deg, rgba(26,31,58,0.6), rgba(45,53,97,0.4)); border: 3px dashed rgba(96,165,250,0.3); border-radius: 16px; padding: 4rem; text-align: center; cursor: pointer; transition: all 0.4s; margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .upload:hover { border-color: #60a5fa; background: linear-gradient(135deg, rgba(37,43,74,0.8), rgba(61,69,99,0.6)); transform: scale(1.01); }
    .upload-icon { font-size: 4rem; margin-bottom: 1.5rem; }
    .upload-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .upload-tab { padding: 0.75rem 1.5rem; background: rgba(26,31,58,0.6); border: 2px solid rgba(45,53,97,0.5); border-radius: 8px; cursor: pointer; font-weight: 600; color: #8b92b0; transition: all 0.2s; }
    .upload-tab.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border-color: #60a5fa; }
    .url-input-section { background: rgba(26,31,58,0.8); border: 2px solid rgba(96,165,250,0.3); border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; }
    .url-input-header { font-size: 1.5rem; font-weight: 700; color: #60a5fa; margin-bottom: 1.5rem; }
    .url-input-row { display: flex; gap: 1rem; align-items: flex-end; }
    .url-input-group { flex: 1; }
    .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .processing-card { background: rgba(26,31,58,0.98); border-radius: 16px; padding: 2.5rem; max-width: 400px; border: 2px solid rgba(96,165,250,0.5); text-align: center; }
    .processing-spinner { border: 4px solid rgba(96,165,250,0.2); border-top: 4px solid #60a5fa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; border: 3px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(96,165,250,0.2); }
    .modal-title { font-size: 1.75rem; font-weight: 700; color: #60a5fa; font-family: 'Space Mono', monospace; flex: 1; line-height: 1.3; }
    .modal-actions { display: flex; gap: 0.5rem; margin-left: 1rem; flex-shrink: 0; }
    .close { background: rgba(239,68,68,0.2); border: 2px solid rgba(239,68,68,0.4); font-size: 1.5rem; color: #ef4444; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; font-weight: bold; }
    .close:hover { background: rgba(239,68,68,0.4); transform: scale(1.1); }
    .edit-btn { background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.875rem; }
    .edit-btn:hover { background: rgba(16,185,129,0.3); }
    .form-group { margin-bottom: 2rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .edit-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; }
    textarea.edit-input { min-height: 100px; resize: vertical; font-family: inherit; }
    .ai-summary-box { background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(139,92,246,0.1)); border: 2px solid rgba(167,139,250,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .ai-summary-label { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #a78bfa; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .ai-summary-label::before { content: 'ðŸ¤–'; font-size: 1.25rem; }
    .tags { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
    .tag { padding: 0.5rem 1rem; background: linear-gradient(135deg, rgba(45,53,97,0.8), rgba(61,69,99,0.8)); border-radius: 24px; font-size: 0.8125rem; color: #a78bfa; border: 2px solid rgba(167,139,250,0.3); font-weight: 600; transition: all 0.2s; cursor: pointer; }
    .tag:hover { background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(139,92,246,0.2)); border-color: #a78bfa; transform: scale(1.05); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    .card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 16px; padding: 2rem; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); }
    .card:hover { border-color: #60a5fa; transform: translateY(-4px); box-shadow: 0 8px 24px rgba(96,165,250,0.2); }
    .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: #e0e6ed; }
    .card-count { font-size: 0.875rem; color: #8b92b0; font-weight: 600; }
    .card-tags { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .card-tag { padding: 0.25rem 0.6rem; background: rgba(96,165,250,0.15); border: 1px solid rgba(96,165,250,0.3); border-radius: 12px; font-size: 0.7rem; color: #60a5fa; }
    .level-1 { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-2 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-3 { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .success-msg { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: #10b981; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(16,185,129,0.3); font-weight: 600; }
    .error-msg { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.2)); color: #ef4444; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(239,68,68,0.3); font-weight: 600; }
    .tooltip-wrapper { position: relative; }
    .tooltip-wrapper:hover .tooltip-content { opacity: 1 !important; pointer-events: auto !important; }
    .back-btn { padding: 0.75rem 1.5rem; background: rgba(45,53,97,0.6); border: 2px solid rgba(96,165,250,0.3); border-radius: 10px; color: #60a5fa; font-weight: 600; cursor: pointer; margin-bottom: 2rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .back-btn:hover { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .export-btns { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .empty-state { text-align: center; padding: 4rem 2rem; color: #8b92b0; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    /* â”€â”€ Auth screens â”€â”€ */
    .auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); }
    .auth-card { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px; border: 2px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); }
    .auth-title { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: 700; color: #60a5fa; margin-bottom: 0.5rem; text-align: center; }
    .auth-subtitle { color: #8b92b0; font-size: 0.875rem; margin-bottom: 2rem; text-align: center; }
    .auth-field { margin-bottom: 1.25rem; }
    .auth-label { display: block; font-size: 0.8rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .auth-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; }
    .auth-input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .auth-btn { width: 100%; padding: 0.9rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; transition: all 0.2s; font-family: 'Space Mono', monospace; letter-spacing: 0.5px; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.4); }
    .auth-switch { text-align: center; margin-top: 1.5rem; color: #8b92b0; font-size: 0.875rem; }
    .auth-switch span { color: #60a5fa; cursor: pointer; font-weight: 600; }
    .auth-switch span:hover { text-decoration: underline; }
    .auth-error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    .auth-success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    /* â”€â”€ User chip â”€â”€ */
    .user-chip { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .role-badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .role-owner { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .role-admin { background: linear-gradient(135deg, #a78bfa, #8b5cf6); color: white; }
    .role-user { background: rgba(96,165,250,0.2); color: #60a5fa; border: 1px solid rgba(96,165,250,0.4); }
    .logout-btn { padding: 0.35rem 0.875rem; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); border-radius: 6px; color: #ef4444; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(239,68,68,0.3); }
    /* â”€â”€ Event status badges (visible to all) â”€â”€ */
    .status-historical { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-contested { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-unverified { background: rgba(107,114,128,0.2); color: #9ca3af; border: 1px solid rgba(107,114,128,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-public { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-private { background: rgba(107,114,128,0.15); color: #9ca3af; border: 1px solid rgba(107,114,128,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    /* â”€â”€ Admin panel â”€â”€ */
    .admin-section { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 2rem; border: 2px solid rgba(167,139,250,0.2); margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .admin-section-title { font-size: 1.1rem; font-weight: 700; color: #a78bfa; margin-bottom: 1.25rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .admin-table th { background: rgba(37,43,74,0.8); padding: 0.875rem 1rem; text-align: left; color: #a78bfa; border-bottom: 2px solid rgba(167,139,250,0.3); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .admin-table td { padding: 0.875rem 1rem; border-bottom: 1px solid rgba(45,53,97,0.3); vertical-align: middle; }
    .admin-table tr:hover td { background: rgba(37,43,74,0.3); }
    .role-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer; }
    .status-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.4rem 0.6rem; font-size: 0.8rem; cursor: pointer; font-family: inherit; }
    /* â”€â”€ Account page â”€â”€ */
    .account-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; box-shadow: 0 4px 20px rgba(96,165,250,0.3); }
    .account-profile-card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 20px; padding: 2.5rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; backdrop-filter: blur(10px); }
    .account-tabs { display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid rgba(61,69,99,0.4); }
    .account-tab { padding: 0.875rem 1.75rem; background: none; border: none; border-bottom: 3px solid transparent; color: #8b92b0; font-weight: 700; cursor: pointer; font-size: 0.875rem; margin-bottom: -2px; transition: all 0.2s; font-family: inherit; }
    .account-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    .account-tab.active-admin { color: #a78bfa; border-bottom-color: #a78bfa; }
    .account-tab:hover { color: #e0e6ed; }
    .user-chip-btn { display: flex; align-items: center; gap: 0.6rem; background: rgba(45,53,97,0.5); border: 1px solid rgba(96,165,250,0.2); border-radius: 10px; padding: 0.4rem 0.85rem; cursor: pointer; transition: all 0.2s; }
    .user-chip-btn:hover { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.4); }
    .user-chip-avatar { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // â”€â”€â”€ SUPABASE CLIENT â”€â”€â”€
    const SUPABASE_URL = 'https://dfkxdbkjrfarjudlpqbw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRma3hkYmtqcmZhcmp1ZGxwcWJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDQzMzIsImV4cCI6MjA4NzUyMDMzMn0.A5XuY5C9X5Il6EizS84tKY1Ls3Jyl6Xmi0hKbqQg2qo';
    const supabaseClient = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
    if (!supabaseClient) console.error('Supabase JS failed to load from CDN');

    // â”€â”€â”€ ANALYSIS BACKEND URL â”€â”€â”€
    // When running locally: '' (uses relative /api/ paths)
    // When deployed: points to Render backend
    const API_BASE = window.location.hostname === 'localhost' ? '' : 'https://historical-events-api-n45u.onrender.com';

    // â”€â”€â”€ FIELD MAPPING: JS camelCase â†” Postgres snake_case â”€â”€â”€
    const toDbRow = (e) => ({
      id: e.id, title: e.title, description: e.description, date: e.date,
      date_uploaded: e.dateUploaded, topics: e.topics || [], people: e.people || [],
      organizations: e.organizations || [], links: e.links || [],
      research_level: e.researchLevel, source_type: e.sourceType || '',
      source: e.source || '', primary_source: e.primarySource || '',
      source_sheet: e.sourceSheet || '', main_link: e.mainLink || '',
      connections: e.connections || [], ai_summary: e.aiSummary || '',
      is_major_event: e.isMajorEvent || false, uploaded_by: e.uploadedBy || 'system',
      is_public: e.isPublic !== undefined ? e.isPublic : true,
      event_status: e.eventStatus || 'unverified',
      backend_id: e._backendId || null, ai_analyzed: e._aiAnalyzed || false,
      analysis_mode: e._analysisMode || '', has_frames: e._hasFrames || false,
      visual_content: e._visualContent || '', frames_data: e._framesData || [],
      transcript_file: e._transcriptFile || '', attachments: e._attachments || [],
      backend_file_name: e._backendFileName || '', is_video: e.isVideo || false,
      transcription: e.transcription || null,
    });
    const fromDbRow = (r) => ({
      id: r.id, title: r.title, description: r.description, date: r.date,
      dateUploaded: r.date_uploaded, topics: r.topics || [], people: r.people || [],
      organizations: r.organizations || [], links: r.links || [],
      researchLevel: r.research_level, sourceType: r.source_type,
      source: r.source, primarySource: r.primary_source,
      sourceSheet: r.source_sheet, mainLink: r.main_link,
      connections: r.connections || [], aiSummary: r.ai_summary,
      isMajorEvent: r.is_major_event, uploadedBy: r.uploaded_by,
      isPublic: r.is_public, eventStatus: r.event_status,
      _backendId: r.backend_id, _aiAnalyzed: r.ai_analyzed,
      _analysisMode: r.analysis_mode, _hasFrames: r.has_frames,
      _visualContent: r.visual_content, _framesData: r.frames_data || [],
      _transcriptFile: r.transcript_file, _attachments: r.attachments || [],
      _backendFileName: r.backend_file_name, isVideo: r.is_video,
      transcription: r.transcription,
    });
    const generateEventId = () => 'EVT-' + crypto.randomUUID().substring(0, 8);
    const rebuildAggregates = (events) => {
      const allP = new Set(), allO = new Set(), allT = new Set();
      events.forEach(e => { (e.people||[]).forEach(p=>allP.add(p)); (e.organizations||[]).forEach(o=>allO.add(o)); (e.topics||[]).forEach(t=>allT.add(t)); });
      return { people:[...allP].sort(), organizations:[...allO].sort(), topics:[...allT].sort() };
    };

    // â”€â”€â”€ AUTH HELPERS (Supabase-backed) â”€â”€â”€
    const findUser = async (username, password) => {
      const { data, error } = await supabaseClient
        .from('users').select('username, role').eq('username', username.toLowerCase()).eq('password', password).single();
      if (error || !data) return null;
      return { username: data.username, role: data.role };
    };
    const getAllUsers = async () => {
      const { data, error } = await supabaseClient.from('users').select('username, role, created_at').order('created_at');
      return error ? [] : data;
    };

    // â”€â”€â”€ NORMALIZE DATA (adds auth fields to existing events) â”€â”€â”€
    const normalizeData = (raw) => ({
      ...raw,
      events: raw.events.map(e => ({
        uploadedBy: 'system', isPublic: true, eventStatus: 'historical_record', ...e
      }))
    });

    // â”€â”€â”€ LOGIN SCREEN â”€â”€â”€
    const LoginScreen = ({ onLogin, onGoSignup }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async () => {
        if (!username.trim() || !password.trim()) { setError('Please fill in all fields.'); return; }
        setLoading(true); setError('');
        const user = await findUser(username.trim(), password.trim());
        setLoading(false);
        if (!user) { setError('Invalid username or password.'); return; }
        onLogin(user);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Historical Events DB</div>
              <div className="auth-subtitle">Sign in to access the database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Enter username" value={username}
                onChange={e=>setUsername(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Enter password" value={password}
                onChange={e=>setPassword(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit} disabled={loading}>{loading ? 'Signing in...' : 'Sign In â†’'}</button>
            <div className="auth-switch">Don't have an account? <span onClick={onGoSignup}>Create one</span></div>
          </div>
        </div>
      );
    };

    // â”€â”€â”€ SIGNUP SCREEN â”€â”€â”€
    const SignupScreen = ({ onGoLogin }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async () => {
        if (!username.trim() || !password.trim() || !confirm.trim()) { setError('Please fill in all fields.'); return; }
        if (username.trim().length < 3) { setError('Username must be at least 3 characters.'); return; }
        if (password.length < 6) { setError('Password must be at least 6 characters.'); return; }
        if (password !== confirm) { setError('Passwords do not match.'); return; }
        setLoading(true); setError('');
        // Check if username already exists
        const { data: existing } = await supabaseClient.from('users').select('username').eq('username', username.trim().toLowerCase()).single();
        if (existing) { setLoading(false); setError('Username already taken.'); return; }
        // Insert new user
        const { error: insertErr } = await supabaseClient.from('users').insert([{ username: username.trim().toLowerCase(), password, role: 'user' }]);
        setLoading(false);
        if (insertErr) { setError('Registration failed: ' + insertErr.message); return; }
        setSuccess('Account created! Redirecting to sign inâ€¦'); setError('');
        setTimeout(() => onGoLogin(), 1500);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Create Account</div>
              <div className="auth-subtitle">Join the Historical Events Database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            {success && <div className="auth-success">{success}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Min. 3 characters" value={username}
                onChange={e=>setUsername(e.target.value)} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Min. 6 characters" value={password}
                onChange={e=>setPassword(e.target.value)} />
            </div>
            <div className="auth-field">
              <label className="auth-label">Confirm Password</label>
              <input className="auth-input" type="password" placeholder="Re-enter password" value={confirm}
                onChange={e=>setConfirm(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit} disabled={loading}>{loading ? 'Creating...' : 'Create Account'}</button>
            <div className="auth-switch">Already have an account? <span onClick={onGoLogin}>Sign in</span></div>
          </div>
        </div>
      );
    };

    const EMBEDDED_DATA = {"events":[{"id":"EVT-0001","title":"Are we all breathing SMART dust?","description":"everything can be done with smart dust, eventually you'll breathe it, but because it isn't mass manufactured yet you prob aren't breathing it YET","date":null,"dateUploaded":"2026-02-12","topics":["Nano particles","smart dust","CYBORG","MERGING WITH MACHINES","micro particles"],"people":[],"organizations":["Brite Innovation"],"links":["https://brite.ikeinstitute.org/brite_innovation_review_issue_31_winter_2023/are_we_all_breathing_smart_dust"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article discussing smart dust and nano particles technology. RAND developed microelectromechanical systems (MEMS) that can monitor anything anywhere."},{"id":"EVT-0002","title":"Chemtrails: What In The World Are They Spraying?","description":"documentary on chemtrails and geoengineering","date":"2010-01-01","dateUploaded":"2026-02-12","topics":["chemtrails","Geoengineering"],"people":[],"organizations":[],"links":["https://www.youtube.com/watch?v=jf0khstYDLA"],"researchLevel":2,"sourceType":"Documentary","sourceSheet":"Sheet1","connections":[],"aiSummary":"Documentary exploring chemtrails and geoengineering programs, examining what is being sprayed in the atmosphere."},{"id":"EVT-0003","title":"CIA Document 1035-960: Concerning Criticism of the Warren Report","description":"CIA coins the term 'conspiracy theory' to discredit critics of the Warren Commission","date":"1967-01-01","dateUploaded":"2026-02-12","topics":["CIA","conspiracy theory","Warren Commission","JFK"],"people":[],"organizations":["Central Intelligence Agency (CIA)"],"links":[],"researchLevel":3,"sourceType":"Declassified Document","sourceSheet":"Sheet1","connections":[],"aiSummary":"Declassified CIA document that is widely credited with popularizing the term 'conspiracy theory' as a way to discredit critics of the Warren Commission report on JFK's assassination."},{"id":"EVT-0004","title":"COVID-19 Lab Leak Theory","description":"Evidence suggests COVID-19 may have originated from a laboratory in Wuhan, China rather than natural transmission","date":"2020-01-01","dateUploaded":"2026-02-12","topics":["COVID-19","lab leak","Wuhan","biological weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Article","sourceSheet":"Covid","connections":[],"aiSummary":"Analysis of COVID-19 origins and the lab leak hypothesis. Multiple intelligence agencies now assess this as the likely origin."},{"id":"EVT-0005","title":"Direct Energy Weapon Patent","description":"Patent for directed energy weapon technology used by military","date":"1990-01-01","dateUploaded":"2026-02-12","topics":["Directed Energy Weapons (DEW)","military technology","weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Patent","sourceSheet":"Direct energy weapon","connections":[],"aiSummary":"Patent covering directed energy weapon systems including microwave and laser-based weapons."},{"id":"EVT-0006","title":"Election of President Abraham Lincoln","description":"Abraham Lincoln served as the 16th President of the United States from 1861-03-04 to 1865-04-15.","date":"1861-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Abraham Lincoln"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Abraham Lincoln as the 16th President. Led the country through the Civil War and issued the Emancipation Proclamation.","isMajorEvent":true},{"id":"EVT-0007","title":"Election of President Barack Obama","description":"Barack Obama served as the 44th President of the United States from 2009-01-20 to 2017-01-20.","date":"2009-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Barack Obama"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Barack Obama as the 44th President and first African-American president of the United States.","isMajorEvent":true},{"id":"EVT-0008","title":"Election of President Bill Clinton","description":"Bill Clinton served as the 42nd President of the United States from 1993-01-20 to 2001-01-20.","date":"1993-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Bill Clinton"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Bill Clinton as the 42nd President of the United States.","isMajorEvent":true},{"id":"EVT-0009","title":"Election of President Donald Trump","description":"Donald Trump served as the 45th President of the United States from 2017-01-20 to 2021-01-20, and was elected again as the 47th President in 2024.","date":"2017-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Donald Trump"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Donald Trump as the 45th President.","isMajorEvent":true},{"id":"EVT-0010","title":"Election of President Dwight D. Eisenhower","description":"Dwight D. Eisenhower served as the 34th President of the United States from 1953-01-20 to 1961-01-20.","date":"1953-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Dwight D. Eisenhower"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Dwight D. Eisenhower. Famously warned about the military-industrial complex in his farewell address.","isMajorEvent":true},{"id":"EVT-0011","title":"Election of President Franklin D. Roosevelt","description":"Franklin D. Roosevelt served as the 32nd President of the United States from 1933-03-04 to 1945-04-12.","date":"1933-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Franklin D. Roosevelt"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Franklin D. Roosevelt. Led the country through the Great Depression and World War II.","isMajorEvent":true},{"id":"EVT-0012","title":"Election of President George W. Bush","description":"George W. Bush served as the 43rd President of the United States from 2001-01-20 to 2009-01-20.","date":"2001-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","9/11"],"people":["George W. Bush"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of George W. Bush. His presidency was defined by the 9/11 attacks and subsequent War on Terror.","isMajorEvent":true},{"id":"EVT-0013","title":"Election of President George Washington","description":"George Washington served as the 1st President of the United States from 1789-04-30 to 1797-03-04.","date":"1789-04-30","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","Founding Fathers"],"people":["George Washington"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Inauguration of George Washington as the first President of the United States and Founding Father.","isMajorEvent":true},{"id":"EVT-0014","title":"Election of President Harry S. Truman","description":"Harry S. Truman served as the 33rd President of the United States from 1945-04-12 to 1953-01-20.","date":"1945-04-12","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Harry S. Truman"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Harry S. Truman became President after FDR's death. Authorized use of atomic bombs on Japan and oversaw end of WWII.","isMajorEvent":true},{"id":"EVT-0015","title":"Election of President Joe Biden","description":"Joe Biden served as the 46th President of the United States from 2021-01-20 to 2025-01-20.","date":"2021-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Joe Biden"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Joe Biden as the 46th President.","isMajorEvent":true},{"id":"EVT-0016","title":"Election of President John F. Kennedy","description":"John F. Kennedy served as the 35th President of the United States from 1961-01-20 to 1963-11-22.","date":"1961-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","JFK","assassination"],"people":["John F. Kennedy"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of JFK. His assassination in 1963 remains one of history's most debated events.","isMajorEvent":true},{"id":"EVT-0017","title":"Gulf War","description":"Gulf War was a major military conflict involving the United States and coalition forces against Iraq, lasting from 1991-01-17 to 1991-02-28.","date":"1991-01-17","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Gulf War","Middle East"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Gulf War (Operation Desert Storm). Coalition forces expelled Iraq from Kuwait.","isMajorEvent":true},{"id":"EVT-0018","title":"Iraq War","description":"Iraq War was a major military conflict involving the United States, lasting from 2003-03-20 to 2011-12-15. Launched after claims of weapons of mass destruction.","date":"2003-03-20","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Iraq War","Middle East","weapons of mass destruction"],"people":[],"organizations":["United States Armed Forces","Central Intelligence Agency (CIA)"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Iraq War. Launched based on disputed WMD claims. No WMDs were found.","isMajorEvent":true},{"id":"EVT-0019","title":"Korean War","description":"Korean War was a major military conflict involving the United States, lasting from 1950-06-25 to 1953-07-27.","date":"1950-06-25","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Korean War"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Korean War, often called 'The Forgotten War'. Ended in armistice, not a peace treaty.","isMajorEvent":true},{"id":"EVT-0020","title":"October Surprise: A Four-Decade Secret","description":"Media now admits October Surprise is real â€” proof that the CIA and intelligence agencies will interfere with elections","date":"2023-03-28","dateUploaded":"2026-02-12","topics":["October Surprise","CIA","Ronald Reagan","Jimmy Carter","election fraud","election interference"],"people":["Jimmy Carter","Ronald Reagan"],"organizations":["New York Times (NYT)","The Intercept","Central Intelligence Agency (CIA)"],"links":["https://www.nytimes.com/2023/03/18/us/politics/jimmy-carter-october-surprise-iran-hostages.html","https://theintercept.com/2023/03/24/october-surprise-ben-barnes/"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article in NYT confirming the October Surprise â€” that Reagan's 1980 campaign secretly negotiated with Iran to delay hostage release to undermine Carter's re-election."}],"people":["Abraham Lincoln","Barack Obama","Bill Clinton","Donald Trump","Dwight D. Eisenhower","Franklin D. Roosevelt","George W. Bush","George Washington","Harry S. Truman","Jimmy Carter","Joe Biden","John F. Kennedy","Ronald Reagan"],"organizations":["Brite Innovation","Central Intelligence Agency (CIA)","New York Times (NYT)","The Intercept","United States Armed Forces","United States Government"],"topics":["9/11","American History","CYBORG","CIA","COVID-19","Directed Energy Weapons (DEW)","Founding Fathers","Geoengineering","Gulf War","Iraq War","JFK","Jimmy Carter","Korean War","MERGING WITH MACHINES","Middle East","Military Conflict","Nano particles","October Surprise","Politics","Presidential Election","Ronald Reagan","US President","War","Warren Commission","Wuhan","assassination","biological weapons","chemtrails","conspiracy theory","election fraud","election interference","lab leak","micro particles","military technology","smart dust","weapons of mass destruction"],"metadata":{"totalEvents":20,"totalPeople":13,"totalOrganizations":6,"totalTopics":36,"lastUpdated":"2026-02-16T12:00:00.000Z"}};

    // â”€â”€â”€ FILTERS COMPONENT (defined OUTSIDE App so it never remounts on keypress) â”€â”€â”€
    // â”€â”€ Multi-Select Dropdown Component â”€â”€
    const MultiSelectDropdown = ({ options, selected, onChange, placeholder }) => {
      const [open, setOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [newValue, setNewValue] = React.useState('');
      const ref = React.useRef(null);
      React.useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
      }, []);
      const filtered = (options||[]).filter(o => o.toLowerCase().includes(search.toLowerCase()) && !selected.includes(o));
      const toggle = (val) => {
        if (selected.includes(val)) onChange(selected.filter(v => v !== val));
        else onChange([...selected, val]);
      };
      const addNew = () => {
        const v = newValue.trim();
        if (v && !selected.includes(v)) { onChange([...selected, v]); setNewValue(''); setSearch(''); }
      };
      return React.createElement('div', { ref, style: { position: 'relative' } },
        React.createElement('div', {
          style: { minHeight: '38px', padding: '0.3rem 0.5rem', background: 'rgba(26,31,58,0.5)', border: '1px solid rgba(61,69,99,0.5)', borderRadius: '8px', cursor: 'pointer', display: 'flex', flexWrap: 'wrap', gap: '0.3rem', alignItems: 'center' },
          onClick: () => setOpen(!open)
        },
          ...(selected.length > 0 ? selected.map(v =>
            React.createElement('span', { key: v, style: { display: 'inline-flex', alignItems: 'center', gap: '0.25rem', padding: '0.15rem 0.5rem', background: 'rgba(96,165,250,0.15)', border: '1px solid rgba(96,165,250,0.3)', borderRadius: '6px', fontSize: '0.8rem', color: '#60a5fa' } },
              v,
              React.createElement('span', { onClick: (e) => { e.stopPropagation(); toggle(v); }, style: { cursor: 'pointer', color: '#f87171', fontWeight: 700, marginLeft: '0.2rem' } }, 'Ã—')
            )
          ) : [React.createElement('span', { key: '_ph', style: { color: '#6b7394', fontSize: '0.85rem' } }, placeholder || 'Select...')]),
        ),
        open && React.createElement('div', {
          style: { position: 'absolute', top: '100%', left: 0, right: 0, zIndex: 1000, background: '#1a1f3a', border: '1px solid rgba(61,69,99,0.7)', borderRadius: '8px', marginTop: '4px', maxHeight: '200px', overflow: 'auto', boxShadow: '0 8px 24px rgba(0,0,0,0.4)' }
        },
          React.createElement('div', { style: { padding: '0.4rem', borderBottom: '1px solid rgba(61,69,99,0.3)', display: 'flex', gap: '0.3rem' } },
            React.createElement('input', {
              value: search || newValue, onChange: (e) => { setSearch(e.target.value); setNewValue(e.target.value); },
              onKeyDown: (e) => { if (e.key === 'Enter') { e.preventDefault(); addNew(); } },
              placeholder: 'Search or add new...', autoFocus: true, onClick: (e) => e.stopPropagation(),
              style: { flex: 1, padding: '0.3rem 0.5rem', background: 'rgba(26,31,58,0.8)', border: '1px solid rgba(61,69,99,0.5)', borderRadius: '6px', color: '#e0e6ed', fontSize: '0.8rem', fontFamily: 'inherit', outline: 'none' }
            }),
            newValue.trim() && !options.includes(newValue.trim()) && !selected.includes(newValue.trim()) && React.createElement('button', {
              onClick: (e) => { e.stopPropagation(); addNew(); },
              style: { padding: '0.3rem 0.6rem', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', fontSize: '0.75rem', cursor: 'pointer', fontWeight: 600, whiteSpace: 'nowrap' }
            }, '+ Add')
          ),
          ...filtered.slice(0, 50).map(o =>
            React.createElement('div', {
              key: o, onClick: (e) => { e.stopPropagation(); toggle(o); },
              style: { padding: '0.35rem 0.75rem', cursor: 'pointer', fontSize: '0.8rem', color: '#c0c7d8', borderBottom: '1px solid rgba(61,69,99,0.15)' },
              onMouseEnter: (e) => e.currentTarget.style.background = 'rgba(96,165,250,0.1)',
              onMouseLeave: (e) => e.currentTarget.style.background = 'transparent',
            }, o)
          ),
          filtered.length === 0 && !newValue.trim() && React.createElement('div', { style: { padding: '0.5rem 0.75rem', color: '#6b7394', fontSize: '0.8rem', fontStyle: 'italic' } }, 'No options found')
        )
      );
    };

    const FiltersComponent = ({ filters, setFilters, data, activeTab, onSearch, onClear, onExportCSV, onExportJSON }) => {
      return (
        <div className="filters">
          <div className="filters-header">
            <div className="filters-title">Filters</div>
            <button className="btn btn-secondary" onClick={onClear} style={{padding:'0.5rem 1rem', fontSize:'0.8rem'}}>
              ðŸ—‘ï¸ Clear All Filters
            </button>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Search</label>
              <div className="search-row">
                <input
                  type="text"
                  placeholder="Search events, topics, people..."
                  value={filters.search}
                  onChange={e => setFilters(prev => ({ ...prev, search: e.target.value }))}
                  onKeyDown={e => { if (e.key === 'Enter') { e.preventDefault(); onSearch(); } }}
                />
                <button className="search-btn" onClick={onSearch}>â†’</button>
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Date From</label>
              <input type="date" value={filters.dateFrom} onChange={e => setFilters(prev => ({ ...prev, dateFrom: e.target.value }))} />
            </div>
            <div className="filter-group">
              <label className="filter-label">Date To</label>
              <input type="date" value={filters.dateTo} onChange={e => setFilters(prev => ({ ...prev, dateTo: e.target.value }))} />
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Topics</label>
              <div className="checkbox-grid">
                {(data.topics || []).map(t => (
                  <label key={t} className={`checkbox-label ${filters.topics.includes(t) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.topics.includes(t)}
                      onChange={e => setFilters(prev => ({
                        ...prev, topics: e.target.checked ? [...prev.topics, t] : prev.topics.filter(x => x !== t)
                      }))} />
                    {t}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">People</label>
              <div className="checkbox-grid">
                {(data.people || []).map(p => (
                  <label key={p} className={`checkbox-label ${filters.people.includes(p) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.people.includes(p)}
                      onChange={e => setFilters(prev => ({
                        ...prev, people: e.target.checked ? [...prev.people, p] : prev.people.filter(x => x !== p)
                      }))} />
                    {p}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Organizations</label>
              <div className="checkbox-grid">
                {(data.organizations || []).map(o => (
                  <label key={o} className={`checkbox-label ${filters.organizations.includes(o) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.organizations.includes(o)}
                      onChange={e => setFilters(prev => ({
                        ...prev, organizations: e.target.checked ? [...prev.organizations, o] : prev.organizations.filter(x => x !== o)
                      }))} />
                    {o}
                  </label>
                ))}
              </div>
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Research Levels</label>
              <div style={{display:'flex', gap:'0.75rem', flexWrap:'wrap'}}>
                {['1','2','3'].map(level => (
                  <label key={level} className={`checkbox-label ${filters.researchLevels.includes(level) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.researchLevels.includes(level)}
                      onChange={e => setFilters(prev => ({
                        ...prev, researchLevels: e.target.checked ? [...prev.researchLevels, level] : prev.researchLevels.filter(x => x !== level)
                      }))} />
                    Level {level}
                  </label>
                ))}
              </div>
            </div>
            {activeTab === 'timeline' && (
              <div className="filter-group">
                <label className="filter-label">Display Options</label>
                <label className="checkbox-label" style={{width:'fit-content'}}>
                  <input type="checkbox" checked={filters.showMajorOnly}
                    onChange={e => setFilters(prev => ({ ...prev, showMajorOnly: e.target.checked }))} />
                  Major Events Only (Presidents & Wars)
                </label>
              </div>
            )}
          </div>
          <div className="export-btns">
            <button className="btn btn-primary" onClick={onExportCSV}>ðŸ“¥ Export CSV</button>
            <button className="btn btn-primary" onClick={onExportJSON}>ðŸ“¥ Export JSON</button>
          </div>
        </div>
      );
    };

    // â”€â”€â”€ MAIN APP â”€â”€â”€
    function App() {
      const [data, setData] = useState(() => normalizeData(EMBEDDED_DATA));
      const [dbReady, setDbReady] = useState(false);

      const [currentUser, setCurrentUser] = useState(() => {
        try { return JSON.parse(localStorage.getItem('hdb_session')); } catch { return null; }
      });
      const [authScreen, setAuthScreen] = useState('login');
      const [accountTab, _setAccountTab] = useState(() => sessionStorage.getItem('hdb_accountTab') || 'uploads');
      const setAccountTab = (t) => { sessionStorage.setItem('hdb_accountTab', t); _setAccountTab(t); };
      const [myFilters, setMyFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [myPageTab, _setMyPageTab] = useState(() => sessionStorage.getItem('hdb_myPageTab') || 'timeline');
      const setMyPageTab = (t) => { sessionStorage.setItem('hdb_myPageTab', t); _setMyPageTab(t); };

      const TABS = ['timeline','network','spreadsheet','topics','people','organizations','upload'];

      const [activeTab, _setActiveTab] = useState(() => sessionStorage.getItem('hdb_activeTab') || 'timeline');
      const setActiveTab = (t) => { sessionStorage.setItem('hdb_activeTab', t); _setActiveTab(t); };
      const [filters, setFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [showModal, setShowModal] = useState(false);
      const [modalData, setModalData] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [editedEvent, setEditedEvent] = useState(null);
      const [editSections, setEditSections] = useState({basic:true,ai:true,tags:true,links:true,attachments:true});
      const [isCondensing, setIsCondensing] = useState(false);
      const [uploadMessage, setUploadMessage] = useState('');
      const [saveStatus, setSaveStatus] = useState('');
      const [selectedEntity, setSelectedEntity] = useState(null);
      const [urlInput, setUrlInput] = useState('');
      const [timestampStart, setTimestampStart] = useState('');
      const [timestampEnd, setTimestampEnd] = useState('');
      const [isTimelineFullscreen, setIsTimelineFullscreen] = useState(false);
      const [isNetworkFullscreen, setIsNetworkFullscreen] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [uploadTab, _setUploadTab] = useState(() => sessionStorage.getItem('hdb_uploadTab') || 'new');
      const setUploadTab = (t) => { sessionStorage.setItem('hdb_uploadTab', t); _setUploadTab(t); };
      const [selectedForAnalysis, setSelectedForAnalysis] = useState(new Set());
      const [recentHoursFilter, setRecentHoursFilter] = useState(24);
      const [autoAnalysis, setAutoAnalysis] = useState(false);
      const [analysisMode, setAnalysisMode] = useState(()=>sessionStorage.getItem('hdb_analysisMode')||'long');
      const [skipFrames, setSkipFrames] = useState(()=>sessionStorage.getItem('hdb_skipFrames')==='true');
      const [analysisSearch, setAnalysisSearch] = useState('');
      const [selectedEvents, setSelectedEvents] = useState(new Set());
      const [selectedMyEvents, setSelectedMyEvents] = useState(new Set());
      const [showDownloadPopup, setShowDownloadPopup] = useState(null); // 'spreadsheet' | 'myuploads' | 'recent' | null
      // Breadcrumb: array of {label, action}
      const [breadcrumbs, setBreadcrumbs] = useState([]);
      const fileInputRef = useRef(null);

      // â”€â”€ Load from Supabase on mount â”€â”€
      useEffect(() => {
        const loadEvents = async () => {
          try {
            const { data: rows, error } = await supabaseClient
              .from('events').select('*').order('date_uploaded', { ascending: false });
            if (error) throw error;
            if (rows && rows.length > 0) {
              const events = rows.map(fromDbRow);
              const agg = rebuildAggregates(events);
              setData({ events, ...agg, metadata: { totalEvents: events.length, lastUpdated: new Date().toISOString() } });
            } else {
              // First time: seed embedded data to Supabase
              const seedEvents = normalizeData(EMBEDDED_DATA).events;
              const { error: seedErr } = await supabaseClient.from('events').insert(seedEvents.map(toDbRow));
              if (seedErr) console.error('Seed error:', seedErr);
              else {
                const agg = rebuildAggregates(seedEvents);
                setData({ events: seedEvents, ...agg, metadata: { totalEvents: seedEvents.length, lastUpdated: new Date().toISOString() } });
              }
            }
          } catch (err) {
            console.error('Supabase load failed, using localStorage fallback:', err);
            try {
              const saved = localStorage.getItem('historicalEventsDB');
              if (saved) setData(normalizeData(JSON.parse(saved)));
            } catch (e) {}
          }
          setDbReady(true);
        };
        loadEvents();
      }, []);

      // â”€â”€ Cache to localStorage as offline fallback â”€â”€
      useEffect(() => {
        if (dbReady) {
          try { localStorage.setItem('historicalEventsDB', JSON.stringify(data)); } catch(e) {}
        }
      }, [data, dbReady]);

      // â”€â”€ Refresh from server â”€â”€
      const refreshFromServer = useCallback(async () => {
        setSaveStatus('Refreshing...');
        try {
          const { data: rows, error } = await supabaseClient
            .from('events').select('*').order('date_uploaded', { ascending: false });
          if (error) throw error;
          const events = (rows || []).map(fromDbRow);
          const agg = rebuildAggregates(events);
          setData({ events, ...agg, metadata: { totalEvents: events.length, lastUpdated: new Date().toISOString() } });
          setSaveStatus(`Refreshed âœ“ (${events.length} events)`);
        } catch(err) {
          setSaveStatus('Refresh failed');
        }
        setTimeout(() => setSaveStatus(''), 3000);
      }, []);

      // â”€â”€ Breadcrumb helpers â”€â”€
      const pushBreadcrumb = (label, action) => {
        setBreadcrumbs(prev => [...prev, { label, action }]);
      };

      const goToBreadcrumb = (index) => {
        const crumb = breadcrumbs[index];
        setBreadcrumbs(prev => prev.slice(0, index));
        if (crumb && crumb.action) crumb.action();
      };

      const navigateToTab = (tab) => {
        setActiveTab(tab);
        setSelectedEntity(null);
        setBreadcrumbs([{ label: tab.charAt(0).toUpperCase() + tab.slice(1), action: () => { setActiveTab(tab); setSelectedEntity(null); } }]);
      };

      // â”€â”€ Auth functions â”€â”€
      const login = (user) => {
        const session = { username: user.username, role: user.role };
        localStorage.setItem('hdb_session', JSON.stringify(session));
        setCurrentUser(session);
      };
      const logout = () => {
        localStorage.removeItem('hdb_session');
        setCurrentUser(null);
        setAuthScreen('login');
      };

      // â”€â”€ Visibility: what the current user can see â”€â”€
      const visibleEvents = useMemo(() => {
        if (!currentUser) return [];
        if (currentUser.role === 'admin' || currentUser.role === 'owner') return data.events;
        return data.events.filter(e => e.isPublic || e.uploadedBy === currentUser.username);
      }, [data.events, currentUser]);

      // â”€â”€ Event management â”€â”€
      const toggleEventPublic = async (eventId) => {
        const event = data.events.find(e => e.id === eventId);
        if (!event) return;
        const newVal = !event.isPublic;
        const { error } = await supabaseClient.from('events').update({ is_public: newVal }).eq('id', eventId);
        if (error) console.error('Toggle public error:', error);
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, isPublic: newVal } : e) }));
      };
      const updateEventStatus = async (eventId, status) => {
        const { error } = await supabaseClient.from('events').update({ event_status: status }).eq('id', eventId);
        if (error) console.error('Update status error:', error);
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, eventStatus: status } : e) }));
      };
      const deleteEvent = async (eventId) => {
        const { error } = await supabaseClient.from('events').delete().eq('id', eventId);
        if (error) { console.error('Delete error:', error); return; }
        setData(prev => {
          const updated = prev.events.filter(e => e.id !== eventId);
          const agg = rebuildAggregates(updated);
          return { ...prev, events: updated, ...agg, metadata:{...prev.metadata, totalEvents:updated.length} };
        });
        setShowModal(false);
      };

      // â”€â”€ User management (admin panel, Supabase-backed) â”€â”€
      const [adminUsers, setAdminUsers] = useState([]);
      const refreshAdminUsers = async () => { const users = await getAllUsers(); setAdminUsers(users); };
      useEffect(() => { refreshAdminUsers(); }, []);
      const updateUserRole = async (username, newRole) => {
        const { error } = await supabaseClient.from('users').update({ role: newRole }).eq('username', username.toLowerCase());
        if (error) { console.error('Update role error:', error); return; }
        setAdminUsers(prev => prev.map(u => u.username === username ? { ...u, role: newRole } : u));
        if (currentUser.username === username) {
          const session = { ...currentUser, role: newRole };
          localStorage.setItem('hdb_session', JSON.stringify(session));
          setCurrentUser(session);
        }
      };
      const deleteUserAccount = async (username) => {
        const { error } = await supabaseClient.from('users').delete().eq('username', username.toLowerCase());
        if (error) { console.error('Delete user error:', error); return; }
        setAdminUsers(prev => prev.filter(u => u.username !== username));
      };

      // â”€â”€ Filters â”€â”€
      const applySearch = () => setFilters(prev => ({ ...prev, appliedSearch: prev.search }));

      const clearAllFilters = () => setFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const applyMySearch = () => setMyFilters(prev => ({...prev, appliedSearch: prev.search}));
      const clearMyFilters = () => setMyFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });

      const filteredEvents = useMemo(() => {
        return visibleEvents.filter(e => {
          if (filters.showMajorOnly && !e.isMajorEvent) return false;
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            const match = (e.title||'').toLowerCase().includes(s) || (e.description||'').toLowerCase().includes(s) ||
              (e.topics||[]).some(t => t.toLowerCase().includes(s)) ||
              (e.people||[]).some(p => p.toLowerCase().includes(s)) ||
              (e.organizations||[]).some(o => o.toLowerCase().includes(s));
            if (!match) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          if (filters.researchLevels.length > 0 && !filters.researchLevels.includes(String(e.researchLevel))) return false;
          if (filters.dateFrom && e.date && e.date < filters.dateFrom) return false;
          if (filters.dateTo && e.date && e.date > filters.dateTo) return false;
          return true;
        });
      }, [data.events, filters]);

      const sortedEvents = useMemo(() => [...filteredEvents].sort((a,b) => {
        if (!a.date && !b.date) return 0;
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [filteredEvents]);

      const timelineEvents = useMemo(() =>
        filteredEvents.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [filteredEvents]);

      const filteredTopics = useMemo(() =>
        (data.topics||[]).map(t => ({ name:t, count: filteredEvents.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0)
      , [data.topics, filteredEvents]);

      const filteredPeople = useMemo(() =>
        (data.people||[]).map(p => ({ name:p, count: filteredEvents.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0)
      , [data.people, filteredEvents]);

      const filteredOrganizations = useMemo(() =>
        (data.organizations||[]).map(o => ({ name:o, count: filteredEvents.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0)
      , [data.organizations, filteredEvents]);

      const recentUploads = useMemo(() => {
        const cutoff = new Date(Date.now() - recentHoursFilter * 60 * 60 * 1000);
        return visibleEvents
          .filter(e => e.dateUploaded && new Date(e.dateUploaded) >= cutoff)
          .sort((a, b) => new Date(b.dateUploaded) - new Date(a.dateUploaded));
      }, [visibleEvents, recentHoursFilter]);

      const myUploads = useMemo(() =>
        data.events.filter(e => e.uploadedBy === (currentUser ? currentUser.username : '__none__'))
      , [data.events, currentUser]);

      const filteredMyUploads = useMemo(() => {
        return myUploads.filter(e => {
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s)) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          return true;
        });
      }, [myUploads, filters]);

      // â”€â”€ My Uploads scoped memos (for Account page) â”€â”€
      const myFiltered = useMemo(() => {
        return myUploads.filter(e => {
          if (myFilters.showMajorOnly && !e.isMajorEvent) return false;
          if (myFilters.appliedSearch) {
            const s = myFilters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s) &&
                !(e.topics||[]).some(t=>t.toLowerCase().includes(s)) &&
                !(e.people||[]).some(p=>p.toLowerCase().includes(s)) &&
                !(e.organizations||[]).some(o=>o.toLowerCase().includes(s))) return false;
          }
          if (myFilters.topics.length > 0 && !(e.topics||[]).some(t => myFilters.topics.includes(t))) return false;
          if (myFilters.researchLevels.length > 0 && !myFilters.researchLevels.includes(String(e.researchLevel))) return false;
          if (myFilters.people.length > 0 && !(e.people||[]).some(p => myFilters.people.includes(p))) return false;
          if (myFilters.organizations.length > 0 && !(e.organizations||[]).some(o => myFilters.organizations.includes(o))) return false;
          if (myFilters.dateFrom && e.date && new Date(e.date) < new Date(myFilters.dateFrom)) return false;
          if (myFilters.dateTo && e.date && new Date(e.date) > new Date(myFilters.dateTo)) return false;
          return true;
        });
      }, [myUploads, myFilters]);

      const mySortedEvents = useMemo(() => [...myFiltered].sort((a,b) => {
        if (!a.date && !b.date) return 0; if (!a.date) return 1; if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [myFiltered]);

      const myTimelineEvents = useMemo(() =>
        myFiltered.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [myFiltered]);

      const myFilteredTopics = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        return all.map(t => ({ name:t, count: myFiltered.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredPeople = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        return all.map(p => ({ name:p, count: myFiltered.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredOrgs = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        return all.map(o => ({ name:o, count: myFiltered.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0);
      }, [myUploads, myFiltered]);

      // â”€â”€ Network â”€â”€
      useEffect(() => {
        if (activeTab === 'network' && filteredEvents.length > 0) setTimeout(initNetwork, 100);
      }, [activeTab, filteredEvents]);

      const initNetwork = () => {
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = filteredEvents.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', color:{ background:'#60a5fa', border:'#3b82f6' }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#a78bfa', border:'#8b5cf6' } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#8b92b0' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#10b981', border:'#059669' } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#8b92b0' } });
          });
        });
        const container = document.getElementById('network-graph');
        if (container) {
          const net = new vis.Network(container, { nodes, edges }, {
            physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 } },
            interaction:{ hover:true }
          });
          net.on('click', params => {
            if (params.nodes.length > 0) {
              const id = params.nodes[0];
              if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
              else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
              else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, activeTab); }
            }
          });
        }
      };

      // â”€â”€ My Network (Account page) â”€â”€
      useEffect(() => {
        if (activeTab === 'account' && accountTab === 'uploads' && myPageTab === 'network' && myFiltered.length > 0)
          setTimeout(initMyNetwork, 100);
      }, [activeTab, accountTab, myPageTab, myFiltered]);

      const initMyNetwork = () => {
        const container = document.getElementById('my-network-graph');
        if (!container) return;
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = myFiltered.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', color:{ background:'#60a5fa', border:'#3b82f6' }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#a78bfa', border:'#8b5cf6' } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#8b92b0' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#10b981', border:'#059669' } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#8b92b0' } });
          });
        });
        const net = new vis.Network(container, { nodes, edges }, {
          physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 } },
          interaction:{ hover:true }
        });
        net.on('click', params => {
          if (params.nodes.length > 0) {
            const id = params.nodes[0];
            if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
            else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
            else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, 'account'); }
          }
        });
      };

      // â”€â”€ AI doc analysis â”€â”€
      const analyzeDocument = (text) => {
        const words = text.toLowerCase().split(/\s+/);
        const wordFreq = {};
        words.forEach(w => { if (w.length > 4 && /^[a-z]+$/.test(w)) wordFreq[w] = (wordFreq[w]||0)+1; });
        const topicCandidates = Object.entries(wordFreq).filter(([,f]) => f >= 3).map(([w]) => w).slice(0,10);
        const names = [...new Set((text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g)||[]))].slice(0,10);
        const orgs = [...new Set((text.match(/\b[A-Z][a-zA-Z\s&]+(Inc\.|Corp\.|LLC|Agency|Department|Institute|University|Company|Foundation)\b/g)||[]))].slice(0,5);
        const sentences = text.split(/[.!?]+/).filter(s=>s.trim());
        const summary = `AI Analysis: ${words.length} words analyzed. Key topics identified: ${topicCandidates.slice(0,5).join(', ')}. ${sentences.slice(0,2).join('. ').substring(0,200)}...`;
        return { topics: topicCandidates, people: names, organizations: orgs, summary };
      };

      // â”€â”€ File upload â”€â”€
      const handleFileUpload = async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        setIsProcessing(true);
        setUploadMessage('Processing files...');
        const newEvents = [];
        const timeout = setTimeout(() => { setIsProcessing(false); setUploadMessage('âš ï¸ Timeout - file may be too large'); setTimeout(()=>setUploadMessage(''),3000); }, 60000);
        try {
          for (const file of files) {
            let extractedText = '';
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
              await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = ev => {
                  try {
                    const wb = XLSX.read(ev.target.result, { type:'binary' });
                    wb.SheetNames.forEach(sheetName => {
                      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                      rows.forEach(row => {
                        extractedText += JSON.stringify(row)+' ';
                        newEvents.push({
                          id:generateEventId(),
                          title: row.title||row.Title||row.TITLE||`Uploaded: ${file.name}`,
                          description: row.description||row.Description||row.Abstract||'',
                          date: row.date||row.Date||row.year||null,
                          dateUploaded: new Date().toISOString(),
                          topics: (row.topics||row.Topics||sheetName).toString().split(/[,;/]/).map(t=>t.trim()).filter(t=>t),
                          people: (row.writer||row.inventor||row.people||'').toString().split(/[,;]/).map(p=>p.trim()).filter(p=>p),
                          organizations: (row.publisher||row.company||row.organization||'').toString().split(/[,;/]/).map(o=>o.trim()).filter(o=>o),
                          links: [row['link main']||row.link||''].filter(l=>l),
                          researchLevel: parseInt(row['srch lvl']||row['My search lvl']||1)||1,
                          sourceType:'Uploaded Excel', sourceSheet:sheetName, connections:[], aiSummary:'', isMajorEvent:false,
                          uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified'
                        });

                      });
                    });
                  } catch(err) {}
                  resolve();
                };
                reader.onerror = ()=>resolve();
                reader.readAsBinaryString(file);
              });
            } else if (file.name.endsWith('.csv')) {
              extractedText = await file.text();
              const lines = extractedText.split('\n').filter(l=>l.trim());
              if (lines.length > 1) {
                const headers = lines[0].split(',').map(h=>h.trim());
                for (let i=1; i<Math.min(lines.length,1000); i++) {
                  const vals = lines[i].split(',');
                  const row = {};
                  headers.forEach((h,idx)=>{ row[h]=vals[idx]?.trim()||''; });
                  newEvents.push({ id:generateEventId(), title:row.title||row.Title||`CSV Entry ${i}`, description:row.description||row.Description||'', date:row.date||row.Date||null, dateUploaded:new Date().toISOString(), topics:(row.topics||'CSV Import').split(/[,;]/).map(t=>t.trim()).filter(t=>t), people:(row.people||'').split(/[,;]/).map(p=>p.trim()).filter(p=>p), organizations:(row.organization||'').split(/[,;]/).map(o=>o.trim()).filter(o=>o), links:[row.link||''].filter(l=>l), researchLevel:1, sourceType:'Uploaded CSV', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                }
              }
            } else if (file.name.endsWith('.txt')) {
              extractedText = await file.text();
              newEvents.push({ id:generateEventId(), title:file.name.replace('.txt',''), description:extractedText.substring(0,500), date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:['Text Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded Text', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
            } else if (/\.(pdf|docx?|png|jpe?g|gif|bmp|tiff|webp)$/i.test(file.name)) {
              // Send to backend for real text extraction
              try {
                const formData = new FormData();
                formData.append('files', file);
                const resp = await fetch(`${API_BASE}/api/upload`, { method: 'POST', body: formData });
                if (resp.ok) {
                  const result = await resp.json();
                  for (const rec of (result.records || [])) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeLabel = {pdf:'PDF',doc:'Word',docx:'Word',png:'Image',jpg:'Image',jpeg:'Image',gif:'Image',bmp:'Image',tiff:'Image',webp:'Image'}[ext] || 'Document';
                    // Clean description: skip URLs, nav junk, take first meaningful sentences
                    const rawText = rec.extracted_text || '';
                    const cleanLines = rawText.split('\n').filter(l => {
                      const t = l.trim();
                      return t.length > 20 && !t.startsWith('http') && !/^(Share|Save|Click here|Recommended Stories|list of|list \d|end of list)/i.test(t);
                    });
                    const cleanDesc = cleanLines.slice(0, 3).join(' ').substring(0, 500);
                    newEvents.push({
                      id:generateEventId(),
                      title: file.name.replace(/\.[^.]+$/, ''),
                      description: cleanDesc || `${typeLabel} document uploaded: ${file.name}`,
                      date: new Date().toISOString().split('T')[0],
                      dateUploaded: new Date().toISOString(),
                      topics: [typeLabel + ' Document'],
                      people: [], organizations: [], links: [],
                      researchLevel: 1,
                      sourceType: 'Uploaded ' + typeLabel,
                      sourceSheet: file.name,
                      connections: [],
                      aiSummary: 'Text extracted â€” select and click "Analyze Selected" for AI analysis.',
                      isMajorEvent: false,
                      uploadedBy: currentUser ? currentUser.username : 'unknown',
                      isPublic: false, eventStatus: 'unverified',
                      _backendId: rec.id,
                      _backendFileName: rec.saved_filename || '',
                      _hasBackend: true,
                      mainLink: '',
                      source: '',
                      primarySource: ''
                    });
                    }
                } else {
                  // Fallback: create stub event if backend is unavailable
                  const ext = file.name.split('.').pop().toLowerCase();
                  const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                  newEvents.push({ id:generateEventId(), title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - backend unavailable for extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                }
              } catch(fetchErr) {
                const ext = file.name.split('.').pop().toLowerCase();
                const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                newEvents.push({ id:generateEventId(), title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - server not running. Start the backend to enable extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                }
            }
            if (extractedText && newEvents.length > 0 && !newEvents[newEvents.length-1]._hasBackend) {
              // Only run client-side analysis for non-backend files (Excel, CSV, TXT)
              const analysis = analyzeDocument(extractedText);
              const last = newEvents[newEvents.length-1];
              last.aiSummary = analysis.summary;
              last.topics = [...new Set([...last.topics, ...analysis.topics])];
              last.people = [...new Set([...last.people, ...analysis.people])];
              last.organizations = [...new Set([...last.organizations, ...analysis.organizations])];
            }
          }
          clearTimeout(timeout);
          if (newEvents.length > 0) {
            // Insert to Supabase
            const { error: sbErr } = await supabaseClient.from('events').insert(newEvents.map(toDbRow));
            if (sbErr) console.error('Supabase insert error:', sbErr);
            const updated = {
              events:[...data.events,...newEvents],
              people:Array.from(new Set([...data.people,...newEvents.flatMap(e=>e.people)])).sort(),
              organizations:Array.from(new Set([...data.organizations,...newEvents.flatMap(e=>e.organizations)])).sort(),
              topics:Array.from(new Set([...data.topics,...newEvents.flatMap(e=>e.topics)])).sort(),
              metadata:{...data.metadata, totalEvents:data.events.length+newEvents.length, lastUpdated:new Date().toISOString()}
            };
            setData(updated);
            // Auto AI Analysis: trigger backend analysis and sync results back
            if (autoAnalysis) {
              const toAnalyze = newEvents.filter(e => e._backendId);
              if (toAnalyze.length > 0) {
                setUploadMessage(`âœ“ Uploaded ${newEvents.length} event(s) â€” analyzing ${toAnalyze.length} with AI...`);
                (async () => {
                  for (const evt of toAnalyze) {
                    try {
                      const resp = await fetch(`${API_BASE}/api/analyze/${evt._backendId}?mode=${analysisMode}${analysisSearch.trim()?'&search_focus='+encodeURIComponent(analysisSearch.trim()):''}`, { method: 'POST' });
                      if (resp.ok) {
                        const result = await resp.json();
                        const rec = result.record;
                        if (rec) {
                          // Sync to Supabase
                          await supabaseClient.from('events').update({
                            ai_summary: rec.summary || '', description: rec.description || rec.summary || '',
                            topics: rec.topics || [], people: rec.people || [], organizations: rec.organizations || [],
                            source: rec.source || '', primary_source: rec.primary_source || '', main_link: rec.main_link || '',
                            ai_analyzed: true, analysis_mode: rec.analysis_mode || '', has_frames: rec.has_frames || false,
                          }).eq('id', evt.id);
                          setData(prev => ({
                            ...prev,
                            events: prev.events.map(e => e.id === evt.id ? {
                              ...e,
                              aiSummary: rec.summary || e.aiSummary,
                              description: rec.description || rec.summary || e.description,
                              topics: rec.topics && rec.topics.length > 0 ? rec.topics : e.topics,
                              people: rec.people && rec.people.length > 0 ? rec.people : e.people,
                              organizations: rec.organizations && rec.organizations.length > 0 ? rec.organizations : e.organizations,
                              source: rec.source || e.source || '',
                              primarySource: rec.primary_source || e.primarySource || '',
                              mainLink: rec.main_link || e.mainLink || '',
                              _aiAnalyzed: true,
                              _analysisMode: rec.analysis_mode || '',
                              _hasFrames: rec.has_frames || false,
                            } : e),
                            people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
                            organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
                            topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
                          }));
                        }
                      }
                    } catch(err) {}
                  }
                  setUploadMessage(`âœ“ AI Analysis complete for ${toAnalyze.length} document(s).`);
                  setTimeout(()=>setUploadMessage(''),5000);
                  // Open modal AFTER analysis so it shows AI data
                  setData(prev => {
                    const updatedEvt = prev.events.find(e => e.id === newEvents[0].id);
                    if (updatedEvt) openEventModal(updatedEvt, 'upload');
                    return prev;
                  });
                })();
              }
            }
            setIsProcessing(false);
            if (!autoAnalysis) {
              setUploadMessage(`âœ“ Successfully uploaded ${newEvents.length} event(s)!`);
              openEventModal(newEvents[0], 'upload');
            }
            setTimeout(()=>setUploadMessage(''),5000);
          } else { setIsProcessing(false); setUploadMessage('âš ï¸ No valid data found'); setTimeout(()=>setUploadMessage(''),3000); }
        } catch(err) { clearTimeout(timeout); setIsProcessing(false); setUploadMessage(`âŒ Error: ${err.message}`); setTimeout(()=>setUploadMessage(''),5000); }
        event.target.value='';
      };

      const parseTimeToSeconds = (str) => {
        if (!str || !str.trim()) return null;
        const s = str.trim();
        if (/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);
        const parts = s.split(':').map(Number);
        if (parts.some(isNaN)) return null;
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        return null;
      };

      const handleUrlSubmit = async () => {
        if (!urlInput.trim()) return;
        setIsProcessing(true);
        const isVideo = /youtube|youtu\.be|vimeo|dailymotion/i.test(urlInput);
        const doAnalysis = autoAnalysis;

        // If using remote backend, ping it first â€” free tier sleeps after inactivity
        if (API_BASE) {
          setUploadMessage('â³ Connecting to analysis server...');
          const pingStart = Date.now();
          try { await fetch(`${API_BASE}/api/records`, { method: 'GET' }); } catch(e) {}
          if (Date.now() - pingStart > 3000) {
            setUploadMessage('ðŸ”„ Backend is waking up â€” it\'ll be ready in just a moment. Subsequent requests will be instant.');
            await new Promise(r => setTimeout(r, 1500));
          }
        }

        const startSecs = parseTimeToSeconds(timestampStart);
        const endSecs = parseTimeToSeconds(timestampEnd);

        if (doAnalysis) {
          const modeLabel = {fast:'Fast',quick:'Quick',short:'Short',long:'Detailed'}[analysisMode]||'';
          const frameLabel = skipFrames ? ', no frames' : '';
          const rangeLabel = isVideo && (startSecs !== null || endSecs !== null)
            ? ` [${timestampStart||'0:00'}â€“${timestampEnd||'end'}]` : '';
          setUploadMessage(isVideo ? `Analyzing video (${modeLabel}${frameLabel}${rangeLabel})...` : 'Scraping & analyzing web page...');
        } else {
          setUploadMessage(isVideo ? 'Fetching video info (no AI analysis)...' : 'Fetching page info (no AI analysis)...');
        }
        try {
          const resp = await fetch(`${API_BASE}/api/analyze-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: urlInput, mode: analysisMode, skip_frames: skipFrames, skip_analysis: !doAnalysis,
              ...(startSecs !== null && { start_time: startSecs }),
              ...(endSecs !== null && { end_time: endSecs }),
              ...(analysisSearch.trim() && { search_focus: analysisSearch.trim() }),
            }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(()=>({}));
            throw new Error(err.detail || `Server error ${resp.status}`);
          }
          const result = await resp.json();
          const rec = result.record;

          // Build transcript chapters from segments if available
          let transcription = null;
          if (rec.transcript && rec.transcript.length > 50) {
            // Create a simple chapter structure from the transcript
            const lines = rec.transcript.split(/[.!?]\s+/).filter(l=>l.trim().length > 20);
            const chunkSize = Math.max(1, Math.floor(lines.length / 5));
            const chapters = [];
            for (let i = 0; i < Math.min(lines.length, 10); i += chunkSize) {
              const chunk = lines.slice(i, i + chunkSize).join('. ');
              if (chunk.trim()) {
                const mins = Math.floor((i / lines.length) * (rec.video_metadata?.duration || 300) / 60);
                const secs = Math.floor((i / lines.length) * (rec.video_metadata?.duration || 300) % 60);
                chapters.push({ timestamp: `${mins}:${String(secs).padStart(2,'0')}`, title: `Section ${chapters.length+1}`, text: chunk.substring(0,500) });
              }
            }
            if (chapters.length > 0) transcription = { chapters };
          }

          // Build visual content description
          let visualDesc = rec.visual_content || '';
          if (rec.frames_data && rec.frames_data.length > 0) {
            visualDesc += (visualDesc ? '\n' : '') + `${rec.frames_data.length} visual frame(s) captured and saved.`;
          }

          const newEvent = {
            id: generateEventId(),
            title: rec.file_name || urlInput,
            description: rec.description || (result.metadata_only && rec.video_metadata?.description ? rec.video_metadata.description.substring(0, 500) : ''),
            aiSummary: rec.summary || (result.metadata_only ? 'Not yet analyzed â€” select and click "Analyze Selected" for AI analysis.' : ''),
            date: new Date().toISOString().split('T')[0],
            dateUploaded: new Date().toISOString(),
            topics: rec.topics || [],
            people: rec.people || [],
            organizations: rec.organizations || [],
            links: [urlInput],
            mainLink: rec.main_link || urlInput,
            researchLevel: 1,
            sourceType: rec.content_type === 'video' ? 'Video URL' : 'Web URL',
            source: rec.source || '',
            primarySource: rec.primary_source || '',
            sourceSheet: 'URL Import',
            connections: [],
            isMajorEvent: false,
            isVideo: rec.content_type === 'video',
            uploadedBy: currentUser ? currentUser.username : 'unknown',
            isPublic: false,
            eventStatus: 'unverified',
            _aiAnalyzed: !result.metadata_only,
            _analysisMode: rec.analysis_mode || '',
            _hasFrames: rec.has_frames || false,
            _backendId: rec.id,
            _backendFileName: rec.saved_filename || '',
            _visualContent: visualDesc,
            _framesData: rec.frames_data || [],
            _transcriptFile: rec.transcript_file || result.transcript_file || '',
            _attachments: rec.attachments || [],
            transcription,
          };

          // Insert to Supabase
          const { error: sbErr } = await supabaseClient.from('events').insert([toDbRow(newEvent)]);
          if (sbErr) console.error('Supabase insert error:', sbErr);

          setData(prev => ({
            events: [...prev.events, newEvent],
            people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
            organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
            topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
            metadata: {...prev.metadata, totalEvents: prev.events.length+1, lastUpdated: new Date().toISOString()},
          }));
          setIsProcessing(false);
          if (result.metadata_only) {
            setUploadMessage('âœ“ URL added (no AI analysis). Select it and click "Analyze Selected" to analyze later.');
          } else {
            setUploadMessage(`âœ“ URL analyzed successfully!${result.has_visual_analysis ? ` (${result.frames_count} visual frames captured)` : ''}`);
          }
          setUrlInput('');
          openEventModal(newEvent, 'upload');
          setTimeout(()=>setUploadMessage(''),5000);
        } catch(err) { setIsProcessing(false); setUploadMessage(`âŒ Error: ${err.message}`); setTimeout(()=>setUploadMessage(''),15000); }
      };

      const cancelProcessing = () => { setIsProcessing(false); setUploadMessage('Processing cancelled'); setTimeout(()=>setUploadMessage(''),2000); };

      // â”€â”€ Modal â”€â”€
      const openEventModal = (event, fromTab) => {
        setModalData(event);
        setEditedEvent({...event});
        setIsEditing(false);
        setShowModal(true);
      };

      const openEntityDetail = (type, name) => {
        const fromTab = activeTab;
        const fromLabel = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);
        pushBreadcrumb(fromLabel, () => { setSelectedEntity(null); setActiveTab(fromTab); });
        setShowModal(false);
        setSelectedEntity({
          type, name,
          events: data.events.filter(e => {
            if (type === 'person') return (e.people||[]).includes(name);
            if (type === 'org') return (e.organizations||[]).includes(name);
            if (type === 'topic') return (e.topics||[]).includes(name);
            return false;
          })
        });
      };

      const goBack = () => {
        setSelectedEntity(null);
        setBreadcrumbs(prev => prev.slice(0,-1));
      };

      const saveEditedEvent = async () => {
        const cleaned = {...editedEvent, links: (editedEvent.links||[]).filter(l=>l.trim())};
        const { error } = await supabaseClient.from('events').update(toDbRow(cleaned)).eq('id', cleaned.id);
        if (error) { setUploadMessage('âŒ Save failed: ' + error.message); setTimeout(()=>setUploadMessage(''),5000); return; }
        const updatedEvents = data.events.map(e => e.id === cleaned.id ? cleaned : e);
        const agg = rebuildAggregates(updatedEvents);
        setData({...data, events:updatedEvents, ...agg});
        setModalData(cleaned);
        setIsEditing(false);
        setUploadMessage('âœ“ Event updated!');
        setTimeout(()=>setUploadMessage(''),3000);
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(()=>{ setUploadMessage('ðŸ“‹ Copied!'); setTimeout(()=>setUploadMessage(''),2000); });
      };

      // â”€â”€ Download helpers â”€â”€
      const downloadEvents = (events, format) => {
        const dateStr = new Date().toISOString().split('T')[0];
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source Type','Source','Primary Source','Main Link','Links'];
        const rows = events.map(e => [e.id,e.title,e.description||'',e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType||'',e.source||'',e.primarySource||'',e.mainLink||'',(e.links||[]).join('; ')]);
        if (format === 'csv') {
          const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
          a.download = `events-${dateStr}.csv`;
          a.click();
        } else if (format === 'excel') {
          const ws = XLSX.utils.aoa_to_sheet([headers,...rows]);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Events');
          XLSX.writeFile(wb, `events-${dateStr}.xlsx`);
        } else if (format === 'json') {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([JSON.stringify({events,exportDate:dateStr},null,2)],{type:'application/json'}));
          a.download = `events-${dateStr}.json`;
          a.click();
        } else if (format === 'pdf') {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: 'landscape' });
          doc.setFontSize(14);
          doc.text('Historical Events Database Export', 14, 15);
          doc.setFontSize(8);
          doc.text(`Exported: ${dateStr}  |  ${events.length} event(s)`, 14, 21);
          const pdfHeaders = ['ID','Title','Date','Topics','Level','Source'];
          const pdfRows = events.map(e => [String(e.id),(e.title||'').substring(0,60),e.date||'',(e.topics||[]).join(', ').substring(0,50),`L${e.researchLevel}`,e.source||'']);
          doc.autoTable({ head:[pdfHeaders], body:pdfRows, startY:25, styles:{fontSize:7,cellPadding:2}, headStyles:{fillColor:[37,99,235]}, alternateRowStyles:{fillColor:[240,242,248]} });
          doc.save(`events-${dateStr}.pdf`);
        } else if (format === 'word') {
          let html = `<html><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:10pt}th,td{border:1px solid #999;padding:6px 8px;text-align:left}th{background:#2563eb;color:#fff}tr:nth-child(even){background:#f0f2f8}h1{font-size:16pt;color:#1a1f3a}</style></head><body>`;
          html += `<h1>Historical Events Database Export</h1><p>Exported: ${dateStr} | ${events.length} event(s)</p>`;
          html += '<table><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
          rows.forEach(r => { html += '<tr>' + r.map(c=>`<td>${String(c||'').replace(/</g,'&lt;')}</td>`).join('') + '</tr>'; });
          html += '</table></body></html>';
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([html],{type:'application/msword'}));
          a.download = `events-${dateStr}.doc`;
          a.click();
        }
        setShowDownloadPopup(null);
      };

      const exportToCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source','Link'];
        const rows = filteredEvents.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType,(e.links&&e.links[0])||'']);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const exportToJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:filteredEvents,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const myExportCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source'];
        const rows = myFiltered.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType]);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };
      const myExportJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:myFiltered,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      // â”€â”€ Shared filter props â”€â”€
      const filterProps = { filters, setFilters, data, activeTab, onSearch:applySearch, onClear:clearAllFilters, onExportCSV:exportToCSV, onExportJSON:exportToJSON };

      // â”€â”€ Uploads grid component (reused in tab and page) â”€â”€
      const UploadsContent = () => (
        <div>
          <FiltersComponent {...filterProps} />
          {filteredMyUploads.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">ðŸ“‚</div>
              <p>No uploads yet â€” use the Upload page to add files or URLs.</p>
            </div>
          ) : (
            <div className="spreadsheet">
              <table className="table">
                <thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Visibility</th><th>Type</th><th>Date</th><th>Topics</th></tr></thead>
                <tbody>
                  {filteredMyUploads.map(e => (
                    <tr key={e.id} style={{cursor:'pointer'}}>
                      <td onClick={()=>openEventModal(e,'my uploads')}>{e.id}</td>
                      <td onClick={()=>openEventModal(e,'my uploads')} style={{fontWeight:600}}>{e.title}</td>
                      <td><span className={`status-${e.eventStatus||'unverified'}`}>{e.eventStatus==='historical_record'?'Historical Record':e.eventStatus==='contested'?'Contested':'Unverified'}</span></td>
                      <td>
                        <button onClick={()=>toggleEventPublic(e.id)} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                          <span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'ðŸŒ Public' : 'ðŸ”’ Private'}</span>
                        </button>
                      </td>
                      <td><span style={{padding:'0.25rem 0.6rem',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'6px',fontSize:'0.75rem',color:'#60a5fa'}}>{e.sourceType}</span></td>
                      <td>{e.dateUploaded ? new Date(e.dateUploaded).toLocaleDateString() : 'â€”'}</td>
                      <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );

      // â”€â”€ Modal â”€â”€
      const modalTabLabel = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);
      const modalCrumbs = selectedEntity
          ? [
              { label: 'ðŸ  Home', action: () => { setShowModal(false); setSelectedEntity(null); setBreadcrumbs([]); setActiveTab('timeline'); } },
              ...breadcrumbs.map((b, i) => ({ label: b.label, action: () => { setShowModal(false); goToBreadcrumb(i); } })),
              { label: selectedEntity.name, action: () => setShowModal(false) }
            ]
          : [
              { label: 'ðŸ  Home', action: () => { setShowModal(false); navigateToTab('timeline'); } },
              { label: modalTabLabel, action: () => setShowModal(false) }
            ];
      const modalViewJSX = (!showModal || !modalData || !currentUser) ? null : (
        <div className="modal" onClick={()=>setShowModal(false)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            {/* Breadcrumb trail inside modal â€” always visible, Notion/ClickUp style */}
            <div style={{display:'flex',alignItems:'center',gap:'0.3rem',marginBottom:'1.25rem',flexWrap:'wrap',borderBottom:'1px solid rgba(61,69,99,0.4)',paddingBottom:'0.75rem'}}>
              {modalCrumbs.map((crumb, i) => (
                <React.Fragment key={i}>
                  {i > 0 && <span className="bc-sep">â€º</span>}
                  <span className="bc-item" style={{fontSize:'0.8rem'}} onClick={crumb.action}>{crumb.label}</span>
                </React.Fragment>
              ))}
              <span className="bc-sep">â€º</span>
              <span className="bc-current" style={{fontSize:'0.8rem'}}>{isEditing ? 'Edit Event' : (modalData.title.length > 60 ? modalData.title.substring(0,60)+'â€¦' : modalData.title)}</span>
            </div>
            <div className="modal-header">
              <h2 className="modal-title">{isEditing ? 'Edit Event' : modalData.title}</h2>
              <div className="modal-actions">
                {!isEditing && <button className="edit-btn" onClick={()=>setIsEditing(true)}>âœï¸ Edit</button>}
                {isEditing && <button className="btn btn-primary" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={saveEditedEvent}>ðŸ’¾ Save</button>}
                {isEditing && <button className="btn btn-danger" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={()=>setIsEditing(false)}>Cancel</button>}
                {!isEditing && (currentUser.role === 'admin' || currentUser.role === 'owner') && <button className="btn btn-danger" style={{padding:'0.4rem 0.75rem',fontSize:'0.8rem'}} onClick={()=>{if(window.confirm('Delete this event permanently?'))deleteEvent(modalData.id);}}>ðŸ—‘ï¸</button>}
                <button className="close" onClick={()=>setShowModal(false)}>Ã—</button>
              </div>
            </div>
            {!isEditing ? (
              <>
                {/* Article Info â€” compact 3-column grid */}
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.4rem 1.5rem',marginBottom:'1rem',padding:'0.75rem 1rem',background:'rgba(26,31,58,0.5)',borderRadius:'10px',border:'1px solid rgba(61,69,99,0.3)',fontSize:'0.8rem',lineHeight:1.6}}>
                  <div><span style={{color:'#6b7394'}}>ID:</span> <span style={{color:'#c0c7d8'}}>{modalData.id}</span></div>
                  <div><span style={{color:'#6b7394'}}>Date:</span> <span style={{color:'#c0c7d8'}}>{modalData.date||'Unknown'}</span></div>
                  <div><span style={{color:'#6b7394'}}>Type:</span> <span style={{color:'#c0c7d8'}}>{modalData.sourceType}</span></div>
                  <div><span style={{color:'#6b7394'}}>Level:</span> <span className={`level-${modalData.researchLevel}`} style={{fontSize:'0.8rem'}}>Level {modalData.researchLevel}</span></div>
                  <div><span style={{color:'#6b7394'}}>Status:</span>{' '}
                    {(currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                      <select className="status-select" style={{marginLeft:'0.3rem',fontSize:'0.75rem',padding:'0.1rem 0.3rem'}} value={modalData.eventStatus||'unverified'}
                        onChange={ev=>{updateEventStatus(modalData.id, ev.target.value); setModalData({...modalData, eventStatus:ev.target.value});}}>
                        <option value="historical_record">Historical Record</option>
                        <option value="contested">Contested</option>
                        <option value="unverified">Unverified</option>
                      </select>
                    ) : (
                      <span className={`status-${modalData.eventStatus||'unverified'}`} style={{fontSize:'0.75rem'}}>{modalData.eventStatus==='historical_record'?'Historical Record':modalData.eventStatus==='contested'?'Contested':'Unverified'}</span>
                    )}
                  </div>
                  <div><span style={{color:'#6b7394'}}>Visibility:</span>{' '}
                    {(modalData.uploadedBy === currentUser.username || currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                      <button onClick={()=>{toggleEventPublic(modalData.id); setModalData({...modalData, isPublic:!modalData.isPublic});}} style={{background:'none',border:'none',cursor:'pointer',padding:0,fontSize:'0.8rem'}}>
                        <span className={modalData.isPublic ? 'vis-public' : 'vis-private'}>{modalData.isPublic ? 'Public' : 'Private'}</span>
                      </button>
                    ) : (
                      <span className={modalData.isPublic ? 'vis-public' : 'vis-private'} style={{fontSize:'0.8rem'}}>{modalData.isPublic ? 'Public' : 'Private'}</span>
                    )}
                  </div>
                  {modalData.source && <div style={{gridColumn: modalData.primarySource ? 'auto' : 'span 3'}}><span style={{color:'#6b7394'}}>Source:</span> <span style={{color:'#c0c7d8'}}>{modalData.source}</span></div>}
                  {modalData.primarySource && <div style={{gridColumn: modalData.source ? 'span 2' : 'span 3'}}><span style={{color:'#6b7394'}}>Primary Source:</span> <span style={{color:'#c0c7d8'}}>{modalData.primarySource}</span></div>}
                </div>
                {/* AI Summary */}
                {modalData.aiSummary && <div className="ai-summary-box"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div className="ai-summary-label">AI Summary</div>{modalData._aiAnalyzed && <span style={{fontSize:'0.7rem',padding:'0.2rem 0.6rem',background:'rgba(16,185,129,0.2)',color:'#10b981',border:'1px solid rgba(16,185,129,0.4)',borderRadius:'6px',fontWeight:600}}>AI Analyzed{modalData._analysisMode ? ` Â· ${modalData._analysisMode.charAt(0).toUpperCase()+modalData._analysisMode.slice(1)}` : ''}{modalData._hasFrames ? ' + Frames' : ''}</span>}</div><p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.aiSummary}</p></div>}
                {/* Description â€” bullet points from AI + human notes */}
                <div className="form-group">
                  <label className="form-label">Description</label>
                  {modalData.description && modalData.description.includes('- ') ? (
                    <ul style={{color:'#e0e6ed',lineHeight:1.8,paddingLeft:'1.25rem',margin:0}}>
                      {modalData.description.split('\n').filter(l=>l.trim()).map((line,i)=>(
                        <li key={i} style={{marginBottom:'0.3rem'}}>{line.replace(/^[-â€¢]\s*/,'')}</li>
                      ))}
                    </ul>
                  ) : (
                    <p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.description}</p>
                  )}
                </div>
                {modalData.transcription && (
                  <div style={{background:'rgba(16,185,129,0.1)',border:'2px solid rgba(16,185,129,0.3)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#10b981',marginBottom:'1rem'}}>Video Transcription</h3>
                    {modalData.transcription.chapters.map((ch,i)=>(
                      <div key={i} style={{padding:'1rem',marginBottom:'0.75rem',background:'rgba(26,31,58,0.5)',borderLeft:'4px solid #10b981',borderRadius:'8px'}}>
                        <div style={{fontWeight:700,color:'#10b981',marginBottom:'0.4rem'}}>{ch.timestamp} â€” {ch.title}</div>
                        <p style={{color:'#8b92b0',fontSize:'0.875rem'}}>{ch.text}</p>
                      </div>
                    ))}
                  </div>
                )}
                {/* Visual Content from video frames */}
                {modalData._visualContent && (
                  <div style={{background:'rgba(124,58,237,0.1)',border:'2px solid rgba(124,58,237,0.3)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#a78bfa',marginBottom:'1rem'}}>Visual Content Analysis</h3>
                    {modalData._visualContent.includes('- ') ? (
                      <ul style={{color:'#c0c7d8',lineHeight:1.8,paddingLeft:'1.25rem',margin:0}}>
                        {modalData._visualContent.split('\n').filter(l=>l.trim()).map((line,i)=>(
                          <li key={i} style={{marginBottom:'0.3rem'}}>{line.replace(/^[-â€¢]\s*/,'')}</li>
                        ))}
                      </ul>
                    ) : (
                      <p style={{color:'#c0c7d8',lineHeight:1.6}}>{modalData._visualContent}</p>
                    )}
                  </div>
                )}
                {/* Analysis Attachments â€” auto-generated files from AI analysis */}
                {(modalData._transcriptFile || (modalData._framesData||[]).length > 0) && (
                  <div style={{background:'rgba(245,158,11,0.08)',border:'2px solid rgba(245,158,11,0.25)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#f59e0b',marginBottom:'1rem',fontSize:'1rem'}}>Analysis Attachments</h3>
                    {modalData._transcriptFile && (
                      <div style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.6rem 0.75rem',background:'rgba(26,31,58,0.5)',borderRadius:'8px',marginBottom:'0.75rem',border:'1px solid rgba(245,158,11,0.2)'}}>
                        <span style={{fontSize:'1.2rem'}}>ðŸ“</span>
                        <span style={{color:'#e0e6ed',flex:1,fontSize:'0.85rem'}}>Transcript</span>
                        <a href={`${API_BASE}/api/transcripts/${modalData._transcriptFile}`} download style={{padding:'0.3rem 0.6rem',background:'rgba(245,158,11,0.2)',border:'1px solid rgba(245,158,11,0.4)',borderRadius:'6px',color:'#f59e0b',fontSize:'0.75rem',textDecoration:'none',fontWeight:600}}>Download</a>
                      </div>
                    )}
                    {(modalData._framesData||[]).length > 0 && (
                      <>
                        <div style={{color:'#c0c7d8',fontSize:'0.8rem',marginBottom:'0.5rem'}}>{modalData._framesData.length} frame(s) captured</div>
                        <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                          {modalData._framesData.map((f,i) => (
                            <div key={i} style={{position:'relative'}}>
                              <img src={f.base64 ? `data:image/jpeg;base64,${f.base64}` : `${API_BASE}/api/frames/${f.filename}`} alt={`Frame at ${f.timestamp}`} style={{width:'120px',height:'68px',objectFit:'cover',borderRadius:'6px',border:'1px solid rgba(245,158,11,0.3)',cursor:'pointer'}} onClick={()=>window.open(f.base64 ? `data:image/jpeg;base64,${f.base64}` : `${API_BASE}/api/frames/${f.filename}`,'_blank')} />
                              <span style={{position:'absolute',bottom:'2px',left:'2px',fontSize:'0.6rem',color:'#fff',background:'rgba(0,0,0,0.7)',padding:'1px 4px',borderRadius:'3px'}}>{f.timestamp}</span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                )}
                {/* User Attachments â€” manually uploaded files */}
                <div style={{background:'rgba(59,130,246,0.08)',border:'2px solid rgba(59,130,246,0.25)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                    <h3 style={{color:'#3b82f6',margin:0,fontSize:'1rem'}}>Attachments</h3>
                    {modalData._backendId && (
                      <label style={{padding:'0.3rem 0.8rem',background:'rgba(59,130,246,0.2)',border:'1px solid rgba(59,130,246,0.4)',borderRadius:'6px',color:'#3b82f6',fontSize:'0.75rem',fontWeight:600,cursor:'pointer'}}>
                        + Add File
                        <input type="file" multiple style={{display:'none'}} onChange={async (e)=>{
                          const files = e.target.files;
                          if (!files || files.length === 0) return;
                          const formData = new FormData();
                          for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
                          try {
                            const resp = await fetch(`${API_BASE}/api/attachments/${modalData._backendId}`, {method:'POST',body:formData});
                            if (resp.ok) {
                              const result = await resp.json();
                              const updatedAttachments = result.record.attachments || [];
                              setModalData({...modalData, _attachments: updatedAttachments});
                              setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                            }
                          } catch(err) { console.error('Upload failed:', err); }
                          e.target.value = '';
                        }} />
                      </label>
                    )}
                  </div>
                  {(modalData._attachments||[]).length === 0 ? (
                    <p style={{color:'#6b7394',fontSize:'0.85rem',margin:0}}>No attachments yet. Click "Add File" to upload.</p>
                  ) : (
                    <div style={{display:'flex',flexDirection:'column',gap:'0.5rem'}}>
                      {(modalData._attachments||[]).map((att,i) => (
                        <div key={i} style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.5)',borderRadius:'8px',border:'1px solid rgba(59,130,246,0.2)'}}>
                          <span style={{fontSize:'1.2rem'}}>{att.type==='image'?'ðŸ–¼ï¸':att.type==='video'?'ðŸŽ¬':att.type==='audio'?'ðŸŽµ':att.type==='pdf'?'ðŸ“„':att.type==='document'?'ðŸ“ƒ':'ðŸ“Ž'}</span>
                          {att.type==='image' && <img src={`/api/attachments/${att.filename}`} alt={att.original_name} style={{width:'48px',height:'48px',objectFit:'cover',borderRadius:'4px'}} />}
                          <span style={{color:'#e0e6ed',flex:1,fontSize:'0.85rem'}}>{att.original_name}</span>
                          <span style={{color:'#6b7394',fontSize:'0.7rem'}}>{att.size > 1048576 ? (att.size/1048576).toFixed(1)+'MB' : (att.size/1024).toFixed(0)+'KB'}</span>
                          <a href={`/api/attachments/${att.filename}`} download style={{padding:'0.25rem 0.5rem',background:'rgba(59,130,246,0.2)',border:'1px solid rgba(59,130,246,0.4)',borderRadius:'4px',color:'#3b82f6',fontSize:'0.7rem',textDecoration:'none'}}>Download</a>
                          {(modalData.uploadedBy === (currentUser||{}).username || (currentUser||{}).role === 'admin' || (currentUser||{}).role === 'owner') && (
                            <button onClick={async ()=>{
                              if (!window.confirm('Remove this attachment?')) return;
                              try {
                                const resp = await fetch(`${API_BASE}/api/attachments/${modalData._backendId}/${att.filename}`, {method:'DELETE'});
                                if (resp.ok) {
                                  const result = await resp.json();
                                  const updatedAttachments = result.record.attachments || [];
                                  setModalData({...modalData, _attachments: updatedAttachments});
                                  setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                                }
                              } catch(err) { console.error('Delete failed:', err); }
                            }} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',fontSize:'1rem',padding:'0.1rem 0.3rem'}}>Ã—</button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                {(modalData.topics||[]).length > 0 && <div className="form-group"><label className="form-label">Topics</label><div className="tags">{modalData.topics.map((t,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('topic',t);}}>{t}</span>)}</div></div>}
                {(modalData.people||[]).length > 0 && <div className="form-group"><label className="form-label">People</label><div className="tags">{modalData.people.map((p,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('person',p);}}>{p}</span>)}</div></div>}
                {(modalData.organizations||[]).length > 0 && <div className="form-group"><label className="form-label">Organizations</label><div className="tags">{modalData.organizations.map((o,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('org',o);}}>{o}</span>)}</div></div>}
                {/* Links â€” main link first, then additional */}
                {(modalData.mainLink || (modalData.links||[]).length > 0) && (
                  <div className="form-group"><label className="form-label">Links</label>
                    {modalData.mainLink && (
                      <div style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem',padding:'0.5rem',background:'rgba(96,165,250,0.08)',borderRadius:'8px',border:'1px solid rgba(96,165,250,0.2)'}}>
                        <span style={{color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,whiteSpace:'nowrap'}}>MAIN</span>
                        <a href={modalData.mainLink} target="_blank" rel="noopener noreferrer" style={{color:'#60a5fa',wordBreak:'break-all',flex:1}}>{modalData.mainLink}</a>
                        <button onClick={()=>copyToClipboard(modalData.mainLink)} className="btn btn-secondary" style={{padding:'0.4rem 0.75rem',fontSize:'0.75rem'}}>Copy</button>
                      </div>
                    )}
                    {(modalData.links||[]).filter(l=>l && l !== modalData.mainLink).map((l,i)=>(
                      <div key={i} style={{marginBottom:'0.5rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                        <a href={l} target="_blank" rel="noopener noreferrer" style={{color:'#60a5fa',wordBreak:'break-all',flex:1}}>{l}</a>
                        <button onClick={()=>copyToClipboard(l)} className="btn btn-secondary" style={{padding:'0.4rem 0.75rem',fontSize:'0.75rem'}}>Copy</button>
                      </div>
                    ))}
                  </div>
                )}
                {/* Download original document */}
                {modalData._backendFileName && (
                  <div className="form-group">
                    <a href={`/api/uploads/${modalData._backendFileName}`} download style={{display:'inline-block',padding:'0.5rem 1rem',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'8px',color:'#60a5fa',fontSize:'0.85rem',textDecoration:'none',fontWeight:600}}>Download Original Document</a>
                  </div>
                )}
              </>
            ) : (
              <>
                {/* â”€â”€ Section: Basic Info â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,basic:!s.basic}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.basic?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Basic Info</span>
                  </div>
                  {editSections.basic && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Title</label><input className="edit-input" value={editedEvent.title||''} onChange={e=>setEditedEvent({...editedEvent,title:e.target.value})} /></div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0 1rem'}}>
                      <div className="form-group"><label className="form-label">Date</label><input type="date" className="edit-input" value={editedEvent.date||''} onChange={e=>setEditedEvent({...editedEvent,date:e.target.value})} /></div>
                      <div className="form-group"><label className="form-label">Research Level</label>
                        <select className="edit-input" value={editedEvent.researchLevel||1} onChange={e=>setEditedEvent({...editedEvent,researchLevel:parseInt(e.target.value)})}>
                          <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option>
                        </select>
                      </div>
                    </div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0 1rem'}}>
                      <div className="form-group"><label className="form-label">Source (publisher)</label><input className="edit-input" value={editedEvent.source||''} onChange={e=>setEditedEvent({...editedEvent,source:e.target.value})} placeholder="e.g., Al Jazeera, CDC" /></div>
                      <div className="form-group"><label className="form-label">Primary Source</label><input className="edit-input" value={editedEvent.primarySource||''} onChange={e=>setEditedEvent({...editedEvent,primarySource:e.target.value})} placeholder="Original source of info" /></div>
                    </div>
                  </div>}
                </div>

                {/* â”€â”€ Section: AI Summary & Description â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,ai:!s.ai}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.ai?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>AI Summary & Description</span>
                  </div>
                  {editSections.ai && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group">
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                        <label className="form-label" style={{marginBottom:0}}>AI Summary</label>
                        <button disabled={isCondensing} onClick={async ()=>{
                          if (!editedEvent.aiSummary) return;
                          setIsCondensing(true);
                          try {
                            const resp = await fetch(`${API_BASE}/api/condense`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:editedEvent.aiSummary})});
                            if (resp.ok) { const r = await resp.json(); setEditedEvent({...editedEvent, aiSummary: r.condensed}); }
                          } catch(e) {}
                          setIsCondensing(false);
                        }} style={{padding:'0.3rem 0.7rem',fontSize:'0.75rem',fontWeight:600,color:'#fff',background:isCondensing?'#6b7394':'linear-gradient(135deg,#7c3aed,#6d28d9)',border:'none',borderRadius:'6px',cursor:isCondensing?'wait':'pointer',fontFamily:'inherit'}}>
                          {isCondensing ? 'Condensing...' : 'Condense'}
                        </button>
                      </div>
                      <textarea className="edit-input" rows={3} value={editedEvent.aiSummary||''} onChange={e=>setEditedEvent({...editedEvent,aiSummary:e.target.value})} style={{marginTop:'0.4rem'}} />
                    </div>
                    <div className="form-group"><label className="form-label">Description (bullet points or notes)</label><textarea className="edit-input" rows={3} value={editedEvent.description||''} onChange={e=>setEditedEvent({...editedEvent,description:e.target.value})} placeholder="- Key fact 1&#10;- Key fact 2&#10;Or free-form notes..." /></div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Tags â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,tags:!s.tags}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.tags?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Tags</span>
                  </div>
                  {editSections.tags && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Topics</label><MultiSelectDropdown options={data.topics||[]} selected={editedEvent.topics||[]} onChange={v=>setEditedEvent({...editedEvent,topics:v})} placeholder="Select or add topics..." /></div>
                    <div className="form-group"><label className="form-label">People</label><MultiSelectDropdown options={data.people||[]} selected={editedEvent.people||[]} onChange={v=>setEditedEvent({...editedEvent,people:v})} placeholder="Select or add people..." /></div>
                    <div className="form-group"><label className="form-label">Organizations</label><MultiSelectDropdown options={data.organizations||[]} selected={editedEvent.organizations||[]} onChange={v=>setEditedEvent({...editedEvent,organizations:v})} placeholder="Select or add organizations..." /></div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Links â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,links:!s.links}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.links?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Links</span>
                  </div>
                  {editSections.links && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Main Link</label><input className="edit-input" value={editedEvent.mainLink||''} onChange={e=>setEditedEvent({...editedEvent,mainLink:e.target.value})} placeholder="https://..." /></div>
                    <div className="form-group">
                      <label className="form-label">Additional Links</label>
                      {(editedEvent.links||[]).map((link,i) => (
                        <div key={i} style={{display:'flex',gap:'0.5rem',marginBottom:'0.4rem',alignItems:'center'}}>
                          <input className="edit-input" style={{flex:1,marginBottom:0}} value={link} onChange={e=>{const newLinks=[...(editedEvent.links||[])];newLinks[i]=e.target.value;setEditedEvent({...editedEvent,links:newLinks});}} placeholder={`Link ${i+2}`} />
                          <button onClick={()=>{const newLinks=[...(editedEvent.links||[])];newLinks.splice(i,1);setEditedEvent({...editedEvent,links:newLinks});}} style={{padding:'0.3rem 0.6rem',background:'rgba(248,113,113,0.15)',color:'#f87171',border:'1px solid rgba(248,113,113,0.3)',borderRadius:'6px',cursor:'pointer',fontSize:'0.8rem',fontWeight:700,fontFamily:'inherit'}}>Ã—</button>
                        </div>
                      ))}
                      <button onClick={()=>setEditedEvent({...editedEvent,links:[...(editedEvent.links||[]),'']}) } style={{padding:'0.35rem 0.8rem',fontSize:'0.8rem',fontWeight:600,color:'#60a5fa',background:'rgba(96,165,250,0.1)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',marginTop:'0.25rem'}}>+ Add Link</button>
                    </div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Attachments â”€â”€ */}
                {editedEvent._backendId && (
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,attachments:!s.attachments}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.attachments?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Attachments</span>
                    <span style={{color:'#6b7394',fontSize:'0.75rem',marginLeft:'auto'}}>{(editedEvent._attachments||[]).length} file(s)</span>
                  </div>
                  {editSections.attachments && <div style={{padding:'0.75rem 1rem'}}>
                    {(editedEvent._attachments||[]).map((att,i) => (
                      <div key={i} style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.4rem',padding:'0.4rem 0.5rem',background:'rgba(26,31,58,0.5)',borderRadius:'6px'}}>
                        <span style={{fontSize:'1rem'}}>{att.type==='image'?'ðŸ–¼ï¸':att.type==='video'?'ðŸŽ¬':att.type==='audio'?'ðŸŽµ':'ðŸ“Ž'}</span>
                        <span style={{color:'#e0e6ed',flex:1,fontSize:'0.8rem'}}>{att.original_name}</span>
                        <button onClick={async ()=>{
                          if (!window.confirm('Remove this attachment?')) return;
                          try {
                            const resp = await fetch(`${API_BASE}/api/attachments/${editedEvent._backendId}/${att.filename}`, {method:'DELETE'});
                            if (resp.ok) {
                              const result = await resp.json();
                              const updatedAttachments = result.record.attachments || [];
                              setEditedEvent({...editedEvent, _attachments: updatedAttachments});
                              setModalData({...modalData, _attachments: updatedAttachments});
                              setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                            }
                          } catch(err) { console.error('Delete failed:', err); }
                        }} style={{padding:'0.2rem 0.4rem',background:'rgba(248,113,113,0.15)',color:'#f87171',border:'1px solid rgba(248,113,113,0.3)',borderRadius:'4px',cursor:'pointer',fontSize:'0.75rem',fontWeight:700,fontFamily:'inherit'}}>Ã—</button>
                      </div>
                    ))}
                    <label style={{display:'inline-block',padding:'0.35rem 0.8rem',fontSize:'0.8rem',fontWeight:600,color:'#3b82f6',background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.3)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',marginTop:'0.25rem'}}>
                      + Add File
                      <input type="file" multiple style={{display:'none'}} onChange={async (e)=>{
                        const files = e.target.files;
                        if (!files || files.length === 0) return;
                        const formData = new FormData();
                        for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
                        try {
                          const resp = await fetch(`${API_BASE}/api/attachments/${editedEvent._backendId}`, {method:'POST',body:formData});
                          if (resp.ok) {
                            const result = await resp.json();
                            const updatedAttachments = result.record.attachments || [];
                            setEditedEvent({...editedEvent, _attachments: updatedAttachments});
                            setModalData({...modalData, _attachments: updatedAttachments});
                            setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                          }
                        } catch(err) { console.error('Upload failed:', err); }
                        e.target.value = '';
                      }} />
                    </label>
                  </div>}
                </div>
                )}
              </>
            )}
          </div>
        </div>
      );

      // â”€â”€ Account Page â”€â”€
      // NOTE: accountTab, myFilters, myPageTab all live in App scope to prevent reset on re-render
      const AccountPage = () => {
        const isAdminOrOwner = currentUser.role === 'admin' || currentUser.role === 'owner';
        const myPublicCount = myUploads.filter(e => e.isPublic).length;
        const myPrivateCount = myUploads.length - myPublicCount;
        const initials = currentUser.username.substring(0, 2).toUpperCase();
        const matchedUser = adminUsers.find(u => u.username === currentUser.username);
        const memberSince = matchedUser && matchedUser.created_at
          ? new Date(matchedUser.created_at).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' })
          : 'Member';
        // Scoped data: only user's own topics/people/orgs appear in FiltersComponent checkboxes
        const userTopics = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        const userPeople = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        const userOrgs   = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        const accountScopedData = { ...data, topics: userTopics, people: userPeople, organizations: userOrgs };
        const myFilterProps = { filters: myFilters, setFilters: setMyFilters, data: accountScopedData, activeTab: myPageTab, onSearch: applyMySearch, onClear: clearMyFilters, onExportCSV: myExportCSV, onExportJSON: myExportJSON };
        const statusLabel = s => s==='historical_record'?'Historical Record':s==='contested'?'Contested':'Unverified';
        return (
          <div>
            {/* Profile card */}
            <div className="account-profile-card">
              <div className="account-avatar">{initials}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem',flexWrap:'wrap'}}>
                  <h2 style={{fontSize:'1.75rem',fontFamily:"'Space Mono',monospace",color:'#e0e6ed',margin:0}}>{currentUser.username}</h2>
                  <span className={`role-badge role-${currentUser.role}`} style={{fontSize:'0.8rem',padding:'0.3rem 0.75rem'}}>{currentUser.role}</span>
                </div>
                <div style={{color:'#8b92b0',fontSize:'0.875rem',marginBottom:'1.25rem'}}>Member since: {memberSince}</div>
                <div style={{display:'flex',gap:'2rem',flexWrap:'wrap'}}>
                  {[
                    {label:'Total Uploads', value:myUploads.length, color:'#60a5fa'},
                    {label:'Public',        value:myPublicCount,     color:'#10b981'},
                    {label:'Private',       value:myPrivateCount,    color:'#9ca3af'},
                  ].map(s=>(
                    <div key={s.label} style={{textAlign:'center'}}>
                      <div style={{fontSize:'1.5rem',fontWeight:700,color:s.color,fontFamily:"'Space Mono',monospace"}}>{s.value}</div>
                      <div style={{fontSize:'0.7rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'0.5px'}}>{s.label}</div>
                    </div>
                  ))}
                </div>
              </div>
              <button className="logout-btn" style={{alignSelf:'flex-start',padding:'0.5rem 1.25rem',fontSize:'0.875rem'}} onClick={logout}>Logout</button>
            </div>
            {/* Sub-tabs */}
            <div className="account-tabs">
              <button className={`account-tab ${accountTab==='uploads'?'active':''}`} onClick={()=>setAccountTab('uploads')}>ðŸ“‚ My Uploads</button>
              {isAdminOrOwner && (
                <button className={`account-tab ${accountTab==='admin'?'active-admin':''}`} onClick={()=>setAccountTab('admin')}>
                  ðŸ›¡ï¸ {currentUser.role==='owner'?'Owner Panel':'Admin Panel'}
                </button>
              )}
            </div>
            {/* My Uploads â€” Pages nav + FiltersComponent + page content, scoped to user's own uploads */}
            {accountTab === 'uploads' && (
              <div>
                {/* Pages section */}
                <div style={{marginBottom:'0'}}>
                  <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem'}}>Pages</div>
                  <nav className="nav">
                    {['timeline','network','spreadsheet','topics','people','organizations'].map(tab => (
                      <button key={tab} className={`nav-btn ${myPageTab===tab?'active':''}`}
                        onClick={() => setMyPageTab(tab)}>
                        {tab==='timeline'?'ðŸ“…':tab==='network'?'ðŸ”—':tab==='spreadsheet'?'ðŸ“Š':tab==='topics'?'ðŸ·ï¸':tab==='people'?'ðŸ‘¤':'ðŸ›ï¸'}{' '}{tab.charAt(0).toUpperCase()+tab.slice(1)}
                      </button>
                    ))}
                    <button className="nav-btn" onClick={() => setActiveTab('upload')}>
                      ðŸ“¤ Upload
                    </button>
                  </nav>
                </div>

                {/* Full FiltersComponent scoped to user's uploads */}
                <FiltersComponent {...myFilterProps} />

                {/* Timeline */}
                {myPageTab === 'timeline' && (
                  <div className="timeline-wrapper">
                    <div className="timeline-container">
                      <div className="timeline-line"></div>
                      <div className="timeline-events">
                        {myTimelineEvents.length === 0 ? (
                          <div className="empty-state"><div className="empty-state-icon">ðŸ“…</div><p>{myUploads.length===0?'No uploads yet â€” go to Upload to add events.':'No dated events match your filters.'}</p></div>
                        ) : myTimelineEvents.map((e,index) => {
                          const dateStr = String(e.date||'');
                          const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                          const prevYear = index>0 ? String(myTimelineEvents[index-1].date||'').substring(0,4) : null;
                          const showYear = index===0 || year!==prevYear;
                          return (
                            <div key={e.id} className={`timeline-event ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'account')}>
                              {showYear && <div className="timeline-year">{year}</div>}
                              <div className="timeline-icon">{e.isMajorEvent?'â­':'ðŸ“Œ'}</div>
                              <div className="timeline-label">{(e.title||'').substring(0,28)}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {/* Network */}
                {myPageTab === 'network' && (
                  <div className="network">
                    <div id="my-network-graph" style={{width:'100%',height:'100%',borderRadius:'16px'}}></div>
                  </div>
                )}

                {/* Spreadsheet */}
                {myPageTab === 'spreadsheet' && (
                  <div className="spreadsheet">
                    {selectedMyEvents.size > 0 && (
                      <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem',alignItems:'center'}}>
                        <span style={{color:'#a78bfa',fontSize:'0.85rem',fontWeight:600}}>{selectedMyEvents.size} selected</span>
                        <button onClick={()=>setShowDownloadPopup('myuploads')} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#fff',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>Download Selected</button>
                        <button onClick={()=>setSelectedMyEvents(new Set())} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#8b92b0',background:'rgba(61,69,99,0.3)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit'}}>Clear</button>
                      </div>
                    )}
                    <table className="table">
                      <thead><tr>
                        <th style={{width:'40px',textAlign:'center'}}>
                          <button onClick={()=>{if(selectedMyEvents.size===mySortedEvents.length)setSelectedMyEvents(new Set());else setSelectedMyEvents(new Set(mySortedEvents.map(e=>e.id)));}} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit'}}>{selectedMyEvents.size===mySortedEvents.length&&mySortedEvents.length>0?'âœ“ All':'All'}</button>
                        </th>
                        <th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Status</th><th>Visibility</th>
                      </tr></thead>
                      <tbody>
                        {mySortedEvents.length === 0 ? (
                          <tr><td colSpan="10" style={{textAlign:'center',padding:'2rem',color:'#8b92b0'}}>No events match your filters.</td></tr>
                        ) : mySortedEvents.map(e=>(
                          <tr key={e.id} onClick={()=>openEventModal(e,'account')} style={{cursor:'pointer'}}>
                            <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                              <input type="checkbox" checked={selectedMyEvents.has(e.id)} onChange={()=>setSelectedMyEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                            </td>
                            <td>{e.id}</td>
                            <td style={{fontWeight:600}}>{e.title}</td>
                            <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                            <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                            <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                            <td>{e.date||'â€”'}</td>
                            <td><span className={`status-${e.eventStatus||'unverified'}`}>{statusLabel(e.eventStatus)}</span></td>
                            <td>
                              <button onClick={ev=>{ev.stopPropagation();toggleEventPublic(e.id);}} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                                <span className={e.isPublic?'vis-public':'vis-private'}>{e.isPublic?'ðŸŒ Public':'ðŸ”’ Private'}</span>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}

                {/* Topics */}
                {myPageTab === 'topics' && (
                  <div className="grid">
                    {myFilteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ·ï¸</div><p>No topics in your uploads yet.</p></div> :
                    myFilteredTopics.map(t=>{
                      const relEvents = myFiltered.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                      return (
                        <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                          <div className="card-title">{t.name}</div>
                          <div className="card-count">{t.count} event{t.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* People */}
                {myPageTab === 'people' && (
                  <div className="grid">
                    {myFilteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ‘¤</div><p>No people in your uploads yet.</p></div> :
                    myFilteredPeople.map(p=>{
                      const relEvents = myFiltered.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                      return (
                        <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                          <div className="card-title">{p.name}</div>
                          <div className="card-count">{p.count} event{p.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Organizations */}
                {myPageTab === 'organizations' && (
                  <div className="grid">
                    {myFilteredOrgs.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ›ï¸</div><p>No organizations in your uploads yet.</p></div> :
                    myFilteredOrgs.map(o=>{
                      const relEvents = myFiltered.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                      return (
                        <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                          <div className="card-title">{o.name}</div>
                          <div className="card-count">{o.count} event{o.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            )}
            {/* Admin / Owner Panel */}
            {accountTab === 'admin' && isAdminOrOwner && <AdminPanel />}
          </div>
        );
      };

      // â”€â”€ Auth gate â”€â”€
      if (!currentUser) {
        if (authScreen === 'signup') return <SignupScreen onGoLogin={() => setAuthScreen('login')} />;
        return <LoginScreen onLogin={login} onGoSignup={() => setAuthScreen('signup')} />;
      }

      // â”€â”€ Admin Panel â”€â”€
      const AdminPanel = () => {
        const [users, setUsers] = React.useState([]);
        const isOwner = currentUser.role === 'owner';
        React.useEffect(() => { getAllUsers().then(u => setUsers(u)); }, []);
        const handleRoleChange = async (username, newRole) => {
          await updateUserRole(username, newRole);
          const updated = await getAllUsers();
          setUsers(updated);
        };
        const handleDelete = async (username) => {
          await deleteUserAccount(username);
          const updated = await getAllUsers();
          setUsers(updated);
        };
        const allUsers = users;
        const publicCount = data.events.filter(e => e.isPublic).length;
        const privateCount = data.events.filter(e => !e.isPublic).length;
        return (
          <div>
            <div style={{display:'flex',gap:'1.5rem',marginBottom:'2rem',flexWrap:'wrap'}}>
              {[
                { label:'Total Users', value: allUsers.length, color:'#60a5fa' },
                { label:'Public Events', value: publicCount, color:'#10b981' },
                { label:'Private Events', value: privateCount, color:'#9ca3af' },
                { label:'Total Events', value: data.events.length, color:'#a78bfa' }
              ].map(s=>(
                <div key={s.label} className="stat" style={{background:'rgba(26,31,58,0.6)',padding:'1.25rem 1.75rem',borderRadius:'12px',border:'2px solid rgba(61,69,99,0.5)'}}>
                  <span className="stat-label">{s.label}</span>
                  <span className="stat-value" style={{color:s.color,fontSize:'1.5rem'}}>{s.value}</span>
                </div>
              ))}
            </div>
            <div className="admin-section">
              <div className="admin-section-title">ðŸ‘¥ User Management</div>
              <table className="admin-table">
                <thead><tr><th>Username</th><th>Role</th><th>Type</th><th>Joined</th><th>Actions</th></tr></thead>
                <tbody>
                  {allUsers.map(u => {
                    const isSelf = u.username === currentUser.username;
                    const canChange = !isSelf && (isOwner ? u.role !== 'owner' : u.role === 'user');
                    return (
                      <tr key={u.username}>
                        <td style={{fontWeight:600}}>{u.username}{isSelf ? <span style={{color:'#8b92b0',fontWeight:400,marginLeft:'0.5rem'}}>(you)</span> : ''}</td>
                        <td><span className={`role-badge role-${u.role}`}>{u.role}</span></td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>Registered</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{u.created_at ? new Date(u.created_at).toLocaleDateString() : 'â€”'}</td>
                        <td>
                          {canChange && (
                            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                              {u.role === 'user' && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'admin')}>â†‘ Make Admin</button>}
                              {u.role === 'admin' && isOwner && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'user')}>â†“ Demote</button>}
                              <button className="btn btn-danger" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm(`Delete account "${u.username}"?`))handleDelete(u.username);}}>ðŸ—‘ Delete</button>
                            </div>
                          )}
                          {!canChange && <span style={{color:'#3d4563',fontSize:'0.8rem'}}>â€”</span>}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="admin-section">
              <div className="admin-section-title">ðŸ“‹ All Events</div>
              <table className="admin-table">
                <thead><tr><th>ID</th><th>Title</th><th>Uploaded By</th><th>Status</th><th>Visibility</th><th>Actions</th></tr></thead>
                <tbody>
                  {data.events.slice().reverse().map(e => (
                    <tr key={e.id}>
                      <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.id}</td>
                      <td style={{fontWeight:600,cursor:'pointer',color:'#60a5fa'}} onClick={()=>openEventModal(e,'admin panel')}>{(e.title||'').substring(0,50)}{e.title&&e.title.length>50?'â€¦':''}</td>
                      <td style={{color:'#8b92b0'}}>{e.uploadedBy||'system'}</td>
                      <td>
                        <select className="status-select" value={e.eventStatus||'unverified'} onChange={ev=>updateEventStatus(e.id, ev.target.value)}>
                          <option value="historical_record">Historical Record</option>
                          <option value="contested">Contested</option>
                          <option value="unverified">Unverified</option>
                        </select>
                      </td>
                      <td><span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'ðŸŒ Public' : 'ðŸ”’ Private'}</span></td>
                      <td>
                        <div style={{display:'flex',gap:'0.4rem'}}>
                          <button className="btn btn-secondary" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>toggleEventPublic(e.id)}>{e.isPublic ? 'Make Private' : 'Make Public'}</button>
                          <button className="btn btn-danger" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm('Delete this event?'))deleteEvent(e.id);}}>ðŸ—‘</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // â”€â”€ Account page â€” own layout (no nav bar) â”€â”€
      if (activeTab === 'account') {
        return (
          <div className="app">
            <header className="header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
                <div className="user-chip">
                  <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                    <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                    <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                    <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                  </div>
                  <button className="logout-btn" onClick={logout}>Logout</button>
                </div>
              </div>
            </header>
            <div className="breadcrumb-bar">
              <span className="bc-item" onClick={()=>navigateToTab('timeline')}>ðŸ  Home</span>
              <span className="bc-sep">â€º</span>
              <span className="bc-current">ðŸ‘¤ {currentUser.username}</span>
            </div>
            <main className="content">
              <AccountPage />
            </main>
            {showModal && modalData && modalViewJSX}
          </div>
        );
      }

      // â”€â”€ Entity Detail page â”€â”€
      if (selectedEntity) {
        return (
          <div className="app">
            <header className="header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                <h1 style={{cursor:'pointer'}} onClick={()=>{ setSelectedEntity(null); navigateToTab('timeline'); }}>Historical Events Database</h1>
                <div className="user-chip">
                  <div className="user-chip-btn" onClick={()=>{ setSelectedEntity(null); navigateToTab('account'); }}>
                    <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                    <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                    <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                  </div>
                  <button className="logout-btn" onClick={logout}>Logout</button>
                </div>
              </div>
              <div className="stats">
                <div className="stat"><span className="stat-label">Total Events</span><span className="stat-value">{data.events.length}</span></div>
                <div className="stat"><span className="stat-label">People</span><span className="stat-value">{data.people.length}</span></div>
                <div className="stat"><span className="stat-label">Organizations</span><span className="stat-value">{data.organizations.length}</span></div>
                <div className="stat"><span className="stat-label">Topics</span><span className="stat-value">{data.topics.length}</span></div>
              </div>
            </header>
            <div className="breadcrumb-bar">
              <span className="bc-item" onClick={()=>{ setSelectedEntity(null); setBreadcrumbs([]); setActiveTab('timeline'); }}>ðŸ  Home</span>
              {breadcrumbs.map((b,i) => (
                <React.Fragment key={i}>
                  <span className="bc-sep">â€º</span>
                  <span className="bc-item" onClick={()=>goToBreadcrumb(i)}>{b.label}</span>
                </React.Fragment>
              ))}
              <span className="bc-sep">â€º</span>
              <span className="bc-current">{selectedEntity.name}</span>
            </div>
            <main className="content">
              <button className="back-btn" onClick={goBack}>â† Back</button>
              <div style={{marginBottom:'2rem'}}>
                <h2 style={{fontSize:'2rem',color:'#60a5fa',marginBottom:'0.5rem',fontFamily:"'Space Mono',monospace"}}>{selectedEntity.name}</h2>
                <p style={{color:'#8b92b0'}}>{selectedEntity.events.length} related event{selectedEntity.events.length!==1?'s':''}</p>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:'1.5rem'}}>
                {selectedEntity.events.map(e=>(
                  <div key={e.id} style={{background:'rgba(26,31,58,0.6)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'12px',padding:'1.5rem',cursor:'pointer',transition:'all 0.2s'}}
                    onClick={()=>openEventModal(e,'entity')}
                    onMouseEnter={ev=>ev.currentTarget.style.borderColor='#60a5fa'}
                    onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                    <div style={{color:'#60a5fa',fontSize:'0.85rem',marginBottom:'0.5rem'}}>{e.date||'Date Unknown'}</div>
                    <div style={{fontSize:'1.2rem',fontWeight:700,marginBottom:'0.75rem'}}>{e.title}</div>
                    <div style={{color:'#8b92b0',marginBottom:'1rem',lineHeight:1.5}}>{(e.description||'').substring(0,200)}{(e.description||'').length>200?'...':''}</div>
                    <div className="tags">{(e.topics||[]).slice(0,5).map((t,i)=><span key={i} className="tag">{t}</span>)}</div>
                  </div>
                ))}
              </div>
            </main>
            {showModal && modalData && modalViewJSX}
          </div>
        );
      }

      // â”€â”€ Main layout â”€â”€
      return (
        <div className="app">
          <header className="header">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
              <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
              <div className="user-chip">
                <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                  <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                  <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                  <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                </div>
                <button className="logout-btn" onClick={logout}>Logout</button>
              </div>
            </div>
            <div className="stats">
              <div className="stat"><span className="stat-label">Total Events</span><span className="stat-value">{data.events.length}</span></div>
              <div className="stat"><span className="stat-label">Visible</span><span className="stat-value">{filteredEvents.length}</span></div>
              <div className="stat"><span className="stat-label">People</span><span className="stat-value">{data.people.length}</span></div>
              <div className="stat"><span className="stat-label">Organizations</span><span className="stat-value">{data.organizations.length}</span></div>
              <div className="stat"><span className="stat-label">Topics</span><span className="stat-value">{data.topics.length}</span></div>
            </div>
          </header>

          {/* Breadcrumb bar */}
          <div className="breadcrumb-bar">
            <span className="bc-item" onClick={()=>navigateToTab('timeline')}>ðŸ  Home</span>
            <span className="bc-sep">â€º</span>
            <span className="bc-current">{activeTab==='account'?`ðŸ‘¤ ${currentUser.username}`:activeTab.charAt(0).toUpperCase()+activeTab.slice(1)}</span>
          </div>

          <div className="controls-bar">
            <button className="save-btn" onClick={refreshFromServer}>ðŸ”„ Refresh</button>
            <span className="save-status">{saveStatus}</span>
          </div>

          <div style={{marginBottom:'0'}}>
            <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem',paddingTop:'1rem',background:'rgba(21,25,50,0.4)'}}>Pages</div>
            <nav className="nav" style={{paddingTop:'0.75rem'}}>
              {TABS.map(tab=>(
                <button key={tab} className={`nav-btn ${activeTab===tab?'active':''}`} onClick={()=>navigateToTab(tab)}>
                  {tab.charAt(0).toUpperCase()+tab.slice(1)}
                </button>
              ))}
            </nav>
          </div>

          <main className="content">
            {uploadMessage && <div className={uploadMessage.includes('âŒ')||uploadMessage.includes('âš ï¸')?'error-msg':'success-msg'} style={{position:'relative',paddingRight:'2.5rem'}}>{uploadMessage}<button onClick={()=>setUploadMessage('')} style={{position:'absolute',top:'50%',right:'0.75rem',transform:'translateY(-50%)',background:'none',border:'none',color:'inherit',fontSize:'1.2rem',cursor:'pointer',opacity:0.7,padding:'0.25rem'}}>Ã—</button></div>}

            {/* Show filters on all tabs except upload and account */}
            {activeTab !== 'upload' && activeTab !== 'account' && <FiltersComponent {...filterProps} />}

            {/* TIMELINE */}
            {activeTab === 'timeline' && (
              <div className={`timeline-wrapper ${isTimelineFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsTimelineFullscreen(!isTimelineFullscreen)}>
                  {isTimelineFullscreen?'âœ• Exit':'â›¶ Fullscreen'}
                </button>
                <div className="timeline-container">
                  <div className="timeline-line"></div>
                  <div className="timeline-events">
                    {timelineEvents.length===0 ? (
                      <div className="empty-state"><div className="empty-state-icon">ðŸ“…</div><p>No dated events to display. Try clearing filters.</p></div>
                    ) : timelineEvents.map((e,index)=>{
                      const dateStr = String(e.date||'');
                      const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                      const prevYear = index>0 ? String(timelineEvents[index-1].date||'').substring(0,4) : null;
                      const showYear = index===0 || year!==prevYear;
                      return (
                        <div key={e.id} className={`timeline-event ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'timeline')}>
                          {showYear && <div className="timeline-year">{year}</div>}
                          <div className="timeline-icon">{e.isMajorEvent?'â­':'ðŸ“Œ'}</div>
                          <div className="timeline-label">{(e.title||'').substring(0,28)}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* NETWORK */}
            {activeTab === 'network' && (
              <div className={`network ${isNetworkFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsNetworkFullscreen(!isNetworkFullscreen)}>
                  {isNetworkFullscreen?'âœ• Exit':'â›¶ Fullscreen'}
                </button>
                <div id="network-graph"></div>
              </div>
            )}

            {/* SPREADSHEET */}
            {activeTab === 'spreadsheet' && (
              <div className="spreadsheet">
                {selectedEvents.size > 0 && (
                  <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem',alignItems:'center'}}>
                    <span style={{color:'#a78bfa',fontSize:'0.85rem',fontWeight:600}}>{selectedEvents.size} selected</span>
                    <button onClick={()=>setShowDownloadPopup('spreadsheet')} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#fff',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>Download Selected</button>
                    <button onClick={()=>setSelectedEvents(new Set())} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#8b92b0',background:'rgba(61,69,99,0.3)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit'}}>Clear</button>
                  </div>
                )}
                <table className="table">
                  <thead><tr>
                    <th style={{width:'40px',textAlign:'center'}}>
                      <button onClick={()=>{if(selectedEvents.size===sortedEvents.length)setSelectedEvents(new Set());else setSelectedEvents(new Set(sortedEvents.map(e=>e.id)));}} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit'}}>{selectedEvents.size===sortedEvents.length&&sortedEvents.length>0?'âœ“ All':'All'}</button>
                    </th>
                    <th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Source</th><th>Link</th>
                  </tr></thead>
                  <tbody>
                    {sortedEvents.map(e=>(
                      <tr key={e.id} onClick={()=>openEventModal(e,'spreadsheet')} style={{cursor:'pointer'}}>
                        <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                          <input type="checkbox" checked={selectedEvents.has(e.id)} onChange={()=>setSelectedEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                        </td>
                        <td>{e.id}</td>
                        <td style={{fontWeight:600}}>{e.title}</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                        <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                        <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                        <td>{e.date||'â€”'}</td>
                        <td>{e.sourceType}</td>
                        <td>
                          {(e.mainLink||e.links&&e.links[0])&&(
                            <><a href={e.mainLink||e.links[0]} target="_blank" rel="noopener noreferrer" onClick={ev=>ev.stopPropagation()}>{(e.mainLink||e.links[0]).substring(0,28)}...</a>
                            <span className="copy-link" onClick={ev=>{ev.stopPropagation();copyToClipboard(e.mainLink||e.links[0]);}}>ðŸ“‹</span></>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {/* TOPICS */}
            {activeTab === 'topics' && (
              <div className="grid">
                {filteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ·ï¸</div><p>No topics match the current filters.</p></div> :
                filteredTopics.map(t=>{
                  const relEvents = filteredEvents.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                  return (
                    <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                      <div className="card-title">{t.name}</div>
                      <div className="card-count">{t.count} event{t.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* PEOPLE */}
            {activeTab === 'people' && (
              <div className="grid">
                {filteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ‘¤</div><p>No people match the current filters.</p></div> :
                filteredPeople.map(p=>{
                  const relEvents = filteredEvents.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                  return (
                    <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                      <div className="card-title">{p.name}</div>
                      <div className="card-count">{p.count} event{p.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* ORGANIZATIONS */}
            {activeTab === 'organizations' && (
              <div className="grid">
                {filteredOrganizations.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ›ï¸</div><p>No organizations match the current filters.</p></div> :
                filteredOrganizations.map(o=>{
                  const relEvents = filteredEvents.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                  return (
                    <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                      <div className="card-title">{o.name}</div>
                      <div className="card-count">{o.count} event{o.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* UPLOAD */}
            {activeTab === 'upload' && (
              <div>
                <div className="upload-tabs">
                  <div className={`upload-tab ${uploadTab==='new'?'active':''}`} onClick={()=>setUploadTab('new')}>ðŸ“¤ New Upload</div>
                  <div className={`upload-tab ${uploadTab==='myuploads'?'active':''}`} onClick={()=>setUploadTab('myuploads')}>ðŸ“‚ My Uploads ({myUploads.length})</div>
                </div>

                {uploadTab === 'new' ? (
                  <>
                    <div className="url-input-section">
                      <div className="url-input-header">ðŸ”— Add Website or Video Link</div>
                      <p style={{color:'#8b92b0',marginBottom:'1.5rem'}}>Paste any URL â€” YouTube videos are auto-detected for transcription</p>
                      <div style={{display:'flex',gap:'1rem',alignItems:'flex-end'}}>
                        <div className="url-input-group" style={{flex:1}}>
                          <label className="filter-label">URL</label>
                          <input type="url" placeholder="https://..." value={urlInput} onChange={e=>setUrlInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleUrlSubmit();}} />
                        </div>
                        <button className="btn btn-primary" style={{flexShrink:0}} onClick={handleUrlSubmit}>Add URL</button>
                      </div>
                      <div style={{display:'flex',gap:'0.75rem',alignItems:'center',marginTop:'0.75rem',flexWrap:'wrap'}}>
                        <div style={{display:'flex',flexDirection:'column',gap:'0.3rem'}}>
                          <label className="filter-label" style={{fontSize:'0.75rem'}}>Start time</label>
                          <input type="text" placeholder="0:00 or 1:30:00" value={timestampStart} onChange={e=>setTimestampStart(e.target.value)}
                            style={{padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.9rem',width:'120px'}} />
                        </div>
                        <div style={{display:'flex',flexDirection:'column',gap:'0.3rem'}}>
                          <label className="filter-label" style={{fontSize:'0.75rem'}}>End time</label>
                          <input type="text" placeholder="5:30 or 2:10:00" value={timestampEnd} onChange={e=>setTimestampEnd(e.target.value)}
                            style={{padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.9rem',width:'120px'}} />
                        </div>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginTop:'1.2rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help',flexShrink:0}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'260px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.78rem',lineHeight:1.6,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <b style={{color:'#60a5fa'}}>Timestamp range (optional)</b><br/>
                            Leave both blank to analyze the full video or audio.<br/><br/>
                            Accepts <b>MM:SS</b> (e.g. <code style={{color:'#a78bfa'}}>4:30</code>) or <b>HH:MM:SS</b> (e.g. <code style={{color:'#a78bfa'}}>1:04:30</code>).<br/><br/>
                            Only the transcript and frames within the specified range will be sent to AI for analysis.
                          </div>
                        </div>
                      </div>
                    </div>
                    <input ref={fileInputRef} type="file" style={{display:'none'}} multiple accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" onChange={handleFileUpload} />
                    <div className="upload" onClick={()=>fileInputRef.current.click()}>
                      <div className="upload-icon">ðŸš€</div>
                      <h2 style={{fontSize:'1.75rem',marginBottom:'1rem'}}>Upload Documents</h2>
                      <p style={{fontSize:'1.125rem',marginBottom:'0.5rem',color:'#a78bfa'}}>AI-powered analysis & auto-tagging</p>
                      <p style={{fontSize:'0.875rem',color:'#8b92b0'}}>Excel Â· CSV Â· TXT Â· PDF Â· Word (.docx)</p>
                    </div>
                    {/* â”€â”€ AI Analysis Controls â”€â”€ */}
                    <div style={{display:'flex',gap:'0.75rem',margin:'1rem 0',flexWrap:'wrap',alignItems:'center'}}>
                      <button onClick={()=>setAutoAnalysis(!autoAnalysis)} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:autoAnalysis?'linear-gradient(135deg,#10b981,#059669)':'rgba(61,69,99,0.5)',border:autoAnalysis?'2px solid #10b981':'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit',transition:'all 0.2s'}}>
                        {autoAnalysis ? 'âœ“ Auto AI Analysis: ON' : 'âš¡ Auto AI Analysis: OFF'}
                      </button>
                      <div style={{position:'relative',display:'inline-flex',alignItems:'flex-start',gap:'0.25rem'}}>
                        <textarea
                          placeholder="ðŸ” Analysis focus (optional)"
                          value={analysisSearch}
                          onChange={e=>setAnalysisSearch(e.target.value)}
                          rows={1}
                          style={{padding:'0.72rem 0.9rem',fontSize:'0.88rem',color:'#e0e6ed',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',fontFamily:'inherit',width:'220px',outline:'none',resize:'vertical',minHeight:'42px',lineHeight:1.5}}
                        ></textarea>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginTop:'0.6rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help',flexShrink:0}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'270px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.78rem',lineHeight:1.6,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <b style={{color:'#60a5fa'}}>Analysis focus (optional)</b><br/>
                            Tell the AI what to specifically look for. The analysis will prioritize finding and highlighting anything related to your search.<br/><br/>
                            e.g. <i style={{color:'#a78bfa'}}>"CIA involvement"</i>, <i style={{color:'#a78bfa'}}>"timeline of events"</i>, <i style={{color:'#a78bfa'}}>"financial connections"</i><br/><br/>
                            Applies to both URL and document uploads.
                          </div>
                        </div>
                      </div>
                      <div style={{position:'relative',display:'inline-block'}}>
                        <select value={analysisMode} onChange={e=>{setAnalysisMode(e.target.value);sessionStorage.setItem('hdb_analysisMode',e.target.value);}} style={{padding:'0.75rem 1rem',paddingRight:'2.5rem',fontSize:'0.9rem',fontWeight:600,color:'#e0e6ed',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit'}}>
                          <option value="fast">Fast</option>
                          <option value="quick">Quick</option>
                          <option value="short">Short</option>
                          <option value="long">Long (Detailed)</option>
                        </select>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginLeft:'0.25rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help'}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:'50%',transform:'translateX(-50%)',marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'280px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.75rem',lineHeight:1.5,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#10b981'}}>Fast</b> (~5-10s) â€” Haiku model, transcript only. Best for podcasts & quick tagging.</div>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#60a5fa'}}>Quick</b> (~15-25s) â€” Sonnet model, transcript only. Better quality, no frames.</div>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#a78bfa'}}>Short</b> (~30-45s) â€” Sonnet + frames. Concise summary with visual analysis.</div>
                            <div><b style={{color:'#f59e0b'}}>Long</b> (~45-90s) â€” Sonnet + frames. Detailed analysis with full visual evidence.</div>
                          </div>
                        </div>
                      </div>
                      <label style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.75rem 1rem',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontSize:'0.85rem',fontWeight:600,color: skipFrames ? '#6b7394' : '#e0e6ed',userSelect:'none'}}>
                        <input type="checkbox" checked={!skipFrames} onChange={e=>{setSkipFrames(!e.target.checked);sessionStorage.setItem('hdb_skipFrames',String(!e.target.checked));}} style={{accentColor:'#7c3aed'}} />
                        Frames
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',position:'relative'}}>
                          <span style={{width:'16px',height:'16px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.65rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help'}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',right:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'240px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.75rem',lineHeight:1.5,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            Extract screenshots from the video every 30 seconds and include them in the AI analysis. Adds ~15-20s but captures on-screen evidence. Disable for podcasts/audio.
                          </div>
                        </div>
                      </label>
                      <button disabled={isProcessing} onClick={async ()=>{
                        const selected = [...selectedForAnalysis].map(evtId => {
                          const evt = recentUploads.find(e => e.id === evtId);
                          return evt ? { evtId, backendId: evt._backendId } : null;
                        }).filter(x => x && x.backendId);
                        if (selected.length === 0) { alert('Select documents with backend records first (PDF, Word, or Image uploads).'); return; }
                        const alreadyAnalyzed = selected.filter(({evtId}) => recentUploads.find(e=>e.id===evtId)?._aiAnalyzed);
                        if (alreadyAnalyzed.length > 0 && !window.confirm(`${alreadyAnalyzed.length} of ${selected.length} document(s) have already been analyzed. Re-analyze them?`)) return;
                        setIsProcessing(true);
                        setUploadMessage(`Analyzing ${selected.length} document(s) with AI...`);
                        let successCount = 0;
                        let lastAnalyzedEvent = null;
                        for (const { evtId, backendId } of selected) {
                          try {
                            setUploadMessage(`Analyzing document ${successCount + 1} of ${selected.length}...`);
                            const resp = await fetch(`${API_BASE}/api/analyze/${backendId}?mode=${analysisMode}${analysisSearch.trim()?'&search_focus='+encodeURIComponent(analysisSearch.trim()):''}`, { method: 'POST' });
                            if (resp.ok) {
                              const result = await resp.json();
                              const rec = result.record;
                              if (rec) {
                                const updatedEvent = {
                                  ...(data.events.find(e => e.id === evtId) || {}),
                                  aiSummary: rec.summary || '',
                                  description: rec.description || rec.summary || '',
                                  topics: rec.topics && rec.topics.length > 0 ? rec.topics : [],
                                  people: rec.people && rec.people.length > 0 ? rec.people : [],
                                  organizations: rec.organizations && rec.organizations.length > 0 ? rec.organizations : [],
                                  source: rec.source || '',
                                  primarySource: rec.primary_source || '',
                                  mainLink: rec.main_link || '',
                                  _aiAnalyzed: true,
                                  _analysisMode: rec.analysis_mode || '',
                                  _hasFrames: rec.has_frames || false,
                                  _attachments: rec.attachments || [],
                                  _transcriptFile: rec.transcript_file || '',
                                };
                                setData(prev => ({
                                  ...prev,
                                  events: prev.events.map(e => e.id === evtId ? {...e, ...updatedEvent} : e),
                                  people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
                                  organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
                                  topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
                                }));
                                lastAnalyzedEvent = updatedEvent;
                                successCount++;
                              }
                            }
                          } catch(err) {}
                        }
                        setIsProcessing(false);
                        setSelectedForAnalysis(new Set());
                        setUploadMessage(`âœ“ AI Analysis complete: ${successCount} of ${selected.length} document(s) analyzed.`);
                        setTimeout(()=>setUploadMessage(''),5000);
                        if (lastAnalyzedEvent) {
                          openEventModal(lastAnalyzedEvent, 'upload');
                        }
                      }} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:isProcessing?'#6b7394':'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'10px',cursor:isProcessing?'wait':'pointer',fontFamily:'inherit'}}>
                        {isProcessing ? 'â³ Analyzing...' : `ðŸ§  Analyze Selected (${selectedForAnalysis.size})`}
                      </button>
                      {selectedForAnalysis.size > 0 && <button onClick={()=>setShowDownloadPopup('recent')} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:'rgba(61,69,99,0.5)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit'}}>Download Selected ({selectedForAnalysis.size})</button>}
                    </div>

                    {/* â”€â”€ Recent Uploads Section â”€â”€ */}
                    <div style={{background:'rgba(26,31,58,0.6)',padding:'1.5rem',borderRadius:'16px',border:'2px solid rgba(61,69,99,0.5)',marginTop:'0.5rem'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',flexWrap:'wrap',gap:'0.75rem'}}>
                        <h3 style={{color:'#60a5fa',fontSize:'1.25rem',margin:0}}>ðŸ“‹ Recent Uploads</h3>
                        <div style={{display:'flex',gap:'0.75rem',alignItems:'center'}}>
                          <label style={{color:'#8b92b0',fontSize:'0.85rem'}}>Last</label>
                          <select value={recentHoursFilter} onChange={e=>setRecentHoursFilter(Number(e.target.value))} style={{background:'rgba(16,20,40,0.8)',color:'#e0e6ed',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',padding:'0.4rem 0.6rem',fontSize:'0.85rem',fontFamily:'inherit'}}>
                            <option value={1}>1 hour</option>
                            <option value={3}>3 hours</option>
                            <option value={12}>12 hours</option>
                            <option value={24}>24 hours</option>
                          </select>
                        </div>
                      </div>
                      {recentUploads.length === 0 ? (
                        <div style={{textAlign:'center',padding:'2rem',color:'#8b92b0'}}>No uploads in the last {recentHoursFilter} hour{recentHoursFilter!==1?'s':''}.</div>
                      ) : (
                        <div className="spreadsheet" style={{maxHeight:'400px',overflowY:'auto'}}>
                          <table className="table">
                            <thead><tr>
                              <th style={{width:'40px',textAlign:'center'}}>
                                <button onClick={()=>{
                                  if (selectedForAnalysis.size === recentUploads.length) setSelectedForAnalysis(new Set());
                                  else setSelectedForAnalysis(new Set(recentUploads.map(e=>e.id)));
                                }} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit',whiteSpace:'nowrap'}}>
                                  {selectedForAnalysis.size === recentUploads.length && recentUploads.length > 0 ? 'âœ“ All' : 'All'}
                                </button>
                              </th>
                              <th>ID</th>
                              <th>Title</th>
                              <th>AI Summary</th>
                              <th>Topics</th>
                              <th>Level</th>
                              <th>Uploaded</th>
                              <th>Source</th>
                            </tr></thead>
                            <tbody>
                              {recentUploads.map(e=>(
                                <tr key={e.id} style={{cursor:'pointer'}} onClick={()=>openEventModal(e,'upload')}>
                                  <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                                    <input type="checkbox" checked={selectedForAnalysis.has(e.id)} onChange={()=>{
                                      setSelectedForAnalysis(prev=>{const n=new Set(prev); n.has(e.id)?n.delete(e.id):n.add(e.id); return n;});
                                    }} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                                  </td>
                                  <td>{e.id}</td>
                                  <td style={{fontWeight:600}}>{e.title}</td>
                                  <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                                  <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                                  <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                                  <td style={{fontSize:'0.8rem'}}>{e.dateUploaded ? new Date(e.dateUploaded).toLocaleString() : 'â€”'}</td>
                                  <td>{e.sourceType}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </>
                ) : (
                  <UploadsContent />
                )}
              </div>
            )}

            {/* MY UPLOADS moved to Account Page */}

            {/* ADMIN PANEL (kept for backward compat but hidden from nav) */}
            {activeTab === 'admin panel' && (currentUser.role === 'admin' || currentUser.role === 'owner') && <AdminPanel />}

          </main>

          {showModal && modalData && modalViewJSX}

          {/* Download Format Popup */}
          {showDownloadPopup && (
            <div className="modal" onClick={()=>setShowDownloadPopup(null)}>
              <div className="modal-content" onClick={ev=>ev.stopPropagation()} style={{maxWidth:'550px',textAlign:'center'}}>
                <h3 style={{marginBottom:'1.5rem',color:'#e0e6ed'}}>Download Format</h3>
                <div style={{display:'flex',gap:'1rem',justifyContent:'center',flexWrap:'wrap'}}>
                  {['csv','excel','json','pdf','word'].map(fmt=>{
                    const colors = {csv:'#10b981',excel:'#2563eb',json:'#7c3aed',pdf:'#ef4444',word:'#3b82f6'};
                    const labels = {csv:'CSV',excel:'Excel (.xlsx)',json:'JSON',pdf:'PDF',word:'Word (.doc)'};
                    return (
                    <button key={fmt} onClick={()=>{
                      let events;
                      if (showDownloadPopup==='spreadsheet') events = sortedEvents.filter(e=>selectedEvents.has(e.id));
                      else if (showDownloadPopup==='myuploads') events = mySortedEvents.filter(e=>selectedMyEvents.has(e.id));
                      else if (showDownloadPopup==='recent') events = recentUploads.filter(e=>selectedForAnalysis.has(e.id));
                      else events = [];
                      downloadEvents(events, fmt);
                    }} style={{padding:'0.75rem 1.5rem',fontSize:'0.9rem',fontWeight:700,color:'#fff',background:colors[fmt],border:'none',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit',minWidth:'90px'}}>
                      {labels[fmt]}
                    </button>
                    );
                  })}
                </div>
                <button onClick={()=>setShowDownloadPopup(null)} style={{marginTop:'1.5rem',padding:'0.5rem 1.5rem',color:'#8b92b0',background:'none',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',cursor:'pointer',fontFamily:'inherit'}}>Cancel</button>
              </div>
            </div>
          )}

          {isProcessing && (
            <div className="processing-overlay">
              <div className="processing-card">
                <div className="processing-spinner"></div>
                <h3 style={{marginBottom:'1rem',color:'#60a5fa'}}>Processing...</h3>
                <p style={{marginBottom:'1.5rem',color:'#8b92b0'}}>Analyzing your files with AI</p>
                <button className="btn btn-cancel" onClick={cancelProcessing}>Cancel</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
