<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Events Database v2.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Karla:wght@400;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Karla', sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); color: #e0e6ed; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(96,165,250,0.05) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(167,139,250,0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .app { min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }
    .fullscreen { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: #0a0e27; padding: 2rem; }
    .header { background: linear-gradient(135deg, rgba(26,31,58,0.95), rgba(45,53,97,0.95)); padding: 2rem 3rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-bottom: 3px solid rgba(96,165,250,0.3); backdrop-filter: blur(10px); }
    .header h1 { font-family: 'Space Mono', monospace; font-size: 2.5rem; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; letter-spacing: -1px; font-weight: 700; }
    .stats { display: flex; gap: 3rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .stat { display: flex; flex-direction: column; gap: 0.25rem; position: relative; padding-left: 1rem; }
    .stat::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 80%; background: linear-gradient(180deg, #60a5fa, #a78bfa); border-radius: 2px; }
    .stat-label { font-size: 0.75rem; color: #8b92b0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-value { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: bold; color: #60a5fa; }
    .breadcrumb-bar { padding: 0.6rem 3rem; background: rgba(10,14,39,0.5); border-bottom: 1px solid rgba(61,69,99,0.4); display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; min-height: 36px; }
    .bc-item { color: #60a5fa; cursor: pointer; transition: all 0.15s; padding: 0.2rem 0.4rem; border-radius: 4px; }
    .bc-item:hover { background: rgba(96,165,250,0.15); text-decoration: underline; }
    .bc-sep { color: #3d4563; font-size: 0.75rem; }
    .bc-current { color: #e0e6ed; font-weight: 600; padding: 0.2rem 0.4rem; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 3rem; background: rgba(21,25,50,0.6); border-bottom: 1px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .save-btn { padding: 0.75rem 2rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Space Mono', monospace; text-transform: uppercase; letter-spacing: 1px; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.5); }
    .save-status { font-size: 0.875rem; color: #10b981; font-weight: 600; }
    .nav { display: flex; gap: 0.75rem; padding: 1.5rem 3rem; background: rgba(21,25,50,0.4); border-bottom: 1px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(5px); }
    .nav-btn { padding: 0.875rem 1.75rem; background: rgba(26,31,58,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 600; color: #8b92b0; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-btn:hover { background: rgba(37,43,74,0.9); border-color: #60a5fa; color: #e0e6ed; transform: translateY(-2px); }
    .nav-btn.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: #0a0e27; border-color: #60a5fa; box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .content { flex: 1; padding: 2rem 3rem; }
    .filters { background: rgba(26,31,58,0.6); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 2px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .filters-title { font-size: 1.25rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 1px; }
    .filter-row { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .filter-group { flex: 1; min-width: 220px; }
    .filter-label { display: block; font-size: 0.875rem; color: #8b92b0; margin-bottom: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.875rem; transition: all 0.2s; font-family: 'Karla', sans-serif; }
    input:focus, select:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .search-row { display: flex; gap: 0.5rem; }
    .search-row input { flex: 1; width: auto; }
    .search-btn { padding: 0.875rem 1.5rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 0.875rem; white-space: nowrap; transition: all 0.2s; }
    .search-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: rgba(10,14,39,0.4); border-radius: 8px; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(45,53,97,0.4); border: 1px solid rgba(61,69,99,0.5); border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; user-select: none; }
    .checkbox-label:hover { background: rgba(96,165,250,0.1); border-color: #60a5fa; }
    .checkbox-label input[type="checkbox"] { margin: 0; cursor: pointer; width: 16px; height: 16px; flex-shrink: 0; }
    .checkbox-label.checked { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .btn { padding: 0.875rem 2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; box-shadow: 0 4px 12px rgba(96,165,250,0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.5); }
    .btn-secondary { background: rgba(45,53,97,0.6); color: #e0e6ed; border: 2px solid rgba(96,165,250,0.3); }
    .btn-secondary:hover { background: rgba(96,165,250,0.15); }
    .btn-danger { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .btn-cancel { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .fullscreen-btn { position: absolute; top: 1rem; right: 1rem; z-index: 100; }
    .timeline-wrapper { background: rgba(26,31,58,0.6); border-radius: 12px; padding: 3rem 2rem; border: 2px solid rgba(61,69,99,0.5); min-height: 400px; position: relative; overflow-x: auto; overflow-y: visible; }
    .timeline-container { position: relative; min-width: max-content; padding: 3rem 1rem; }
    .timeline-line { position: absolute; left: 0; right: 0; top: 50%; height: 4px; background: linear-gradient(90deg, #60a5fa, #a78bfa); border-radius: 2px; transform: translateY(-50%); }
    .timeline-events { position: relative; display: flex; align-items: center; gap: 4rem; min-width: 100%; }
    .timeline-event { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s; z-index: 10; }
    .timeline-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #60a5fa, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; border: 3px solid #0a0e27; box-shadow: 0 4px 12px rgba(96,165,250,0.4); transition: all 0.3s; }
    .timeline-event:hover .timeline-icon { transform: scale(1.2); box-shadow: 0 6px 20px rgba(96,165,250,0.6); }
    .timeline-event.major .timeline-icon { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
    .timeline-label { position: absolute; top: 62px; font-size: 0.68rem; color: #8b92b0; text-align: center; width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .timeline-year { position: absolute; top: -32px; font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; color: #60a5fa; white-space: nowrap; }
    .network { background: rgba(26,31,58,0.6); border-radius: 16px; border: 2px solid rgba(61,69,99,0.5); height: 700px; position: relative; backdrop-filter: blur(10px); }
    #network-graph { width: 100%; height: 100%; border-radius: 16px; }
    .spreadsheet { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 1.5rem; border: 2px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(10px); }
    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th { background: rgba(37,43,74,0.8); padding: 1.25rem; text-align: left; font-weight: 700; color: #60a5fa; border-bottom: 3px solid rgba(61,69,99,0.8); position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .table td { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(45,53,97,0.3); }
    .table tr:hover td { background: rgba(37,43,74,0.4); }
    .table a { color: #60a5fa; text-decoration: none; }
    .table a:hover { text-decoration: underline; }
    .copy-link { margin-left: 0.5rem; cursor: pointer; color: #10b981; font-weight: bold; opacity: 0.6; }
    .copy-link:hover { opacity: 1; }
    .upload { background: linear-gradient(135deg, rgba(26,31,58,0.6), rgba(45,53,97,0.4)); border: 3px dashed rgba(96,165,250,0.3); border-radius: 16px; padding: 4rem; text-align: center; cursor: pointer; transition: all 0.4s; margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .upload:hover { border-color: #60a5fa; background: linear-gradient(135deg, rgba(37,43,74,0.8), rgba(61,69,99,0.6)); transform: scale(1.01); }
    .upload-icon { font-size: 4rem; margin-bottom: 1.5rem; }
    .upload-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .upload-tab { padding: 0.75rem 1.5rem; background: rgba(26,31,58,0.6); border: 2px solid rgba(45,53,97,0.5); border-radius: 8px; cursor: pointer; font-weight: 600; color: #8b92b0; transition: all 0.2s; }
    .upload-tab.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border-color: #60a5fa; }
    .url-input-section { background: rgba(26,31,58,0.8); border: 2px solid rgba(96,165,250,0.3); border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; }
    .url-input-header { font-size: 1.5rem; font-weight: 700; color: #60a5fa; margin-bottom: 1.5rem; }
    .url-input-row { display: flex; gap: 1rem; align-items: flex-end; }
    .url-input-group { flex: 1; }
    .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .processing-card { background: rgba(26,31,58,0.98); border-radius: 16px; padding: 2.5rem; max-width: 400px; border: 2px solid rgba(96,165,250,0.5); text-align: center; }
    .processing-spinner { border: 4px solid rgba(96,165,250,0.2); border-top: 4px solid #60a5fa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; border: 3px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(96,165,250,0.2); }
    .modal-title { font-size: 1.75rem; font-weight: 700; color: #60a5fa; font-family: 'Space Mono', monospace; flex: 1; line-height: 1.3; }
    .modal-actions { display: flex; gap: 0.5rem; margin-left: 1rem; flex-shrink: 0; }
    .close { background: rgba(239,68,68,0.2); border: 2px solid rgba(239,68,68,0.4); font-size: 1.5rem; color: #ef4444; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; font-weight: bold; }
    .close:hover { background: rgba(239,68,68,0.4); transform: scale(1.1); }
    .edit-btn { background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.875rem; }
    .edit-btn:hover { background: rgba(16,185,129,0.3); }
    .form-group { margin-bottom: 2rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .edit-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; }
    textarea.edit-input { min-height: 100px; resize: vertical; font-family: inherit; }
    .ai-summary-box { background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(139,92,246,0.1)); border: 2px solid rgba(167,139,250,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .ai-summary-label { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #a78bfa; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .ai-summary-label::before { content: 'ü§ñ'; font-size: 1.25rem; }
    .tags { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
    .tag { padding: 0.5rem 1rem; background: linear-gradient(135deg, rgba(45,53,97,0.8), rgba(61,69,99,0.8)); border-radius: 24px; font-size: 0.8125rem; color: #a78bfa; border: 2px solid rgba(167,139,250,0.3); font-weight: 600; transition: all 0.2s; cursor: pointer; }
    .tag:hover { background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(139,92,246,0.2)); border-color: #a78bfa; transform: scale(1.05); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    .card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 16px; padding: 2rem; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); }
    .card:hover { border-color: #60a5fa; transform: translateY(-4px); box-shadow: 0 8px 24px rgba(96,165,250,0.2); }
    .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: #e0e6ed; }
    .card-count { font-size: 0.875rem; color: #8b92b0; font-weight: 600; }
    .card-tags { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .card-tag { padding: 0.25rem 0.6rem; background: rgba(96,165,250,0.15); border: 1px solid rgba(96,165,250,0.3); border-radius: 12px; font-size: 0.7rem; color: #60a5fa; }
    .level-1 { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-2 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-3 { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .success-msg { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: #10b981; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(16,185,129,0.3); font-weight: 600; }
    .error-msg { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.2)); color: #ef4444; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(239,68,68,0.3); font-weight: 600; }
    .back-btn { padding: 0.75rem 1.5rem; background: rgba(45,53,97,0.6); border: 2px solid rgba(96,165,250,0.3); border-radius: 10px; color: #60a5fa; font-weight: 600; cursor: pointer; margin-bottom: 2rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .back-btn:hover { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .export-btns { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .empty-state { text-align: center; padding: 4rem 2rem; color: #8b92b0; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    /* ‚îÄ‚îÄ Auth screens ‚îÄ‚îÄ */
    .auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); }
    .auth-card { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px; border: 2px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); }
    .auth-title { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: 700; color: #60a5fa; margin-bottom: 0.5rem; text-align: center; }
    .auth-subtitle { color: #8b92b0; font-size: 0.875rem; margin-bottom: 2rem; text-align: center; }
    .auth-field { margin-bottom: 1.25rem; }
    .auth-label { display: block; font-size: 0.8rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .auth-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; }
    .auth-input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .auth-btn { width: 100%; padding: 0.9rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; transition: all 0.2s; font-family: 'Space Mono', monospace; letter-spacing: 0.5px; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.4); }
    .auth-switch { text-align: center; margin-top: 1.5rem; color: #8b92b0; font-size: 0.875rem; }
    .auth-switch span { color: #60a5fa; cursor: pointer; font-weight: 600; }
    .auth-switch span:hover { text-decoration: underline; }
    .auth-error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    .auth-success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    /* ‚îÄ‚îÄ User chip ‚îÄ‚îÄ */
    .user-chip { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .role-badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .role-owner { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .role-admin { background: linear-gradient(135deg, #a78bfa, #8b5cf6); color: white; }
    .role-user { background: rgba(96,165,250,0.2); color: #60a5fa; border: 1px solid rgba(96,165,250,0.4); }
    .logout-btn { padding: 0.35rem 0.875rem; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); border-radius: 6px; color: #ef4444; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(239,68,68,0.3); }
    /* ‚îÄ‚îÄ Event status badges (visible to all) ‚îÄ‚îÄ */
    .status-historical { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-contested { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-unverified { background: rgba(107,114,128,0.2); color: #9ca3af; border: 1px solid rgba(107,114,128,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-public { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-private { background: rgba(107,114,128,0.15); color: #9ca3af; border: 1px solid rgba(107,114,128,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    /* ‚îÄ‚îÄ Admin panel ‚îÄ‚îÄ */
    .admin-section { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 2rem; border: 2px solid rgba(167,139,250,0.2); margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .admin-section-title { font-size: 1.1rem; font-weight: 700; color: #a78bfa; margin-bottom: 1.25rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .admin-table th { background: rgba(37,43,74,0.8); padding: 0.875rem 1rem; text-align: left; color: #a78bfa; border-bottom: 2px solid rgba(167,139,250,0.3); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .admin-table td { padding: 0.875rem 1rem; border-bottom: 1px solid rgba(45,53,97,0.3); vertical-align: middle; }
    .admin-table tr:hover td { background: rgba(37,43,74,0.3); }
    .role-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer; }
    .status-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.4rem 0.6rem; font-size: 0.8rem; cursor: pointer; font-family: inherit; }
    /* ‚îÄ‚îÄ Account page ‚îÄ‚îÄ */
    .account-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; box-shadow: 0 4px 20px rgba(96,165,250,0.3); }
    .account-profile-card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 20px; padding: 2.5rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; backdrop-filter: blur(10px); }
    .account-tabs { display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid rgba(61,69,99,0.4); }
    .account-tab { padding: 0.875rem 1.75rem; background: none; border: none; border-bottom: 3px solid transparent; color: #8b92b0; font-weight: 700; cursor: pointer; font-size: 0.875rem; margin-bottom: -2px; transition: all 0.2s; font-family: inherit; }
    .account-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    .account-tab.active-admin { color: #a78bfa; border-bottom-color: #a78bfa; }
    .account-tab:hover { color: #e0e6ed; }
    .user-chip-btn { display: flex; align-items: center; gap: 0.6rem; background: rgba(45,53,97,0.5); border: 1px solid rgba(96,165,250,0.2); border-radius: 10px; padding: 0.4rem 0.85rem; cursor: pointer; transition: all 0.2s; }
    .user-chip-btn:hover { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.4); }
    .user-chip-avatar { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // ‚îÄ‚îÄ‚îÄ HARDCODED ACCOUNTS (‚ö† change passwords before sharing) ‚îÄ‚îÄ‚îÄ
    // ‚ö† Change passwords before sharing publicly
    const HARDCODED_USERS = [
      { username: 'owner',    password: 'owner123', role: 'owner' },
      { username: 'admin',    password: 'admin123', role: 'admin'  },
      { username: 'testuser', password: 'test123',  role: 'user'   }
    ];

    // ‚îÄ‚îÄ‚îÄ AUTH HELPERS ‚îÄ‚îÄ‚îÄ
    const getRegisteredUsers = () => { try { return JSON.parse(localStorage.getItem('hdb_users')) || []; } catch { return []; } };
    const saveRegisteredUsers = (users) => { localStorage.setItem('hdb_users', JSON.stringify(users)); };
    const findUser = (username, password) => {
      const hc = HARDCODED_USERS.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
      if (hc) return hc;
      return getRegisteredUsers().find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password) || null;
    };

    // ‚îÄ‚îÄ‚îÄ NORMALIZE DATA (adds auth fields to existing events) ‚îÄ‚îÄ‚îÄ
    const normalizeData = (raw) => ({
      ...raw,
      events: raw.events.map(e => ({
        uploadedBy: 'system', isPublic: true, eventStatus: 'historical_record', ...e
      }))
    });

    // ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ
    const LoginScreen = ({ onLogin, onGoSignup }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const submit = () => {
        if (!username.trim() || !password.trim()) { setError('Please fill in all fields.'); return; }
        const user = findUser(username.trim(), password.trim());
        if (!user) { setError('Invalid username or password.'); return; }
        onLogin(user);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Historical Events DB</div>
              <div className="auth-subtitle">Sign in to access the database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Enter username" value={username}
                onChange={e=>setUsername(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Enter password" value={password}
                onChange={e=>setPassword(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit}>Sign In ‚Üí</button>
            <div className="auth-switch">Don't have an account? <span onClick={onGoSignup}>Create one</span></div>
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ SIGNUP SCREEN ‚îÄ‚îÄ‚îÄ
    const SignupScreen = ({ onGoLogin }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const submit = () => {
        if (!username.trim() || !password.trim() || !confirm.trim()) { setError('Please fill in all fields.'); return; }
        if (username.trim().length < 3) { setError('Username must be at least 3 characters.'); return; }
        if (password.length < 6) { setError('Password must be at least 6 characters.'); return; }
        if (password !== confirm) { setError('Passwords do not match.'); return; }
        const allNames = [...HARDCODED_USERS, ...getRegisteredUsers()].map(u => u.username.toLowerCase());
        if (allNames.includes(username.trim().toLowerCase())) { setError('Username already taken.'); return; }
        saveRegisteredUsers([...getRegisteredUsers(), { username: username.trim(), password, role: 'user', createdAt: new Date().toISOString() }]);
        setSuccess('Account created! Redirecting to sign in‚Ä¶'); setError('');
        setTimeout(() => onGoLogin(), 1500);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Create Account</div>
              <div className="auth-subtitle">Join the Historical Events Database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            {success && <div className="auth-success">{success}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Min. 3 characters" value={username}
                onChange={e=>setUsername(e.target.value)} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Min. 6 characters" value={password}
                onChange={e=>setPassword(e.target.value)} />
            </div>
            <div className="auth-field">
              <label className="auth-label">Confirm Password</label>
              <input className="auth-input" type="password" placeholder="Re-enter password" value={confirm}
                onChange={e=>setConfirm(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit}>Create Account</button>
            <div className="auth-switch">Already have an account? <span onClick={onGoLogin}>Sign in</span></div>
          </div>
        </div>
      );
    };

    const EMBEDDED_DATA = {"events":[{"id":"EVT-0001","title":"Are we all breathing SMART dust?","description":"everything can be done with smart dust, eventually you'll breathe it, but because it isn't mass manufactured yet you prob aren't breathing it YET","date":null,"dateUploaded":"2026-02-12","topics":["Nano particles","smart dust","CYBORG","MERGING WITH MACHINES","micro particles"],"people":[],"organizations":["Brite Innovation"],"links":["https://brite.ikeinstitute.org/brite_innovation_review_issue_31_winter_2023/are_we_all_breathing_smart_dust"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article discussing smart dust and nano particles technology. RAND developed microelectromechanical systems (MEMS) that can monitor anything anywhere."},{"id":"EVT-0002","title":"Chemtrails: What In The World Are They Spraying?","description":"documentary on chemtrails and geoengineering","date":"2010-01-01","dateUploaded":"2026-02-12","topics":["chemtrails","Geoengineering"],"people":[],"organizations":[],"links":["https://www.youtube.com/watch?v=jf0khstYDLA"],"researchLevel":2,"sourceType":"Documentary","sourceSheet":"Sheet1","connections":[],"aiSummary":"Documentary exploring chemtrails and geoengineering programs, examining what is being sprayed in the atmosphere."},{"id":"EVT-0003","title":"CIA Document 1035-960: Concerning Criticism of the Warren Report","description":"CIA coins the term 'conspiracy theory' to discredit critics of the Warren Commission","date":"1967-01-01","dateUploaded":"2026-02-12","topics":["CIA","conspiracy theory","Warren Commission","JFK"],"people":[],"organizations":["Central Intelligence Agency (CIA)"],"links":[],"researchLevel":3,"sourceType":"Declassified Document","sourceSheet":"Sheet1","connections":[],"aiSummary":"Declassified CIA document that is widely credited with popularizing the term 'conspiracy theory' as a way to discredit critics of the Warren Commission report on JFK's assassination."},{"id":"EVT-0004","title":"COVID-19 Lab Leak Theory","description":"Evidence suggests COVID-19 may have originated from a laboratory in Wuhan, China rather than natural transmission","date":"2020-01-01","dateUploaded":"2026-02-12","topics":["COVID-19","lab leak","Wuhan","biological weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Article","sourceSheet":"Covid","connections":[],"aiSummary":"Analysis of COVID-19 origins and the lab leak hypothesis. Multiple intelligence agencies now assess this as the likely origin."},{"id":"EVT-0005","title":"Direct Energy Weapon Patent","description":"Patent for directed energy weapon technology used by military","date":"1990-01-01","dateUploaded":"2026-02-12","topics":["Directed Energy Weapons (DEW)","military technology","weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Patent","sourceSheet":"Direct energy weapon","connections":[],"aiSummary":"Patent covering directed energy weapon systems including microwave and laser-based weapons."},{"id":"EVT-0006","title":"Election of President Abraham Lincoln","description":"Abraham Lincoln served as the 16th President of the United States from 1861-03-04 to 1865-04-15.","date":"1861-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Abraham Lincoln"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Abraham Lincoln as the 16th President. Led the country through the Civil War and issued the Emancipation Proclamation.","isMajorEvent":true},{"id":"EVT-0007","title":"Election of President Barack Obama","description":"Barack Obama served as the 44th President of the United States from 2009-01-20 to 2017-01-20.","date":"2009-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Barack Obama"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Barack Obama as the 44th President and first African-American president of the United States.","isMajorEvent":true},{"id":"EVT-0008","title":"Election of President Bill Clinton","description":"Bill Clinton served as the 42nd President of the United States from 1993-01-20 to 2001-01-20.","date":"1993-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Bill Clinton"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Bill Clinton as the 42nd President of the United States.","isMajorEvent":true},{"id":"EVT-0009","title":"Election of President Donald Trump","description":"Donald Trump served as the 45th President of the United States from 2017-01-20 to 2021-01-20, and was elected again as the 47th President in 2024.","date":"2017-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Donald Trump"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Donald Trump as the 45th President.","isMajorEvent":true},{"id":"EVT-0010","title":"Election of President Dwight D. Eisenhower","description":"Dwight D. Eisenhower served as the 34th President of the United States from 1953-01-20 to 1961-01-20.","date":"1953-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Dwight D. Eisenhower"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Dwight D. Eisenhower. Famously warned about the military-industrial complex in his farewell address.","isMajorEvent":true},{"id":"EVT-0011","title":"Election of President Franklin D. Roosevelt","description":"Franklin D. Roosevelt served as the 32nd President of the United States from 1933-03-04 to 1945-04-12.","date":"1933-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Franklin D. Roosevelt"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Franklin D. Roosevelt. Led the country through the Great Depression and World War II.","isMajorEvent":true},{"id":"EVT-0012","title":"Election of President George W. Bush","description":"George W. Bush served as the 43rd President of the United States from 2001-01-20 to 2009-01-20.","date":"2001-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","9/11"],"people":["George W. Bush"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of George W. Bush. His presidency was defined by the 9/11 attacks and subsequent War on Terror.","isMajorEvent":true},{"id":"EVT-0013","title":"Election of President George Washington","description":"George Washington served as the 1st President of the United States from 1789-04-30 to 1797-03-04.","date":"1789-04-30","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","Founding Fathers"],"people":["George Washington"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Inauguration of George Washington as the first President of the United States and Founding Father.","isMajorEvent":true},{"id":"EVT-0014","title":"Election of President Harry S. Truman","description":"Harry S. Truman served as the 33rd President of the United States from 1945-04-12 to 1953-01-20.","date":"1945-04-12","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Harry S. Truman"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Harry S. Truman became President after FDR's death. Authorized use of atomic bombs on Japan and oversaw end of WWII.","isMajorEvent":true},{"id":"EVT-0015","title":"Election of President Joe Biden","description":"Joe Biden served as the 46th President of the United States from 2021-01-20 to 2025-01-20.","date":"2021-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Joe Biden"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Joe Biden as the 46th President.","isMajorEvent":true},{"id":"EVT-0016","title":"Election of President John F. Kennedy","description":"John F. Kennedy served as the 35th President of the United States from 1961-01-20 to 1963-11-22.","date":"1961-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","JFK","assassination"],"people":["John F. Kennedy"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of JFK. His assassination in 1963 remains one of history's most debated events.","isMajorEvent":true},{"id":"EVT-0017","title":"Gulf War","description":"Gulf War was a major military conflict involving the United States and coalition forces against Iraq, lasting from 1991-01-17 to 1991-02-28.","date":"1991-01-17","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Gulf War","Middle East"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Gulf War (Operation Desert Storm). Coalition forces expelled Iraq from Kuwait.","isMajorEvent":true},{"id":"EVT-0018","title":"Iraq War","description":"Iraq War was a major military conflict involving the United States, lasting from 2003-03-20 to 2011-12-15. Launched after claims of weapons of mass destruction.","date":"2003-03-20","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Iraq War","Middle East","weapons of mass destruction"],"people":[],"organizations":["United States Armed Forces","Central Intelligence Agency (CIA)"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Iraq War. Launched based on disputed WMD claims. No WMDs were found.","isMajorEvent":true},{"id":"EVT-0019","title":"Korean War","description":"Korean War was a major military conflict involving the United States, lasting from 1950-06-25 to 1953-07-27.","date":"1950-06-25","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Korean War"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Korean War, often called 'The Forgotten War'. Ended in armistice, not a peace treaty.","isMajorEvent":true},{"id":"EVT-0020","title":"October Surprise: A Four-Decade Secret","description":"Media now admits October Surprise is real ‚Äî proof that the CIA and intelligence agencies will interfere with elections","date":"2023-03-28","dateUploaded":"2026-02-12","topics":["October Surprise","CIA","Ronald Reagan","Jimmy Carter","election fraud","election interference"],"people":["Jimmy Carter","Ronald Reagan"],"organizations":["New York Times (NYT)","The Intercept","Central Intelligence Agency (CIA)"],"links":["https://www.nytimes.com/2023/03/18/us/politics/jimmy-carter-october-surprise-iran-hostages.html","https://theintercept.com/2023/03/24/october-surprise-ben-barnes/"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article in NYT confirming the October Surprise ‚Äî that Reagan's 1980 campaign secretly negotiated with Iran to delay hostage release to undermine Carter's re-election."}],"people":["Abraham Lincoln","Barack Obama","Bill Clinton","Donald Trump","Dwight D. Eisenhower","Franklin D. Roosevelt","George W. Bush","George Washington","Harry S. Truman","Jimmy Carter","Joe Biden","John F. Kennedy","Ronald Reagan"],"organizations":["Brite Innovation","Central Intelligence Agency (CIA)","New York Times (NYT)","The Intercept","United States Armed Forces","United States Government"],"topics":["9/11","American History","CYBORG","CIA","COVID-19","Directed Energy Weapons (DEW)","Founding Fathers","Geoengineering","Gulf War","Iraq War","JFK","Jimmy Carter","Korean War","MERGING WITH MACHINES","Middle East","Military Conflict","Nano particles","October Surprise","Politics","Presidential Election","Ronald Reagan","US President","War","Warren Commission","Wuhan","assassination","biological weapons","chemtrails","conspiracy theory","election fraud","election interference","lab leak","micro particles","military technology","smart dust","weapons of mass destruction"],"metadata":{"totalEvents":20,"totalPeople":13,"totalOrganizations":6,"totalTopics":36,"lastUpdated":"2026-02-16T12:00:00.000Z"}};

    // ‚îÄ‚îÄ‚îÄ FILTERS COMPONENT (defined OUTSIDE App so it never remounts on keypress) ‚îÄ‚îÄ‚îÄ
    const FiltersComponent = ({ filters, setFilters, data, activeTab, onSearch, onClear, onExportCSV, onExportJSON }) => {
      return (
        <div className="filters">
          <div className="filters-header">
            <div className="filters-title">Filters</div>
            <button className="btn btn-secondary" onClick={onClear} style={{padding:'0.5rem 1rem', fontSize:'0.8rem'}}>
              üóëÔ∏è Clear All Filters
            </button>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Search</label>
              <div className="search-row">
                <input
                  type="text"
                  placeholder="Search events, topics, people..."
                  value={filters.search}
                  onChange={e => setFilters(prev => ({ ...prev, search: e.target.value }))}
                  onKeyDown={e => { if (e.key === 'Enter') { e.preventDefault(); onSearch(); } }}
                />
                <button className="search-btn" onClick={onSearch}>‚Üí</button>
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Date From</label>
              <input type="date" value={filters.dateFrom} onChange={e => setFilters(prev => ({ ...prev, dateFrom: e.target.value }))} />
            </div>
            <div className="filter-group">
              <label className="filter-label">Date To</label>
              <input type="date" value={filters.dateTo} onChange={e => setFilters(prev => ({ ...prev, dateTo: e.target.value }))} />
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Topics</label>
              <div className="checkbox-grid">
                {(data.topics || []).map(t => (
                  <label key={t} className={`checkbox-label ${filters.topics.includes(t) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.topics.includes(t)}
                      onChange={e => setFilters(prev => ({
                        ...prev, topics: e.target.checked ? [...prev.topics, t] : prev.topics.filter(x => x !== t)
                      }))} />
                    {t}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">People</label>
              <div className="checkbox-grid">
                {(data.people || []).map(p => (
                  <label key={p} className={`checkbox-label ${filters.people.includes(p) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.people.includes(p)}
                      onChange={e => setFilters(prev => ({
                        ...prev, people: e.target.checked ? [...prev.people, p] : prev.people.filter(x => x !== p)
                      }))} />
                    {p}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Organizations</label>
              <div className="checkbox-grid">
                {(data.organizations || []).map(o => (
                  <label key={o} className={`checkbox-label ${filters.organizations.includes(o) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.organizations.includes(o)}
                      onChange={e => setFilters(prev => ({
                        ...prev, organizations: e.target.checked ? [...prev.organizations, o] : prev.organizations.filter(x => x !== o)
                      }))} />
                    {o}
                  </label>
                ))}
              </div>
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Research Levels</label>
              <div style={{display:'flex', gap:'0.75rem', flexWrap:'wrap'}}>
                {['1','2','3'].map(level => (
                  <label key={level} className={`checkbox-label ${filters.researchLevels.includes(level) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.researchLevels.includes(level)}
                      onChange={e => setFilters(prev => ({
                        ...prev, researchLevels: e.target.checked ? [...prev.researchLevels, level] : prev.researchLevels.filter(x => x !== level)
                      }))} />
                    Level {level}
                  </label>
                ))}
              </div>
            </div>
            {activeTab === 'timeline' && (
              <div className="filter-group">
                <label className="filter-label">Display Options</label>
                <label className="checkbox-label" style={{width:'fit-content'}}>
                  <input type="checkbox" checked={filters.showMajorOnly}
                    onChange={e => setFilters(prev => ({ ...prev, showMajorOnly: e.target.checked }))} />
                  Major Events Only (Presidents & Wars)
                </label>
              </div>
            )}
          </div>
          <div className="export-btns">
            <button className="btn btn-primary" onClick={onExportCSV}>üì• Export CSV</button>
            <button className="btn btn-primary" onClick={onExportJSON}>üì• Export JSON</button>
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ
    function App() {
      const [data, setData] = useState(() => {
        try {
          const saved = localStorage.getItem('historicalEventsDB');
          return normalizeData(saved ? JSON.parse(saved) : EMBEDDED_DATA);
        } catch (e) { return normalizeData(EMBEDDED_DATA); }
      });

      const [currentUser, setCurrentUser] = useState(() => {
        try { return JSON.parse(localStorage.getItem('hdb_session')); } catch { return null; }
      });
      const [authScreen, setAuthScreen] = useState('login');
      const [accountTab, setAccountTab] = useState('uploads');
      const [myFilters, setMyFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [myPageTab, setMyPageTab] = useState('timeline');

      const TABS = ['timeline','network','spreadsheet','topics','people','organizations','upload'];

      const [activeTab, setActiveTab] = useState('timeline');
      const [filters, setFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [showModal, setShowModal] = useState(false);
      const [modalData, setModalData] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [editedEvent, setEditedEvent] = useState(null);
      const [uploadMessage, setUploadMessage] = useState('');
      const [saveStatus, setSaveStatus] = useState('');
      const [selectedEntity, setSelectedEntity] = useState(null);
      const [urlInput, setUrlInput] = useState('');
      const [isTimelineFullscreen, setIsTimelineFullscreen] = useState(false);
      const [isNetworkFullscreen, setIsNetworkFullscreen] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [uploadTab, setUploadTab] = useState('new');
      // Breadcrumb: array of {label, action}
      const [breadcrumbs, setBreadcrumbs] = useState([]);
      const fileInputRef = useRef(null);

      // ‚îÄ‚îÄ Auto-save every 30s ‚îÄ‚îÄ
      useEffect(() => {
        const timer = setInterval(() => {
          try {
            localStorage.setItem('historicalEventsDB', JSON.stringify(data));
            setSaveStatus('Auto-saved ‚úì');
            setTimeout(() => setSaveStatus(''), 2000);
          } catch (e) {}
        }, 30000);
        return () => clearInterval(timer);
      }, [data]);

      const saveState = useCallback(() => {
        try {
          localStorage.setItem('historicalEventsDB', JSON.stringify(data));
          setSaveStatus('Saved ‚úì');
          setTimeout(() => setSaveStatus(''), 3000);
        } catch (e) { setSaveStatus('Save Error'); }
      }, [data]);

      // ‚îÄ‚îÄ Breadcrumb helpers ‚îÄ‚îÄ
      const pushBreadcrumb = (label, action) => {
        setBreadcrumbs(prev => [...prev, { label, action }]);
      };

      const goToBreadcrumb = (index) => {
        const crumb = breadcrumbs[index];
        setBreadcrumbs(prev => prev.slice(0, index));
        if (crumb && crumb.action) crumb.action();
      };

      const navigateToTab = (tab) => {
        setActiveTab(tab);
        setSelectedEntity(null);
        setBreadcrumbs([{ label: tab.charAt(0).toUpperCase() + tab.slice(1), action: () => { setActiveTab(tab); setSelectedEntity(null); } }]);
      };

      // ‚îÄ‚îÄ Auth functions ‚îÄ‚îÄ
      const login = (user) => {
        const session = { username: user.username, role: user.role };
        localStorage.setItem('hdb_session', JSON.stringify(session));
        setCurrentUser(session);
      };
      const logout = () => {
        localStorage.removeItem('hdb_session');
        setCurrentUser(null);
        setAuthScreen('login');
      };

      // ‚îÄ‚îÄ Visibility: what the current user can see ‚îÄ‚îÄ
      const visibleEvents = useMemo(() => {
        if (!currentUser) return [];
        if (currentUser.role === 'admin' || currentUser.role === 'owner') return data.events;
        return data.events.filter(e => e.isPublic || e.uploadedBy === currentUser.username);
      }, [data.events, currentUser]);

      // ‚îÄ‚îÄ Event management ‚îÄ‚îÄ
      const toggleEventPublic = (eventId) => {
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, isPublic: !e.isPublic } : e) }));
      };
      const updateEventStatus = (eventId, status) => {
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, eventStatus: status } : e) }));
      };
      const deleteEvent = (eventId) => {
        setData(prev => {
          const updated = prev.events.filter(e => e.id !== eventId);
          const allP = new Set(), allO = new Set(), allT = new Set();
          updated.forEach(e => { (e.people||[]).forEach(p=>allP.add(p)); (e.organizations||[]).forEach(o=>allO.add(o)); (e.topics||[]).forEach(t=>allT.add(t)); });
          return { ...prev, events: updated, people:[...allP].sort(), organizations:[...allO].sort(), topics:[...allT].sort(), metadata:{...prev.metadata, totalEvents:updated.length} };
        });
        setShowModal(false);
      };

      // ‚îÄ‚îÄ User management (admin panel) ‚îÄ‚îÄ
      const [adminUsers, setAdminUsers] = useState([]);
      const refreshAdminUsers = () => setAdminUsers(getRegisteredUsers());
      const updateUserRole = (username, newRole) => {
        const updated = getRegisteredUsers().map(u => u.username === username ? { ...u, role: newRole } : u);
        saveRegisteredUsers(updated);
        setAdminUsers(updated);
        // update session if changing self
        if (currentUser.username === username) {
          const session = { ...currentUser, role: newRole };
          localStorage.setItem('hdb_session', JSON.stringify(session));
          setCurrentUser(session);
        }
      };
      const deleteUserAccount = (username) => {
        const updated = getRegisteredUsers().filter(u => u.username !== username);
        saveRegisteredUsers(updated);
        setAdminUsers(updated);
      };

      // ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
      const applySearch = () => setFilters(prev => ({ ...prev, appliedSearch: prev.search }));

      const clearAllFilters = () => setFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const applyMySearch = () => setMyFilters(prev => ({...prev, appliedSearch: prev.search}));
      const clearMyFilters = () => setMyFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });

      const filteredEvents = useMemo(() => {
        return visibleEvents.filter(e => {
          if (filters.showMajorOnly && !e.isMajorEvent) return false;
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            const match = (e.title||'').toLowerCase().includes(s) || (e.description||'').toLowerCase().includes(s) ||
              (e.topics||[]).some(t => t.toLowerCase().includes(s)) ||
              (e.people||[]).some(p => p.toLowerCase().includes(s)) ||
              (e.organizations||[]).some(o => o.toLowerCase().includes(s));
            if (!match) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          if (filters.researchLevels.length > 0 && !filters.researchLevels.includes(String(e.researchLevel))) return false;
          if (filters.dateFrom && e.date && e.date < filters.dateFrom) return false;
          if (filters.dateTo && e.date && e.date > filters.dateTo) return false;
          return true;
        });
      }, [data.events, filters]);

      const sortedEvents = useMemo(() => [...filteredEvents].sort((a,b) => {
        if (!a.date && !b.date) return 0;
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [filteredEvents]);

      const timelineEvents = useMemo(() =>
        filteredEvents.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [filteredEvents]);

      const filteredTopics = useMemo(() =>
        (data.topics||[]).map(t => ({ name:t, count: filteredEvents.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0)
      , [data.topics, filteredEvents]);

      const filteredPeople = useMemo(() =>
        (data.people||[]).map(p => ({ name:p, count: filteredEvents.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0)
      , [data.people, filteredEvents]);

      const filteredOrganizations = useMemo(() =>
        (data.organizations||[]).map(o => ({ name:o, count: filteredEvents.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0)
      , [data.organizations, filteredEvents]);

      const myUploads = useMemo(() =>
        data.events.filter(e => e.uploadedBy === (currentUser ? currentUser.username : '__none__'))
      , [data.events, currentUser]);

      const filteredMyUploads = useMemo(() => {
        return myUploads.filter(e => {
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s)) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          return true;
        });
      }, [myUploads, filters]);

      // ‚îÄ‚îÄ My Uploads scoped memos (for Account page) ‚îÄ‚îÄ
      const myFiltered = useMemo(() => {
        return myUploads.filter(e => {
          if (myFilters.showMajorOnly && !e.isMajorEvent) return false;
          if (myFilters.appliedSearch) {
            const s = myFilters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s) &&
                !(e.topics||[]).some(t=>t.toLowerCase().includes(s)) &&
                !(e.people||[]).some(p=>p.toLowerCase().includes(s)) &&
                !(e.organizations||[]).some(o=>o.toLowerCase().includes(s))) return false;
          }
          if (myFilters.topics.length > 0 && !(e.topics||[]).some(t => myFilters.topics.includes(t))) return false;
          if (myFilters.researchLevels.length > 0 && !myFilters.researchLevels.includes(String(e.researchLevel))) return false;
          if (myFilters.people.length > 0 && !(e.people||[]).some(p => myFilters.people.includes(p))) return false;
          if (myFilters.organizations.length > 0 && !(e.organizations||[]).some(o => myFilters.organizations.includes(o))) return false;
          if (myFilters.dateFrom && e.date && new Date(e.date) < new Date(myFilters.dateFrom)) return false;
          if (myFilters.dateTo && e.date && new Date(e.date) > new Date(myFilters.dateTo)) return false;
          return true;
        });
      }, [myUploads, myFilters]);

      const mySortedEvents = useMemo(() => [...myFiltered].sort((a,b) => {
        if (!a.date && !b.date) return 0; if (!a.date) return 1; if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [myFiltered]);

      const myTimelineEvents = useMemo(() =>
        myFiltered.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [myFiltered]);

      const myFilteredTopics = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        return all.map(t => ({ name:t, count: myFiltered.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredPeople = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        return all.map(p => ({ name:p, count: myFiltered.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredOrgs = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        return all.map(o => ({ name:o, count: myFiltered.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0);
      }, [myUploads, myFiltered]);

      // ‚îÄ‚îÄ Network ‚îÄ‚îÄ
      useEffect(() => {
        if (activeTab === 'network' && filteredEvents.length > 0) setTimeout(initNetwork, 100);
      }, [activeTab, filteredEvents]);

      const initNetwork = () => {
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = filteredEvents.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', color:{ background:'#60a5fa', border:'#3b82f6' }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#a78bfa', border:'#8b5cf6' } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#8b92b0' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#10b981', border:'#059669' } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#8b92b0' } });
          });
        });
        const container = document.getElementById('network-graph');
        if (container) {
          const net = new vis.Network(container, { nodes, edges }, {
            physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 } },
            interaction:{ hover:true }
          });
          net.on('click', params => {
            if (params.nodes.length > 0) {
              const id = params.nodes[0];
              if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
              else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
              else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, activeTab); }
            }
          });
        }
      };

      // ‚îÄ‚îÄ My Network (Account page) ‚îÄ‚îÄ
      useEffect(() => {
        if (activeTab === 'account' && accountTab === 'uploads' && myPageTab === 'network' && myFiltered.length > 0)
          setTimeout(initMyNetwork, 100);
      }, [activeTab, accountTab, myPageTab, myFiltered]);

      const initMyNetwork = () => {
        const container = document.getElementById('my-network-graph');
        if (!container) return;
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = myFiltered.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', color:{ background:'#60a5fa', border:'#3b82f6' }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#a78bfa', border:'#8b5cf6' } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#8b92b0' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#10b981', border:'#059669' } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#8b92b0' } });
          });
        });
        const net = new vis.Network(container, { nodes, edges }, {
          physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 } },
          interaction:{ hover:true }
        });
        net.on('click', params => {
          if (params.nodes.length > 0) {
            const id = params.nodes[0];
            if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
            else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
            else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, 'account'); }
          }
        });
      };

      // ‚îÄ‚îÄ AI doc analysis ‚îÄ‚îÄ
      const analyzeDocument = (text) => {
        const words = text.toLowerCase().split(/\s+/);
        const wordFreq = {};
        words.forEach(w => { if (w.length > 4 && /^[a-z]+$/.test(w)) wordFreq[w] = (wordFreq[w]||0)+1; });
        const topicCandidates = Object.entries(wordFreq).filter(([,f]) => f >= 3).map(([w]) => w).slice(0,10);
        const names = [...new Set((text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g)||[]))].slice(0,10);
        const orgs = [...new Set((text.match(/\b[A-Z][a-zA-Z\s&]+(Inc\.|Corp\.|LLC|Agency|Department|Institute|University|Company|Foundation)\b/g)||[]))].slice(0,5);
        const sentences = text.split(/[.!?]+/).filter(s=>s.trim());
        const summary = `AI Analysis: ${words.length} words analyzed. Key topics identified: ${topicCandidates.slice(0,5).join(', ')}. ${sentences.slice(0,2).join('. ').substring(0,200)}...`;
        return { topics: topicCandidates, people: names, organizations: orgs, summary };
      };

      // ‚îÄ‚îÄ File upload ‚îÄ‚îÄ
      const handleFileUpload = async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        setIsProcessing(true);
        setUploadMessage('Processing files...');
        const newEvents = [];
        let eventId = data.events.length + 1;
        const timeout = setTimeout(() => { setIsProcessing(false); setUploadMessage('‚ö†Ô∏è Timeout - file may be too large'); setTimeout(()=>setUploadMessage(''),3000); }, 60000);
        try {
          for (const file of files) {
            let extractedText = '';
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
              await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = ev => {
                  try {
                    const wb = XLSX.read(ev.target.result, { type:'binary' });
                    wb.SheetNames.forEach(sheetName => {
                      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                      rows.forEach(row => {
                        extractedText += JSON.stringify(row)+' ';
                        newEvents.push({
                          id:`EVT-${String(eventId).padStart(4,'0')}`,
                          title: row.title||row.Title||row.TITLE||`Uploaded: ${file.name}`,
                          description: row.description||row.Description||row.Abstract||'',
                          date: row.date||row.Date||row.year||null,
                          dateUploaded: new Date().toISOString().split('T')[0],
                          topics: (row.topics||row.Topics||sheetName).toString().split(/[,;/]/).map(t=>t.trim()).filter(t=>t),
                          people: (row.writer||row.inventor||row.people||'').toString().split(/[,;]/).map(p=>p.trim()).filter(p=>p),
                          organizations: (row.publisher||row.company||row.organization||'').toString().split(/[,;/]/).map(o=>o.trim()).filter(o=>o),
                          links: [row['link main']||row.link||''].filter(l=>l),
                          researchLevel: parseInt(row['srch lvl']||row['My search lvl']||1)||1,
                          sourceType:'Uploaded Excel', sourceSheet:sheetName, connections:[], aiSummary:'', isMajorEvent:false,
                          uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified'
                        });
                        eventId++;
                      });
                    });
                  } catch(err) {}
                  resolve();
                };
                reader.onerror = ()=>resolve();
                reader.readAsBinaryString(file);
              });
            } else if (file.name.endsWith('.csv')) {
              extractedText = await file.text();
              const lines = extractedText.split('\n').filter(l=>l.trim());
              if (lines.length > 1) {
                const headers = lines[0].split(',').map(h=>h.trim());
                for (let i=1; i<Math.min(lines.length,1000); i++) {
                  const vals = lines[i].split(',');
                  const row = {};
                  headers.forEach((h,idx)=>{ row[h]=vals[idx]?.trim()||''; });
                  newEvents.push({ id:`EVT-${String(eventId).padStart(4,'0')}`, title:row.title||row.Title||`CSV Entry ${i}`, description:row.description||row.Description||'', date:row.date||row.Date||null, dateUploaded:new Date().toISOString().split('T')[0], topics:(row.topics||'CSV Import').split(/[,;]/).map(t=>t.trim()).filter(t=>t), people:(row.people||'').split(/[,;]/).map(p=>p.trim()).filter(p=>p), organizations:(row.organization||'').split(/[,;]/).map(o=>o.trim()).filter(o=>o), links:[row.link||''].filter(l=>l), researchLevel:1, sourceType:'Uploaded CSV', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                  eventId++;
                }
              }
            } else if (file.name.endsWith('.txt')) {
              extractedText = await file.text();
              newEvents.push({ id:`EVT-${String(eventId).padStart(4,'0')}`, title:file.name.replace('.txt',''), description:extractedText.substring(0,500), date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString().split('T')[0], topics:['Text Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded Text', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
              eventId++;
            } else if (/\.(pdf|docx?|png|jpe?g|gif|bmp|tiff|webp)$/i.test(file.name)) {
              // Send to backend for real text extraction
              try {
                const formData = new FormData();
                formData.append('files', file);
                const resp = await fetch('/api/upload', { method: 'POST', body: formData });
                if (resp.ok) {
                  const result = await resp.json();
                  for (const rec of (result.records || [])) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeLabel = {pdf:'PDF',doc:'Word',docx:'Word',png:'Image',jpg:'Image',jpeg:'Image',gif:'Image',bmp:'Image',tiff:'Image',webp:'Image'}[ext] || 'Document';
                    extractedText = rec.extracted_text || '';
                    newEvents.push({
                      id:`EVT-${String(eventId).padStart(4,'0')}`,
                      title: file.name.replace(/\.[^.]+$/, ''),
                      description: (rec.extracted_text || '').substring(0, 500),
                      date: new Date().toISOString().split('T')[0],
                      dateUploaded: new Date().toISOString().split('T')[0],
                      topics: [typeLabel + ' Document'],
                      people: [], organizations: [], links: [],
                      researchLevel: 1,
                      sourceType: 'Uploaded ' + typeLabel,
                      sourceSheet: file.name,
                      connections: [],
                      aiSummary: rec.status === 'pending' ? 'Text extracted ‚Äî click Analyze to run AI analysis.' : (rec.summary || ''),
                      isMajorEvent: false,
                      uploadedBy: currentUser ? currentUser.username : 'unknown',
                      isPublic: false, eventStatus: 'unverified',
                      _backendId: rec.id
                    });
                    eventId++;
                  }
                } else {
                  // Fallback: create stub event if backend is unavailable
                  const ext = file.name.split('.').pop().toLowerCase();
                  const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                  newEvents.push({ id:`EVT-${String(eventId).padStart(4,'0')}`, title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString().split('T')[0], topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - backend unavailable for extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                  eventId++;
                }
              } catch(fetchErr) {
                const ext = file.name.split('.').pop().toLowerCase();
                const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                newEvents.push({ id:`EVT-${String(eventId).padStart(4,'0')}`, title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString().split('T')[0], topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - server not running. Start the backend to enable extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                eventId++;
              }
            }
            if (extractedText && newEvents.length > 0) {
              const analysis = analyzeDocument(extractedText);
              const last = newEvents[newEvents.length-1];
              last.aiSummary = analysis.summary;
              last.topics = [...new Set([...last.topics, ...analysis.topics])];
              last.people = [...new Set([...last.people, ...analysis.people])];
              last.organizations = [...new Set([...last.organizations, ...analysis.organizations])];
            }
          }
          clearTimeout(timeout);
          if (newEvents.length > 0) {
            const updated = {
              events:[...data.events,...newEvents],
              people:Array.from(new Set([...data.people,...newEvents.flatMap(e=>e.people)])).sort(),
              organizations:Array.from(new Set([...data.organizations,...newEvents.flatMap(e=>e.organizations)])).sort(),
              topics:Array.from(new Set([...data.topics,...newEvents.flatMap(e=>e.topics)])).sort(),
              metadata:{...data.metadata, totalEvents:data.events.length+newEvents.length, lastUpdated:new Date().toISOString()}
            };
            setData(updated);
            setIsProcessing(false);
            setUploadMessage(`‚úì Successfully uploaded ${newEvents.length} event(s)!`);
            openEventModal(newEvents[0], 'upload');
            setTimeout(()=>setUploadMessage(''),5000);
          } else { setIsProcessing(false); setUploadMessage('‚ö†Ô∏è No valid data found'); setTimeout(()=>setUploadMessage(''),3000); }
        } catch(err) { clearTimeout(timeout); setIsProcessing(false); setUploadMessage(`‚ùå Error: ${err.message}`); setTimeout(()=>setUploadMessage(''),5000); }
        event.target.value='';
      };

      const handleUrlSubmit = async () => {
        if (!urlInput.trim()) return;
        setIsProcessing(true);
        setUploadMessage('Analyzing URL...');
        try {
          const isVideo = /youtube|youtu\.be|vimeo|dailymotion/i.test(urlInput);
          const newEvent = {
            id:`EVT-${String(data.events.length+1).padStart(4,'0')}`,
            title:`${isVideo?'Video':'Web'} Link: ${urlInput}`,
            description:`Content from ${urlInput}`,
            date:new Date().toISOString().split('T')[0],
            dateUploaded:new Date().toISOString().split('T')[0],
            topics:[isVideo?'Video Content':'Web Link'],
            people:[], organizations:[],
            links:[urlInput], researchLevel:1,
            sourceType:isVideo?'Video URL':'Web URL',
            sourceSheet:'URL Import', connections:[],
            aiSummary:`${isVideo?'Video':'Web'} content from ${urlInput}. AI would extract metadata, identify key topics and entities, and generate a full summary.`,
            isMajorEvent:false, isVideo,
            uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified',
            transcription: isVideo ? { chapters:[{timestamp:'0:00',title:'Introduction',text:'AI transcription would appear here'},{timestamp:'5:30',title:'Main Content',text:'Full video transcription with chapter markers'}] } : null
          };
          const updated = {
            events:[...data.events, newEvent],
            people:data.people, organizations:data.organizations,
            topics:Array.from(new Set([...data.topics, isVideo?'Video Content':'Web Link'])).sort(),
            metadata:{...data.metadata, totalEvents:data.events.length+1, lastUpdated:new Date().toISOString()}
          };
          setData(updated);
          setIsProcessing(false);
          setUploadMessage('‚úì URL added successfully!');
          setUrlInput('');
          openEventModal(newEvent, 'upload');
          setTimeout(()=>setUploadMessage(''),3000);
        } catch(err) { setIsProcessing(false); setUploadMessage(`‚ùå Error: ${err.message}`); setTimeout(()=>setUploadMessage(''),5000); }
      };

      const cancelProcessing = () => { setIsProcessing(false); setUploadMessage('Processing cancelled'); setTimeout(()=>setUploadMessage(''),2000); };

      // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
      const openEventModal = (event, fromTab) => {
        setModalData(event);
        setEditedEvent({...event});
        setIsEditing(false);
        setShowModal(true);
      };

      const openEntityDetail = (type, name) => {
        const fromTab = activeTab;
        const fromLabel = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);
        pushBreadcrumb(fromLabel, () => { setSelectedEntity(null); setActiveTab(fromTab); });
        setShowModal(false);
        setSelectedEntity({
          type, name,
          events: data.events.filter(e => {
            if (type === 'person') return (e.people||[]).includes(name);
            if (type === 'org') return (e.organizations||[]).includes(name);
            if (type === 'topic') return (e.topics||[]).includes(name);
            return false;
          })
        });
      };

      const goBack = () => {
        setSelectedEntity(null);
        setBreadcrumbs(prev => prev.slice(0,-1));
      };

      const saveEditedEvent = () => {
        const updatedEvents = data.events.map(e => e.id === editedEvent.id ? editedEvent : e);
        const allP=new Set(), allO=new Set(), allT=new Set();
        updatedEvents.forEach(e => { (e.people||[]).forEach(p=>allP.add(p)); (e.organizations||[]).forEach(o=>allO.add(o)); (e.topics||[]).forEach(t=>allT.add(t)); });
        setData({...data, events:updatedEvents, people:[...allP].sort(), organizations:[...allO].sort(), topics:[...allT].sort()});
        setModalData(editedEvent);
        setIsEditing(false);
        setUploadMessage('‚úì Event updated!');
        setTimeout(()=>setUploadMessage(''),3000);
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(()=>{ setUploadMessage('üìã Copied!'); setTimeout(()=>setUploadMessage(''),2000); });
      };

      const exportToCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source','Link'];
        const rows = filteredEvents.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType,(e.links&&e.links[0])||'']);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const exportToJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:filteredEvents,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const myExportCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source'];
        const rows = myFiltered.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType]);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };
      const myExportJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:myFiltered,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      // ‚îÄ‚îÄ Shared filter props ‚îÄ‚îÄ
      const filterProps = { filters, setFilters, data, activeTab, onSearch:applySearch, onClear:clearAllFilters, onExportCSV:exportToCSV, onExportJSON:exportToJSON };

      // ‚îÄ‚îÄ Uploads grid component (reused in tab and page) ‚îÄ‚îÄ
      const UploadsContent = () => (
        <div>
          <FiltersComponent {...filterProps} />
          {filteredMyUploads.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">üìÇ</div>
              <p>No uploads yet ‚Äî use the Upload page to add files or URLs.</p>
            </div>
          ) : (
            <div className="spreadsheet">
              <table className="table">
                <thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Visibility</th><th>Type</th><th>Date</th><th>Topics</th></tr></thead>
                <tbody>
                  {filteredMyUploads.map(e => (
                    <tr key={e.id} style={{cursor:'pointer'}}>
                      <td onClick={()=>openEventModal(e,'my uploads')}>{e.id}</td>
                      <td onClick={()=>openEventModal(e,'my uploads')} style={{fontWeight:600}}>{e.title}</td>
                      <td><span className={`status-${e.eventStatus||'unverified'}`}>{e.eventStatus==='historical_record'?'Historical Record':e.eventStatus==='contested'?'Contested':'Unverified'}</span></td>
                      <td>
                        <button onClick={()=>toggleEventPublic(e.id)} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                          <span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'üåê Public' : 'üîí Private'}</span>
                        </button>
                      </td>
                      <td><span style={{padding:'0.25rem 0.6rem',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'6px',fontSize:'0.75rem',color:'#60a5fa'}}>{e.sourceType}</span></td>
                      <td>{e.dateUploaded||'‚Äî'}</td>
                      <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );

      // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
      const modalTabLabel = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);
      const modalCrumbs = selectedEntity
          ? [
              { label: 'üè† Home', action: () => { setShowModal(false); setSelectedEntity(null); setBreadcrumbs([]); setActiveTab('timeline'); } },
              ...breadcrumbs.map((b, i) => ({ label: b.label, action: () => { setShowModal(false); goToBreadcrumb(i); } })),
              { label: selectedEntity.name, action: () => setShowModal(false) }
            ]
          : [
              { label: 'üè† Home', action: () => { setShowModal(false); navigateToTab('timeline'); } },
              { label: modalTabLabel, action: () => setShowModal(false) }
            ];
      const modalViewJSX = (!showModal || !modalData || !currentUser) ? null : (
        <div className="modal" onClick={()=>setShowModal(false)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            {/* Breadcrumb trail inside modal ‚Äî always visible, Notion/ClickUp style */}
            <div style={{display:'flex',alignItems:'center',gap:'0.3rem',marginBottom:'1.25rem',flexWrap:'wrap',borderBottom:'1px solid rgba(61,69,99,0.4)',paddingBottom:'0.75rem'}}>
              {modalCrumbs.map((crumb, i) => (
                <React.Fragment key={i}>
                  {i > 0 && <span className="bc-sep">‚Ä∫</span>}
                  <span className="bc-item" style={{fontSize:'0.8rem'}} onClick={crumb.action}>{crumb.label}</span>
                </React.Fragment>
              ))}
              <span className="bc-sep">‚Ä∫</span>
              <span className="bc-current" style={{fontSize:'0.8rem'}}>{isEditing ? 'Edit Event' : (modalData.title.length > 60 ? modalData.title.substring(0,60)+'‚Ä¶' : modalData.title)}</span>
            </div>
            <div className="modal-header">
              <h2 className="modal-title">{isEditing ? 'Edit Event' : modalData.title}</h2>
              <div className="modal-actions">
                {!isEditing && <button className="edit-btn" onClick={()=>setIsEditing(true)}>‚úèÔ∏è Edit</button>}
                {isEditing && <button className="btn btn-primary" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={saveEditedEvent}>üíæ Save</button>}
                {isEditing && <button className="btn btn-danger" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={()=>setIsEditing(false)}>Cancel</button>}
                <button className="close" onClick={()=>setShowModal(false)}>√ó</button>
              </div>
            </div>
            {!isEditing ? (
              <>
                {modalData.aiSummary && <div className="ai-summary-box"><div className="ai-summary-label">AI Summary</div><p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.aiSummary}</p></div>}
                <div style={{marginBottom:'1.5rem',lineHeight:1.8}}>
                  <strong>ID:</strong> {modalData.id}<br/>
                  <strong>Date:</strong> {modalData.date||'Unknown'}<br/>
                  <strong>Source:</strong> {modalData.sourceType}<br/>
                  <strong>Research Level:</strong> <span className={`level-${modalData.researchLevel}`}>Level {modalData.researchLevel}</span><br/>
                  <strong>Status:</strong>{' '}
                  {(currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                    <select className="status-select" style={{marginLeft:'0.5rem'}} value={modalData.eventStatus||'unverified'}
                      onChange={ev=>{updateEventStatus(modalData.id, ev.target.value); setModalData({...modalData, eventStatus:ev.target.value});}}>
                      <option value="historical_record">Historical Record</option>
                      <option value="contested">Contested</option>
                      <option value="unverified">Unverified</option>
                    </select>
                  ) : (
                    <span style={{marginLeft:'0.5rem'}}><span className={`status-${modalData.eventStatus||'unverified'}`}>{modalData.eventStatus==='historical_record'?'Historical Record':modalData.eventStatus==='contested'?'Contested':'Unverified'}</span></span>
                  )}<br/>
                  <strong>Visibility:</strong>{' '}
                  {(modalData.uploadedBy === currentUser.username || currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                    <button onClick={()=>{toggleEventPublic(modalData.id); setModalData({...modalData, isPublic:!modalData.isPublic});}} style={{background:'none',border:'none',cursor:'pointer',padding:0,marginLeft:'0.5rem'}}>
                      <span className={modalData.isPublic ? 'vis-public' : 'vis-private'}>{modalData.isPublic ? 'üåê Public ‚Äî click to make private' : 'üîí Private ‚Äî click to make public'}</span>
                    </button>
                  ) : (
                    <span style={{marginLeft:'0.5rem'}}><span className={modalData.isPublic ? 'vis-public' : 'vis-private'}>{modalData.isPublic ? 'üåê Public' : 'üîí Private'}</span></span>
                  )}
                  {(currentUser.role === 'admin' || currentUser.role === 'owner') && (
                    <><br/><button className="btn btn-danger" style={{marginTop:'0.75rem',padding:'0.3rem 0.75rem',fontSize:'0.8rem'}} onClick={()=>{if(window.confirm('Delete this event permanently?'))deleteEvent(modalData.id);}}>üóëÔ∏è Delete Event</button></>
                  )}
                </div>
                <div className="form-group"><label className="form-label">Description</label><p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.description}</p></div>
                {modalData.transcription && (
                  <div style={{background:'rgba(16,185,129,0.1)',border:'2px solid rgba(16,185,129,0.3)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#10b981',marginBottom:'1rem'}}>üìù Video Transcription</h3>
                    {modalData.transcription.chapters.map((ch,i)=>(
                      <div key={i} style={{padding:'1rem',marginBottom:'0.75rem',background:'rgba(26,31,58,0.5)',borderLeft:'4px solid #10b981',borderRadius:'8px'}}>
                        <div style={{fontWeight:700,color:'#10b981',marginBottom:'0.4rem'}}>{ch.timestamp} ‚Äî {ch.title}</div>
                        <p style={{color:'#8b92b0',fontSize:'0.875rem'}}>{ch.text}</p>
                      </div>
                    ))}
                  </div>
                )}
                {(modalData.topics||[]).length > 0 && <div className="form-group"><label className="form-label">Topics</label><div className="tags">{modalData.topics.map((t,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('topic',t);}}>{t}</span>)}</div></div>}
                {(modalData.people||[]).length > 0 && <div className="form-group"><label className="form-label">People</label><div className="tags">{modalData.people.map((p,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('person',p);}}>{p}</span>)}</div></div>}
                {(modalData.organizations||[]).length > 0 && <div className="form-group"><label className="form-label">Organizations</label><div className="tags">{modalData.organizations.map((o,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('org',o);}}>{o}</span>)}</div></div>}
                {(modalData.links||[]).length > 0 && (
                  <div className="form-group"><label className="form-label">Links</label>
                    {modalData.links.map((l,i)=>(
                      <div key={i} style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                        <a href={l} target="_blank" rel="noopener noreferrer" style={{color:'#60a5fa',wordBreak:'break-all',flex:1}}>{l}</a>
                        <button onClick={()=>copyToClipboard(l)} className="btn btn-secondary" style={{padding:'0.5rem 1rem',fontSize:'0.8rem'}}>üìã Copy</button>
                      </div>
                    ))}
                  </div>
                )}
              </>
            ) : (
              <>
                <div className="form-group"><label className="form-label">Title</label><input className="edit-input" value={editedEvent.title||''} onChange={e=>setEditedEvent({...editedEvent,title:e.target.value})} /></div>
                <div className="form-group"><label className="form-label">Description</label><textarea className="edit-input" value={editedEvent.description||''} onChange={e=>setEditedEvent({...editedEvent,description:e.target.value})} /></div>
                <div className="form-group"><label className="form-label">AI Summary</label><textarea className="edit-input" value={editedEvent.aiSummary||''} onChange={e=>setEditedEvent({...editedEvent,aiSummary:e.target.value})} /></div>
                <div className="form-group"><label className="form-label">Date</label><input type="date" className="edit-input" value={editedEvent.date||''} onChange={e=>setEditedEvent({...editedEvent,date:e.target.value})} /></div>
                <div className="form-group"><label className="form-label">Topics (comma-separated)</label><input className="edit-input" value={(editedEvent.topics||[]).join(', ')} onChange={e=>setEditedEvent({...editedEvent,topics:e.target.value.split(',').map(t=>t.trim()).filter(t=>t)})} /></div>
                <div className="form-group"><label className="form-label">People (comma-separated)</label><input className="edit-input" value={(editedEvent.people||[]).join(', ')} onChange={e=>setEditedEvent({...editedEvent,people:e.target.value.split(',').map(p=>p.trim()).filter(p=>p)})} /></div>
                <div className="form-group"><label className="form-label">Organizations (comma-separated)</label><input className="edit-input" value={(editedEvent.organizations||[]).join(', ')} onChange={e=>setEditedEvent({...editedEvent,organizations:e.target.value.split(',').map(o=>o.trim()).filter(o=>o)})} /></div>
                <div className="form-group"><label className="form-label">Research Level</label>
                  <select className="edit-input" value={editedEvent.researchLevel||1} onChange={e=>setEditedEvent({...editedEvent,researchLevel:parseInt(e.target.value)})}>
                    <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option>
                  </select>
                </div>
              </>
            )}
          </div>
        </div>
      );

      // ‚îÄ‚îÄ Account Page ‚îÄ‚îÄ
      // NOTE: accountTab, myFilters, myPageTab all live in App scope to prevent reset on re-render
      const AccountPage = () => {
        const isAdminOrOwner = currentUser.role === 'admin' || currentUser.role === 'owner';
        const myPublicCount = myUploads.filter(e => e.isPublic).length;
        const myPrivateCount = myUploads.length - myPublicCount;
        const initials = currentUser.username.substring(0, 2).toUpperCase();
        const regUser = getRegisteredUsers().find(u => u.username === currentUser.username);
        const memberSince = regUser
          ? new Date(regUser.createdAt).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' })
          : 'Built-in account';
        // Scoped data: only user's own topics/people/orgs appear in FiltersComponent checkboxes
        const userTopics = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        const userPeople = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        const userOrgs   = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        const accountScopedData = { ...data, topics: userTopics, people: userPeople, organizations: userOrgs };
        const myFilterProps = { filters: myFilters, setFilters: setMyFilters, data: accountScopedData, activeTab: myPageTab, onSearch: applyMySearch, onClear: clearMyFilters, onExportCSV: myExportCSV, onExportJSON: myExportJSON };
        const statusLabel = s => s==='historical_record'?'Historical Record':s==='contested'?'Contested':'Unverified';
        return (
          <div>
            {/* Profile card */}
            <div className="account-profile-card">
              <div className="account-avatar">{initials}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem',flexWrap:'wrap'}}>
                  <h2 style={{fontSize:'1.75rem',fontFamily:"'Space Mono',monospace",color:'#e0e6ed',margin:0}}>{currentUser.username}</h2>
                  <span className={`role-badge role-${currentUser.role}`} style={{fontSize:'0.8rem',padding:'0.3rem 0.75rem'}}>{currentUser.role}</span>
                </div>
                <div style={{color:'#8b92b0',fontSize:'0.875rem',marginBottom:'1.25rem'}}>Member since: {memberSince}</div>
                <div style={{display:'flex',gap:'2rem',flexWrap:'wrap'}}>
                  {[
                    {label:'Total Uploads', value:myUploads.length, color:'#60a5fa'},
                    {label:'Public',        value:myPublicCount,     color:'#10b981'},
                    {label:'Private',       value:myPrivateCount,    color:'#9ca3af'},
                  ].map(s=>(
                    <div key={s.label} style={{textAlign:'center'}}>
                      <div style={{fontSize:'1.5rem',fontWeight:700,color:s.color,fontFamily:"'Space Mono',monospace"}}>{s.value}</div>
                      <div style={{fontSize:'0.7rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'0.5px'}}>{s.label}</div>
                    </div>
                  ))}
                </div>
              </div>
              <button className="logout-btn" style={{alignSelf:'flex-start',padding:'0.5rem 1.25rem',fontSize:'0.875rem'}} onClick={logout}>Logout</button>
            </div>
            {/* Sub-tabs */}
            <div className="account-tabs">
              <button className={`account-tab ${accountTab==='uploads'?'active':''}`} onClick={()=>setAccountTab('uploads')}>üìÇ My Uploads</button>
              {isAdminOrOwner && (
                <button className={`account-tab ${accountTab==='admin'?'active-admin':''}`} onClick={()=>setAccountTab('admin')}>
                  üõ°Ô∏è {currentUser.role==='owner'?'Owner Panel':'Admin Panel'}
                </button>
              )}
            </div>
            {/* My Uploads ‚Äî Pages nav + FiltersComponent + page content, scoped to user's own uploads */}
            {accountTab === 'uploads' && (
              <div>
                {/* Pages section */}
                <div style={{marginBottom:'0'}}>
                  <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem'}}>Pages</div>
                  <nav className="nav">
                    {['timeline','network','spreadsheet','topics','people','organizations'].map(tab => (
                      <button key={tab} className={`nav-btn ${myPageTab===tab?'active':''}`}
                        onClick={() => setMyPageTab(tab)}>
                        {tab==='timeline'?'üìÖ':tab==='network'?'üîó':tab==='spreadsheet'?'üìä':tab==='topics'?'üè∑Ô∏è':tab==='people'?'üë§':'üèõÔ∏è'}{' '}{tab.charAt(0).toUpperCase()+tab.slice(1)}
                      </button>
                    ))}
                    <button className="nav-btn" onClick={() => setActiveTab('upload')}>
                      üì§ Upload
                    </button>
                  </nav>
                </div>

                {/* Full FiltersComponent scoped to user's uploads */}
                <FiltersComponent {...myFilterProps} />

                {/* Timeline */}
                {myPageTab === 'timeline' && (
                  <div className="timeline-wrapper">
                    <div className="timeline-container">
                      <div className="timeline-line"></div>
                      <div className="timeline-events">
                        {myTimelineEvents.length === 0 ? (
                          <div className="empty-state"><div className="empty-state-icon">üìÖ</div><p>{myUploads.length===0?'No uploads yet ‚Äî go to Upload to add events.':'No dated events match your filters.'}</p></div>
                        ) : myTimelineEvents.map((e,index) => {
                          const dateStr = String(e.date||'');
                          const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                          const prevYear = index>0 ? String(myTimelineEvents[index-1].date||'').substring(0,4) : null;
                          const showYear = index===0 || year!==prevYear;
                          return (
                            <div key={e.id} className={`timeline-event ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'account')}>
                              {showYear && <div className="timeline-year">{year}</div>}
                              <div className="timeline-icon">{e.isMajorEvent?'‚≠ê':'üìå'}</div>
                              <div className="timeline-label">{(e.title||'').substring(0,28)}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {/* Network */}
                {myPageTab === 'network' && (
                  <div className="network">
                    <div id="my-network-graph" style={{width:'100%',height:'100%',borderRadius:'16px'}}></div>
                  </div>
                )}

                {/* Spreadsheet */}
                {myPageTab === 'spreadsheet' && (
                  <div className="spreadsheet">
                    <table className="table">
                      <thead><tr><th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Status</th><th>Visibility</th></tr></thead>
                      <tbody>
                        {mySortedEvents.length === 0 ? (
                          <tr><td colSpan="8" style={{textAlign:'center',padding:'2rem',color:'#8b92b0'}}>No events match your filters.</td></tr>
                        ) : mySortedEvents.map(e=>(
                          <tr key={e.id} onClick={()=>openEventModal(e,'account')} style={{cursor:'pointer'}}>
                            <td>{e.id}</td>
                            <td style={{fontWeight:600}}>{e.title}</td>
                            <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'‚Äî'}</td>
                            <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                            <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                            <td>{e.date||'‚Äî'}</td>
                            <td><span className={`status-${e.eventStatus||'unverified'}`}>{statusLabel(e.eventStatus)}</span></td>
                            <td>
                              <button onClick={ev=>{ev.stopPropagation();toggleEventPublic(e.id);}} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                                <span className={e.isPublic?'vis-public':'vis-private'}>{e.isPublic?'üåê Public':'üîí Private'}</span>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}

                {/* Topics */}
                {myPageTab === 'topics' && (
                  <div className="grid">
                    {myFilteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">üè∑Ô∏è</div><p>No topics in your uploads yet.</p></div> :
                    myFilteredTopics.map(t=>{
                      const relEvents = myFiltered.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                      return (
                        <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                          <div className="card-title">{t.name}</div>
                          <div className="card-count">{t.count} event{t.count!==1?'s':''} ‚Üí</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* People */}
                {myPageTab === 'people' && (
                  <div className="grid">
                    {myFilteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">üë§</div><p>No people in your uploads yet.</p></div> :
                    myFilteredPeople.map(p=>{
                      const relEvents = myFiltered.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                      return (
                        <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                          <div className="card-title">{p.name}</div>
                          <div className="card-count">{p.count} event{p.count!==1?'s':''} ‚Üí</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Organizations */}
                {myPageTab === 'organizations' && (
                  <div className="grid">
                    {myFilteredOrgs.length===0 ? <div className="empty-state"><div className="empty-state-icon">üèõÔ∏è</div><p>No organizations in your uploads yet.</p></div> :
                    myFilteredOrgs.map(o=>{
                      const relEvents = myFiltered.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                      return (
                        <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                          <div className="card-title">{o.name}</div>
                          <div className="card-count">{o.count} event{o.count!==1?'s':''} ‚Üí</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            )}
            {/* Admin / Owner Panel */}
            {accountTab === 'admin' && isAdminOrOwner && <AdminPanel />}
          </div>
        );
      };

      // ‚îÄ‚îÄ Auth gate ‚îÄ‚îÄ
      if (!currentUser) {
        if (authScreen === 'signup') return <SignupScreen onGoLogin={() => setAuthScreen('login')} />;
        return <LoginScreen onLogin={login} onGoSignup={() => setAuthScreen('signup')} />;
      }

      // ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ
      const AdminPanel = () => {
        const [users, setUsers] = React.useState(getRegisteredUsers());
        const isOwner = currentUser.role === 'owner';
        const refresh = () => setUsers(getRegisteredUsers());
        const handleRoleChange = (username, newRole) => {
          updateUserRole(username, newRole);
          refresh();
        };
        const handleDelete = (username) => {
          deleteUserAccount(username);
          refresh();
        };
        const allUsers = [
          ...HARDCODED_USERS.map(u => ({ ...u, isHardcoded: true })),
          ...users
        ];
        const publicCount = data.events.filter(e => e.isPublic).length;
        const privateCount = data.events.filter(e => !e.isPublic).length;
        return (
          <div>
            <div style={{display:'flex',gap:'1.5rem',marginBottom:'2rem',flexWrap:'wrap'}}>
              {[
                { label:'Total Users', value: allUsers.length, color:'#60a5fa' },
                { label:'Public Events', value: publicCount, color:'#10b981' },
                { label:'Private Events', value: privateCount, color:'#9ca3af' },
                { label:'Total Events', value: data.events.length, color:'#a78bfa' }
              ].map(s=>(
                <div key={s.label} className="stat" style={{background:'rgba(26,31,58,0.6)',padding:'1.25rem 1.75rem',borderRadius:'12px',border:'2px solid rgba(61,69,99,0.5)'}}>
                  <span className="stat-label">{s.label}</span>
                  <span className="stat-value" style={{color:s.color,fontSize:'1.5rem'}}>{s.value}</span>
                </div>
              ))}
            </div>
            <div className="admin-section">
              <div className="admin-section-title">üë• User Management</div>
              <table className="admin-table">
                <thead><tr><th>Username</th><th>Role</th><th>Type</th><th>Joined</th><th>Actions</th></tr></thead>
                <tbody>
                  {allUsers.map(u => {
                    const isSelf = u.username === currentUser.username;
                    const isHardcodedOwner = u.role === 'owner';
                    // Admin can only change basic users; owner can change admins too (but not other owners)
                    const canChange = !u.isHardcoded && !isSelf && (isOwner ? u.role !== 'owner' : u.role === 'user');
                    return (
                      <tr key={u.username}>
                        <td style={{fontWeight:600}}>{u.username}{isSelf ? <span style={{color:'#8b92b0',fontWeight:400,marginLeft:'0.5rem'}}>(you)</span> : ''}</td>
                        <td><span className={`role-badge role-${u.role}`}>{u.role}</span></td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{u.isHardcoded ? 'Built-in' : 'Registered'}</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '‚Äî'}</td>
                        <td>
                          {canChange && (
                            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                              {u.role === 'user' && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'admin')}>‚Üë Make Admin</button>}
                              {u.role === 'admin' && isOwner && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'user')}>‚Üì Demote</button>}
                              <button className="btn btn-danger" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm(`Delete account "${u.username}"?`))handleDelete(u.username);}}>üóë Delete</button>
                            </div>
                          )}
                          {!canChange && <span style={{color:'#3d4563',fontSize:'0.8rem'}}>‚Äî</span>}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="admin-section">
              <div className="admin-section-title">üìã All Events</div>
              <table className="admin-table">
                <thead><tr><th>ID</th><th>Title</th><th>Uploaded By</th><th>Status</th><th>Visibility</th><th>Actions</th></tr></thead>
                <tbody>
                  {data.events.slice().reverse().map(e => (
                    <tr key={e.id}>
                      <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.id}</td>
                      <td style={{fontWeight:600,cursor:'pointer',color:'#60a5fa'}} onClick={()=>openEventModal(e,'admin panel')}>{(e.title||'').substring(0,50)}{e.title&&e.title.length>50?'‚Ä¶':''}</td>
                      <td style={{color:'#8b92b0'}}>{e.uploadedBy||'system'}</td>
                      <td>
                        <select className="status-select" value={e.eventStatus||'unverified'} onChange={ev=>updateEventStatus(e.id, ev.target.value)}>
                          <option value="historical_record">Historical Record</option>
                          <option value="contested">Contested</option>
                          <option value="unverified">Unverified</option>
                        </select>
                      </td>
                      <td><span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'üåê Public' : 'üîí Private'}</span></td>
                      <td>
                        <div style={{display:'flex',gap:'0.4rem'}}>
                          <button className="btn btn-secondary" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>toggleEventPublic(e.id)}>{e.isPublic ? 'Make Private' : 'Make Public'}</button>
                          <button className="btn btn-danger" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm('Delete this event?'))deleteEvent(e.id);}}>üóë</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // ‚îÄ‚îÄ Account page ‚Äî own layout (no nav bar) ‚îÄ‚îÄ
      if (activeTab === 'account') {
        return (
          <div className="app">
            <header className="header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
                <div className="user-chip">
                  <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                    <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                    <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                    <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                  </div>
                  <button className="logout-btn" onClick={logout}>Logout</button>
                </div>
              </div>
            </header>
            <div className="breadcrumb-bar">
              <span className="bc-item" onClick={()=>navigateToTab('timeline')}>üè† Home</span>
              <span className="bc-sep">‚Ä∫</span>
              <span className="bc-current">üë§ {currentUser.username}</span>
            </div>
            <main className="content">
              <AccountPage />
            </main>
            {showModal && modalData && modalViewJSX}
          </div>
        );
      }

      // ‚îÄ‚îÄ Entity Detail page ‚îÄ‚îÄ
      if (selectedEntity) {
        return (
          <div className="app">
            <header className="header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                <h1 style={{cursor:'pointer'}} onClick={()=>{ setSelectedEntity(null); navigateToTab('timeline'); }}>Historical Events Database</h1>
                <div className="user-chip">
                  <div className="user-chip-btn" onClick={()=>{ setSelectedEntity(null); navigateToTab('account'); }}>
                    <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                    <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                    <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                  </div>
                  <button className="logout-btn" onClick={logout}>Logout</button>
                </div>
              </div>
              <div className="stats">
                <div className="stat"><span className="stat-label">Total Events</span><span className="stat-value">{data.events.length}</span></div>
                <div className="stat"><span className="stat-label">People</span><span className="stat-value">{data.people.length}</span></div>
                <div className="stat"><span className="stat-label">Organizations</span><span className="stat-value">{data.organizations.length}</span></div>
                <div className="stat"><span className="stat-label">Topics</span><span className="stat-value">{data.topics.length}</span></div>
              </div>
            </header>
            <div className="breadcrumb-bar">
              <span className="bc-item" onClick={()=>{ setSelectedEntity(null); setBreadcrumbs([]); setActiveTab('timeline'); }}>üè† Home</span>
              {breadcrumbs.map((b,i) => (
                <React.Fragment key={i}>
                  <span className="bc-sep">‚Ä∫</span>
                  <span className="bc-item" onClick={()=>goToBreadcrumb(i)}>{b.label}</span>
                </React.Fragment>
              ))}
              <span className="bc-sep">‚Ä∫</span>
              <span className="bc-current">{selectedEntity.name}</span>
            </div>
            <main className="content">
              <button className="back-btn" onClick={goBack}>‚Üê Back</button>
              <div style={{marginBottom:'2rem'}}>
                <h2 style={{fontSize:'2rem',color:'#60a5fa',marginBottom:'0.5rem',fontFamily:"'Space Mono',monospace"}}>{selectedEntity.name}</h2>
                <p style={{color:'#8b92b0'}}>{selectedEntity.events.length} related event{selectedEntity.events.length!==1?'s':''}</p>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:'1.5rem'}}>
                {selectedEntity.events.map(e=>(
                  <div key={e.id} style={{background:'rgba(26,31,58,0.6)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'12px',padding:'1.5rem',cursor:'pointer',transition:'all 0.2s'}}
                    onClick={()=>openEventModal(e,'entity')}
                    onMouseEnter={ev=>ev.currentTarget.style.borderColor='#60a5fa'}
                    onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                    <div style={{color:'#60a5fa',fontSize:'0.85rem',marginBottom:'0.5rem'}}>{e.date||'Date Unknown'}</div>
                    <div style={{fontSize:'1.2rem',fontWeight:700,marginBottom:'0.75rem'}}>{e.title}</div>
                    <div style={{color:'#8b92b0',marginBottom:'1rem',lineHeight:1.5}}>{(e.description||'').substring(0,200)}{(e.description||'').length>200?'...':''}</div>
                    <div className="tags">{(e.topics||[]).slice(0,5).map((t,i)=><span key={i} className="tag">{t}</span>)}</div>
                  </div>
                ))}
              </div>
            </main>
            {showModal && modalData && modalViewJSX}
          </div>
        );
      }

      // ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ
      return (
        <div className="app">
          <header className="header">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
              <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
              <div className="user-chip">
                <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                  <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                  <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                  <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                </div>
                <button className="logout-btn" onClick={logout}>Logout</button>
              </div>
            </div>
            <div className="stats">
              <div className="stat"><span className="stat-label">Total Events</span><span className="stat-value">{data.events.length}</span></div>
              <div className="stat"><span className="stat-label">Visible</span><span className="stat-value">{filteredEvents.length}</span></div>
              <div className="stat"><span className="stat-label">People</span><span className="stat-value">{data.people.length}</span></div>
              <div className="stat"><span className="stat-label">Organizations</span><span className="stat-value">{data.organizations.length}</span></div>
              <div className="stat"><span className="stat-label">Topics</span><span className="stat-value">{data.topics.length}</span></div>
            </div>
          </header>

          {/* Breadcrumb bar */}
          <div className="breadcrumb-bar">
            <span className="bc-item" onClick={()=>navigateToTab('timeline')}>üè† Home</span>
            <span className="bc-sep">‚Ä∫</span>
            <span className="bc-current">{activeTab==='account'?`üë§ ${currentUser.username}`:activeTab.charAt(0).toUpperCase()+activeTab.slice(1)}</span>
          </div>

          <div className="controls-bar">
            <button className="save-btn" onClick={saveState}>üíæ Save Now</button>
            <span className="save-status">{saveStatus}</span>
          </div>

          <div style={{marginBottom:'0'}}>
            <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem',paddingTop:'1rem',background:'rgba(21,25,50,0.4)'}}>Pages</div>
            <nav className="nav" style={{paddingTop:'0.75rem'}}>
              {TABS.map(tab=>(
                <button key={tab} className={`nav-btn ${activeTab===tab?'active':''}`} onClick={()=>navigateToTab(tab)}>
                  {tab.charAt(0).toUpperCase()+tab.slice(1)}
                </button>
              ))}
            </nav>
          </div>

          <main className="content">
            {uploadMessage && <div className={uploadMessage.includes('‚ùå')||uploadMessage.includes('‚ö†Ô∏è')?'error-msg':'success-msg'}>{uploadMessage}</div>}

            {/* Show filters on all tabs except upload and account */}
            {activeTab !== 'upload' && activeTab !== 'account' && <FiltersComponent {...filterProps} />}

            {/* TIMELINE */}
            {activeTab === 'timeline' && (
              <div className={`timeline-wrapper ${isTimelineFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsTimelineFullscreen(!isTimelineFullscreen)}>
                  {isTimelineFullscreen?'‚úï Exit':'‚õ∂ Fullscreen'}
                </button>
                <div className="timeline-container">
                  <div className="timeline-line"></div>
                  <div className="timeline-events">
                    {timelineEvents.length===0 ? (
                      <div className="empty-state"><div className="empty-state-icon">üìÖ</div><p>No dated events to display. Try clearing filters.</p></div>
                    ) : timelineEvents.map((e,index)=>{
                      const dateStr = String(e.date||'');
                      const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                      const prevYear = index>0 ? String(timelineEvents[index-1].date||'').substring(0,4) : null;
                      const showYear = index===0 || year!==prevYear;
                      return (
                        <div key={e.id} className={`timeline-event ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'timeline')}>
                          {showYear && <div className="timeline-year">{year}</div>}
                          <div className="timeline-icon">{e.isMajorEvent?'‚≠ê':'üìå'}</div>
                          <div className="timeline-label">{(e.title||'').substring(0,28)}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* NETWORK */}
            {activeTab === 'network' && (
              <div className={`network ${isNetworkFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsNetworkFullscreen(!isNetworkFullscreen)}>
                  {isNetworkFullscreen?'‚úï Exit':'‚õ∂ Fullscreen'}
                </button>
                <div id="network-graph"></div>
              </div>
            )}

            {/* SPREADSHEET */}
            {activeTab === 'spreadsheet' && (
              <div className="spreadsheet">
                <table className="table">
                  <thead><tr><th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Source</th><th>Link</th></tr></thead>
                  <tbody>
                    {sortedEvents.map(e=>(
                      <tr key={e.id} onClick={()=>openEventModal(e,'spreadsheet')} style={{cursor:'pointer'}}>
                        <td>{e.id}</td>
                        <td style={{fontWeight:600}}>{e.title}</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'‚Äî'}</td>
                        <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                        <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                        <td>{e.date||'‚Äî'}</td>
                        <td>{e.sourceType}</td>
                        <td>
                          {e.links&&e.links[0]&&(
                            <><a href={e.links[0]} target="_blank" rel="noopener noreferrer" onClick={ev=>ev.stopPropagation()}>{e.links[0].substring(0,28)}...</a>
                            <span className="copy-link" onClick={ev=>{ev.stopPropagation();copyToClipboard(e.links[0]);}}>üìã</span></>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {/* TOPICS */}
            {activeTab === 'topics' && (
              <div className="grid">
                {filteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">üè∑Ô∏è</div><p>No topics match the current filters.</p></div> :
                filteredTopics.map(t=>{
                  const relEvents = filteredEvents.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                  return (
                    <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                      <div className="card-title">{t.name}</div>
                      <div className="card-count">{t.count} event{t.count!==1?'s':''} ‚Üí</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* PEOPLE */}
            {activeTab === 'people' && (
              <div className="grid">
                {filteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">üë§</div><p>No people match the current filters.</p></div> :
                filteredPeople.map(p=>{
                  const relEvents = filteredEvents.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                  return (
                    <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                      <div className="card-title">{p.name}</div>
                      <div className="card-count">{p.count} event{p.count!==1?'s':''} ‚Üí</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* ORGANIZATIONS */}
            {activeTab === 'organizations' && (
              <div className="grid">
                {filteredOrganizations.length===0 ? <div className="empty-state"><div className="empty-state-icon">üèõÔ∏è</div><p>No organizations match the current filters.</p></div> :
                filteredOrganizations.map(o=>{
                  const relEvents = filteredEvents.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                  return (
                    <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                      <div className="card-title">{o.name}</div>
                      <div className="card-count">{o.count} event{o.count!==1?'s':''} ‚Üí</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}‚Ä¶</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* UPLOAD */}
            {activeTab === 'upload' && (
              <div>
                <div className="upload-tabs">
                  <div className={`upload-tab ${uploadTab==='new'?'active':''}`} onClick={()=>setUploadTab('new')}>üì§ New Upload</div>
                  <div className={`upload-tab ${uploadTab==='myuploads'?'active':''}`} onClick={()=>setUploadTab('myuploads')}>üìÇ My Uploads ({myUploads.length})</div>
                </div>

                {uploadTab === 'new' ? (
                  <>
                    <div className="url-input-section">
                      <div className="url-input-header">üîó Add Website or Video Link</div>
                      <p style={{color:'#8b92b0',marginBottom:'1.5rem'}}>Paste any URL ‚Äî YouTube videos are auto-detected for transcription</p>
                      <div className="url-input-row">
                        <div className="url-input-group">
                          <label className="filter-label">URL</label>
                          <input type="url" placeholder="https://..." value={urlInput} onChange={e=>setUrlInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleUrlSubmit();}} />
                        </div>
                        <button className="btn btn-primary" onClick={handleUrlSubmit}>Add URL</button>
                      </div>
                    </div>
                    <input ref={fileInputRef} type="file" style={{display:'none'}} multiple accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" onChange={handleFileUpload} />
                    <div className="upload" onClick={()=>fileInputRef.current.click()}>
                      <div className="upload-icon">üöÄ</div>
                      <h2 style={{fontSize:'1.75rem',marginBottom:'1rem'}}>Upload Documents</h2>
                      <p style={{fontSize:'1.125rem',marginBottom:'0.5rem',color:'#a78bfa'}}>AI-powered analysis & auto-tagging</p>
                      <p style={{fontSize:'0.875rem',color:'#8b92b0'}}>Excel ¬∑ CSV ¬∑ TXT ¬∑ PDF ¬∑ Word (.docx)</p>
                    </div>
                    <div style={{margin:'1rem 0'}}>
                      <button onClick={()=>{ fetch('/api/analyze-all').then(r=>r.json()).then(d=>alert('Analysis Started ‚Äî '+d.analyzed+' document(s) analyzed, '+d.errors+' error(s)')).catch(()=>alert('Analysis Started ‚Äî server may be offline')); }} style={{width:'100%',padding:'1rem 2rem',fontSize:'1.125rem',fontWeight:700,color:'#fff',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'12px',cursor:'pointer',fontFamily:'inherit'}}>üß† Start AI Analysis</button>
                    </div>
                    <div style={{background:'rgba(26,31,58,0.6)',padding:'2.5rem',borderRadius:'16px',border:'2px solid rgba(61,69,99,0.5)'}}>
                      <h3 style={{marginBottom:'1.5rem',color:'#60a5fa',fontSize:'1.5rem'}}>ü§ñ AI Analysis Features</h3>
                      <ul style={{color:'#8b92b0',lineHeight:2,listStyle:'none'}}>
                        <li>‚úì Auto-extract topics, people, organizations, dates</li>
                        <li>‚úì Generate AI summaries for every document</li>
                        <li>‚úì Video/audio transcription with chapter markers</li>
                        <li>‚úì Smart categorization across all file types</li>
                      </ul>
                    </div>
                  </>
                ) : (
                  <UploadsContent />
                )}
              </div>
            )}

            {/* MY UPLOADS moved to Account Page */}

            {/* ADMIN PANEL (kept for backward compat but hidden from nav) */}
            {activeTab === 'admin panel' && (currentUser.role === 'admin' || currentUser.role === 'owner') && <AdminPanel />}

          </main>

          {showModal && modalData && modalViewJSX}

          {isProcessing && (
            <div className="processing-overlay">
              <div className="processing-card">
                <div className="processing-spinner"></div>
                <h3 style={{marginBottom:'1rem',color:'#60a5fa'}}>Processing...</h3>
                <p style={{marginBottom:'1.5rem',color:'#8b92b0'}}>Analyzing your files with AI</p>
                <button className="btn btn-cancel" onClick={cancelProcessing}>Cancel</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
