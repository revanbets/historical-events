<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Events Database v2.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Karla:wght@400;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Karla', sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); color: #e0e6ed; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(96,165,250,0.05) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(167,139,250,0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .app { min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }
    .fullscreen { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: #0a0e27; padding: 2rem; }
    .header { background: linear-gradient(135deg, rgba(26,31,58,0.95), rgba(45,53,97,0.95)); padding: 2rem 3rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-bottom: 3px solid rgba(96,165,250,0.3); backdrop-filter: blur(10px); }
    .header h1 { font-family: 'Space Mono', monospace; font-size: 2.5rem; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; letter-spacing: -1px; font-weight: 700; }
    .stats { display: flex; gap: 3rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .stat { display: flex; flex-direction: column; gap: 0.25rem; position: relative; padding-left: 1rem; }
    .stat::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 80%; background: linear-gradient(180deg, #60a5fa, #a78bfa); border-radius: 2px; }
    .stat-label { font-size: 0.75rem; color: #8b92b0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-value { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: bold; color: #60a5fa; }
    .breadcrumb-bar { padding: 0.6rem 3rem; background: rgba(10,14,39,0.5); border-bottom: 1px solid rgba(61,69,99,0.4); display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; min-height: 36px; }
    .bc-item { color: #60a5fa; cursor: pointer; transition: all 0.15s; padding: 0.2rem 0.4rem; border-radius: 4px; }
    .bc-item:hover { background: rgba(96,165,250,0.15); text-decoration: underline; }
    .bc-sep { color: #3d4563; font-size: 0.75rem; }
    .bc-current { color: #e0e6ed; font-weight: 600; padding: 0.2rem 0.4rem; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 3rem; background: rgba(21,25,50,0.6); border-bottom: 1px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .save-btn { padding: 0.75rem 2rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Space Mono', monospace; text-transform: uppercase; letter-spacing: 1px; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.5); }
    .save-status { font-size: 0.875rem; color: #10b981; font-weight: 600; }
    .nav { display: flex; gap: 0.75rem; padding: 1.5rem 3rem; background: rgba(21,25,50,0.4); border-bottom: 1px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(5px); }
    .nav-btn { padding: 0.875rem 1.75rem; background: rgba(26,31,58,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-weight: 600; color: #8b92b0; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-btn:hover { background: rgba(37,43,74,0.9); border-color: #60a5fa; color: #e0e6ed; transform: translateY(-2px); }
    .nav-btn.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: #0a0e27; border-color: #60a5fa; box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .content { flex: 1; padding: 2rem 3rem; }
    .filters { background: rgba(26,31,58,0.6); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 2px solid rgba(61,69,99,0.5); backdrop-filter: blur(10px); }
    .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .filters-title { font-size: 1.25rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 1px; }
    .filter-row { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .filter-group { flex: 1; min-width: 220px; }
    .filter-label { display: block; font-size: 0.875rem; color: #8b92b0; margin-bottom: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.875rem; transition: all 0.2s; font-family: 'Karla', sans-serif; }
    input:focus, select:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .search-row { display: flex; gap: 0.5rem; }
    .search-row input { flex: 1; width: auto; }
    .search-btn { padding: 0.875rem 1.5rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 0.875rem; white-space: nowrap; transition: all 0.2s; }
    .search-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: rgba(10,14,39,0.4); border-radius: 8px; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(45,53,97,0.4); border: 1px solid rgba(61,69,99,0.5); border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; user-select: none; }
    .checkbox-label:hover { background: rgba(96,165,250,0.1); border-color: #60a5fa; }
    .checkbox-label input[type="checkbox"] { margin: 0; cursor: pointer; width: 16px; height: 16px; flex-shrink: 0; }
    .checkbox-label.checked { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .btn { padding: 0.875rem 2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; box-shadow: 0 4px 12px rgba(96,165,250,0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.5); }
    .btn-secondary { background: rgba(45,53,97,0.6); color: #e0e6ed; border: 2px solid rgba(96,165,250,0.3); }
    .btn-secondary:hover { background: rgba(96,165,250,0.15); }
    .btn-danger { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .btn-cancel { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid rgba(239,68,68,0.4); }
    .fullscreen-btn { position: absolute; top: 1rem; right: 1rem; z-index: 100; }
    .timeline-wrapper { background: rgba(26,31,58,0.6); border-radius: 12px; padding: 2rem; border: 2px solid rgba(61,69,99,0.5); min-height: 520px; position: relative; overflow-x: auto; overflow-y: visible; }
    .timeline-container { position: relative; min-width: max-content; height: 460px; padding: 0 1rem; }
    .timeline-wrapper.fullscreen .timeline-container { height: calc(100vh - 8rem); }
    .timeline-line { position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: linear-gradient(90deg, transparent, #60a5fa 5%, #a78bfa 50%, #60a5fa 95%, transparent); border-radius: 2px; transform: translateY(-50%); box-shadow: 0 0 10px rgba(96,165,250,0.25); }
    .timeline-events { position: relative; display: flex; align-items: stretch; gap: 2rem; height: 100%; padding: 0 1rem; }
    .timeline-event { position: relative; width: 120px; flex-shrink: 0; cursor: pointer; transition: all 0.3s; }
    .tl-dot { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: 2px solid rgba(10,14,39,0.9); box-shadow: 0 0 8px rgba(96,165,250,0.4); transition: all 0.3s; z-index: 10; }
    .timeline-event.major .tl-dot { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 0 8px rgba(16,185,129,0.4); }
    .timeline-event:hover .tl-dot { transform: translate(-50%, -50%) scale(1.35); box-shadow: 0 0 14px rgba(96,165,250,0.6); }
    .timeline-event.major:hover .tl-dot { box-shadow: 0 0 14px rgba(16,185,129,0.6); }
    .tl-connector { position: absolute; left: 50%; transform: translateX(-50%); width: 2px; }
    .timeline-event.above .tl-connector { top: calc(50% - 41px); height: 30px; background: linear-gradient(180deg, rgba(96,165,250,0.15), rgba(96,165,250,0.5)); }
    .timeline-event.below .tl-connector { top: calc(50% + 11px); height: 30px; background: linear-gradient(180deg, rgba(96,165,250,0.5), rgba(96,165,250,0.15)); }
    .tl-card { position: absolute; left: 50%; transform: translateX(-50%); width: 110px; background: rgba(20,24,50,0.94); border: 1px solid rgba(96,165,250,0.2); border-radius: 8px; padding: 0.45rem 0.55rem; text-align: center; transition: all 0.3s; }
    .timeline-event.above .tl-card { bottom: calc(50% + 45px); }
    .timeline-event.below .tl-card { top: calc(50% + 45px); }
    .timeline-event.major .tl-card { border-color: rgba(16,185,129,0.3); }
    .timeline-event:hover .tl-card { border-color: rgba(96,165,250,0.45); background: rgba(37,43,74,0.95); box-shadow: 0 4px 16px rgba(96,165,250,0.12); }
    .timeline-event.major:hover .tl-card { border-color: rgba(16,185,129,0.5); }
    .tl-card-title { font-size: 0.67rem; color: #c0c7d8; line-height: 1.35; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-break: break-word; }
    .tl-card-date { font-size: 0.6rem; color: #60a5fa; font-family: 'Space Mono', monospace; margin-top: 0.25rem; }
    .timeline-event.major .tl-card-date { color: #10b981; }
    .tl-year { position: absolute; left: 50%; white-space: nowrap; font-family: 'Space Mono', monospace; font-size: 0.68rem; font-weight: 700; color: #7086b0; background: rgba(26,31,58,0.88); padding: 0.08rem 0.3rem; border-radius: 3px; border: 1px solid rgba(96,165,250,0.2); z-index: 5; pointer-events: none; }
    .timeline-event.above .tl-year { top: calc(50% + 10px); transform: translateX(-50%); }
    .timeline-event.below .tl-year { bottom: calc(50% + 10px); transform: translateX(-50%); }
    .network { background: rgba(26,31,58,0.6); border-radius: 16px; border: 2px solid rgba(61,69,99,0.5); height: 700px; position: relative; backdrop-filter: blur(10px); }
    #network-graph { width: 100%; height: 100%; border-radius: 16px; }
    .spreadsheet { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 1.5rem; border: 2px solid rgba(61,69,99,0.5); overflow-x: auto; backdrop-filter: blur(10px); }
    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th { background: rgba(37,43,74,0.8); padding: 1.25rem; text-align: left; font-weight: 700; color: #60a5fa; border-bottom: 3px solid rgba(61,69,99,0.8); position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .table td { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(45,53,97,0.3); }
    .table tr:hover td { background: rgba(37,43,74,0.4); }
    .table a { color: #60a5fa; text-decoration: none; }
    .table a:hover { text-decoration: underline; }
    .copy-link { margin-left: 0.5rem; cursor: pointer; color: #10b981; font-weight: bold; opacity: 0.6; }
    .copy-link:hover { opacity: 1; }
    .upload { background: linear-gradient(135deg, rgba(26,31,58,0.6), rgba(45,53,97,0.4)); border: 3px dashed rgba(96,165,250,0.3); border-radius: 16px; padding: 4rem; text-align: center; cursor: pointer; transition: all 0.4s; margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .upload:hover { border-color: #60a5fa; background: linear-gradient(135deg, rgba(37,43,74,0.8), rgba(61,69,99,0.6)); transform: scale(1.01); }
    .upload-icon { font-size: 4rem; margin-bottom: 1.5rem; }
    .upload-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .upload-tab { padding: 0.75rem 1.5rem; background: rgba(26,31,58,0.6); border: 2px solid rgba(45,53,97,0.5); border-radius: 8px; cursor: pointer; font-weight: 600; color: #8b92b0; transition: all 0.2s; }
    .upload-tab.active { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border-color: #60a5fa; }
    .url-input-section { background: rgba(26,31,58,0.8); border: 2px solid rgba(96,165,250,0.3); border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; }
    .url-input-header { font-size: 1.5rem; font-weight: 700; color: #60a5fa; margin-bottom: 1.5rem; }
    .url-input-row { display: flex; gap: 1rem; align-items: flex-end; }
    .url-input-group { flex: 1; }
    .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .processing-card { background: rgba(26,31,58,0.98); border-radius: 16px; padding: 2.5rem; max-width: 400px; border: 2px solid rgba(96,165,250,0.5); text-align: center; }
    .processing-spinner { border: 4px solid rgba(96,165,250,0.2); border-top: 4px solid #60a5fa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; border: 3px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(96,165,250,0.2); }
    .modal-title { font-size: 1.75rem; font-weight: 700; color: #60a5fa; font-family: 'Space Mono', monospace; flex: 1; line-height: 1.3; }
    .modal-actions { display: flex; gap: 0.5rem; margin-left: 1rem; flex-shrink: 0; }
    .close { background: rgba(239,68,68,0.2); border: 2px solid rgba(239,68,68,0.4); font-size: 1.5rem; color: #ef4444; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; font-weight: bold; }
    .close:hover { background: rgba(239,68,68,0.4); transform: scale(1.1); }
    .edit-btn { background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.875rem; }
    .edit-btn:hover { background: rgba(16,185,129,0.3); }
    .form-group { margin-bottom: 2rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .edit-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; }
    textarea.edit-input { min-height: 100px; resize: vertical; font-family: inherit; }
    .ai-summary-box { background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(139,92,246,0.1)); border: 2px solid rgba(167,139,250,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .ai-summary-label { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #a78bfa; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; }
    .ai-summary-label::before { content: 'ðŸ¤–'; font-size: 1.25rem; }
    .tags { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
    .tag { padding: 0.5rem 1rem; background: linear-gradient(135deg, rgba(45,53,97,0.8), rgba(61,69,99,0.8)); border-radius: 24px; font-size: 0.8125rem; color: #a78bfa; border: 2px solid rgba(167,139,250,0.3); font-weight: 600; transition: all 0.2s; cursor: pointer; }
    .tag:hover { background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(139,92,246,0.2)); border-color: #a78bfa; transform: scale(1.05); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    .card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 16px; padding: 2rem; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); }
    .card:hover { border-color: #60a5fa; transform: translateY(-4px); box-shadow: 0 8px 24px rgba(96,165,250,0.2); }
    .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: #e0e6ed; }
    .card-count { font-size: 0.875rem; color: #8b92b0; font-weight: 600; }
    .card-tags { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .card-tag { padding: 0.25rem 0.6rem; background: rgba(96,165,250,0.15); border: 1px solid rgba(96,165,250,0.3); border-radius: 12px; font-size: 0.7rem; color: #60a5fa; }
    .level-1 { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-2 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .level-3 { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .success-msg { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: #10b981; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(16,185,129,0.3); font-weight: 600; }
    .error-msg { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.2)); color: #ef4444; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(239,68,68,0.3); font-weight: 600; }
    .tooltip-wrapper { position: relative; }
    .tooltip-wrapper:hover .tooltip-content { opacity: 1 !important; pointer-events: auto !important; }
    .back-btn { padding: 0.75rem 1.5rem; background: rgba(45,53,97,0.6); border: 2px solid rgba(96,165,250,0.3); border-radius: 10px; color: #60a5fa; font-weight: 600; cursor: pointer; margin-bottom: 2rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .back-btn:hover { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
    .export-btns { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .empty-state { text-align: center; padding: 4rem 2rem; color: #8b92b0; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    /* â”€â”€ Auth screens â”€â”€ */
    .auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); }
    .auth-card { background: linear-gradient(135deg, rgba(26,31,58,0.98), rgba(45,53,97,0.98)); border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px; border: 2px solid rgba(96,165,250,0.3); box-shadow: 0 24px 80px rgba(0,0,0,0.6); }
    .auth-title { font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: 700; color: #60a5fa; margin-bottom: 0.5rem; text-align: center; }
    .auth-subtitle { color: #8b92b0; font-size: 0.875rem; margin-bottom: 2rem; text-align: center; }
    .auth-field { margin-bottom: 1.25rem; }
    .auth-label { display: block; font-size: 0.8rem; font-weight: 700; color: #8b92b0; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .auth-input { width: 100%; padding: 0.875rem; background: rgba(10,14,39,0.8); border: 2px solid rgba(45,53,97,0.5); border-radius: 10px; color: #e0e6ed; font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; }
    .auth-input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.1); }
    .auth-btn { width: 100%; padding: 0.9rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; transition: all 0.2s; font-family: 'Space Mono', monospace; letter-spacing: 0.5px; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,165,250,0.4); }
    .auth-switch { text-align: center; margin-top: 1.5rem; color: #8b92b0; font-size: 0.875rem; }
    .auth-switch span { color: #60a5fa; cursor: pointer; font-weight: 600; }
    .auth-switch span:hover { text-decoration: underline; }
    .auth-error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    .auth-success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4); color: #10b981; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    /* â”€â”€ User chip â”€â”€ */
    .user-chip { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .role-badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .role-owner { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .role-admin { background: linear-gradient(135deg, #a78bfa, #8b5cf6); color: white; }
    .role-user { background: rgba(96,165,250,0.2); color: #60a5fa; border: 1px solid rgba(96,165,250,0.4); }
    .logout-btn { padding: 0.35rem 0.875rem; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); border-radius: 6px; color: #ef4444; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(239,68,68,0.3); }
    /* â”€â”€ Event status badges (visible to all) â”€â”€ */
    .status-historical { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-contested { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .status-unverified { background: rgba(107,114,128,0.2); color: #9ca3af; border: 1px solid rgba(107,114,128,0.4); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-public { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .vis-private { background: rgba(107,114,128,0.15); color: #9ca3af; border: 1px solid rgba(107,114,128,0.3); padding: 0.2rem 0.55rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    /* â”€â”€ Admin panel â”€â”€ */
    .admin-section { background: rgba(26,31,58,0.6); border-radius: 16px; padding: 2rem; border: 2px solid rgba(167,139,250,0.2); margin-bottom: 2rem; backdrop-filter: blur(10px); }
    .admin-section-title { font-size: 1.1rem; font-weight: 700; color: #a78bfa; margin-bottom: 1.25rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .admin-table th { background: rgba(37,43,74,0.8); padding: 0.875rem 1rem; text-align: left; color: #a78bfa; border-bottom: 2px solid rgba(167,139,250,0.3); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .admin-table td { padding: 0.875rem 1rem; border-bottom: 1px solid rgba(45,53,97,0.3); vertical-align: middle; }
    .admin-table tr:hover td { background: rgba(37,43,74,0.3); }
    .role-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer; }
    .status-select { background: rgba(10,14,39,0.8); border: 1px solid rgba(45,53,97,0.6); border-radius: 6px; color: #e0e6ed; padding: 0.4rem 0.6rem; font-size: 0.8rem; cursor: pointer; font-family: inherit; }
    /* â”€â”€ Notifications â”€â”€ */
    .bell-icon { font-size: 1.4rem; display: inline-block; transform-origin: top center; line-height: 1; }
    @keyframes bellShake {
      0%,82%,100% { transform: rotate(0); }
      84% { transform: rotate(18deg); }
      86% { transform: rotate(-14deg); }
      88% { transform: rotate(10deg); }
      90% { transform: rotate(-7deg); }
      92% { transform: rotate(4deg); }
      94% { transform: rotate(-2deg); }
      96% { transform: rotate(1deg); }
    }
    .bell-shake { animation: bellShake 3s ease-in-out infinite; }
    .notif-badge { position: absolute; top: -6px; right: -8px; background: #ef4444; color: white; font-size: 0.6rem; font-weight: 800; min-width: 18px; height: 18px; border-radius: 9px; padding: 0 4px; display: flex; align-items: center; justify-content: center; border: 2px solid #0a0e27; pointer-events: none; animation: badgePop 0.3s ease-out; font-family: 'Space Mono', monospace; }
    @keyframes badgePop { 0%{transform:scale(0)} 70%{transform:scale(1.2)} 100%{transform:scale(1)} }
    .bell-btn { position: relative; background: none; border: none; cursor: pointer; padding: 0.3rem; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; }
    .bell-btn:hover { background: rgba(96,165,250,0.1); }
    .notif-item { display: flex; gap: 1rem; align-items: flex-start; padding: 1rem 1.25rem; border-radius: 12px; border: 1px solid rgba(61,69,99,0.5); background: rgba(26,31,58,0.5); transition: all 0.2s; cursor: pointer; margin-bottom: 0.5rem; position: relative; }
    .notif-item.unread { background: rgba(96,165,250,0.06); border-color: rgba(96,165,250,0.2); border-left: 3px solid #60a5fa; }
    .notif-item:hover { background: rgba(45,53,97,0.6); border-color: rgba(96,165,250,0.3); }
    .notif-item.unread:hover { background: rgba(96,165,250,0.1); }
    .notif-icon-wrap { font-size: 1.35rem; flex-shrink: 0; margin-top: 0.1rem; line-height: 1; }
    .notif-content { flex: 1; min-width: 0; }
    .notif-title { font-weight: 700; font-size: 0.9rem; color: #c0c7d8; margin-bottom: 0.2rem; }
    .notif-item.unread .notif-title { color: #ffffff; }
    .notif-message { font-size: 0.82rem; color: #8b92b0; line-height: 1.5; }
    .notif-meta { font-size: 0.72rem; color: #5a6080; margin-top: 0.3rem; }
    .notif-dismiss { background: none; border: none; color: #5a6080; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 1rem; font-weight: 700; line-height: 1; flex-shrink: 0; transition: all 0.15s; }
    .notif-dismiss:hover { color: #ef4444; background: rgba(239,68,68,0.1); }
    .notif-unread-dot { width: 8px; height: 8px; border-radius: 50%; background: #60a5fa; flex-shrink: 0; margin-top: 0.45rem; }
    .notif-filter-btn { padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-family: inherit; transition: all 0.15s; }
    /* â”€â”€ Account page â”€â”€ */
    .account-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; box-shadow: 0 4px 20px rgba(96,165,250,0.3); }
    .account-profile-card { background: linear-gradient(135deg, rgba(26,31,58,0.8), rgba(45,53,97,0.6)); border: 2px solid rgba(61,69,99,0.5); border-radius: 20px; padding: 2.5rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; backdrop-filter: blur(10px); }
    .account-tabs { display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid rgba(61,69,99,0.4); }
    .account-tab { padding: 0.875rem 1.75rem; background: none; border: none; border-bottom: 3px solid transparent; color: #8b92b0; font-weight: 700; cursor: pointer; font-size: 0.875rem; margin-bottom: -2px; transition: all 0.2s; font-family: inherit; }
    .account-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    .account-tab.active-admin { color: #a78bfa; border-bottom-color: #a78bfa; }
    .account-tab:hover { color: #e0e6ed; }
    .user-chip-btn { display: flex; align-items: center; gap: 0.6rem; background: rgba(45,53,97,0.5); border: 1px solid rgba(96,165,250,0.2); border-radius: 10px; padding: 0.4rem 0.85rem; cursor: pointer; transition: all 0.2s; }
    .user-chip-btn:hover { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.4); }
    .user-chip-avatar { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: white; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // â”€â”€â”€ SUPABASE CLIENT â”€â”€â”€
    const SUPABASE_URL = 'https://dfkxdbkjrfarjudlpqbw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRma3hkYmtqcmZhcmp1ZGxwcWJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDQzMzIsImV4cCI6MjA4NzUyMDMzMn0.A5XuY5C9X5Il6EizS84tKY1Ls3Jyl6Xmi0hKbqQg2qo';
    const supabaseClient = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
    if (!supabaseClient) console.error('Supabase JS failed to load from CDN');

    // â”€â”€â”€ ANALYSIS BACKEND URL â”€â”€â”€
    // When running locally: '' (uses relative /api/ paths)
    // When deployed: points to Render backend
    const API_BASE = window.location.hostname === 'localhost' ? '' : 'https://historical-events-api-n45u.onrender.com';

    // â”€â”€â”€ FIELD MAPPING: JS camelCase â†” Postgres snake_case â”€â”€â”€
    const toDbRow = (e) => ({
      id: e.id, title: e.title, description: e.description, date: e.date,
      date_uploaded: e.dateUploaded, topics: e.topics || [], people: e.people || [],
      organizations: e.organizations || [], links: e.links || [],
      research_level: e.researchLevel, source_type: e.sourceType || '',
      source: e.source || '', primary_source: e.primarySource || '',
      source_sheet: e.sourceSheet || '', main_link: e.mainLink || '',
      connections: e.connections || [], ai_summary: e.aiSummary || '',
      is_major_event: e.isMajorEvent || false, uploaded_by: e.uploadedBy || 'system',
      is_public: e.isPublic !== undefined ? e.isPublic : true,
      event_status: e.eventStatus || 'unverified',
      backend_id: e._backendId || null, ai_analyzed: e._aiAnalyzed || false,
      analysis_mode: e._analysisMode || '', has_frames: e._hasFrames || false,
      visual_content: e._visualContent || '', frames_data: e._framesData || [],
      transcript_file: e._transcriptFile || '', attachments: e._attachments || [],
      backend_file_name: e._backendFileName || '', is_video: e.isVideo || false,
      transcription: e.transcription || null,
    });
    const fromDbRow = (r) => ({
      id: r.id, title: r.title, description: r.description, date: r.date,
      dateUploaded: r.date_uploaded, topics: r.topics || [], people: r.people || [],
      organizations: r.organizations || [], links: r.links || [],
      researchLevel: r.research_level, sourceType: r.source_type,
      source: r.source, primarySource: r.primary_source,
      sourceSheet: r.source_sheet, mainLink: r.main_link,
      connections: r.connections || [], aiSummary: r.ai_summary,
      isMajorEvent: r.is_major_event, uploadedBy: r.uploaded_by,
      isPublic: r.is_public, eventStatus: r.event_status,
      _backendId: r.backend_id, _aiAnalyzed: r.ai_analyzed,
      _analysisMode: r.analysis_mode, _hasFrames: r.has_frames,
      _visualContent: r.visual_content, _framesData: r.frames_data || [],
      _transcriptFile: r.transcript_file, _attachments: r.attachments || [],
      _backendFileName: r.backend_file_name, isVideo: r.is_video,
      transcription: r.transcription,
    });
    const generateEventId = () => 'EVT-' + crypto.randomUUID().substring(0, 8);
    const rebuildAggregates = (events) => {
      const allP = new Set(), allO = new Set(), allT = new Set();
      events.forEach(e => { (e.people||[]).forEach(p=>allP.add(p)); (e.organizations||[]).forEach(o=>allO.add(o)); (e.topics||[]).forEach(t=>allT.add(t)); });
      return { people:[...allP].sort(), organizations:[...allO].sort(), topics:[...allT].sort() };
    };

    // â”€â”€â”€ AUTH HELPERS (Supabase-backed) â”€â”€â”€
    const findUser = async (username, password) => {
      const { data, error } = await supabaseClient
        .from('users').select('username, role').eq('username', username.toLowerCase()).eq('password', password).single();
      if (error || !data) return null;
      return { username: data.username, role: data.role };
    };
    const getAllUsers = async () => {
      const { data, error } = await supabaseClient.from('users').select('username, role, created_at').order('created_at');
      return error ? [] : data;
    };

    // â”€â”€â”€ NORMALIZE DATA (adds auth fields to existing events) â”€â”€â”€
    const normalizeData = (raw) => ({
      ...raw,
      events: raw.events.map(e => ({
        uploadedBy: 'system', isPublic: true, eventStatus: 'historical_record', ...e
      }))
    });

    // â”€â”€â”€ LOGIN SCREEN â”€â”€â”€
    const LoginScreen = ({ onLogin, onGoSignup }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async () => {
        if (!username.trim() || !password.trim()) { setError('Please fill in all fields.'); return; }
        setLoading(true); setError('');
        const user = await findUser(username.trim(), password.trim());
        setLoading(false);
        if (!user) { setError('Invalid username or password.'); return; }
        onLogin(user);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Historical Events DB</div>
              <div className="auth-subtitle">Sign in to access the database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Enter username" value={username}
                onChange={e=>setUsername(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Enter password" value={password}
                onChange={e=>setPassword(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit} disabled={loading}>{loading ? 'Signing in...' : 'Sign In â†’'}</button>
            <div className="auth-switch">Don't have an account? <span onClick={onGoSignup}>Create one</span></div>
          </div>
        </div>
      );
    };

    // â”€â”€â”€ SIGNUP SCREEN â”€â”€â”€
    const SignupScreen = ({ onGoLogin }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async () => {
        if (!username.trim() || !password.trim() || !confirm.trim()) { setError('Please fill in all fields.'); return; }
        if (username.trim().length < 3) { setError('Username must be at least 3 characters.'); return; }
        if (password.length < 6) { setError('Password must be at least 6 characters.'); return; }
        if (password !== confirm) { setError('Passwords do not match.'); return; }
        setLoading(true); setError('');
        // Check if username already exists
        const { data: existing } = await supabaseClient.from('users').select('username').eq('username', username.trim().toLowerCase()).single();
        if (existing) { setLoading(false); setError('Username already taken.'); return; }
        // Insert new user
        const { error: insertErr } = await supabaseClient.from('users').insert([{ username: username.trim().toLowerCase(), password, role: 'user' }]);
        setLoading(false);
        if (insertErr) { setError('Registration failed: ' + insertErr.message); return; }
        setSuccess('Account created! Redirecting to sign inâ€¦'); setError('');
        // Notify admins/owner of new registration
        supabaseClient.from('notifications').insert([{
          type: 'new_user', title: 'New User Registered',
          message: `${username.trim().toLowerCase()} just created a new account.`,
          created_by: username.trim().toLowerCase(), created_by_role: 'user',
          event_id: null, metadata: {}, read_by: [], dismissed_by: [],
        }]).catch(()=>{});
        setTimeout(() => onGoLogin(), 1500);
      };
      return (
        <div className="auth-screen">
          <div className="auth-card">
            <div style={{marginBottom:'2rem'}}>
              <div className="auth-title">Create Account</div>
              <div className="auth-subtitle">Join the Historical Events Database</div>
            </div>
            {error && <div className="auth-error">{error}</div>}
            {success && <div className="auth-success">{success}</div>}
            <div className="auth-field">
              <label className="auth-label">Username</label>
              <input className="auth-input" type="text" placeholder="Min. 3 characters" value={username}
                onChange={e=>setUsername(e.target.value)} autoFocus />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder="Min. 6 characters" value={password}
                onChange={e=>setPassword(e.target.value)} />
            </div>
            <div className="auth-field">
              <label className="auth-label">Confirm Password</label>
              <input className="auth-input" type="password" placeholder="Re-enter password" value={confirm}
                onChange={e=>setConfirm(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')submit();}} />
            </div>
            <button className="auth-btn" onClick={submit} disabled={loading}>{loading ? 'Creating...' : 'Create Account'}</button>
            <div className="auth-switch">Already have an account? <span onClick={onGoLogin}>Sign in</span></div>
          </div>
        </div>
      );
    };

    const EMBEDDED_DATA = {"events":[{"id":"EVT-0001","title":"Are we all breathing SMART dust?","description":"everything can be done with smart dust, eventually you'll breathe it, but because it isn't mass manufactured yet you prob aren't breathing it YET","date":null,"dateUploaded":"2026-02-12","topics":["Nano particles","smart dust","CYBORG","MERGING WITH MACHINES","micro particles"],"people":[],"organizations":["Brite Innovation"],"links":["https://brite.ikeinstitute.org/brite_innovation_review_issue_31_winter_2023/are_we_all_breathing_smart_dust"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article discussing smart dust and nano particles technology. RAND developed microelectromechanical systems (MEMS) that can monitor anything anywhere."},{"id":"EVT-0002","title":"Chemtrails: What In The World Are They Spraying?","description":"documentary on chemtrails and geoengineering","date":"2010-01-01","dateUploaded":"2026-02-12","topics":["chemtrails","Geoengineering"],"people":[],"organizations":[],"links":["https://www.youtube.com/watch?v=jf0khstYDLA"],"researchLevel":2,"sourceType":"Documentary","sourceSheet":"Sheet1","connections":[],"aiSummary":"Documentary exploring chemtrails and geoengineering programs, examining what is being sprayed in the atmosphere."},{"id":"EVT-0003","title":"CIA Document 1035-960: Concerning Criticism of the Warren Report","description":"CIA coins the term 'conspiracy theory' to discredit critics of the Warren Commission","date":"1967-01-01","dateUploaded":"2026-02-12","topics":["CIA","conspiracy theory","Warren Commission","JFK"],"people":[],"organizations":["Central Intelligence Agency (CIA)"],"links":[],"researchLevel":3,"sourceType":"Declassified Document","sourceSheet":"Sheet1","connections":[],"aiSummary":"Declassified CIA document that is widely credited with popularizing the term 'conspiracy theory' as a way to discredit critics of the Warren Commission report on JFK's assassination."},{"id":"EVT-0004","title":"COVID-19 Lab Leak Theory","description":"Evidence suggests COVID-19 may have originated from a laboratory in Wuhan, China rather than natural transmission","date":"2020-01-01","dateUploaded":"2026-02-12","topics":["COVID-19","lab leak","Wuhan","biological weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Article","sourceSheet":"Covid","connections":[],"aiSummary":"Analysis of COVID-19 origins and the lab leak hypothesis. Multiple intelligence agencies now assess this as the likely origin."},{"id":"EVT-0005","title":"Direct Energy Weapon Patent","description":"Patent for directed energy weapon technology used by military","date":"1990-01-01","dateUploaded":"2026-02-12","topics":["Directed Energy Weapons (DEW)","military technology","weapons"],"people":[],"organizations":[],"links":[],"researchLevel":2,"sourceType":"Patent","sourceSheet":"Direct energy weapon","connections":[],"aiSummary":"Patent covering directed energy weapon systems including microwave and laser-based weapons."},{"id":"EVT-0006","title":"Election of President Abraham Lincoln","description":"Abraham Lincoln served as the 16th President of the United States from 1861-03-04 to 1865-04-15.","date":"1861-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Abraham Lincoln"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Abraham Lincoln as the 16th President. Led the country through the Civil War and issued the Emancipation Proclamation.","isMajorEvent":true},{"id":"EVT-0007","title":"Election of President Barack Obama","description":"Barack Obama served as the 44th President of the United States from 2009-01-20 to 2017-01-20.","date":"2009-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Barack Obama"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Barack Obama as the 44th President and first African-American president of the United States.","isMajorEvent":true},{"id":"EVT-0008","title":"Election of President Bill Clinton","description":"Bill Clinton served as the 42nd President of the United States from 1993-01-20 to 2001-01-20.","date":"1993-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Bill Clinton"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Bill Clinton as the 42nd President of the United States.","isMajorEvent":true},{"id":"EVT-0009","title":"Election of President Donald Trump","description":"Donald Trump served as the 45th President of the United States from 2017-01-20 to 2021-01-20, and was elected again as the 47th President in 2024.","date":"2017-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Donald Trump"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Donald Trump as the 45th President.","isMajorEvent":true},{"id":"EVT-0010","title":"Election of President Dwight D. Eisenhower","description":"Dwight D. Eisenhower served as the 34th President of the United States from 1953-01-20 to 1961-01-20.","date":"1953-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Dwight D. Eisenhower"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Dwight D. Eisenhower. Famously warned about the military-industrial complex in his farewell address.","isMajorEvent":true},{"id":"EVT-0011","title":"Election of President Franklin D. Roosevelt","description":"Franklin D. Roosevelt served as the 32nd President of the United States from 1933-03-04 to 1945-04-12.","date":"1933-03-04","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Franklin D. Roosevelt"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Franklin D. Roosevelt. Led the country through the Great Depression and World War II.","isMajorEvent":true},{"id":"EVT-0012","title":"Election of President George W. Bush","description":"George W. Bush served as the 43rd President of the United States from 2001-01-20 to 2009-01-20.","date":"2001-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","9/11"],"people":["George W. Bush"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of George W. Bush. His presidency was defined by the 9/11 attacks and subsequent War on Terror.","isMajorEvent":true},{"id":"EVT-0013","title":"Election of President George Washington","description":"George Washington served as the 1st President of the United States from 1789-04-30 to 1797-03-04.","date":"1789-04-30","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","Founding Fathers"],"people":["George Washington"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Inauguration of George Washington as the first President of the United States and Founding Father.","isMajorEvent":true},{"id":"EVT-0014","title":"Election of President Harry S. Truman","description":"Harry S. Truman served as the 33rd President of the United States from 1945-04-12 to 1953-01-20.","date":"1945-04-12","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Harry S. Truman"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Harry S. Truman became President after FDR's death. Authorized use of atomic bombs on Japan and oversaw end of WWII.","isMajorEvent":true},{"id":"EVT-0015","title":"Election of President Joe Biden","description":"Joe Biden served as the 46th President of the United States from 2021-01-20 to 2025-01-20.","date":"2021-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics"],"people":["Joe Biden"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of Joe Biden as the 46th President.","isMajorEvent":true},{"id":"EVT-0016","title":"Election of President John F. Kennedy","description":"John F. Kennedy served as the 35th President of the United States from 1961-01-20 to 1963-11-22.","date":"1961-01-20","dateUploaded":"2026-02-14","topics":["US President","Presidential Election","American History","Politics","JFK","assassination"],"people":["John F. Kennedy"],"organizations":["United States Government"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Presidents","connections":[],"aiSummary":"Presidential inauguration of JFK. His assassination in 1963 remains one of history's most debated events.","isMajorEvent":true},{"id":"EVT-0017","title":"Gulf War","description":"Gulf War was a major military conflict involving the United States and coalition forces against Iraq, lasting from 1991-01-17 to 1991-02-28.","date":"1991-01-17","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Gulf War","Middle East"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Gulf War (Operation Desert Storm). Coalition forces expelled Iraq from Kuwait.","isMajorEvent":true},{"id":"EVT-0018","title":"Iraq War","description":"Iraq War was a major military conflict involving the United States, lasting from 2003-03-20 to 2011-12-15. Launched after claims of weapons of mass destruction.","date":"2003-03-20","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Iraq War","Middle East","weapons of mass destruction"],"people":[],"organizations":["United States Armed Forces","Central Intelligence Agency (CIA)"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Iraq War. Launched based on disputed WMD claims. No WMDs were found.","isMajorEvent":true},{"id":"EVT-0019","title":"Korean War","description":"Korean War was a major military conflict involving the United States, lasting from 1950-06-25 to 1953-07-27.","date":"1950-06-25","dateUploaded":"2026-02-14","topics":["War","Military Conflict","American History","Korean War"],"people":[],"organizations":["United States Armed Forces"],"links":[],"researchLevel":1,"sourceType":"Historical Record","sourceSheet":"US Wars","connections":[],"aiSummary":"Major military conflict: Korean War, often called 'The Forgotten War'. Ended in armistice, not a peace treaty.","isMajorEvent":true},{"id":"EVT-0020","title":"October Surprise: A Four-Decade Secret","description":"Media now admits October Surprise is real â€” proof that the CIA and intelligence agencies will interfere with elections","date":"2023-03-28","dateUploaded":"2026-02-12","topics":["October Surprise","CIA","Ronald Reagan","Jimmy Carter","election fraud","election interference"],"people":["Jimmy Carter","Ronald Reagan"],"organizations":["New York Times (NYT)","The Intercept","Central Intelligence Agency (CIA)"],"links":["https://www.nytimes.com/2023/03/18/us/politics/jimmy-carter-october-surprise-iran-hostages.html","https://theintercept.com/2023/03/24/october-surprise-ben-barnes/"],"researchLevel":1,"sourceType":"Article","sourceSheet":"Sheet1","connections":[],"aiSummary":"Article in NYT confirming the October Surprise â€” that Reagan's 1980 campaign secretly negotiated with Iran to delay hostage release to undermine Carter's re-election."}],"people":["Abraham Lincoln","Barack Obama","Bill Clinton","Donald Trump","Dwight D. Eisenhower","Franklin D. Roosevelt","George W. Bush","George Washington","Harry S. Truman","Jimmy Carter","Joe Biden","John F. Kennedy","Ronald Reagan"],"organizations":["Brite Innovation","Central Intelligence Agency (CIA)","New York Times (NYT)","The Intercept","United States Armed Forces","United States Government"],"topics":["9/11","American History","CYBORG","CIA","COVID-19","Directed Energy Weapons (DEW)","Founding Fathers","Geoengineering","Gulf War","Iraq War","JFK","Jimmy Carter","Korean War","MERGING WITH MACHINES","Middle East","Military Conflict","Nano particles","October Surprise","Politics","Presidential Election","Ronald Reagan","US President","War","Warren Commission","Wuhan","assassination","biological weapons","chemtrails","conspiracy theory","election fraud","election interference","lab leak","micro particles","military technology","smart dust","weapons of mass destruction"],"metadata":{"totalEvents":20,"totalPeople":13,"totalOrganizations":6,"totalTopics":36,"lastUpdated":"2026-02-16T12:00:00.000Z"}};

    // â”€â”€â”€ FILTERS COMPONENT (defined OUTSIDE App so it never remounts on keypress) â”€â”€â”€
    // â”€â”€ Multi-Select Dropdown Component â”€â”€
    const MultiSelectDropdown = ({ options, selected, onChange, placeholder }) => {
      const [open, setOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [newValue, setNewValue] = React.useState('');
      const ref = React.useRef(null);
      React.useEffect(() => {
        const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
      }, []);
      const filtered = (options||[]).filter(o => o.toLowerCase().includes(search.toLowerCase()) && !selected.includes(o));
      const toggle = (val) => {
        if (selected.includes(val)) onChange(selected.filter(v => v !== val));
        else onChange([...selected, val]);
      };
      const addNew = () => {
        const v = newValue.trim();
        if (v && !selected.includes(v)) { onChange([...selected, v]); setNewValue(''); setSearch(''); }
      };
      return React.createElement('div', { ref, style: { position: 'relative' } },
        React.createElement('div', {
          style: { minHeight: '38px', padding: '0.3rem 0.5rem', background: 'rgba(26,31,58,0.5)', border: '1px solid rgba(61,69,99,0.5)', borderRadius: '8px', cursor: 'pointer', display: 'flex', flexWrap: 'wrap', gap: '0.3rem', alignItems: 'center' },
          onClick: () => setOpen(!open)
        },
          ...(selected.length > 0 ? selected.map(v =>
            React.createElement('span', { key: v, style: { display: 'inline-flex', alignItems: 'center', gap: '0.25rem', padding: '0.15rem 0.5rem', background: 'rgba(96,165,250,0.15)', border: '1px solid rgba(96,165,250,0.3)', borderRadius: '6px', fontSize: '0.8rem', color: '#60a5fa' } },
              v,
              React.createElement('span', { onClick: (e) => { e.stopPropagation(); toggle(v); }, style: { cursor: 'pointer', color: '#f87171', fontWeight: 700, marginLeft: '0.2rem' } }, 'Ã—')
            )
          ) : [React.createElement('span', { key: '_ph', style: { color: '#6b7394', fontSize: '0.85rem' } }, placeholder || 'Select...')]),
        ),
        open && React.createElement('div', {
          style: { position: 'absolute', top: '100%', left: 0, right: 0, zIndex: 1000, background: '#1a1f3a', border: '1px solid rgba(61,69,99,0.7)', borderRadius: '8px', marginTop: '4px', maxHeight: '200px', overflow: 'auto', boxShadow: '0 8px 24px rgba(0,0,0,0.4)' }
        },
          React.createElement('div', { style: { padding: '0.4rem', borderBottom: '1px solid rgba(61,69,99,0.3)', display: 'flex', gap: '0.3rem' } },
            React.createElement('input', {
              value: search || newValue, onChange: (e) => { setSearch(e.target.value); setNewValue(e.target.value); },
              onKeyDown: (e) => { if (e.key === 'Enter') { e.preventDefault(); addNew(); } },
              placeholder: 'Search or add new...', autoFocus: true, onClick: (e) => e.stopPropagation(),
              style: { flex: 1, padding: '0.3rem 0.5rem', background: 'rgba(26,31,58,0.8)', border: '1px solid rgba(61,69,99,0.5)', borderRadius: '6px', color: '#e0e6ed', fontSize: '0.8rem', fontFamily: 'inherit', outline: 'none' }
            }),
            newValue.trim() && !options.includes(newValue.trim()) && !selected.includes(newValue.trim()) && React.createElement('button', {
              onClick: (e) => { e.stopPropagation(); addNew(); },
              style: { padding: '0.3rem 0.6rem', background: '#10b981', color: '#fff', border: 'none', borderRadius: '6px', fontSize: '0.75rem', cursor: 'pointer', fontWeight: 600, whiteSpace: 'nowrap' }
            }, '+ Add')
          ),
          ...filtered.slice(0, 50).map(o =>
            React.createElement('div', {
              key: o, onClick: (e) => { e.stopPropagation(); toggle(o); },
              style: { padding: '0.35rem 0.75rem', cursor: 'pointer', fontSize: '0.8rem', color: '#c0c7d8', borderBottom: '1px solid rgba(61,69,99,0.15)' },
              onMouseEnter: (e) => e.currentTarget.style.background = 'rgba(96,165,250,0.1)',
              onMouseLeave: (e) => e.currentTarget.style.background = 'transparent',
            }, o)
          ),
          filtered.length === 0 && !newValue.trim() && React.createElement('div', { style: { padding: '0.5rem 0.75rem', color: '#6b7394', fontSize: '0.8rem', fontStyle: 'italic' } }, 'No options found')
        )
      );
    };

    // â”€â”€ Research Companion Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Defined OUTSIDE App to prevent a conditional React.useState hook violation.
    // (Calling useState inside a conditional IIFE corrupts hook order â†’ white screen.)
    const _COMPANION_URL    = 'https://historical-events-databse.netlify.app/research-companion.html';
    const _EXT_ZIP_URL      = 'https://historical-events-databse.netlify.app/hdb-extension.zip';
    const _COMPANION_BM_SRC = `javascript:(function(){var sel='';try{sel=window.getSelection().toString().trim();}catch(e){}var tc='';try{var v=document.querySelector('video');if(v&&!isNaN(v.currentTime)){var s=Math.floor(v.currentTime);tc=Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);}}catch(e){}var d={url:location.href,title:document.title,text:sel,timecode:tc,ts:Date.now()};var w=window.open('','hdb_companion');if(w&&w.location&&w.location.href.indexOf('research-companion')!==-1){w.postMessage({type:'HDB_CAPTURE',data:d},'*');w.focus();}else{var encoded=encodeURIComponent(JSON.stringify(d));window.open('${_COMPANION_URL}#bm='+encoded,'hdb_companion','width=450,height=680,resizable=yes,scrollbars=yes');}})();`;


    // â”€â”€ Research Sessions Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Full-featured top-level page: view all sessions + AI pipeline to save them.
    // Defined outside App (same pattern as CompanionPage) to avoid hook violations.
    const ResearchSessionsPage = ({ currentUser }) => {
      const [rsSessions, setRsSessions] = React.useState([]);
      const [rsLoading, setRsLoading] = React.useState(true);
      const [rsLoaded, setRsLoaded] = React.useState(false);
      const [rsExpanded, setRsExpanded] = React.useState(null);
      const [rsSaving, setRsSaving] = React.useState({});
      const [rsCaptureModal, setRsCaptureModal] = React.useState(null);
      const [rsCaptureAnalyzing, setRsCaptureAnalyzing] = React.useState(false);
      const [rsCaptureAiResult, setRsCaptureAiResult] = React.useState(null);
      const [rsTrailModal, setRsTrailModal] = React.useState(null);
      const [rsSelectMode, setRsSelectMode] = React.useState(false);
      const [rsSelected, setRsSelected] = React.useState(new Set());
      const [rsCombining, setRsCombining] = React.useState(false);

      async function rsLoad() {
        setRsLoading(true);
        try {
          const { data: rows, error } = await supabaseClient
            .from('research_sessions')
            .select('*')
            .eq('uploaded_by', currentUser.username)
            .order('started_at', { ascending: false });
          if (!error && rows) setRsSessions(rows);
        } catch(e) { /* table may not exist yet */ }
        setRsLoading(false);
        setRsLoaded(true);
      }

      React.useEffect(() => { rsLoad(); }, []);

      async function rsSaveToDb(sess) {
        const sid   = sess.id;
        const caps  = Array.isArray(sess.captured_items) ? sess.captured_items : [];
        const trl   = Array.isArray(sess.trail)          ? sess.trail          : [];
        const uname = currentUser.username;

        function prog(msg) {
          setRsSaving(s => ({ ...s, [sid]: { ...s[sid], progress: msg, done: false } }));
        }
        setRsSaving(s => ({ ...s, [sid]: { progress: 'Starting\u2026', done: false, created: 0 } }));
        let created = 0;

        function rsIsVideo(url) {
          return !!(url && (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('vimeo.com')));
        }
        function rsGenId() {
          const a = new Uint8Array(8);
          crypto.getRandomValues(a);
          return 'EVT-' + Array.from(a, b => b.toString(16).padStart(2,'0')).join('');
        }

        // â”€â”€ Process captured items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for (let i = 0; i < caps.length; i++) {
          const c = caps[i];
          prog('Analyzing capture ' + (i+1) + ' of ' + caps.length + '\u2026');
          try {
            let ai = null;
            if (c.url) {
              const r = await fetch(API_BASE + '/api/analyze-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: c.url, mode: 'full', skip_frames: true,
                  skip_analysis: false, search_focus: c.text || '' })
              });
              if (r.ok) { const d = await r.json(); ai = d.record || d; }
            }
            let title = c.pageTitle || c.url || 'Captured item';
            if (c.text) { const fl = c.text.split('\n')[0].trim().slice(0,120); if (fl.length > 10) title = fl; }
            if (ai && ai.title) title = ai.title;
            const ev = {
              id: rsGenId(), title,
              description: c.text || (ai && ai.description) || '',
              date: '', date_uploaded: new Date().toISOString(),
              topics: (ai && ai.topics) || [], people: (ai && ai.people) || [],
              organizations: (ai && ai.organizations) || [],
              links: c.url ? [c.url] : [], research_level: 2,
              source_type: 'Session Capture',
              source: c.pageTitle || sess.session_name || '',
              primary_source: '', source_sheet: '', main_link: c.url || '',
              connections: [], ai_summary: (ai && ai.summary) || '',
              is_major_event: false, uploaded_by: uname, is_public: true,
              event_status: 'unverified',
              backend_id: (ai && ai.id) || null,
              ai_analyzed: !!ai, analysis_mode: ai ? 'url' : null,
              has_frames: !!(c.frames && c.frames.length > 0), frames_data: c.frames || [], visual_content: '',
              transcript_file: null, attachments: [], backend_file_name: null,
              is_video: rsIsVideo(c.url),
              transcription: c.timecode ? { timecode: c.timecode, timecodeEnd: c.timecodeEnd || null, url: c.url } : null
            };
            await supabaseClient.from('events').insert(ev);
            created++;
          } catch(e) { console.warn('[HDB] Capture save failed:', e.message); }
        }

        // â”€â”€ Process trail-only pages (skip pause/resume markers) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const capUrls = new Set(caps.map(c => c.url).filter(Boolean));
        const trailOnly = trl.filter(t => t.url && !capUrls.has(t.url) && t.type !== 'pause' && t.type !== 'resume');
        for (let i = 0; i < trailOnly.length; i++) {
          const t = trailOnly[i];
          prog('Analyzing trail page ' + (i+1) + ' of ' + trailOnly.length + '\u2026');
          try {
            const r = await fetch(API_BASE + '/api/analyze-url', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: t.url, mode: 'full', skip_frames: true, skip_analysis: false })
            });
            if (!r.ok) continue;
            const d = await r.json();
            const ai = d.record || d;
            if (!ai || !ai.title) continue; // skip uninformative pages
            const ev = {
              id: rsGenId(), title: ai.title || t.title || t.url,
              description: ai.description || '',
              date: '', date_uploaded: new Date().toISOString(),
              topics: ai.topics || [], people: ai.people || [],
              organizations: ai.organizations || [],
              links: [t.url], research_level: 2,
              source_type: 'Session Trail',
              source: t.title || sess.session_name || '',
              primary_source: '', source_sheet: '', main_link: t.url,
              connections: [], ai_summary: ai.summary || '',
              is_major_event: false, uploaded_by: uname, is_public: true,
              event_status: 'unverified',
              backend_id: ai.id || null,
              ai_analyzed: true, analysis_mode: 'url',
              has_frames: false, frames_data: [], visual_content: '',
              transcript_file: null, attachments: [], backend_file_name: null,
              is_video: rsIsVideo(t.url), transcription: null
            };
            await supabaseClient.from('events').insert(ev);
            created++;
          } catch(e) { console.warn('[HDB] Trail save failed:', e.message); }
        }

        setRsSaving(s => ({ ...s, [sid]: { done: true, created, progress: '' } }));
      }

      async function rsCombineSelected() {
        const selected = rsSessions.filter(s => rsSelected.has(s.id));
        if (selected.length < 2) return;
        setRsCombining(true);
        const allTrail = selected.flatMap(s => Array.isArray(s.trail) ? s.trail : []);
        const trailByUrl = new Map();
        allTrail.forEach(t => { if (t.url && !trailByUrl.has(t.url)) trailByUrl.set(t.url, t); });
        const mergedTrail = Array.from(trailByUrl.values()).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        const allCaptures = selected.flatMap(s => Array.isArray(s.captured_items) ? s.captured_items : []);
        const capKeys = new Set();
        const mergedCaptures = allCaptures.filter(c => {
          const key = c.id || (c.url + '||' + (c.text||'').slice(0,60));
          if (capKeys.has(key)) return false;
          capKeys.add(key); return true;
        });
        const names = selected.map(s => s.session_name || 'Unnamed').join(' + ');
        const starts = selected.map(s => s.started_at).filter(Boolean).sort();
        const ends = selected.map(s => s.ended_at).filter(Boolean).sort();
        const newSess = {
          session_name: 'Combined: ' + names,
          uploaded_by: currentUser.username,
          started_at: starts[0] || new Date().toISOString(),
          ended_at: ends[ends.length-1] || new Date().toISOString(),
          trail: mergedTrail,
          captured_items: mergedCaptures
        };
        try {
          await supabaseClient.from('research_sessions').insert(newSess);
          setRsSelectMode(false);
          setRsSelected(new Set());
          await rsLoad();
        } catch(e) { console.error('[HDB] Combine failed:', e); }
        setRsCombining(false);
      }

      async function rsCaptureAnalyze(capture) {
        setRsCaptureAnalyzing(true);
        setRsCaptureAiResult(null);
        try {
          const r = await fetch(API_BASE + '/api/analyze-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: capture.url, mode: 'full', skip_frames: true, skip_analysis: false, search_focus: capture.text || '' })
          });
          if (r.ok) { const d = await r.json(); setRsCaptureAiResult(d.record || d); }
        } catch(e) { console.warn('[HDB] Single capture analysis failed:', e); }
        setRsCaptureAnalyzing(false);
      }

      const fmtDate = iso => iso
        ? new Date(iso).toLocaleString('en-US', { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' })
        : '';

      return (
        <div style={{padding:'1.5rem 2rem', maxWidth:'860px'}}>
          {/* Header */}
          <div style={{display:'flex', alignItems:'center', gap:'0.75rem', marginBottom:'1rem', flexWrap:'wrap'}}>
            <span style={{fontSize:'1.1rem', fontWeight:700, color:'#e2e8f8'}}>&#128506; Research Sessions</span>
            <span style={{fontSize:'0.72rem', color:'#8b92b0', background:'rgba(96,165,250,0.08)', border:'1px solid rgba(96,165,250,0.2)', borderRadius:'6px', padding:'2px 8px'}}>Chrome Extension &amp; Companion App</span>
          {rsSelectMode && rsSelected.size >= 2 && (
            <button onClick={rsCombineSelected} disabled={rsCombining}
              style={{background:'linear-gradient(135deg,#3b82f6,#6366f1)', border:'none', borderRadius:'6px', color:'white', fontSize:'0.75rem', fontWeight:700, padding:'4px 12px', cursor:'pointer', opacity:rsCombining?0.6:1}}>
              {rsCombining ? 'Combining\u2026' : '\uD83D\uDD17 Combine ' + rsSelected.size + ' Sessions'}
            </button>
          )}
          <button onClick={()=>{ setRsSelectMode(m=>!m); setRsSelected(new Set()); }}
            style={{background: rsSelectMode ? 'rgba(96,165,250,0.15)' : 'transparent', border:'1px solid rgba(96,165,250,0.25)', borderRadius:'6px', color:'#60a5fa', fontSize:'0.75rem', fontWeight: rsSelectMode ? 700 : 400, padding:'4px 10px', cursor:'pointer'}}>
            {rsSelectMode ? '\u2715 Cancel' : '\u2610 Select to Combine'}
          </button>
          <button onClick={()=>{setRsLoaded(false);setRsSessions([]);rsLoad();}}
            style={{marginLeft: rsSelectMode ? '0' : 'auto', background:'transparent', border:'1px solid rgba(96,165,250,0.25)', borderRadius:'6px', color:'#60a5fa', fontSize:'0.75rem', padding:'4px 10px', cursor:'pointer'}}>&#8635; Refresh</button>
          </div>
          <p style={{fontSize:'0.82rem', color:'#8b92b0', marginBottom:'1.5rem', lineHeight:1.6, maxWidth:'700px'}}>
            Sessions are saved when you click <strong style={{color:'#c0c7d8'}}>"End Session"</strong> in the Chrome Extension or Research Companion app.
            Expand a session and click <strong style={{color:'#c0c7d8'}}>"Analyze &amp; Save"</strong> to run AI over every page and captured item &mdash;
            creating full event records with topics, people, organizations, and links.
          </p>

          {rsLoading && <div style={{color:'#8b92b0', fontSize:'0.85rem', padding:'1rem 0'}}>Loading sessions&hellip;</div>}

          {!rsLoading && rsLoaded && rsSessions.length === 0 && (
            <div style={{background:'rgba(15,19,40,0.6)', border:'1px solid rgba(96,165,250,0.12)', borderRadius:'10px', padding:'2.5rem', textAlign:'center'}}>
              <div style={{fontSize:'2rem', marginBottom:'0.5rem', opacity:0.5}}>&#128506;</div>
              <div style={{fontSize:'0.9rem', fontWeight:600, color:'#8b92b0', marginBottom:'0.4rem'}}>No sessions yet</div>
              <div style={{fontSize:'0.78rem', color:'#4a5270', maxWidth:'360px', margin:'0 auto', lineHeight:1.6}}>
                Start a session in the Chrome Extension or Research Companion app, browse the web, then end it to save your research trail here.
              </div>
            </div>
          )}

          {!rsLoading && rsSessions.map(sess => {
            const trail    = Array.isArray(sess.trail)          ? sess.trail          : [];
            const captures = Array.isArray(sess.captured_items) ? sess.captured_items : [];
            const startDate = fmtDate(sess.started_at);
            const endDate   = fmtDate(sess.ended_at);
            const isExp  = rsExpanded === sess.id;
            const saving = rsSaving[sess.id];
            const durMin = sess.started_at && sess.ended_at
              ? Math.round((new Date(sess.ended_at) - new Date(sess.started_at)) / 60000) : null;
            return (
              <div key={sess.id} style={{background:'rgba(15,19,40,0.7)', border:'1px solid rgba(96,165,250,0.15)', borderRadius:'10px', marginBottom:'0.75rem', overflow:'hidden'}}>

                {/* â”€â”€ Session header â”€â”€ */}
                <div onClick={()=>{
                    if (rsSelectMode) {
                      setRsSelected(prev => {
                        const next = new Set(prev);
                        if (next.has(sess.id)) next.delete(sess.id); else next.add(sess.id);
                        return next;
                      });
                    } else { setRsExpanded(isExp ? null : sess.id); }
                  }}
                  style={{display:'flex', alignItems:'center', gap:'0.75rem', padding:'0.85rem 1rem', cursor:'pointer',
                    background: rsSelectMode && rsSelected.has(sess.id) ? 'rgba(99,102,241,0.1)' : isExp ? 'rgba(96,165,250,0.05)' : 'transparent',
                    outline: rsSelectMode && rsSelected.has(sess.id) ? '1px solid rgba(99,102,241,0.35)' : 'none',
                    transition:'background 0.15s'}}>
                  <span style={{fontSize:'0.9rem', color: rsSelectMode ? (rsSelected.has(sess.id) ? '#6366f1' : '#4a5270') : '#8b92b0'}}>
                    {rsSelectMode ? (rsSelected.has(sess.id) ? '&#9745;' : '&#9744;') : (isExp ? '&#9662;' : '&#9656;')}
                  </span>
                  <div style={{flex:1, minWidth:0}}>
                    <div style={{fontSize:'0.88rem', fontWeight:700, color:'#e2e8f8', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>
                      {sess.session_name || 'Unnamed Session'}
                    </div>
                    <div style={{fontSize:'0.72rem', color:'#8b92b0', marginTop:'2px'}}>
                      {startDate}{endDate && startDate !== endDate ? ' \u2192 ' + endDate : ''}{durMin != null ? ' \u00b7 ' + durMin + ' min' : ''}
                    </div>
                  </div>
                  <div style={{display:'flex', gap:'0.4rem', alignItems:'center', flexShrink:0, flexWrap:'wrap', justifyContent:'flex-end'}}>
                    <span style={{background:'rgba(96,165,250,0.1)', border:'1px solid rgba(96,165,250,0.2)', borderRadius:'5px', padding:'2px 8px', fontSize:'0.7rem', color:'#60a5fa', fontWeight:600}}>{trail.length} pages</span>
                    {captures.length > 0 && <span style={{background:'rgba(74,222,128,0.1)', border:'1px solid rgba(74,222,128,0.2)', borderRadius:'5px', padding:'2px 8px', fontSize:'0.7rem', color:'#4ade80', fontWeight:600}}>{captures.length} captured</span>}
                    {saving && saving.done && <span style={{background:'rgba(74,222,128,0.1)', border:'1px solid rgba(74,222,128,0.2)', borderRadius:'5px', padding:'2px 8px', fontSize:'0.7rem', color:'#4ade80', fontWeight:600}}>&#10003; {saving.created} events</span>}
                  </div>
                </div>

                {/* â”€â”€ Expanded content â”€â”€ */}
                {isExp && (
                  <div style={{padding:'0 1rem 1rem', borderTop:'1px solid rgba(96,165,250,0.1)'}}>

                    {/* â”€â”€ Analyze & Save panel â”€â”€ */}
                    <div style={{margin:'0.85rem 0', padding:'0.85rem 1rem', background:'rgba(96,165,250,0.04)', border:'1px solid rgba(96,165,250,0.15)', borderRadius:'8px'}}>
                      {saving && saving.done ? (
                        <div style={{display:'flex', alignItems:'center', gap:'0.75rem', flexWrap:'wrap'}}>
                          <span style={{fontSize:'0.85rem', color:'#4ade80', fontWeight:700}}>
                            &#10003; {saving.created} event{saving.created !== 1 ? 's' : ''} created &amp; saved
                          </span>
                          <span style={{fontSize:'0.78rem', color:'#8b92b0'}}>&#8594; Find them in Account &#8594; My Uploads</span>
                        </div>
                      ) : saving && saving.progress ? (
                        <div style={{display:'flex', alignItems:'center', gap:'0.75rem'}}>
                          <span className="spinner" style={{width:'14px', height:'14px', display:'inline-block', flexShrink:0}}></span>
                          <span style={{fontSize:'0.82rem', color:'#8b92b0'}}>{saving.progress}</span>
                          <span style={{fontSize:'0.75rem', color:'#4a5270'}}>(may take several minutes)</span>
                        </div>
                      ) : (
                        <div style={{display:'flex', alignItems:'center', gap:'1rem', flexWrap:'wrap'}}>
                          <div style={{flex:1, minWidth:'200px'}}>
                            <div style={{fontSize:'0.85rem', fontWeight:700, color:'#e2e8f8', marginBottom:'3px'}}>&#129302; Analyze &amp; Save to Database</div>
                            <div style={{fontSize:'0.78rem', color:'#8b92b0', lineHeight:1.5}}>
                              AI analyzes every captured item and trail page &mdash; extracts topics, people, organizations, and creates full event records in your database.
                            </div>
                          </div>
                          <button onClick={e=>{e.stopPropagation(); rsSaveToDb(sess);}}
                            style={{background:'linear-gradient(135deg,#3b82f6,#6366f1)', border:'none', borderRadius:'8px', color:'white',
                              fontSize:'0.82rem', fontWeight:700, padding:'0.5rem 1.25rem', cursor:'pointer', flexShrink:0,
                              boxShadow:'0 0 14px rgba(99,102,241,0.3)'}}>
                            Analyze &amp; Save
                          </button>
                        </div>
                      )}
                    </div>

                    {/* â”€â”€ Research Trail â”€â”€ */}
                    {trail.length > 0 && (() => {
                      const realPages = trail.filter(e => e.type !== 'pause' && e.type !== 'resume');
                      const firstRealId = realPages[0]?.id;
                      return (
                        <div style={{marginTop:'0.85rem'}}>
                          <div style={{fontSize:'0.7rem', fontWeight:700, color:'#4a5270', textTransform:'uppercase', letterSpacing:'0.8px', marginBottom:'0.5rem'}}>
                            Research Trail &mdash; {realPages.length} page{realPages.length !== 1 ? 's' : ''} visited
                          </div>
                          {trail.map((entry, i) => {
                            // Pause marker
                            if (entry.type === 'pause') return (
                              <div key={entry.id || i} style={{display:'flex', alignItems:'center', gap:'7px', padding:'3px 7px', margin:'2px 0', background:'rgba(251,191,36,0.07)', border:'1px solid rgba(251,191,36,0.22)', borderRadius:'5px'}}>
                                <span style={{fontSize:'0.75rem'}}>â¸</span>
                                <span style={{fontSize:'0.72rem', fontWeight:700, color:'#fbbf24', flex:1}}>Session paused</span>
                                <span style={{fontSize:'0.67rem', color:'#4a5270'}}>{entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) : ''}</span>
                              </div>
                            );
                            // Resume marker
                            if (entry.type === 'resume') return (
                              <div key={entry.id || i} style={{display:'flex', alignItems:'center', gap:'7px', padding:'3px 7px', margin:'2px 0', background:'rgba(74,222,128,0.07)', border:'1px solid rgba(74,222,128,0.22)', borderRadius:'5px'}}>
                                <span style={{fontSize:'0.75rem'}}>â–¶</span>
                                <span style={{fontSize:'0.72rem', fontWeight:700, color:'#4ade80', flex:1}}>Session resumed</span>
                                <span style={{fontSize:'0.67rem', color:'#4a5270'}}>{entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) : ''}</span>
                              </div>
                            );
                            // Regular trail entry
                            const isFirst = entry.id === firstRealId;
                            const trailCaptures = captures.filter(c => c.url && entry.url && c.url === entry.url);
                            const hasTrailCaptures = trailCaptures.length > 0;
                            return (
                              <div key={entry.id || i} style={{display:'flex', alignItems:'flex-start', gap:'0.6rem', padding:'4px 0'}}>
                                <div style={{display:'flex', flexDirection:'column', alignItems:'center', paddingTop:'4px', flexShrink:0, width:'14px'}}>
                                  <div style={{width:'7px', height:'7px', borderRadius:'50%',
                                    background: isFirst ? '#4ade80' : hasTrailCaptures ? '#c4b5fd' : 'rgba(96,165,250,0.45)',
                                    boxShadow: isFirst ? '0 0 5px rgba(74,222,128,0.4)' : hasTrailCaptures ? '0 0 5px rgba(196,181,253,0.4)' : 'none'}}></div>
                                  {i < trail.length - 1 && (
                                    <div style={{width:'1px', height:'16px', background:'rgba(96,165,250,0.13)', margin:'2px 0'}}></div>
                                  )}
                                </div>
                                <div style={{flex:1, minWidth:0}}>
                                  <div style={{display:'flex', alignItems:'center', gap:'0.4rem', flexWrap:'wrap'}}>
                                    <a href={entry.url} target="_blank" rel="noreferrer"
                                      onClick={hasTrailCaptures ? e => { e.preventDefault(); setRsTrailModal({entry, captures: trailCaptures, session: sess}); } : undefined}
                                      style={{fontSize:'0.78rem', color: hasTrailCaptures ? '#c4b5fd' : '#c0c7d8', textDecoration:'none',
                                        overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', display:'block'}}
                                      title={hasTrailCaptures ? 'Click to see ' + trailCaptures.length + ' highlight(s) from this page' : entry.url}
                                      onMouseEnter={e => e.currentTarget.style.color = hasTrailCaptures ? '#e9d5ff' : '#93c5fd'}
                                      onMouseLeave={e => e.currentTarget.style.color = hasTrailCaptures ? '#c4b5fd' : '#c0c7d8'}>
                                      {entry.title || entry.url}
                                    </a>
                                    {hasTrailCaptures && (
                                      <span style={{fontSize:'0.63rem', color:'#c4b5fd', background:'rgba(196,181,253,0.12)', border:'1px solid rgba(196,181,253,0.25)', borderRadius:'4px', padding:'1px 5px', flexShrink:0, fontWeight:600, cursor:'pointer'}}
                                        onClick={()=>setRsTrailModal({entry, captures: trailCaptures, session: sess})}>
                                        {trailCaptures.length} highlight{trailCaptures.length !== 1 ? 's' : ''}
                                      </span>
                                    )}
                                  </div>
                                  <div style={{fontSize:'0.67rem', color:'#4a5270', fontFamily:'monospace',
                                    overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{entry.url}</div>
                                </div>
                                <div style={{fontSize:'0.67rem', color:'#4a5270', flexShrink:0, paddingTop:'2px'}}>
                                  {entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) : ''}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}

                    {/* â”€â”€ Captured Items â”€â”€ */}
                    {captures.length > 0 && (
                      <div style={{marginTop:'0.85rem'}}>
                        <div style={{fontSize:'0.7rem', fontWeight:700, color:'#4a5270', textTransform:'uppercase', letterSpacing:'0.8px', marginBottom:'0.5rem'}}>
                          Captured Items &mdash; {captures.length} item{captures.length !== 1 ? 's' : ''}
                        </div>
                        {captures.map((c, i) => (
                          <div key={c.id || i}
                            onClick={() => { setRsCaptureModal({capture: c, session: sess}); setRsCaptureAiResult(null); }}
                            style={{background:'rgba(10,13,28,0.5)', border:'1px solid rgba(96,165,250,0.1)',
                              borderRadius:'7px', padding:'0.6rem 0.8rem', marginBottom:'0.4rem', cursor:'pointer',
                              transition:'border-color 0.15s, background 0.15s'}}
                            onMouseEnter={e=>{e.currentTarget.style.borderColor='rgba(96,165,250,0.3)';e.currentTarget.style.background='rgba(10,13,28,0.75)';}}
                            onMouseLeave={e=>{e.currentTarget.style.borderColor='rgba(96,165,250,0.1)';e.currentTarget.style.background='rgba(10,13,28,0.5)';}}>
                            <div style={{display:'flex', alignItems:'flex-start', gap:'0.5rem'}}>
                              <span style={{fontSize:'0.85rem', flexShrink:0, paddingTop:'1px'}}>
                                {c.type==='video' ? '&#127916;' : c.type==='url' ? '&#128279;' : '&#128221;'}
                              </span>
                              <div style={{flex:1, minWidth:0}}>
                                <div style={{fontSize:'0.78rem', color:'#e2e8f8', lineHeight:1.4, marginBottom:'4px',
                                  display:'-webkit-box', WebkitLineClamp:3, WebkitBoxOrient:'vertical', overflow:'hidden'}}>
                                  {c.text || c.url}
                                </div>
                                <div style={{display:'flex', alignItems:'center', gap:'0.4rem', flexWrap:'wrap'}}>
                                  {c.url && (
                                    <span style={{fontSize:'0.7rem', color:'#60a5fa', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', maxWidth:'260px'}}>
                                      {c.pageTitle || c.url}
                                    </span>
                                  )}
                                  {c.timecode && (
                                    <span style={{fontSize:'0.68rem', color:'#c4b5fd', background:'rgba(196,181,253,0.1)',
                                      border:'1px solid rgba(196,181,253,0.2)', borderRadius:'4px', padding:'1px 5px',
                                      fontFamily:'monospace', flexShrink:0}}>&#9201; {c.timecode}</span>
                                  )}
                                  {c.saved && <span style={{fontSize:'0.68rem', color:'#4ade80', fontWeight:700, flexShrink:0}}>&#10003; saved</span>}
                                </div>
                              </div>
                              <div style={{display:'flex', flexDirection:'column', alignItems:'flex-end', gap:'3px', flexShrink:0}}>
                                {c.timestamp && (
                                  <div style={{fontSize:'0.67rem', color:'#4a5270', paddingTop:'2px'}}>
                                    {new Date(c.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}
                                  </div>
                                )}
                                <span style={{fontSize:'0.6rem', color:'#60a5fa', opacity:0.5}}>details \u2192</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                  </div>
                )}
              </div>
            );
          })}

          {/* â”€â”€ Capture Detail Modal â”€â”€ */}
          {rsCaptureModal && (
            <div style={{position:'fixed', inset:0, background:'rgba(5,8,20,0.88)', zIndex:9998, display:'flex', alignItems:'center', justifyContent:'center', padding:'1rem'}}
              onClick={()=>setRsCaptureModal(null)}>
              <div style={{background:'rgba(15,19,40,0.98)', border:'1px solid rgba(96,165,250,0.25)', borderRadius:'14px', padding:'1.5rem', maxWidth:'620px', width:'100%', maxHeight:'82vh', overflowY:'auto', position:'relative'}}
                onClick={e=>e.stopPropagation()}>
                <button onClick={()=>setRsCaptureModal(null)}
                  style={{position:'absolute', top:'0.75rem', right:'0.75rem', background:'transparent', border:'none', color:'#4a5270', fontSize:'1.1rem', cursor:'pointer', lineHeight:1}}>&#10005;</button>

                {/* Header */}
                <div style={{display:'flex', alignItems:'center', gap:'0.6rem', marginBottom:'1rem'}}>
                  <span style={{fontSize:'1.2rem'}}>{rsCaptureModal.capture.type==='video' ? '\uD83C\uDFAC' : rsCaptureModal.capture.type==='url' ? '\uD83D\uDD17' : '\uD83D\uDCDD'}</span>
                  <div>
                    <div style={{fontSize:'0.85rem', fontWeight:700, color:'#e2e8f8'}}>Captured Item</div>
                    <div style={{fontSize:'0.72rem', color:'#8b92b0'}}>{rsCaptureModal.session.session_name || 'Unnamed Session'}</div>
                  </div>
                  {rsCaptureModal.capture.saved && (
                    <span style={{marginLeft:'auto', fontSize:'0.72rem', color:'#4ade80', background:'rgba(74,222,128,0.1)', border:'1px solid rgba(74,222,128,0.2)', borderRadius:'5px', padding:'2px 8px', fontWeight:700}}>&#10003; Saved to DB</span>
                  )}
                </div>

                {/* Metadata badges */}
                <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap', marginBottom:'1rem'}}>
                  {rsCaptureModal.capture.type && (
                    <span style={{fontSize:'0.68rem', color:'#60a5fa', background:'rgba(96,165,250,0.1)', border:'1px solid rgba(96,165,250,0.2)', borderRadius:'4px', padding:'2px 7px', fontWeight:600, textTransform:'uppercase'}}>{rsCaptureModal.capture.type}</span>
                  )}
                  {rsCaptureModal.capture.timecode && (
                    <span style={{fontSize:'0.68rem', color:'#c4b5fd', background:'rgba(196,181,253,0.1)', border:'1px solid rgba(196,181,253,0.2)', borderRadius:'4px', padding:'2px 7px', fontFamily:'monospace', fontWeight:600}}>&#9201; {rsCaptureModal.capture.timecode}</span>
                  )}
                  {rsCaptureModal.capture.timestamp && (
                    <span style={{fontSize:'0.68rem', color:'#4a5270', padding:'2px 0'}}>{new Date(rsCaptureModal.capture.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</span>
                  )}
                </div>

                {/* Highlighted text */}
                {rsCaptureModal.capture.text && (
                  <div style={{background:'rgba(10,13,28,0.6)', border:'1px solid rgba(96,165,250,0.12)', borderRadius:'8px', padding:'0.9rem', marginBottom:'1rem'}}>
                    <div style={{fontSize:'0.68rem', color:'#4a5270', fontWeight:700, textTransform:'uppercase', letterSpacing:'0.7px', marginBottom:'0.5rem'}}>Highlighted Text</div>
                    <div style={{fontSize:'0.82rem', color:'#e2e8f8', lineHeight:1.6, whiteSpace:'pre-wrap'}}>{rsCaptureModal.capture.text}</div>
                  </div>
                )}

                {/* Source info */}
                {rsCaptureModal.capture.url && (
                  <div style={{background:'rgba(10,13,28,0.4)', border:'1px solid rgba(96,165,250,0.1)', borderRadius:'8px', padding:'0.75rem 0.9rem', marginBottom:'1rem'}}>
                    <div style={{fontSize:'0.68rem', color:'#4a5270', fontWeight:700, textTransform:'uppercase', letterSpacing:'0.7px', marginBottom:'0.4rem'}}>Source</div>
                    <div style={{fontSize:'0.85rem', fontWeight:600, color:'#c0c7d8', marginBottom:'3px'}}>{rsCaptureModal.capture.pageTitle || 'Unknown Page'}</div>
                    <a href={rsCaptureModal.capture.url} target="_blank" rel="noreferrer"
                      style={{fontSize:'0.72rem', color:'#60a5fa', textDecoration:'none', fontFamily:'monospace', wordBreak:'break-all'}}
                      onMouseEnter={e=>e.currentTarget.style.textDecoration='underline'}
                      onMouseLeave={e=>e.currentTarget.style.textDecoration='none'}>
                      {rsCaptureModal.capture.url}
                    </a>
                    {rsCaptureModal.capture.timecode && rsCaptureModal.capture.url && (rsCaptureModal.capture.url.includes('youtube.com') || rsCaptureModal.capture.url.includes('youtu.be')) && (
                      <div style={{marginTop:'0.4rem'}}>
                        <a href={rsCaptureModal.capture.url + '&t=' + rsCaptureModal.capture.timecode.replace(':','m') + 's'} target="_blank" rel="noreferrer"
                          style={{fontSize:'0.72rem', color:'#c4b5fd', textDecoration:'none'}}
                          onMouseEnter={e=>e.currentTarget.style.textDecoration='underline'}
                          onMouseLeave={e=>e.currentTarget.style.textDecoration='none'}>
                          &#9654; Jump to {rsCaptureModal.capture.timecode}{rsCaptureModal.capture.timecodeEnd ? ' â†’ ' + rsCaptureModal.capture.timecodeEnd : ''}
                        </a>
                      </div>
                    )}
                  </div>
                )}

                {/* Frame strip */}
                {rsCaptureModal.capture.frames && rsCaptureModal.capture.frames.length > 0 && (
                  <div style={{marginBottom:'1rem'}}>
                    <div style={{fontSize:'0.68rem', color:'#4a5270', fontWeight:700, textTransform:'uppercase', letterSpacing:'0.7px', marginBottom:'0.5rem'}}>
                      Captured Frames &mdash; {rsCaptureModal.capture.frames.length} frame{rsCaptureModal.capture.frames.length !== 1 ? 's' : ''}
                      {rsCaptureModal.capture.timecodeEnd && (
                        <span style={{marginLeft:'0.5rem', color:'#c4b5fd', fontWeight:400, textTransform:'none', letterSpacing:0}}>
                          ({rsCaptureModal.capture.timecode} â†’ {rsCaptureModal.capture.timecodeEnd})
                        </span>
                      )}
                    </div>
                    <div style={{display:'flex', gap:'5px', flexWrap:'wrap'}}>
                      {rsCaptureModal.capture.frames.map((f, fi) => (
                        <a key={fi} href={rsCaptureModal.capture.url} target="_blank" rel="noreferrer" style={{display:'block', flexShrink:0}}>
                          <img src={f.dataUrl} alt={'Frame at ' + f.timecode} title={'Frame at ' + f.timecode}
                            style={{width:'96px', height:'54px', objectFit:'cover', borderRadius:'5px',
                              border:'1px solid rgba(196,181,253,0.2)', display:'block', cursor:'pointer',
                              transition:'border-color 0.12s'}}
                            onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(196,181,253,0.5)'}
                            onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(196,181,253,0.2)'} />
                          <div style={{fontSize:'0.6rem', color:'#4a5270', textAlign:'center', fontFamily:'monospace', marginTop:'2px'}}>{f.timecode}</div>
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                {/* AI Analysis result */}
                {rsCaptureAiResult && (
                  <div style={{background:'rgba(99,102,241,0.07)', border:'1px solid rgba(99,102,241,0.2)', borderRadius:'8px', padding:'0.9rem', marginBottom:'1rem'}}>
                    <div style={{fontSize:'0.68rem', color:'#a5b4fc', fontWeight:700, textTransform:'uppercase', letterSpacing:'0.7px', marginBottom:'0.5rem'}}>\uD83E\uDD16 AI Analysis</div>
                    {rsCaptureAiResult.summary && <div style={{fontSize:'0.82rem', color:'#c0c7d8', lineHeight:1.6, marginBottom:'0.5rem'}}>{rsCaptureAiResult.summary}</div>}
                    {rsCaptureAiResult.topics && rsCaptureAiResult.topics.length > 0 && (
                      <div style={{marginBottom:'0.3rem'}}><span style={{fontSize:'0.7rem', color:'#4a5270', fontWeight:700}}>Topics: </span><span style={{fontSize:'0.78rem', color:'#60a5fa'}}>{rsCaptureAiResult.topics.join(', ')}</span></div>
                    )}
                    {rsCaptureAiResult.people && rsCaptureAiResult.people.length > 0 && (
                      <div style={{marginBottom:'0.3rem'}}><span style={{fontSize:'0.7rem', color:'#4a5270', fontWeight:700}}>People: </span><span style={{fontSize:'0.78rem', color:'#4ade80'}}>{rsCaptureAiResult.people.join(', ')}</span></div>
                    )}
                    {rsCaptureAiResult.organizations && rsCaptureAiResult.organizations.length > 0 && (
                      <div><span style={{fontSize:'0.7rem', color:'#4a5270', fontWeight:700}}>Organizations: </span><span style={{fontSize:'0.78rem', color:'#fbbf24'}}>{rsCaptureAiResult.organizations.join(', ')}</span></div>
                    )}
                  </div>
                )}

                {/* Actions */}
                <div style={{display:'flex', gap:'0.6rem', flexWrap:'wrap', justifyContent:'flex-end', marginTop:'0.5rem'}}>
                  {rsCaptureModal.capture.url && (
                    <a href={rsCaptureModal.capture.url} target="_blank" rel="noreferrer"
                      style={{background:'rgba(96,165,250,0.1)', border:'1px solid rgba(96,165,250,0.25)', borderRadius:'7px', color:'#60a5fa', fontSize:'0.8rem', fontWeight:600, padding:'0.45rem 1rem', cursor:'pointer', textDecoration:'none', display:'inline-flex', alignItems:'center', gap:'0.4rem'}}>
                      \uD83D\uDD17 Open Source
                    </a>
                  )}
                  {rsCaptureModal.capture.url && !rsCaptureAiResult && (
                    <button onClick={()=>rsCaptureAnalyze(rsCaptureModal.capture)} disabled={rsCaptureAnalyzing}
                      style={{background: rsCaptureAnalyzing ? 'rgba(99,102,241,0.15)' : 'linear-gradient(135deg,#3b82f6,#6366f1)', border:'1px solid rgba(99,102,241,0.4)', borderRadius:'7px', color:'white', fontSize:'0.8rem', fontWeight:700, padding:'0.45rem 1rem', cursor: rsCaptureAnalyzing ? 'wait' : 'pointer', display:'inline-flex', alignItems:'center', gap:'0.4rem'}}>
                      {rsCaptureAnalyzing ? '\u23F3 Analyzing\u2026' : '\uD83E\uDD16 Analyze with AI'}
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* â”€â”€ Trail Highlights Modal â”€â”€ */}
          {rsTrailModal && (
            <div style={{position:'fixed', inset:0, background:'rgba(5,8,20,0.88)', zIndex:9998, display:'flex', alignItems:'center', justifyContent:'center', padding:'1rem'}}
              onClick={()=>setRsTrailModal(null)}>
              <div style={{background:'rgba(15,19,40,0.98)', border:'1px solid rgba(196,181,253,0.25)', borderRadius:'14px', padding:'1.5rem', maxWidth:'580px', width:'100%', maxHeight:'80vh', overflowY:'auto', position:'relative'}}
                onClick={e=>e.stopPropagation()}>
                <button onClick={()=>setRsTrailModal(null)}
                  style={{position:'absolute', top:'0.75rem', right:'0.75rem', background:'transparent', border:'none', color:'#4a5270', fontSize:'1.1rem', cursor:'pointer', lineHeight:1}}>&#10005;</button>

                <div style={{marginBottom:'1.1rem'}}>
                  <div style={{fontSize:'0.68rem', color:'#c4b5fd', fontWeight:700, textTransform:'uppercase', letterSpacing:'0.7px', marginBottom:'0.35rem'}}>Highlights from this page</div>
                  <div style={{fontSize:'0.9rem', fontWeight:700, color:'#e2e8f8', marginBottom:'3px'}}>{rsTrailModal.entry.title || 'Unknown Page'}</div>
                  <div style={{fontSize:'0.7rem', color:'#4a5270', fontFamily:'monospace', wordBreak:'break-all'}}>{rsTrailModal.entry.url}</div>
                </div>

                {rsTrailModal.captures.map((c, i) => (
                  <div key={c.id || i} style={{background:'rgba(10,13,28,0.5)', border:'1px solid rgba(196,181,253,0.12)', borderRadius:'8px', padding:'0.75rem', marginBottom:'0.5rem'}}>
                    <div style={{display:'flex', alignItems:'center', gap:'0.5rem', marginBottom: c.text ? '0.4rem' : 0}}>
                      <span style={{fontSize:'0.8rem'}}>{c.type==='video' ? '\uD83C\uDFAC' : c.type==='url' ? '\uD83D\uDD17' : '\uD83D\uDCDD'}</span>
                      {c.timecode && (
                        <span style={{fontSize:'0.68rem', color:'#c4b5fd', background:'rgba(196,181,253,0.1)', border:'1px solid rgba(196,181,253,0.2)', borderRadius:'4px', padding:'1px 5px', fontFamily:'monospace', fontWeight:600}}>&#9201; {c.timecode}</span>
                      )}
                      <span style={{fontSize:'0.67rem', color:'#4a5270', marginLeft:'auto'}}>
                        {c.timestamp ? new Date(c.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) : ''}
                      </span>
                    </div>
                    {c.text && (
                      <div style={{fontSize:'0.8rem', color:'#e2e8f8', lineHeight:1.55, background:'rgba(196,181,253,0.05)', borderRadius:'5px', padding:'0.5rem 0.65rem', borderLeft:'2px solid rgba(196,181,253,0.3)', whiteSpace:'pre-wrap'}}>
                        {c.text}
                      </div>
                    )}
                    {c.saved && <div style={{marginTop:'5px', fontSize:'0.67rem', color:'#4ade80', fontWeight:700}}>&#10003; Saved to database</div>}
                  </div>
                ))}

                <div style={{display:'flex', gap:'0.6rem', justifyContent:'flex-end', marginTop:'0.9rem'}}>
                  <a href={rsTrailModal.entry.url} target="_blank" rel="noreferrer"
                    style={{background:'rgba(196,181,253,0.12)', border:'1px solid rgba(196,181,253,0.3)', borderRadius:'7px', color:'#c4b5fd', fontSize:'0.8rem', fontWeight:700, padding:'0.45rem 1.1rem', cursor:'pointer', textDecoration:'none', display:'inline-flex', alignItems:'center', gap:'0.4rem'}}>
                    &#8599; Visit Page
                  </a>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    };

    const CompanionPage = () => {
      const [companionTab, setCompanionTab] = React.useState('setup');

      const Badge = ({children, color='#60a5fa', bg='rgba(96,165,250,0.1)', border='rgba(96,165,250,0.25)'}) => (
        <span style={{display:'inline-flex',alignItems:'center',gap:'4px',padding:'3px 9px',background:bg,border:`1px solid ${border}`,borderRadius:'20px',fontSize:'0.72rem',fontWeight:700,color,whiteSpace:'nowrap'}}>{children}</span>
      );

      const Step = ({n, title, children}) => (
        <div style={{display:'flex',gap:'1rem',alignItems:'flex-start',padding:'0.9rem 0',borderBottom:'1px solid rgba(96,165,250,0.07)'}}>
          <div style={{width:'30px',height:'30px',borderRadius:'50%',background:'linear-gradient(135deg,rgba(96,165,250,0.25),rgba(96,165,250,0.1))',border:'1px solid rgba(96,165,250,0.35)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.8rem',fontWeight:700,color:'#60a5fa',flexShrink:0}}>{n}</div>
          <div style={{flex:1}}>
            <div style={{fontSize:'0.9rem',fontWeight:700,color:'#e2e8f8',marginBottom:'0.25rem'}}>{title}</div>
            <div style={{fontSize:'0.82rem',color:'#8b95b0',lineHeight:1.6}}>{children}</div>
          </div>
        </div>
      );

      const Section = ({icon, title, subtitle, children}) => (
        <div style={{background:'rgba(15,19,40,0.7)',border:'1px solid rgba(96,165,250,0.14)',borderRadius:'14px',padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'flex-start',gap:'0.75rem',marginBottom:'1rem'}}>
            <span style={{fontSize:'1.6rem',lineHeight:1}}>{icon}</span>
            <div>
              <div style={{fontSize:'1.05rem',fontWeight:700,color:'#e2e8f8'}}>{title}</div>
              {subtitle && <div style={{fontSize:'0.8rem',color:'#8b95b0',marginTop:'2px'}}>{subtitle}</div>}
            </div>
          </div>
          {children}
        </div>
      );

      const UsageCard = ({icon, title, steps}) => (
        <div style={{background:'rgba(10,13,28,0.5)',border:'1px solid rgba(96,165,250,0.12)',borderRadius:'10px',padding:'1.1rem 1.25rem',marginBottom:'0.75rem'}}>
          <div style={{display:'flex',alignItems:'center',gap:'0.6rem',marginBottom:'0.85rem'}}>
            <span style={{fontSize:'1.2rem'}}>{icon}</span>
            <span style={{fontSize:'0.9rem',fontWeight:700,color:'#e2e8f8'}}>{title}</span>
          </div>
          {steps.map((s,i) => (
            <div key={i} style={{display:'flex',gap:'0.75rem',alignItems:'flex-start',padding:'5px 0',borderTop: i>0 ? '1px solid rgba(96,165,250,0.06)' : 'none'}}>
              <span style={{fontSize:'0.75rem',fontWeight:700,color:'#60a5fa',background:'rgba(96,165,250,0.1)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'4px',padding:'1px 6px',flexShrink:0,marginTop:'1px',minWidth:'22px',textAlign:'center'}}>{i+1}</span>
              <span style={{fontSize:'0.83rem',color:'#c0c7d8',lineHeight:1.5}}>{s}</span>
            </div>
          ))}
        </div>
      );

      return (
        <div style={{maxWidth:'980px',margin:'0 auto',padding:'2rem 1.5rem'}}>
          <div style={{textAlign:'center',marginBottom:'2rem'}}>
            <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>ðŸ”¬</div>
            <h2 style={{fontFamily:"'Space Mono',monospace",fontSize:'1.4rem',fontWeight:700,color:'#e2e8f8',marginBottom:'0.5rem',letterSpacing:'0.5px'}}>Research Companion</h2>
            <p style={{fontSize:'0.88rem',color:'#8b95b0',lineHeight:1.6,maxWidth:'520px',margin:'0 auto'}}>
              Two tools that let you capture URLs, highlighted text, and video timestamps while you browse â€” then save them directly to this database with AI analysis.
            </p>
          </div>
          <div style={{display:'flex',borderBottom:'1px solid rgba(96,165,250,0.14)',marginBottom:'1.75rem'}}>
            {[['setup','ðŸ›  Setup & Install'],['howto','ðŸ“– How to Use']].map(([id,label])=>(
              <button key={id} onClick={()=>setCompanionTab(id)} style={{
                padding:'0.65rem 1.5rem',background:'transparent',border:'none',
                borderBottom: companionTab===id ? '2px solid #60a5fa' : '2px solid transparent',
                color: companionTab===id ? '#60a5fa' : '#8b95b0',
                fontSize:'0.875rem',fontWeight:700,cursor:'pointer',
                fontFamily:'Karla,inherit',transition:'color 0.15s',marginBottom:'-1px'
              }}>{label}</button>
            ))}
          </div>

          {companionTab === 'setup' && (
            <div>
              <div style={{background:'rgba(96,165,250,0.06)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'10px',padding:'1rem 1.25rem',marginBottom:'1.5rem',display:'flex',gap:'0.75rem',alignItems:'flex-start'}}>
                <span style={{fontSize:'1.1rem',flexShrink:0}}>ðŸ’¡</span>
                <p style={{fontSize:'0.82rem',color:'#8b95b0',lineHeight:1.6,margin:0}}>
                  You only need to set up <strong style={{color:'#c0c7d8'}}>one of these tools</strong> â€” pick whichever fits your browser. Both connect to the same database and do the same job.
                </p>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1.25rem',alignItems:'start'}}>
                <Section icon="ðŸ§©" title="Chrome Extension" subtitle="Best for Chrome, Edge, and Brave â€” adds a toolbar button and right-click menu">
                  <div style={{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'1.1rem'}}>
                    <Badge>âœ“ Chrome</Badge><Badge>âœ“ Edge</Badge><Badge>âœ“ Brave</Badge>
                    <Badge color='#f87171' bg='rgba(248,113,113,0.08)' border='rgba(248,113,113,0.2)'>âœ— Firefox</Badge>
                    <Badge color='#f87171' bg='rgba(248,113,113,0.08)' border='rgba(248,113,113,0.2)'>âœ— Safari</Badge>
                  </div>
                  <Step n="1" title='Download the extension files'>
                    Click below â€” downloads a small ZIP file (~20KB).
                    <br/><br/>
                    <a href={_EXT_ZIP_URL} download style={{display:'inline-flex',alignItems:'center',gap:'8px',padding:'0.65rem 1.4rem',background:'linear-gradient(135deg,rgba(96,165,250,0.22),rgba(96,165,250,0.1))',border:'1px solid rgba(96,165,250,0.5)',borderRadius:'9px',color:'#60a5fa',textDecoration:'none',fontSize:'0.875rem',fontWeight:700}}
                      onMouseEnter={e=>e.currentTarget.style.background='rgba(96,165,250,0.3)'}
                      onMouseLeave={e=>e.currentTarget.style.background='linear-gradient(135deg,rgba(96,165,250,0.22),rgba(96,165,250,0.1))'}>
                      â¬‡ Download Extension (.zip)
                    </a>
                  </Step>
                  <Step n="2" title='Unzip the downloaded file'>
                    <strong style={{color:'#c0c7d8'}}>Mac:</strong> Double-click the ZIP.<br/>
                    <strong style={{color:'#c0c7d8'}}>Windows:</strong> Right-click â†’ "Extract All".<br/>
                    Result: a folder called <code style={{background:'rgba(96,165,250,0.1)',padding:'1px 6px',borderRadius:'4px',fontSize:'0.78rem',color:'#93c5fd'}}>chrome-extension</code>.
                  </Step>
                  <Step n="3" title='Open Chrome Extensions page'>
                    Go to: <code style={{background:'rgba(96,165,250,0.1)',border:'1px solid rgba(96,165,250,0.25)',padding:'4px 10px',borderRadius:'6px',fontSize:'0.82rem',color:'#93c5fd'}}>chrome://extensions</code>
                    <div style={{marginTop:'6px',fontSize:'0.78rem',color:'#8b95b0'}}><strong style={{color:'#c0c7d8'}}>Edge:</strong> use <code style={{background:'rgba(96,165,250,0.1)',padding:'1px 5px',borderRadius:'4px',color:'#93c5fd'}}>edge://extensions</code></div>
                  </Step>
                  <Step n="4" title='Turn on Developer Mode'>
                    Toggle <strong style={{color:'#c0c7d8'}}>"Developer mode"</strong> in the top-right corner.
                    <div style={{marginTop:'6px',padding:'6px 10px',background:'rgba(251,191,36,0.07)',border:'1px solid rgba(251,191,36,0.2)',borderRadius:'6px',fontSize:'0.78rem',color:'#fbbf24'}}>âš  Only allows loading extensions not from the store â€” nothing else changes.</div>
                  </Step>
                  <Step n="5" title='Load the extension folder'>
                    Click <strong style={{color:'#c0c7d8'}}>"Load unpacked"</strong> â†’ navigate to Downloads â†’ select the <code style={{background:'rgba(96,165,250,0.1)',padding:'1px 6px',borderRadius:'4px',fontSize:'0.78rem',color:'#93c5fd'}}>chrome-extension</code> folder â†’ click <strong style={{color:'#c0c7d8'}}>Select Folder</strong>.
                  </Step>
                  <Step n="6" title="You're done!">
                    The <strong style={{color:'#c0c7d8'}}>HDB Research</strong> (â—ˆ) icon should appear in the toolbar.
                    <div style={{display:'flex',gap:'6px',alignItems:'center',padding:'8px 12px',background:'rgba(74,222,128,0.07)',border:'1px solid rgba(74,222,128,0.2)',borderRadius:'7px',fontSize:'0.8rem',color:'#4ade80',fontWeight:600,marginTop:'8px'}}>âœ“ Log in with your normal HDB username and password inside the extension.</div>
                  </Step>
                </Section>

                <Section icon="ðŸŒ" title="Research Companion Web App" subtitle="Works in every browser â€” Firefox, Safari, Chrome, Edge, and mobile">
                  <div style={{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'1.1rem'}}>
                    <Badge>âœ“ Chrome</Badge><Badge>âœ“ Firefox</Badge><Badge>âœ“ Safari</Badge><Badge>âœ“ Edge</Badge><Badge>âœ“ Brave</Badge><Badge>âœ“ Mobile</Badge>
                  </div>
                  <Step n="1" title="Open the companion app">
                    Click below to open in a new window. Keep it open alongside your browser as you research.
                    <br/><br/>
                    <a href={_COMPANION_URL} target="_blank" style={{display:'inline-flex',alignItems:'center',gap:'8px',padding:'0.65rem 1.4rem',background:'linear-gradient(135deg,rgba(96,165,250,0.22),rgba(96,165,250,0.1))',border:'1px solid rgba(96,165,250,0.5)',borderRadius:'9px',color:'#60a5fa',textDecoration:'none',fontSize:'0.875rem',fontWeight:700}}>
                      â†— Open Research Companion
                    </a>
                  </Step>
                  <Step n="2" title="Log in with your HDB credentials">
                    Use the same username and password as this database.
                  </Step>
                  <Step n="3" title="Add the bookmarklet to your browser">
                    Show your bookmarks bar (<code style={{background:'rgba(96,165,250,0.1)',padding:'1px 6px',borderRadius:'4px',fontSize:'0.78rem',color:'#93c5fd'}}>Ctrl+Shift+B</code> / <code style={{background:'rgba(96,165,250,0.1)',padding:'1px 6px',borderRadius:'4px',fontSize:'0.78rem',color:'#93c5fd'}}>Cmd+Shift+B</code>). Drag the <strong style={{color:'#c0c7d8'}}>ðŸ“Ž HDB Capture</strong> button from the companion app to your bookmarks bar.
                    <br/><br/>
                    Or drag this one right now:&nbsp;
                    <a href={_COMPANION_BM_SRC} draggable="true"
                      onClick={e=>{e.preventDefault();alert("Drag this button to your bookmarks bar â€” don't click it on this page.");}}
                      style={{display:'inline-flex',alignItems:'center',gap:'5px',padding:'4px 12px',background:'rgba(96,165,250,0.15)',border:'2px dashed rgba(96,165,250,0.45)',borderRadius:'7px',color:'#93c5fd',textDecoration:'none',fontSize:'0.82rem',fontWeight:700,cursor:'grab'}}>
                      ðŸ“Ž HDB Capture
                    </a>
                  </Step>
                  <Step n="4" title="You're done!">
                    <div style={{display:'flex',gap:'6px',alignItems:'center',padding:'8px 12px',background:'rgba(74,222,128,0.07)',border:'1px solid rgba(74,222,128,0.2)',borderRadius:'7px',fontSize:'0.8rem',color:'#4ade80',fontWeight:600}}>âœ“ Click the ðŸ“Ž HDB Capture bookmark anytime to save a page or highlighted text.</div>
                  </Step>
                </Section>
              </div>
            </div>
          )}

          {companionTab === 'howto' && (
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1.25rem',alignItems:'start'}}>
              <Section icon="ðŸ§©" title="Using the Chrome Extension" subtitle="Click the â—ˆ icon in your Chrome toolbar to open it">
                <UsageCard icon="ðŸ“Ž" title="Save highlighted text from any page" steps={[
                  "Go to any web page you're researching.",
                  'Highlight the text you want to save.',
                  'A small "Save to DB" button pops up next to your selection â€” click it.',
                  'Open the extension and click "Add to DB" â€” it saves instantly with no AI needed.',
                  'Find it in the main database under Account â†’ My Uploads.'
                ]} />
                <UsageCard icon="ðŸ”—" title="Save the current page URL" steps={[
                  'Open the extension by clicking the â—ˆ toolbar icon.',
                  'Click "Save Page" next to the current page card at the top.',
                  'Click "Add to DB" â€” saves the URL, title, and any highlighted text instantly.',
                  'Find it in Account â†’ My Uploads. Use "Analyze Session" later for full AI analysis.'
                ]} />
                <UsageCard icon="ðŸŽ¬" title="Save a video with a timestamp" steps={[
                  'Go to a YouTube video and pause at the moment you want to reference.',
                  'Highlight any text on the page (even the title is fine).',
                  'The capture bubble shows the current timestamp â€” click "Save to DB".',
                  'Find it in Account â†’ My Uploads with the timecode attached.'
                ]} />
                <UsageCard icon="ðŸ–± " title="Right-click shortcut (fastest method)" steps={[
                  'Highlight any text on a page.',
                  'Right-click the highlighted text.',
                  'Select "Save to Historical Events DB" from the menu.',
                  "Instantly saved â€” find it in Account â†’ My Uploads."
                ]} />
                <UsageCard icon="ðŸ—º" title="Track your research trail with sessions" steps={[
                  'Open the extension and click "Start Session".',
                  'Browse normally â€” every page you visit is automatically logged.',
                  'Click "End Session" â€” the session is saved to the database.',
                  'View past sessions in Account â†’ Research Sessions tab.',
                  'Open a session and click "Analyze" to have AI create full event records from every page and capture.'
                ]} />
              </Section>

              <Section icon="ðŸŒ" title="Using the Research Companion App" subtitle="Keep the companion open alongside your browser while you research">
                <UsageCard icon="ðŸ“Ž" title="Save a page or highlighted text" steps={[
                  'Highlight text on any page (or nothing if you just want the URL).',
                  'Click the ðŸ“Ž HDB Capture bookmark in your bookmarks bar.',
                  'The companion opens with the URL and text already filled in.',
                  'Click "Capture", then "Add to DB" â€” saves instantly with no AI needed.',
                  'Find it in the main database under Account â†’ My Uploads.'
                ]} />
                <UsageCard icon="ðŸŽ¬" title="Save a video timecode" steps={[
                  'Pause a YouTube or Vimeo video at the moment you want.',
                  'Click the ðŸ“Ž HDB Capture bookmark.',
                  'The companion auto-detects the timestamp â€” click Capture, then Add to DB.',
                  'Find it in Account â†’ My Uploads with the timecode attached.'
                ]} />
                <UsageCard icon="âœï¸" title="Manually add a URL or note" steps={[
                  'Open the companion app.',
                  'Paste a URL into the URL field and add optional notes.',
                  'Click "Capture", then "Add to DB" â€” find it in Account â†’ My Uploads.'
                ]} />
                <UsageCard icon="ðŸ—º" title="Track your research sessions" steps={[
                  'In the companion app, click "Start Session".',
                  'Use the ðŸ“Ž HDB Capture bookmark as you browse â€” each page is added to your trail.',
                  'Click "End Session" when done â€” the session is saved.',
                  'Go to the Sessions tab, expand a session, and click "Analyze" to have AI go through every capture and trail page and create full event records.',
                  'Also viewable in Account â†’ Research Sessions in the main database.'
                ]} />
              </Section>

              <div style={{gridColumn:'1 / -1'}}>
                <Section icon="ðŸ“š" title="Viewing your Research Sessions" subtitle="See a full record of where you went and what you found">
                  <p style={{fontSize:'0.85rem',color:'#8b95b0',lineHeight:1.7,marginBottom:'0.75rem'}}>
                    After you end a session, a complete record is saved showing every page you visited (in order) and every item you captured. You can view these in two places:
                  </p>
                  <div style={{display:'flex',gap:'1rem'}}>
                    <div style={{flex:1,display:'flex',gap:'0.75rem',alignItems:'flex-start',padding:'0.7rem 0.9rem',background:'rgba(10,13,28,0.5)',border:'1px solid rgba(96,165,250,0.12)',borderRadius:'8px'}}>
                      <span style={{fontSize:'1rem',flexShrink:0}}>ðŸŒ</span>
                      <div>
                        <div style={{fontSize:'0.85rem',fontWeight:700,color:'#e2e8f8',marginBottom:'2px'}}>In the Companion App</div>
                        <div style={{fontSize:'0.8rem',color:'#8b95b0'}}>Click the "Sessions" tab â€” expandable cards show the full trail and all captured items.</div>
                      </div>
                    </div>
                    <div style={{flex:1,display:'flex',gap:'0.75rem',alignItems:'flex-start',padding:'0.7rem 0.9rem',background:'rgba(10,13,28,0.5)',border:'1px solid rgba(96,165,250,0.12)',borderRadius:'8px'}}>
                      <span style={{fontSize:'1rem',flexShrink:0}}>ðŸ‘¤</span>
                      <div>
                        <div style={{fontSize:'0.85rem',fontWeight:700,color:'#e2e8f8',marginBottom:'2px'}}>In this Database</div>
                        <div style={{fontSize:'0.8rem',color:'#8b95b0'}}>Go to the <strong style={{color:'#c0c7d8'}}>Account page</strong> and click the <strong style={{color:'#c0c7d8'}}>Research Sessions</strong> tab. Click any session to expand it and see the full trail.</div>
                      </div>
                    </div>
                  </div>
                </Section>
              </div>
            </div>
          )}
        </div>
      );
    };

    const FiltersComponent = ({ filters, setFilters, data, activeTab, onSearch, onClear, onExportCSV, onExportJSON }) => {
      return (
        <div className="filters">
          <div className="filters-header">
            <div className="filters-title">Filters</div>
            <button className="btn btn-secondary" onClick={onClear} style={{padding:'0.5rem 1rem', fontSize:'0.8rem'}}>
              ðŸ—‘ï¸ Clear All Filters
            </button>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Search</label>
              <div className="search-row">
                <input
                  type="text"
                  placeholder="Search events, topics, people..."
                  value={filters.search}
                  onChange={e => setFilters(prev => ({ ...prev, search: e.target.value }))}
                  onKeyDown={e => { if (e.key === 'Enter') { e.preventDefault(); onSearch(); } }}
                />
                <button className="search-btn" onClick={onSearch}>â†’</button>
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Date From</label>
              <input type="date" value={filters.dateFrom} onChange={e => setFilters(prev => ({ ...prev, dateFrom: e.target.value }))} />
            </div>
            <div className="filter-group">
              <label className="filter-label">Date To</label>
              <input type="date" value={filters.dateTo} onChange={e => setFilters(prev => ({ ...prev, dateTo: e.target.value }))} />
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Topics</label>
              <div className="checkbox-grid">
                {(data.topics || []).map(t => (
                  <label key={t} className={`checkbox-label ${filters.topics.includes(t) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.topics.includes(t)}
                      onChange={e => setFilters(prev => ({
                        ...prev, topics: e.target.checked ? [...prev.topics, t] : prev.topics.filter(x => x !== t)
                      }))} />
                    {t}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">People</label>
              <div className="checkbox-grid">
                {(data.people || []).map(p => (
                  <label key={p} className={`checkbox-label ${filters.people.includes(p) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.people.includes(p)}
                      onChange={e => setFilters(prev => ({
                        ...prev, people: e.target.checked ? [...prev.people, p] : prev.people.filter(x => x !== p)
                      }))} />
                    {p}
                  </label>
                ))}
              </div>
            </div>
            <div className="filter-group">
              <label className="filter-label">Organizations</label>
              <div className="checkbox-grid">
                {(data.organizations || []).map(o => (
                  <label key={o} className={`checkbox-label ${filters.organizations.includes(o) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.organizations.includes(o)}
                      onChange={e => setFilters(prev => ({
                        ...prev, organizations: e.target.checked ? [...prev.organizations, o] : prev.organizations.filter(x => x !== o)
                      }))} />
                    {o}
                  </label>
                ))}
              </div>
            </div>
          </div>
          <div className="filter-row">
            <div className="filter-group">
              <label className="filter-label">Research Levels</label>
              <div style={{display:'flex', gap:'0.75rem', flexWrap:'wrap'}}>
                {['1','2','3'].map(level => (
                  <label key={level} className={`checkbox-label ${filters.researchLevels.includes(level) ? 'checked' : ''}`}>
                    <input type="checkbox" checked={filters.researchLevels.includes(level)}
                      onChange={e => setFilters(prev => ({
                        ...prev, researchLevels: e.target.checked ? [...prev.researchLevels, level] : prev.researchLevels.filter(x => x !== level)
                      }))} />
                    Level {level}
                  </label>
                ))}
              </div>
            </div>
            {activeTab === 'timeline' && (
              <div className="filter-group">
                <label className="filter-label">Display Options</label>
                <label className="checkbox-label" style={{width:'fit-content'}}>
                  <input type="checkbox" checked={filters.showMajorOnly}
                    onChange={e => setFilters(prev => ({ ...prev, showMajorOnly: e.target.checked }))} />
                  Major Events Only (Presidents & Wars)
                </label>
              </div>
            )}
          </div>
          <div className="export-btns">
            <button className="btn btn-primary" onClick={onExportCSV}>ðŸ“¥ Export CSV</button>
            <button className="btn btn-primary" onClick={onExportJSON}>ðŸ“¥ Export JSON</button>
          </div>
        </div>
      );
    };

    // â”€â”€â”€ MAIN APP â”€â”€â”€
    function App() {
      const [data, setData] = useState(() => normalizeData(EMBEDDED_DATA));
      const [dbReady, setDbReady] = useState(false);

      const [currentUser, setCurrentUser] = useState(() => {
        try { return JSON.parse(localStorage.getItem('hdb_session')); } catch { return null; }
      });
      const [authScreen, setAuthScreen] = useState('login');
      const [accountTab, _setAccountTab] = useState(() => sessionStorage.getItem('hdb_accountTab') || 'uploads');
      const setAccountTab = (t) => { sessionStorage.setItem('hdb_accountTab', t); _setAccountTab(t); };
      const [myFilters, setMyFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [myPageTab, _setMyPageTab] = useState(() => sessionStorage.getItem('hdb_myPageTab') || 'timeline');
      const setMyPageTab = (t) => { sessionStorage.setItem('hdb_myPageTab', t); _setMyPageTab(t); };

      const TABS = ['timeline','network','spreadsheet','presentations','topics','people','organizations','upload','sessions','companion','notifications'];

      const [activeTab, _setActiveTab] = useState(() => sessionStorage.getItem('hdb_activeTab') || 'timeline');
      const setActiveTab = (t) => { sessionStorage.setItem('hdb_activeTab', t); _setActiveTab(t); };
      const [filters, setFilters] = useState({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const [showModal, setShowModal] = useState(false);
      const [modalData, setModalData] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [editedEvent, setEditedEvent] = useState(null);
      const [editSections, setEditSections] = useState({basic:true,ai:true,tags:true,links:true,attachments:true});
      const [isCondensing, setIsCondensing] = useState(false);
      const [uploadMessage, setUploadMessage] = useState('');
      const [saveStatus, setSaveStatus] = useState('');
      const [selectedEntity, setSelectedEntity] = useState(null);
      const [entityModalOpen, setEntityModalOpen] = useState(false);
      const [entityModalData, setEntityModalData] = useState(null);
      const [entityModalEditing, setEntityModalEditing] = useState(false);
      const [entityModalDraft, setEntityModalDraft] = useState({description:'',date_start:'',date_end:''});
      const [entityProfiles, setEntityProfiles] = useState({});
      const [entityModalAnalyzing, setEntityModalAnalyzing] = useState(false);
      const [urlInput, setUrlInput] = useState('');
      const [timestampStart, setTimestampStart] = useState('');
      const [timestampEnd, setTimestampEnd] = useState('');
      const [isTimelineFullscreen, setIsTimelineFullscreen] = useState(false);
      const [isNetworkFullscreen, setIsNetworkFullscreen] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [uploadTab, _setUploadTab] = useState(() => sessionStorage.getItem('hdb_uploadTab') || 'new');
      const setUploadTab = (t) => { sessionStorage.setItem('hdb_uploadTab', t); _setUploadTab(t); };
      const [selectedForAnalysis, setSelectedForAnalysis] = useState(new Set());
      const [recentHoursFilter, setRecentHoursFilter] = useState(24);
      const [autoAnalysis, setAutoAnalysis] = useState(false);
      const [showAnalysisSuggestion, setShowAnalysisSuggestion] = useState(false);
      const [analysisSuggestionCtx, setAnalysisSuggestionCtx] = useState(null);
      const [analysisMode, setAnalysisMode] = useState(()=>sessionStorage.getItem('hdb_analysisMode')||'long');
      const [skipFrames, setSkipFrames] = useState(()=>sessionStorage.getItem('hdb_skipFrames')==='true');
      const [analysisSearch, setAnalysisSearch] = useState('');
      const [selectedEvents, setSelectedEvents] = useState(new Set());
      const [selectedMyEvents, setSelectedMyEvents] = useState(new Set());
      const [showDownloadPopup, setShowDownloadPopup] = useState(null); // 'spreadsheet' | 'myuploads' | 'recent' | null
      // Breadcrumb: array of {label, action}
      const [breadcrumbs, setBreadcrumbs] = useState([]);
      // â”€â”€ Owner system health â”€â”€
      const [systemHealth, setSystemHealth] = React.useState(null); // null = not checked yet
      const [ownerAlerts, setOwnerAlerts] = React.useState([]);
      const [healthChecking, setHealthChecking] = React.useState(false);
      // â”€â”€ Notifications â”€â”€
      const [notifications, setNotifications] = React.useState([]);
      const [notifsLoaded, setNotifsLoaded] = React.useState(false);
      const [notifFilter, setNotifFilter] = React.useState('all');

      const fileInputRef = useRef(null);
      // Canvas drag engine refs
      const canvasRef = useRef(null);
      const dragRef = useRef(null);
      const liveBlocksRef = useRef([]);
      const activePresentationIdRef = useRef(null);
      const editingSlideIdRef = useRef(null);

      // â”€â”€ Presentations state â”€â”€
      const [presentations, setPresentations] = useState([]);
      const [presentationsLoading, setPresentationsLoading] = useState(false);
      const [activePresentationId, setActivePresentationId] = useState(null);
      const [editingSlideId, setEditingSlideId] = useState(null);
      const [liveBlocks, setLiveBlocks] = useState([]);
      const [selectedBlockId, setSelectedBlockId] = useState(null);
      const [canvasTextEditId, setCanvasTextEditId] = useState(null);
      const [presentationMode, setPresentationMode] = useState(null); // { pId, idx }
      const [presentationTheme, setPresentationTheme] = useState('dark');
      const [presThemeMap, setPresThemeMap] = useState({}); // presId â†’ themeId, tracks active theme per presentation
      const [showNewPresentationModal, setShowNewPresentationModal] = useState(false);
      const [newPresentationName, setNewPresentationName] = useState('');
      const [presSelectedEvents, setPresSelectedEvents] = useState(new Set());
      const [showImageBrowser, setShowImageBrowser] = useState(null); // blockId | null
      const [imagePasteUrl, setImagePasteUrl] = useState('');
      const [imageBrowserFiles, setImageBrowserFiles] = useState([]);
      const [presAiFocuses, setPresAiFocuses] = useState(['']);
      const [presAiDetail, setPresAiDetail] = useState('standard');
      const [presAiLoading, setPresAiLoading] = useState(false);
      const [presAiSelectMode, setPresAiSelectMode] = useState(false);
      const [presSelectedSlides, setPresSelectedSlides] = useState(new Set());
      const [showShapeMenu, setShowShapeMenu] = useState(false);
      const [showThemeMenu, setShowThemeMenu] = useState(false);
      const [showGradMenu, setShowGradMenu] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [isExporting, setIsExporting] = useState(false);
      const [exportProgress, setExportProgress] = useState(0);
      const [exportTotal, setExportTotal] = useState(0);

      // â”€â”€ Load from Supabase on mount â”€â”€
      useEffect(() => {
        const loadEvents = async () => {
          try {
            const { data: rows, error } = await supabaseClient
              .from('events').select('*').order('date_uploaded', { ascending: false });
            if (error) throw error;
            if (rows && rows.length > 0) {
              const events = rows.map(fromDbRow);
              const agg = rebuildAggregates(events);
              setData({ events, ...agg, metadata: { totalEvents: events.length, lastUpdated: new Date().toISOString() } });
            } else {
              // First time: seed embedded data to Supabase
              const seedEvents = normalizeData(EMBEDDED_DATA).events;
              const { error: seedErr } = await supabaseClient.from('events').insert(seedEvents.map(toDbRow));
              if (seedErr) console.error('Seed error:', seedErr);
              else {
                const agg = rebuildAggregates(seedEvents);
                setData({ events: seedEvents, ...agg, metadata: { totalEvents: seedEvents.length, lastUpdated: new Date().toISOString() } });
              }
            }
          } catch (err) {
            console.error('Supabase load failed, using localStorage fallback:', err);
            try {
              const saved = localStorage.getItem('historicalEventsDB');
              if (saved) setData(normalizeData(JSON.parse(saved)));
            } catch (e) {}
          }
          setDbReady(true);
        };
        loadEvents();
      }, []);

      // â”€â”€ Cache to localStorage as offline fallback â”€â”€
      useEffect(() => {
        if (dbReady) {
          try { localStorage.setItem('historicalEventsDB', JSON.stringify(data)); } catch(e) {}
        }
      }, [data, dbReady]);

      // â”€â”€ Owner health check â€” runs on login and every 6 hours â”€â”€
      const runHealthCheck = React.useCallback(async () => {
        if (healthChecking) return;
        setHealthChecking(true);
        const alerts = [];
        const health = { backend: 'checking', supabase: 'checking', anthropic: 'checking', checkedAt: new Date().toISOString() };

        // 1. Backend (Render) + Anthropic key
        try {
          const res = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(10000) });
          if (res.ok) {
            const j = await res.json();
            health.backend = 'ok';
            const antCheck = j.checks?.anthropic;
            if (antCheck?.status === 'error') {
              health.anthropic = 'error';
              alerts.push({ id: 'anthropic_key', sev: 'error', title: 'Anthropic API Key Problem', message: antCheck.message, action: 'Open Anthropic Console', url: 'https://console.anthropic.com/api-keys' });
            } else {
              health.anthropic = 'ok';
            }
          } else {
            health.backend = 'error'; health.anthropic = 'unknown';
            alerts.push({ id: 'backend_error', sev: 'warning', title: 'Backend Server Error', message: 'The analysis server (Render) responded with an error. Video/file AI analysis may not work.', action: 'View Render Logs', url: 'https://dashboard.render.com' });
          }
        } catch (e) {
          health.backend = 'offline'; health.anthropic = 'unknown';
          // Offline is normal if no one has used the app recently â€” Render sleeps. Not an owner-action alert.
          health.backendNote = 'Sleeping (will auto-wake on next upload)';
        }

        // 2. Supabase â€” run a lightweight count query
        try {
          const { error } = await supabaseClient.from('events').select('id', { count: 'exact', head: true });
          if (error) throw error;
          health.supabase = 'ok';
        } catch (e) {
          health.supabase = 'error';
          alerts.push({ id: 'supabase_down', sev: 'error', title: 'Database Not Responding', message: 'Supabase may be paused. Free projects pause after 7 days of inactivity. Your data is safe â€” it just needs to be manually restored from the Supabase dashboard.', action: 'Restore on Supabase', url: 'https://supabase.com/dashboard' });
        }

        health.checkedAt = new Date().toISOString();
        setSystemHealth(health);
        // Notify owner about NEW alerts (not ones already known)
        if (alerts.length > 0 && currentUser?.role === 'owner') {
          setOwnerAlerts(prev => {
            const prevIds = prev.map(a => a.id);
            const newAlerts = alerts.filter(a => !prevIds.includes(a.id));
            newAlerts.forEach(alert => {
              supabaseClient.from('notifications').insert([{
                type: 'system_health', title: alert.title, message: alert.message,
                created_by: currentUser.username, created_by_role: 'owner',
                event_id: null, metadata: { severity: alert.sev }, read_by: [], dismissed_by: [],
              }]).then(({ data: ins }) => { if (ins?.[0]) setNotifications(p => [ins[0], ...p]); }).catch(()=>{});
            });
            return alerts;
          });
        } else {
          setOwnerAlerts(alerts);
        }
        setHealthChecking(false);
      }, [healthChecking]);

      // Run health check when owner logs in, and repeat every 6 hours
      useEffect(() => {
        if (currentUser?.role !== 'owner') return;
        runHealthCheck();
        const id = setInterval(runHealthCheck, 6 * 60 * 60 * 1000);
        return () => clearInterval(id);
      }, [currentUser?.username]);

      // Keep Render awake while any user is logged in â€” ping every 12 minutes
      useEffect(() => {
        if (!currentUser) return;
        const id = setInterval(() => { fetch(`${API_BASE}/api/health`).catch(()=>{}); }, 12 * 60 * 1000);
        return () => clearInterval(id);
      }, [currentUser?.username]);

      // â”€â”€ Load presentations from Supabase when user logs in â”€â”€
      useEffect(() => {
        if (currentUser && supabaseClient) loadPresentations();
      }, [currentUser?.username]);

      // â”€â”€ Load notifications when user logs in â”€â”€
      useEffect(() => {
        if (!currentUser) return;
        loadNotifications();
      }, [currentUser?.username]);

      // â”€â”€ Sync liveBlocks when editing slide changes â”€â”€
      useEffect(() => {
        if (!editingSlideId || !activePresentationId) { setLiveBlocks([]); setSelectedBlockId(null); return; }
        const pres = presentations.find(p => p.id === activePresentationId);
        const slide = pres?.slides?.find(s => s.id === editingSlideId);
        setLiveBlocks(slide?.blocks || []);
        setSelectedBlockId(null);
        setCanvasTextEditId(null);
      }, [editingSlideId, activePresentationId]); // intentionally excludes `presentations` to avoid loop

      // â”€â”€ Keep refs in sync with state â”€â”€
      useEffect(() => { liveBlocksRef.current = liveBlocks; }, [liveBlocks]);
      useEffect(() => { activePresentationIdRef.current = activePresentationId; }, [activePresentationId]);
      useEffect(() => { editingSlideIdRef.current = editingSlideId; }, [editingSlideId]);

      // â”€â”€ Keyboard navigation for fullscreen presentation mode â”€â”€
      useEffect(() => {
        if (!presentationMode) return;
        const handleKey = (e) => {
          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            setPresentationMode(prev => {
              const pres = presentations.find(p => p.id === prev.pId);
              if (!pres) return prev;
              return { ...prev, idx: Math.min(pres.slides.length - 1, prev.idx + 1) };
            });
          } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            setPresentationMode(prev => ({ ...prev, idx: Math.max(0, prev.idx - 1) }));
          } else if (e.key === 'Escape') {
            setPresentationMode(null);
          }
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, [presentationMode, presentations]);

      // â”€â”€ Refresh from server â”€â”€
      const refreshFromServer = useCallback(async () => {
        setSaveStatus('Refreshing...');
        try {
          const { data: rows, error } = await supabaseClient
            .from('events').select('*').order('date_uploaded', { ascending: false });
          if (error) throw error;
          const events = (rows || []).map(fromDbRow);
          const agg = rebuildAggregates(events);
          setData({ events, ...agg, metadata: { totalEvents: events.length, lastUpdated: new Date().toISOString() } });
          setSaveStatus(`Refreshed âœ“ (${events.length} events)`);
        } catch(err) {
          setSaveStatus('Refresh failed');
        }
        setTimeout(() => setSaveStatus(''), 3000);
      }, []);

      // â”€â”€ Breadcrumb helpers â”€â”€
      const pushBreadcrumb = (label, action) => {
        setBreadcrumbs(prev => [...prev, { label, action }]);
      };

      const goToBreadcrumb = (index) => {
        const crumb = breadcrumbs[index];
        setBreadcrumbs(prev => prev.slice(0, index));
        if (crumb && crumb.action) crumb.action();
      };

      const navigateToTab = (tab) => {
        setActiveTab(tab);
        setSelectedEntity(null);
        setBreadcrumbs([{ label: tab.charAt(0).toUpperCase() + tab.slice(1), action: () => { setActiveTab(tab); setSelectedEntity(null); } }]);
      };

      // â”€â”€ Presentation Supabase helpers â”€â”€
      const loadPresentations = async () => {
        if (!supabaseClient) return;
        setPresentationsLoading(true);
        const { data } = await supabaseClient.from('presentations').select('*').order('updated_at', { ascending: false });
        if (data) setPresentations(data.map(p => ({ ...p, slides: p.slides || [] })));
        setPresentationsLoading(false);
      };
      const presUpdateLocal = (pId, changes) => {
        setPresentations(prev => prev.map(p => p.id === pId ? { ...p, ...changes, updated_at: new Date().toISOString() } : p));
      };
      const saveSlidesToPres = async (pId, newSlides) => {
        await supabaseClient.from('presentations').update({ slides: newSlides, updated_at: new Date().toISOString() }).eq('id', pId);
        presUpdateLocal(pId, { slides: newSlides });
      };
      const createPresentation = async (name) => {
        const { data } = await supabaseClient.from('presentations').insert([{ name: name.trim(), user_id: currentUser?.username || 'anon', is_public: false, slides: [], created_at: new Date().toISOString(), updated_at: new Date().toISOString() }]).select();
        if (data?.[0]) { setPresentations(prev => [{ ...data[0], slides: [] }, ...prev]); setActivePresentationId(data[0].id); setEditingSlideId(null); }
      };
      const deletePresentationById = async (id) => {
        if (!window.confirm('Delete this presentation?')) return;
        await supabaseClient.from('presentations').delete().eq('id', id);
        setPresentations(prev => prev.filter(p => p.id !== id));
        if (activePresentationId === id) { setActivePresentationId(null); setEditingSlideId(null); }
      };
      const togglePresentationPublic = async (id, current) => {
        const nv = !current;
        await supabaseClient.from('presentations').update({ is_public: nv, updated_at: new Date().toISOString() }).eq('id', id);
        presUpdateLocal(id, { is_public: nv });
      };
      const addSlide = async (pId) => {
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
        // Inherit current theme if one has been applied to this presentation
        const themeId = presThemeMap[pId];
        const theme = themeId ? SLIDE_THEMES.find(t=>t.id===themeId) : null;
        const decoBlocks = theme ? _makeThemeDecoBlocks(theme) : [];
        const s = { id: uid(), bg: theme ? theme.bg : '#0a0d1e', blocks: decoBlocks };
        const ns = [...pres.slides, s];
        await saveSlidesToPres(pId, ns);
        setEditingSlideId(s.id);
        setLiveBlocks(decoBlocks);
      };
      const removeSlide = async (pId, sId) => {
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const ns = pres.slides.filter(s => s.id !== sId);
        await saveSlidesToPres(pId, ns);
        if (editingSlideId === sId) setEditingSlideId(ns[0]?.id || null);
      };
      const moveSlide = async (pId, sId, dir) => {
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const slides = [...pres.slides];
        const idx = slides.findIndex(s => s.id === sId);
        const ni = dir === 'left' ? idx - 1 : idx + 1;
        if (ni < 0 || ni >= slides.length) return;
        [slides[idx], slides[ni]] = [slides[ni], slides[idx]];
        await saveSlidesToPres(pId, slides);
      };
      // â”€â”€ AI slide design constants â”€â”€
      const PRES_ACCENT = '#D4AF37';
      const PRES_AI_BG  = '#1E1E2F';
      const PRES_TEXT   = '#E0E0E0';
      const PRES_MUTED  = '#888899';

      // â”€â”€ Rich slide layout builder (shared by addEventsAsSlides + AI generation) â”€â”€
      const createEventSlide = (uid, evt, aiContent) => {
        const title  = aiContent?.title || evt?.title || '';
        const date   = aiContent?.date  || evt?.date  || '';
        const body   = aiContent?.body  || evt?.aiSummary || evt?.description || '';
        const topics = evt?.topics        || [];
        const people = evt?.people        || [];
        const orgs   = evt?.organizations || [];
        const link   = evt?.link || '';
        const hasTags  = topics.length > 0 || people.length > 0 || orgs.length > 0;
        const hasLinks = !!link || !!evt;
        const bodyW  = hasTags ? 59 : 91;
        const bodyY  = 27;
        const bodyH  = hasLinks ? 47 : 59;
        const srcY   = bodyY + bodyH + 2;
        return {
          id: uid(), bg: '#080d22',
          blocks: [
            // Blue accent bar on left edge
            { id: uid(), type: 'image', x: 0, y: 0, w: 1.3, h: 100, background: '#3b82f6', imageUrl: null, noImagePrompt: true, imageFit: 'cover', eventId: null, eventField: null },
            // Title
            { id: uid(), type: 'heading', x: 3, y: 6, w: hasTags ? 58 : 91, h: 17, text: title, fontSize: 34, fontWeight: 'bold', fontStyle: 'normal', color: '#ffffff', textAlign: 'left', background: 'transparent', eventId: evt?.id||null, eventField: 'title' },
            // Date (top-right of main area)
            ...(date ? [{ id: uid(), type: 'text', x: hasTags ? 65 : 67, y: 8, w: hasTags ? 33 : 30, h: 7, text: date, fontSize: 12, fontWeight: 'normal', fontStyle: 'normal', color: '#60a5fa', textAlign: 'right', background: 'transparent', eventId: evt?.id||null, eventField: 'date' }] : []),
            // Thin divider line
            { id: uid(), type: 'image', x: 3, y: 24, w: hasTags ? 58 : 92, h: 0.45, background: 'rgba(96,165,250,0.25)', imageUrl: null, noImagePrompt: true, imageFit: 'cover', eventId: null, eventField: null },
            // Body text
            { id: uid(), type: 'text', x: 3, y: bodyY, w: bodyW, h: bodyH, text: body, fontSize: 14, fontWeight: 'normal', fontStyle: 'normal', color: '#c0c7d8', textAlign: 'left', background: 'transparent', eventId: evt?.id||null, eventField: null },
            // Tags panel (right column)
            ...(hasTags ? [{ id: uid(), type: 'tags', x: 65, y: 6, w: 33, h: hasLinks ? 72 : 88, topics, people, orgs, background: 'transparent', eventId: evt?.id||null, eventField: null }] : []),
            // Sources + event link strip at bottom
            ...(hasLinks ? [{ id: uid(), type: 'sources', x: 3, y: srcY, w: 92, h: 100 - srcY - 2, items: [...(link ? [{url: link, label: 'Source'}] : []), ...(evt ? [{eventId: evt.id, label: 'View Event'}] : [])], background: 'transparent', eventId: evt?.id||null, eventField: null }] : []),
          ].filter(Boolean)
        };
      };

      // â”€â”€ Auto-layout helper: spreads AI-returned text_blocks across the content area â”€â”€
      // n=1 â†’ full area | n=2 â†’ two columns | n=3 â†’ 2 top + 1 bottom | n=4 â†’ 2Ã—2 grid | nâ‰¥5 â†’ stacked rows
      const autoLayoutTextBlocks = (blocks, x, y, w, h, uid, evt, baseFontSize=15) => {
        if (!blocks || blocks.length === 0) return [];
        const mk = (text, bx, by, bw, bh, fs) => ({
          id:uid(), type:'text', x:bx, y:by, w:bw, h:bh, text,
          fontSize:fs||baseFontSize, fontWeight:'normal', fontStyle:'normal',
          color:PRES_TEXT, textAlign:'left', background:'transparent',
          eventId:evt?.id||null, eventField:null
        });
        const n = blocks.length;
        if (n === 1) return [mk(blocks[0], x, y, w, h)];
        if (n === 2) {
          const cw = Math.floor((w-3)/2);
          return [mk(blocks[0], x, y, cw, h), mk(blocks[1], x+cw+3, y, cw, h)];
        }
        if (n === 3) {
          const cw = Math.floor((w-3)/2), th = Math.floor(h*0.52), bh2 = h-th-3;
          return [mk(blocks[0], x, y, cw, th), mk(blocks[1], x+cw+3, y, cw, th), mk(blocks[2], x, y+th+3, w, bh2, baseFontSize-1)];
        }
        if (n === 4) {
          const cw = Math.floor((w-3)/2), rh = Math.floor((h-3)/2), fs = baseFontSize-1;
          return [mk(blocks[0],x,y,cw,rh,fs), mk(blocks[1],x+cw+3,y,cw,rh,fs), mk(blocks[2],x,y+rh+3,cw,rh,fs), mk(blocks[3],x+cw+3,y+rh+3,cw,rh,fs)];
        }
        // 5+ â†’ stacked rows
        const rowH = Math.floor(h/n)-2, fs = baseFontSize-1;
        return blocks.map((b,i) => mk(b, x, y+i*(rowH+2), w, rowH, fs));
      };

      // â”€â”€ AI-specific slide layout builders (5 layout types) â”€â”€

      const buildTitleSlide = (uid, s, evt) => {
        const title    = s.title    || evt?.title || '';
        const subtitle = s.subtitle || '';
        const date     = s.date     || evt?.date  || '';
        return {
          id: uid(), bg: PRES_AI_BG,
          blocks: [
            { id:uid(), type:'shape', x:0, y:0, w:1.5, h:100, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'shape', x:8, y:34, w:84, h:0.5, shapeType:'rectangle', fill:'rgba(212,175,55,0.35)', stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'shape', x:8, y:72, w:84, h:0.5, shapeType:'rectangle', fill:'rgba(212,175,55,0.2)', stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'heading', x:5, y:16, w:90, h:22, text:title, fontSize:44, fontWeight:'bold', fontStyle:'normal', color:'#FFFFFF', textAlign:'center', background:'transparent', eventId:evt?.id||null, eventField:'title' },
            ...(subtitle ? [{ id:uid(), type:'text', x:5, y:42, w:90, h:12, text:subtitle, fontSize:20, fontWeight:'normal', fontStyle:'normal', color:PRES_ACCENT, textAlign:'center', background:'transparent', eventId:null, eventField:null }] : []),
            ...(date ? [{ id:uid(), type:'text', x:5, y:57, w:90, h:8, text:date, fontSize:14, fontWeight:'normal', fontStyle:'normal', color:PRES_MUTED, textAlign:'center', background:'transparent', eventId:evt?.id||null, eventField:'date' }] : []),
          ].filter(Boolean)
        };
      };

      const buildOverviewSlide = (uid, s, evt) => {
        const title   = s.title || evt?.title || '';
        const date    = s.date  || evt?.date  || '';
        // text_blocks (new) â†’ each element is its own visual box, auto-laid-out
        // bullets (fallback) â†’ join into one block   body (last fallback) â†’ single block
        const rawBlocks = s.text_blocks || (s.bullets?.length ? [s.bullets.map(b=>'â€¢ '+b).join('\n')] : null) || (s.body ? [s.body] : (evt?.aiSummary||evt?.description ? [evt.aiSummary||evt.description] : []));
        const topics  = evt?.topics || [];
        const people  = evt?.people || [];
        const orgs    = evt?.organizations || [];
        const hasMeta = topics.length > 0 || people.length > 0 || orgs.length > 0;
        const contentBlocks = autoLayoutTextBlocks(rawBlocks, 3, 26, 57, 70, uid, evt);
        return {
          id: uid(), bg: PRES_AI_BG,
          blocks: [
            { id:uid(), type:'shape',   x:0, y:0,  w:1.5, h:100, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'heading', x:3, y:5,  w:57,  h:16,  text:title, fontSize:32, fontWeight:'bold', fontStyle:'normal', color:PRES_ACCENT, textAlign:'left', background:'transparent', eventId:evt?.id||null, eventField:'title' },
            ...(date ? [{ id:uid(), type:'text', x:63, y:7, w:35, h:7, text:date, fontSize:13, fontWeight:'normal', fontStyle:'normal', color:PRES_MUTED, textAlign:'right', background:'transparent', eventId:evt?.id||null, eventField:'date' }] : []),
            { id:uid(), type:'shape',   x:3, y:23, w:94,  h:0.4, shapeType:'rectangle', fill:'rgba(212,175,55,0.3)', stroke:'transparent', strokeWidth:0, radius:0 },
            ...contentBlocks,
            ...(hasMeta
              ? [{ id:uid(), type:'tags',    x:63, y:26, w:34, h:70, topics, people, orgs, background:'rgba(212,175,55,0.04)', eventId:evt?.id||null, eventField:null }]
              : [{ id:uid(), type:'callout', x:63, y:26, w:34, h:70, text:'Insert image\nor map here', fontSize:13, fontWeight:'normal', fontStyle:'italic', color:'#666688', accentColor:PRES_ACCENT, background:'rgba(212,175,55,0.04)', eventId:null, eventField:null }]
            ),
          ].filter(Boolean)
        };
      };

      const buildKeyFiguresSlide = (uid, s, evt) => {
        const title    = s.title || 'Key Figures';
        const cards    = s.cards || [];
        const people   = evt?.people || [];
        const cardList = cards.length > 0 ? cards : people.map(p => ({ name:p, role:'', detail:'' }));
        const numCards = Math.min(cardList.length, 3);
        if (numCards === 0) return buildContentSlide(uid, s, evt);
        const numCols  = numCards === 1 ? 1 : numCards === 2 ? 2 : 3;
        const colW   = numCols === 1 ? 60 : numCols === 2 ? 43 : 28;
        const startX = numCols === 1 ? 20 : numCols === 2 ? 5  : 3;
        const gapX   = numCols === 1 ? 0  : numCols === 2 ? 4  : 3;
        const cardBlocks = [];
        for (let i = 0; i < numCols; i++) {
          const card = cardList[i] || {};
          const cx   = startX + i * (colW + gapX);
          cardBlocks.push(
            { id:uid(), type:'shape',   x:cx,   y:26,    w:colW,    h:65,  shapeType:'rectangle', fill:'#252540', stroke:PRES_ACCENT, strokeWidth:1, radius:8 },
            { id:uid(), type:'heading', x:cx+2, y:30,    w:colW-4,  h:13,  text:card.name||'', fontSize:18, fontWeight:'bold', fontStyle:'normal', color:PRES_ACCENT, textAlign:'left', background:'transparent', eventId:null, eventField:null },
            ...(card.role   ? [{ id:uid(), type:'text', x:cx+2, y:44, w:colW-4, h:8,  text:card.role,   fontSize:12, fontWeight:'normal', fontStyle:'italic', color:'#9999BB', textAlign:'left', background:'transparent', eventId:null, eventField:null }] : []),
            ...(card.detail ? [{ id:uid(), type:'text', x:cx+2, y:53, w:colW-4, h:35, text:card.detail, fontSize:13, fontWeight:'normal', fontStyle:'normal', color:PRES_TEXT, textAlign:'left', background:'transparent', eventId:null, eventField:null }] : []),
          );
        }
        return {
          id: uid(), bg: PRES_AI_BG,
          blocks: [
            { id:uid(), type:'shape',   x:0, y:0,  w:1.5, h:100, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'heading', x:3, y:5,  w:90,  h:16,  text:title, fontSize:28, fontWeight:'bold', fontStyle:'normal', color:'#FFFFFF', textAlign:'left', background:'transparent', eventId:null, eventField:null },
            { id:uid(), type:'shape',   x:3, y:22, w:94,  h:0.4, shapeType:'rectangle', fill:'rgba(212,175,55,0.3)', stroke:'transparent', strokeWidth:0, radius:0 },
            ...cardBlocks.flat(),
          ].filter(Boolean)
        };
      };

      const buildTimelineSlide = (uid, s, evt) => {
        const title = s.title || 'Timeline';
        const nodes = (s.nodes || []).slice(0, 5);
        const n     = nodes.length;
        const lineY = 52;
        const dotW  = 3;
        const dotH  = dotW * (16/9); // ~5.33% â€” corrects for 16:9 aspect to appear circular
        const nodeBlocks = [];
        if (n > 0) {
          const spacing = n === 1 ? 0 : 72 / (n - 1);
          const startX  = n === 1 ? 48.5 : 10;
          nodes.forEach((node, i) => {
            const nx    = startX + i * spacing;
            const above = i % 2 === 0;
            nodeBlocks.push(
              { id:uid(), type:'shape', x:nx, y:lineY-dotH/2, w:dotW, h:dotH, shapeType:'circle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
              { id:uid(), type:'text',  x:nx-4, y:lineY+dotH/2+1,  w:11, h:8,  text:node.year||'', fontSize:12, fontWeight:'bold',   fontStyle:'normal', color:PRES_ACCENT, textAlign:'center', background:'transparent', eventId:null, eventField:null },
              { id:uid(), type:'text',  x:nx-8, y:above ? lineY-20 : lineY+dotH/2+10, w:19, h:above?16:14, text:node.label||'', fontSize:11, fontWeight:'normal', fontStyle:'normal', color:PRES_TEXT, textAlign:'center', background:'transparent', eventId:null, eventField:null },
            );
          });
        }
        return {
          id: uid(), bg: PRES_AI_BG,
          blocks: [
            { id:uid(), type:'shape',   x:0, y:0,      w:1.5, h:100, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'heading', x:3, y:5,      w:90,  h:16,  text:title, fontSize:28, fontWeight:'bold', fontStyle:'normal', color:'#FFFFFF', textAlign:'left', background:'transparent', eventId:null, eventField:null },
            { id:uid(), type:'shape',   x:3, y:22,     w:94,  h:0.4, shapeType:'rectangle', fill:'rgba(212,175,55,0.3)', stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'shape',   x:5, y:lineY,  w:90,  h:0.6, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            ...nodeBlocks.flat(),
          ].filter(Boolean)
        };
      };

      const buildContentSlide = (uid, s, evt) => {
        const title    = s.title || evt?.title || '';
        const date     = s.date  || evt?.date  || '';
        // text_blocks (new) â†’ each element auto-laid-out as its own visual box
        // bullets (fallback) â†’ join into single block   body/description (last fallback)
        const rawBlocks = s.text_blocks || (s.bullets?.length ? [s.bullets.map(b=>'â€¢ '+b).join('\n')] : null) || (s.body ? [s.body] : (evt?.aiSummary||evt?.description ? [evt.aiSummary||evt.description] : []));
        const topics   = evt?.topics || [];
        const people   = evt?.people || [];
        const orgs     = evt?.organizations || [];
        const hasTags  = topics.length > 0 || people.length > 0 || orgs.length > 0;
        const link     = evt?.link || '';
        const hasLinks = !!link || !!evt;
        const contentX = 3;
        const contentY = 26;
        const contentW = hasTags ? 58 : 90;
        const contentH = hasLinks ? 48 : 66;
        const srcY     = contentY + contentH + 2;
        const contentBlocks = autoLayoutTextBlocks(rawBlocks, contentX, contentY, contentW, contentH, uid, evt);
        return {
          id: uid(), bg: PRES_AI_BG,
          blocks: [
            { id:uid(), type:'shape',   x:0, y:0, w:1.5, h:100, shapeType:'rectangle', fill:PRES_ACCENT, stroke:'transparent', strokeWidth:0, radius:0 },
            { id:uid(), type:'heading', x:3, y:5, w:hasTags?57:90, h:17, text:title, fontSize:32, fontWeight:'bold', fontStyle:'normal', color:'#FFFFFF', textAlign:'left', background:'transparent', eventId:evt?.id||null, eventField:'title' },
            ...(date ? [{ id:uid(), type:'text', x:hasTags?62:68, y:7, w:hasTags?35:29, h:7, text:date, fontSize:12, fontWeight:'normal', fontStyle:'normal', color:PRES_ACCENT, textAlign:'right', background:'transparent', eventId:evt?.id||null, eventField:'date' }] : []),
            { id:uid(), type:'shape',   x:3, y:23, w:hasTags?57:93, h:0.4, shapeType:'rectangle', fill:'rgba(212,175,55,0.3)', stroke:'transparent', strokeWidth:0, radius:0 },
            ...contentBlocks,
            ...(hasTags  ? [{ id:uid(), type:'tags',    x:63, y:5,    w:34, h:hasLinks?72:88, topics, people, orgs, background:'transparent', eventId:evt?.id||null, eventField:null }] : []),
            ...(hasLinks ? [{ id:uid(), type:'sources', x:3,  y:srcY, w:92, h:100-srcY-2, items:[...(link?[{url:link,label:'Source'}]:[]),...(evt?[{eventId:evt.id,label:'View Event'}]:[])], background:'transparent', eventId:evt?.id||null, eventField:null }] : []),
          ].filter(Boolean)
        };
      };

      // Routes to the right builder based on AI-returned layout type
      const buildAiSlide = (uid, s, evt) => {
        switch (s.layout) {
          case 'title':        return buildTitleSlide(uid, s, evt);
          case 'overview':     return buildOverviewSlide(uid, s, evt);
          case 'key_figures':  return buildKeyFiguresSlide(uid, s, evt);
          case 'timeline':     return buildTimelineSlide(uid, s, evt);
          default:             return buildContentSlide(uid, s, evt);
        }
      };

      const addEventsAsSlides = async (pId, events) => {
        // Fetch fresh slides from DB to prevent stale-closure overwrite
        const { data: freshPres } = await supabaseClient.from('presentations').select('slides').eq('id', pId).single();
        const currentSlides = freshPres?.slides || presentations.find(p => p.id === pId)?.slides || [];
        const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
        const newSlides = events.map(evt => createEventSlide(uid, evt, null));
        await saveSlidesToPres(pId, [...currentSlides, ...newSlides]);
        setPresSelectedEvents(new Set());
        setEditingSlideId(newSlides[0]?.id || null);
      };

      const removeEventFromPresentation = async (pId, eventId) => {
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const newSlides = pres.slides.filter(s => !s.blocks.some(b => b.eventId === eventId));
        await saveSlidesToPres(pId, newSlides);
        if (editingSlideId && !newSlides.find(s => s.id === editingSlideId)) {
          setEditingSlideId(newSlides[0]?.id || null);
        }
      };

      // â”€â”€ Canvas block helpers â”€â”€
      const _saveBlocks = async (blocks) => {
        const pId = activePresentationIdRef.current;
        const sId = editingSlideIdRef.current;
        if (!pId || !sId) return;
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const ns = pres.slides.map(s => s.id === sId ? { ...s, blocks } : s);
        await saveSlidesToPres(pId, ns);
      };
      const addBlock = (type) => {
        const uid = Date.now().toString(36) + Math.random().toString(36).slice(2);
        const defs = {
          text:      { type:'text',    x:10, y:40, w:45, h:15, text:'Text box', fontSize:16, fontWeight:'normal', fontStyle:'normal', color:'#e0e6ed', textAlign:'left', background:'transparent', eventId:null, eventField:null },
          heading:   { type:'heading', x:5,  y:8,  w:88, h:20, text:'Heading',  fontSize:36, fontWeight:'bold',   fontStyle:'normal', color:'#ffffff',  textAlign:'left', background:'transparent', eventId:null, eventField:null },
          image:     { type:'image',   x:55, y:20, w:38, h:55, imageUrl:'', imageFit:'cover', eventId:null, eventField:null },
          callout:   { type:'callout', x:8,  y:35, w:55, h:18, text:'Key insight or quote...', fontSize:15, fontWeight:'normal', fontStyle:'italic', color:'#f0f4ff', accentColor:'#f59e0b', background:'rgba(245,158,11,0.08)', eventId:null, eventField:null },
          rectangle: { type:'shape', x:20, y:25, w:25, h:30, shapeType:'rectangle', fill:'#3b82f6', stroke:'transparent', strokeWidth:0, radius:8 },
          circle:    { type:'shape', x:20, y:25, w:25, h:30, shapeType:'circle',    fill:'#8b5cf6', stroke:'transparent', strokeWidth:0, radius:0 },
          triangle:  { type:'shape', x:20, y:25, w:25, h:30, shapeType:'triangle',  fill:'#10b981', stroke:'transparent', strokeWidth:0, radius:0 },
          diamond:   { type:'shape', x:20, y:25, w:25, h:30, shapeType:'diamond',   fill:'#f59e0b', stroke:'transparent', strokeWidth:0, radius:0 },
          line:      { type:'shape', x:10, y:48, w:45, h:8,  shapeType:'line',      fill:'#60a5fa', stroke:'transparent', strokeWidth:2, radius:0 },
          arrow:     { type:'shape', x:10, y:48, w:45, h:8,  shapeType:'arrow',     fill:'#60a5fa', stroke:'transparent', strokeWidth:2, radius:0 },
          star:      { type:'shape', x:20, y:20, w:25, h:30, shapeType:'star',      fill:'#fbbf24', stroke:'transparent', strokeWidth:0, radius:0 },
          hexagon:   { type:'shape', x:20, y:20, w:25, h:30, shapeType:'hexagon',   fill:'#06b6d4', stroke:'transparent', strokeWidth:0, radius:0 },
        };
        const nb = { id: uid, ...defs[type] };
        const updated = [...liveBlocksRef.current, nb];
        setLiveBlocks(updated);
        setSelectedBlockId(uid);
        _saveBlocks(updated);
      };
      const removeBlock = (blockId) => {
        const updated = liveBlocksRef.current.filter(b => b.id !== blockId);
        setLiveBlocks(updated);
        setSelectedBlockId(null);
        _saveBlocks(updated);
      };
      const updateBlock = (blockId, changes) => {
        const updated = liveBlocksRef.current.map(b => b.id === blockId ? { ...b, ...changes } : b);
        setLiveBlocks(updated);
        _saveBlocks(updated);
      };

      // â”€â”€ Presentation themes & gradient presets â”€â”€
      const SLIDE_THEMES = [
        // â”€â”€ 1. Classic Archivist (The Scholar) â”€â”€
        // Double-line border frame + L-shaped corner flourishes. Formal, symmetrical.
        {
          id:'classic_archivist', label:'Classic Archivist',
          bg:'#FDF5E6', swatch:'#FDF5E6',
          textColor:'#3E2723', headingColor:'#3E2723', accentColor:'#5D4037',
          decorations:[
            // Outer border (stroke-only rectangle)
            {shapeType:'rectangle',fill:'transparent',stroke:'#5D4037',strokeWidth:2,x:1.5,y:1.5,w:97,h:97},
            // Inner border (thinner)
            {shapeType:'rectangle',fill:'transparent',stroke:'#8D6E63',strokeWidth:1,x:3,y:3,w:94,h:94},
            // Corner flourish â€” Top-Left (L-shape: horizontal + vertical bar)
            {shapeType:'rectangle',fill:'#5D4037',x:1.5,y:1.5,w:11,h:0.55},
            {shapeType:'rectangle',fill:'#5D4037',x:1.5,y:1.5,w:0.55,h:9},
            // Corner flourish â€” Top-Right
            {shapeType:'rectangle',fill:'#5D4037',x:87.5,y:1.5,w:11,h:0.55},
            {shapeType:'rectangle',fill:'#5D4037',x:97.95,y:1.5,w:0.55,h:9},
            // Corner flourish â€” Bottom-Left
            {shapeType:'rectangle',fill:'#5D4037',x:1.5,y:97.95,w:11,h:0.55},
            {shapeType:'rectangle',fill:'#5D4037',x:1.5,y:89.5,w:0.55,h:9},
            // Corner flourish â€” Bottom-Right
            {shapeType:'rectangle',fill:'#5D4037',x:87.5,y:97.95,w:11,h:0.55},
            {shapeType:'rectangle',fill:'#5D4037',x:97.95,y:89.5,w:0.55,h:9},
          ]
        },

        // â”€â”€ 2. Modern Minimalist (The Gallery) â”€â”€
        // Asymmetric single accent line on the left. Massive white space. No borders.
        {
          id:'modern_minimalist', label:'Modern Minimalist',
          bg:'#FFFFFF', swatch:'#FFFFFF',
          textColor:'#1A1A1A', headingColor:'#000000', accentColor:'#007AFF',
          decorations:[
            // Vertical accent bar far left
            {shapeType:'rectangle',fill:'#007AFF',x:5,y:12,w:0.45,h:56},
            // Thin horizontal accent line extending right from the bar
            {shapeType:'rectangle',fill:'#007AFF',x:5,y:12,w:28,h:0.45},
            // Small square "dot" punctuation at line end
            {shapeType:'rectangle',fill:'#007AFF',x:32.5,y:11,w:1.8,h:2.5},
          ]
        },

        // â”€â”€ 3. Midnight Tech (The Data Stream) â”€â”€
        // HUD-style: dark glass panel + neon cyan corner brackets + scan line.
        {
          id:'midnight_tech', label:'Midnight Tech',
          bg:'#0B0E14', swatch:'#0B0E14',
          textColor:'#E0F7FA', headingColor:'#00F2FF', accentColor:'#00F2FF',
          decorations:[
            // Dark glass panel behind upper content zone (semi-transparent)
            {shapeType:'rectangle',fill:'#000D1A',x:2,y:2,w:96,h:60,opacity:60},
            // HUD corner bracket â€” Top-Left
            {shapeType:'rectangle',fill:'#00F2FF',x:0,y:0,w:6.5,h:0.5},
            {shapeType:'rectangle',fill:'#00F2FF',x:0,y:0,w:0.45,h:9},
            // HUD corner bracket â€” Top-Right
            {shapeType:'rectangle',fill:'#00F2FF',x:93.5,y:0,w:6.5,h:0.5},
            {shapeType:'rectangle',fill:'#00F2FF',x:99.55,y:0,w:0.45,h:9},
            // HUD corner bracket â€” Bottom-Left
            {shapeType:'rectangle',fill:'#00F2FF',x:0,y:99.5,w:6.5,h:0.5},
            {shapeType:'rectangle',fill:'#00F2FF',x:0,y:91,w:0.45,h:9},
            // HUD corner bracket â€” Bottom-Right
            {shapeType:'rectangle',fill:'#00F2FF',x:93.5,y:99.5,w:6.5,h:0.5},
            {shapeType:'rectangle',fill:'#00F2FF',x:99.55,y:91,w:0.45,h:9},
            // Horizontal scan line at panel base
            {shapeType:'rectangle',fill:'#00F2FF',x:0,y:62,w:100,h:0.2,opacity:45},
          ]
        },

        // â”€â”€ 4. Royal Heritage (The Epic) â”€â”€
        // Heavy 20%-wide gold sidebar. Gold accent separators. Top/bottom trim bars.
        {
          id:'royal_heritage', label:'Royal Heritage',
          bg:'#800000', swatch:'#800000',
          textColor:'#FFF8E1', headingColor:'#D4AF37', accentColor:'#D4AF37',
          decorations:[
            // Heavy gold sidebar (20% of slide width)
            {shapeType:'rectangle',fill:'#D4AF37',x:0,y:0,w:20,h:100},
            // Deep burgundy inset panel inside sidebar (creates layered depth)
            {shapeType:'rectangle',fill:'#6B0000',x:1,y:1,w:17.5,h:98},
            // Thin gold re-border on inset (inner glow edge)
            {shapeType:'rectangle',fill:'transparent',stroke:'#D4AF37',strokeWidth:1,x:2,y:2,w:15.5,h:96},
            // Gold top trim bar (full width)
            {shapeType:'rectangle',fill:'#D4AF37',x:0,y:0,w:100,h:1.2},
            // Gold bottom trim bar (full width)
            {shapeType:'rectangle',fill:'#D4AF37',x:0,y:98.8,w:100,h:1.2},
            // Gold "Gold Leaf" accent separator lines in content area
            {shapeType:'rectangle',fill:'#D4AF37',x:23,y:34,w:74,h:0.45},
            {shapeType:'rectangle',fill:'#D4AF37',x:23,y:64,w:74,h:0.45},
          ]
        },

        // â”€â”€ 5. Industrial (The Blueprint) â”€â”€
        // Top-heavy: thick orange bar covers top 30% (title zone). Grid lines below.
        {
          id:'industrial', label:'Industrial',
          bg:'#2F4F4F', swatch:'#2F4F4F',
          textColor:'#E8E8E8', headingColor:'#FFFFFF', accentColor:'#FF8C00',
          decorations:[
            // Thick top bar â€” title zone (30% of slide height)
            {shapeType:'rectangle',fill:'#FF8C00',x:0,y:0,w:100,h:30},
            // Dark shadow bar beneath it (depth effect)
            {shapeType:'rectangle',fill:'#CC6600',x:0,y:30,w:100,h:2.2},
            // Secondary thin orange rule
            {shapeType:'rectangle',fill:'#FF8C00',x:0,y:33,w:100,h:0.9},
            // Vertical alignment guide (far left grid line)
            {shapeType:'rectangle',fill:'#FF8C00',x:5,y:33,w:0.4,h:64,opacity:30},
          ]
        },

        // â”€â”€ 6. The Newsroom (The Headline) â”€â”€
        // "Lower Thirds" red bar at bottom. Title sits in a solid red highlight box at top.
        {
          id:'the_newsroom', label:'The Newsroom',
          bg:'#FFFFFF', swatch:'#FFFFFF',
          textColor:'#1A1A1A', headingColor:'#FFFFFF', accentColor:'#CE1126',
          decorations:[
            // Title highlight box â€” "news ticker" style, top
            {shapeType:'rectangle',fill:'#CE1126',x:0,y:0,w:68,h:19},
            // Black accent block beside title box (channel logo area)
            {shapeType:'rectangle',fill:'#111111',x:68,y:0,w:5,h:19},
            // Thin black rule separating title band from body
            {shapeType:'rectangle',fill:'#111111',x:0,y:19,w:100,h:0.5},
            // Lower third bar at bottom
            {shapeType:'rectangle',fill:'#CE1126',x:0,y:82,w:100,h:18},
            // Thin black rule above lower third
            {shapeType:'rectangle',fill:'#111111',x:0,y:81.5,w:100,h:0.5},
          ]
        },

        // â”€â”€ 7. Earth Exploration (The Field Journal) â”€â”€
        // Large faint "compass" circle. Rounded frame. Organic feel.
        {
          id:'earth_exploration', label:'Earth Exploration',
          bg:'#2D5A27', swatch:'#2D5A27',
          textColor:'#C2B280', headingColor:'#F5ECD7', accentColor:'#C2B280',
          decorations:[
            // Large semi-transparent compass/map circle (organic focal point)
            {shapeType:'circle',fill:'#C2B280',x:18,y:-18,w:72,h:136,opacity:11},
            // Outer rounded frame
            {shapeType:'rectangle',fill:'transparent',stroke:'#C2B280',strokeWidth:1.5,x:3,y:3,w:94,h:94,radius:16},
            // Inner rounded frame (subtle)
            {shapeType:'rectangle',fill:'transparent',stroke:'#8B7355',strokeWidth:0.6,x:5,y:5,w:90,h:90,radius:13},
          ]
        },

        // â”€â”€ 8. Bold Impact (The Poster) â”€â”€
        // Large black diagonal triangle covering bottom-left ~1/3. Aggressive geometry.
        {
          id:'bold_impact', label:'Bold Impact',
          bg:'#FFEF00', swatch:'#FFEF00',
          textColor:'#000000', headingColor:'#000000', accentColor:'#000000',
          decorations:[
            // Large right-angle diagonal triangle â€” bottom-left (extends slightly off-canvas, clipped)
            {shapeType:'triangle',fill:'#000000',x:-4,y:36,w:58,h:64},
            // Bold accent rectangle â€” top-right corner
            {shapeType:'rectangle',fill:'#000000',x:84,y:2,w:14,h:6},
            // Thin black rule under the accent rect
            {shapeType:'rectangle',fill:'#000000',x:84,y:8.5,w:14,h:0.5},
          ]
        },
      ];
      const GRAD_PRESETS = [
        'linear-gradient(135deg,#080d22 0%,#1a0533 100%)',
        'linear-gradient(135deg,#0d1b2e 0%,#1e3a5f 100%)',
        'linear-gradient(135deg,#0a0a0a 0%,#1a1a2e 100%)',
        'linear-gradient(135deg,#1a0608 0%,#3a0d20 100%)',
        'linear-gradient(135deg,#0d2118 0%,#1a3a2a 100%)',
        'linear-gradient(135deg,#0f2027 0%,#2c5364 100%)',
        'linear-gradient(135deg,#1a120a 0%,#3d2b1f 100%)',
        'linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%)',
      ];

      // â”€â”€ Shape SVG renderer â”€â”€
      const renderShapeSVG = (block) => {
        const {shapeType='rectangle', fill='#3b82f6', stroke='transparent', strokeWidth=0, radius=0} = block;
        const s = strokeWidth||0, vb = 100;
        const commonSvg = (children) => (
          <svg viewBox={`0 0 ${vb} ${vb}`} preserveAspectRatio="none" style={{width:'100%',height:'100%',display:'block',overflow:'visible'}}>
            {children}
          </svg>
        );
        if (shapeType==='circle') return commonSvg(<ellipse cx={50} cy={50} rx={50-s} ry={50-s} fill={fill} stroke={stroke} strokeWidth={s*2}/>);
        if (shapeType==='triangle') return commonSvg(<polygon points={`50,${s} ${vb-s},${vb-s} ${s},${vb-s}`} fill={fill} stroke={stroke} strokeWidth={s}/>);
        if (shapeType==='diamond') return commonSvg(<polygon points={`50,${s} ${vb-s},50 50,${vb-s} ${s},50`} fill={fill} stroke={stroke} strokeWidth={s}/>);
        if (shapeType==='line') return commonSvg(<line x1={0} y1={50} x2={vb} y2={50} stroke={fill} strokeWidth={Math.max(s*2,3)} strokeLinecap="round"/>);
        if (shapeType==='arrow') return commonSvg(<>
          <defs><marker id={`ah-${block.id}`} markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill={fill}/></marker></defs>
          <line x1={5} y1={50} x2={88} y2={50} stroke={fill} strokeWidth={Math.max(s*2,3)} markerEnd={`url(#ah-${block.id})`}/>
        </>);
        if (shapeType==='star') {
          const pts = Array.from({length:10},(_,i)=>{const a=Math.PI/5*i-Math.PI/2;const r=i%2===0?48:22;return`${50+r*Math.cos(a)},${50+r*Math.sin(a)}`;}).join(' ');
          return commonSvg(<polygon points={pts} fill={fill} stroke={stroke} strokeWidth={s}/>);
        }
        if (shapeType==='hexagon') {
          const pts = Array.from({length:6},(_,i)=>{const a=Math.PI/3*i-Math.PI/6;return`${50+(50-s)*Math.cos(a)},${50+(50-s)*Math.sin(a)}`;}).join(' ');
          return commonSvg(<polygon points={pts} fill={fill} stroke={stroke} strokeWidth={s}/>);
        }
        // default: rectangle
        return commonSvg(<rect x={s/2} y={s/2} width={vb-s} height={vb-s} rx={radius||0} fill={fill} stroke={stroke} strokeWidth={s}/>);
      };

      // â”€â”€ Duplicate / z-order block helpers â”€â”€
      const duplicateBlock = () => {
        if(!selectedBlockId) return;
        const src = liveBlocksRef.current.find(b=>b.id===selectedBlockId);
        if(!src) return;
        const uid = Date.now().toString(36)+Math.random().toString(36).slice(2);
        const nb = {...src, id:uid, x:Math.min(src.x+3, 90), y:Math.min(src.y+3, 90)};
        const updated = [...liveBlocksRef.current, nb];
        setLiveBlocks(updated); setSelectedBlockId(uid); _saveBlocks(updated);
      };
      const moveBlockZ = (dir) => {
        if(!selectedBlockId) return;
        const arr = [...liveBlocksRef.current];
        const idx = arr.findIndex(b=>b.id===selectedBlockId);
        if(idx<0) return;
        if(dir==='front') { const [b]=arr.splice(idx,1); arr.push(b); }
        else if(dir==='back') { const [b]=arr.splice(idx,1); arr.unshift(b); }
        else if(dir==='fwd'&&idx<arr.length-1) { [arr[idx],arr[idx+1]]=[arr[idx+1],arr[idx]]; }
        else if(dir==='bwd'&&idx>0) { [arr[idx],arr[idx-1]]=[arr[idx-1],arr[idx]]; }
        setLiveBlocks(arr); _saveBlocks(arr);
      };
      const _makeThemeDecoBlocks = (theme) => {
        const genId = () => Date.now().toString(36)+Math.random().toString(36).slice(2)+'td';
        return (theme.decorations||[]).map(spec => ({
          id: genId(), type:'shape',
          shapeType: spec.shapeType||'rectangle',
          fill: spec.fill||'transparent',
          stroke: spec.stroke||'transparent',
          strokeWidth: spec.strokeWidth||0,
          radius: spec.radius||0,
          x:spec.x, y:spec.y, w:spec.w, h:spec.h,
          opacity: spec.opacity!=null ? spec.opacity : 100,
          isThemeDecoration: true,
        }));
      };
      const applyThemeToPresentation = (pId, themeId) => {
        const pres = presentations.find(p=>p.id===pId); if(!pres) return;
        const theme = SLIDE_THEMES.find(t=>t.id===themeId); if(!theme) return;
        const ns = pres.slides.map(s => {
          const nonDeco = (s.blocks||[]).filter(b=>!b.isThemeDecoration);
          const decoBlocks = _makeThemeDecoBlocks(theme);
          const blocks = [...decoBlocks, ...nonDeco.map(b => {
            if (b.type==='heading') return {...b, color:theme.headingColor};
            if (b.type==='text') return {...b, color:theme.textColor};
            return b;
          })];
          return {...s, bg:theme.bg, blocks};
        });
        saveSlidesToPres(pId, ns);
        setPresThemeMap(prev => ({...prev, [pId]: themeId}));
        // Immediately refresh liveBlocks so the canvas updates without needing a slide switch
        if (activePresentationIdRef.current === pId && editingSlideIdRef.current) {
          const cur = ns.find(s => s.id === editingSlideIdRef.current);
          if (cur) setLiveBlocks(cur.blocks || []);
        }
      };
      const clearThemeDecorations = (pId) => {
        const pres = presentations.find(p=>p.id===pId); if(!pres) return;
        const ns = pres.slides.map(s=>({...s, blocks:(s.blocks||[]).filter(b=>!b.isThemeDecoration)}));
        saveSlidesToPres(pId, ns);
        setPresThemeMap(prev => { const n={...prev}; delete n[pId]; return n; });
        // Refresh liveBlocks if currently editing a slide in this presentation
        if (activePresentationIdRef.current === pId && editingSlideIdRef.current) {
          const cur = ns.find(s => s.id === editingSlideIdRef.current);
          if (cur) setLiveBlocks(cur.blocks || []);
        }
      };

      // â”€â”€ Export helpers â”€â”€
      const _hexNoHash = (c) => {
        if (!c) return 'FFFFFF';
        if (c.startsWith('#')) return c.slice(1).toUpperCase().padStart(6,'0');
        const m = c.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (m) return [parseInt(m[1]),parseInt(m[2]),parseInt(m[3])].map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase();
        return 'CCCCCC';
      };

      const buildSlideEl = (slide, W=1280, H=720) => {
        const el = document.createElement('div');
        el.style.cssText = `position:fixed;left:-9999px;top:-9999px;width:${W}px;height:${H}px;overflow:hidden;font-family:Karla,sans-serif;`;
        el.style.background = slide.bg || '#0a0d1e';
        const svgNs = 'http://www.w3.org/2000/svg';
        const makeSvgEl = (tag, attrs) => {
          const e2 = document.createElementNS(svgNs,tag);
          Object.entries(attrs).forEach(([k,v])=>e2.setAttribute(k,String(v)));
          return e2;
        };
        (slide.blocks || []).forEach(block => {
          const b = document.createElement('div');
          b.style.cssText = `position:absolute;left:${block.x}%;top:${block.y}%;width:${block.w}%;height:${block.h}%;box-sizing:border-box;overflow:hidden;`;
          if (block.type === 'image') {
            if (block.imageUrl) {
              const img = document.createElement('img');
              img.src = block.imageUrl; img.crossOrigin = 'anonymous';
              img.style.cssText = `width:100%;height:100%;object-fit:${block.imageFit||'cover'};display:block;`;
              b.appendChild(img);
            }
          } else if (block.type === 'shape') {
            const {shapeType='rectangle',fill='#3b82f6',stroke='transparent',strokeWidth=0,radius=0,opacity} = block;
            b.style.opacity = opacity != null ? opacity/100 : 1;
            const svg = document.createElementNS(svgNs,'svg');
            svg.setAttribute('viewBox','0 0 100 100'); svg.setAttribute('preserveAspectRatio','none');
            svg.style.cssText = 'width:100%;height:100%;display:block;overflow:visible;';
            const s = strokeWidth||0;
            if(shapeType==='circle'){svg.appendChild(makeSvgEl('ellipse',{cx:50,cy:50,rx:50-s,ry:50-s,fill,stroke,'stroke-width':s*2}));}
            else if(shapeType==='triangle'){svg.appendChild(makeSvgEl('polygon',{points:`50,${s} ${100-s},${100-s} ${s},${100-s}`,fill,stroke,'stroke-width':s}));}
            else if(shapeType==='diamond'){svg.appendChild(makeSvgEl('polygon',{points:`50,${s} ${100-s},50 50,${100-s} ${s},50`,fill,stroke,'stroke-width':s}));}
            else if(shapeType==='star'){const pts=[];for(let i=0;i<10;i++){const a=(i*Math.PI/5)-(Math.PI/2),r=i%2===0?50-s:22;pts.push(`${50+r*Math.cos(a)},${50+r*Math.sin(a)}`);}svg.appendChild(makeSvgEl('polygon',{points:pts.join(' '),fill,stroke,'stroke-width':s}));}
            else if(shapeType==='hexagon'){const pts=[];for(let i=0;i<6;i++){const a=(i*Math.PI/3)-(Math.PI/6);pts.push(`${50+(50-s)*Math.cos(a)},${50+(50-s)*Math.sin(a)}`);}svg.appendChild(makeSvgEl('polygon',{points:pts.join(' '),fill,stroke,'stroke-width':s}));}
            else if(shapeType==='line'){svg.appendChild(makeSvgEl('line',{x1:0,y1:50,x2:100,y2:50,stroke:fill,'stroke-width':Math.max(s*2,3),'stroke-linecap':'round'}));}
            else if(shapeType==='arrow'){const defs=document.createElementNS(svgNs,'defs'),mkr=document.createElementNS(svgNs,'marker');mkr.setAttribute('id','ah-x');mkr.setAttribute('viewBox','0 0 8 6');mkr.setAttribute('refX',8);mkr.setAttribute('refY',3);mkr.setAttribute('markerWidth',4);mkr.setAttribute('markerHeight',4);mkr.setAttribute('orient','auto');const poly=document.createElementNS(svgNs,'polygon');poly.setAttribute('points','0 0, 8 3, 0 6');poly.setAttribute('fill',fill);mkr.appendChild(poly);defs.appendChild(mkr);svg.appendChild(defs);svg.appendChild(makeSvgEl('line',{x1:5,y1:50,x2:88,y2:50,stroke:fill,'stroke-width':Math.max(s*2,3),'stroke-linecap':'round','marker-end':'url(#ah-x)'}));}
            else{svg.appendChild(makeSvgEl('rect',{x:s/2,y:s/2,width:100-s,height:100-s,rx:radius||0,fill,stroke,'stroke-width':s}));}
            b.appendChild(svg);
          } else if (block.type === 'callout') {
            b.style.cssText += `display:flex;align-items:stretch;gap:4%;padding:2% 3%;background:${block.background||'rgba(245,158,11,0.08)'};`;
            const accent=document.createElement('div'); accent.style.cssText=`width:3px;flex-shrink:0;border-radius:2px;background:${block.accentColor||'#f59e0b'};`; b.appendChild(accent);
            const txt=document.createElement('div'); txt.style.cssText=`flex:1;color:${block.color||'#f0f4ff'};font-size:${block.fontSize||15}px;font-weight:${block.fontWeight||'normal'};font-style:${block.fontStyle||'italic'};text-align:${block.textAlign||'left'};line-height:1.45;white-space:pre-wrap;word-break:break-word;`; txt.textContent=block.text||''; b.appendChild(txt);
          } else if (block.type === 'tags') {
            b.style.cssText += `display:flex;flex-direction:column;gap:0.45em;padding:4% 5%;font-size:${(W/1280)*13}px;`;
            const addSec=(items,color,bg,border,label)=>{if(!items||!items.length)return;const lbl=document.createElement('div');lbl.style.cssText=`color:${color};font-weight:700;font-size:0.72em;letter-spacing:0.8px;text-transform:uppercase;margin-bottom:0.1em;`;lbl.textContent=label;b.appendChild(lbl);const row=document.createElement('div');row.style.cssText='display:flex;flex-wrap:wrap;gap:0.3em;margin-bottom:0.25em;';items.forEach(item=>{const pill=document.createElement('span');pill.style.cssText=`padding:0.15em 0.55em;border-radius:4px;background:${bg};color:${color};border:1px solid ${border};font-size:0.9em;white-space:nowrap;`;pill.textContent=item;row.appendChild(pill);});b.appendChild(row);};
            addSec(block.topics,'#c4b5fd','rgba(124,58,237,0.2)','rgba(124,58,237,0.3)','Topics');
            addSec(block.people,'#93c5fd','rgba(96,165,250,0.15)','rgba(96,165,250,0.3)','People');
            addSec(block.orgs,'#6ee7b7','rgba(16,185,129,0.15)','rgba(16,185,129,0.3)','Organizations');
          } else if (block.type === 'sources') {
            b.style.cssText += `display:flex;align-items:center;gap:0.6em;flex-wrap:wrap;padding:0 3%;border-top:1px solid rgba(96,165,250,0.12);`;
            (block.items||[]).forEach(item=>{const pill=document.createElement('div');pill.style.cssText=`padding:0.2em 0.85em;border-radius:6px;${item.eventId?'background:rgba(96,165,250,0.15);border:1px solid rgba(96,165,250,0.4);color:#93c5fd;':'background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.35);color:#6ee7b7;'}font-size:${(W/1280)*12}px;font-weight:600;`;pill.textContent=(item.eventId?'â†’ ':'ðŸ”— ')+(item.label||'');b.appendChild(pill);});
          } else {
            b.style.cssText += `display:flex;align-items:flex-start;padding:2% 3%;background:${block.background||'transparent'};`;
            const txt=document.createElement('div');
            txt.style.cssText=`font-size:${block.fontSize||(block.type==='heading'?32:16)}px;font-weight:${block.fontWeight||(block.type==='heading'?700:400)};font-style:${block.fontStyle||'normal'};color:${block.color||'#e0e6ed'};text-align:${block.textAlign||'left'};line-height:1.45;white-space:pre-wrap;word-break:break-word;width:100%;`;
            txt.textContent=block.text||''; b.appendChild(txt);
          }
          el.appendChild(b);
        });
        document.body.appendChild(el);
        return el;
      };

      const captureSlide = async (slide, W=1280, H=720, mime='image/png') => {
        const el = buildSlideEl(slide, W, H);
        try {
          const canvas = await window.html2canvas(el, {width:W, height:H, scale:1, useCORS:true, allowTaint:true, backgroundColor:null, logging:false});
          return canvas.toDataURL(mime, mime==='image/jpeg'?0.92:1);
        } finally {
          if (el.parentNode) el.parentNode.removeChild(el);
        }
      };

      const exportAsPptx = async (pres) => {
        const PptxGenJS = window.PptxGenJS;
        if (!PptxGenJS) { alert('PptxGenJS library not loaded yet. Please wait a moment and try again.'); return; }
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        const W_IN=10, H_IN=5.625;
        const PPTX_SHAPE_MAP = {rectangle:'rect',circle:'ellipse',triangle:'triangle',diamond:'diamond',line:'line',arrow:'rightArrow',star:'star5Point',hexagon:'hexagon'};
        for (const slide of pres.slides) {
          const pSlide = pptx.addSlide();
          const bg = slide.bg || '#0a0d1e';
          if (bg.startsWith('#')) { pSlide.background = {color: _hexNoHash(bg)}; }
          else if (bg.startsWith('linear-gradient')) { const m=bg.match(/#[0-9a-fA-F]{3,8}/g); if(m) pSlide.background={color:_hexNoHash(m[0])}; }
          else { pSlide.background = {color:'0A0D1E'}; }
          for (const block of (slide.blocks||[])) {
            const ox=(block.x/100)*W_IN, oy=(block.y/100)*H_IN, ow=(block.w/100)*W_IN, oh=(block.h/100)*H_IN;
            try {
              if (block.type==='image' && block.imageUrl) {
                pSlide.addImage({x:ox,y:oy,w:ow,h:oh,data:block.imageUrl,sizing:{type:block.imageFit==='contain'?'contain':'crop',w:ow,h:oh}});
              } else if (block.type==='shape') {
                const shType = PPTX_SHAPE_MAP[block.shapeType||'rectangle']||'rect';
                const shFill = (!block.fill||block.fill==='transparent'||block.fill==='none') ? {type:'none'} : {color:_hexNoHash(block.fill)};
                const shLine = block.strokeWidth>0 ? {color:_hexNoHash(block.stroke||'#000000'),width:block.strokeWidth} : {type:'none'};
                // Use roundRect for rectangles with a radius, otherwise use the mapped shape
                if (shType==='rect' && block.radius>0) {
                  pSlide.addShape('roundRect', {x:ox,y:oy,w:ow,h:oh,fill:shFill,line:shLine,rectRadius:Math.min(block.radius/200,0.5)});
                } else {
                  pSlide.addShape(pptx.ShapeType[shType]||shType, {x:ox,y:oy,w:ow,h:oh,fill:shFill,line:shLine});
                }
              } else if (block.type==='callout') {
                const barW = Math.max(ow*0.008,0.03);
                pSlide.addShape(pptx.ShapeType.rect||'rect', {x:ox,y:oy,w:barW,h:oh,fill:{color:_hexNoHash(block.accentColor||'#f59e0b')},line:{type:'none'}});
                pSlide.addText(block.text||'', {x:ox+barW+0.05,y:oy,w:ow-barW-0.05,h:oh,color:_hexNoHash(block.color||'#f0f4ff'),fontSize:block.fontSize||15,bold:block.fontWeight==='bold',italic:block.fontStyle==='italic'||(block.fontWeight!=='bold'&&block.fontStyle!=='normal'),wrap:true,valign:'middle',shrinkText:true});
              } else if (block.type==='tags') {
                const lines=[];
                if(block.topics?.length) lines.push({text:'TOPICS\n',options:{bold:true,color:'A78BFA',fontSize:9}},{text:block.topics.join(', ')+'\n\n',options:{color:'C4B5FD',fontSize:11}});
                if(block.people?.length) lines.push({text:'PEOPLE\n',options:{bold:true,color:'60A5FA',fontSize:9}},{text:block.people.join(', ')+'\n\n',options:{color:'93C5FD',fontSize:11}});
                if(block.orgs?.length) lines.push({text:'ORGANIZATIONS\n',options:{bold:true,color:'34D399',fontSize:9}},{text:block.orgs.join(', '),options:{color:'6EE7B7',fontSize:11}});
                if(lines.length) pSlide.addText(lines,{x:ox,y:oy,w:ow,h:oh,wrap:true,valign:'top',shrinkText:true});
              } else if (block.type==='sources') {
                const labels=(block.items||[]).map(item=>(item.eventId?'â†’ ':'ðŸ”— ')+(item.label||'')).join('  |  ');
                if(labels) pSlide.addText(labels,{x:ox,y:oy,w:ow,h:oh,color:'93C5FD',fontSize:10,wrap:true,valign:'middle',shrinkText:true});
              } else if (block.type==='text'||block.type==='heading') {
                pSlide.addText(block.text||'',{x:ox,y:oy,w:ow,h:oh,color:_hexNoHash(block.color||(block.type==='heading'?'#ffffff':'#e0e6ed')),fontSize:block.fontSize||(block.type==='heading'?32:16),bold:block.fontWeight==='bold'||block.type==='heading',italic:block.fontStyle==='italic',align:block.textAlign||'left',wrap:true,valign:'top',shrinkText:true});
              }
            } catch(e) { console.warn('PPTX block error:', e); }
          }
        }
        await pptx.writeFile({fileName:`${pres.name.replace(/[^a-z0-9]/gi,'_')}.pptx`});
      };

      const exportAsPdf = async (pres) => {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) { alert('jsPDF not loaded'); return; }
        if (!window.html2canvas) { alert('html2canvas not loaded yet. Please try again in a moment.'); return; }
        const W=1280, H=720;
        const pdf = new jsPDF({orientation:'landscape', unit:'px', format:[W,H], hotfixes:['px_scaling']});
        for (let i=0; i<pres.slides.length; i++) {
          setExportProgress(i+1);
          if (i>0) pdf.addPage([W,H],'landscape');
          const dataUrl = await captureSlide(pres.slides[i], W, H, 'image/jpeg');
          pdf.addImage(dataUrl,'JPEG',0,0,W,H);
        }
        pdf.save(`${pres.name.replace(/[^a-z0-9]/gi,'_')}.pdf`);
      };

      const exportAsImages = async (pres, format) => {
        if (!window.html2canvas) { alert('html2canvas not loaded yet. Please try again in a moment.'); return; }
        const mime = format==='jpeg'?'image/jpeg':'image/png';
        for (let i=0; i<pres.slides.length; i++) {
          setExportProgress(i+1);
          const dataUrl = await captureSlide(pres.slides[i], 1280, 720, mime);
          const a = document.createElement('a');
          a.href=dataUrl; a.download=`${pres.name.replace(/[^a-z0-9]/gi,'_')}_slide${i+1}.${format}`;
          a.click();
          await new Promise(r=>setTimeout(r,350));
        }
      };

      const exportPresentation = async (format) => {
        const pres = presentations.find(p=>p.id===activePresentationId);
        if (!pres||!pres.slides?.length) return;
        setIsExporting(true); setExportProgress(0); setExportTotal(pres.slides.length); setShowExportModal(false);
        try {
          if (format==='pptx') await exportAsPptx(pres);
          else if (format==='pdf') await exportAsPdf(pres);
          else await exportAsImages(pres, format);
        } catch(err) {
          console.error('Export failed:',err); alert('Export failed: '+err.message);
        } finally {
          setIsExporting(false); setExportProgress(0);
        }
      };

      // â”€â”€ Canvas drag handlers â”€â”€
      const handleBlockPointerDown = (e, blockId, isResize, handle) => {
        e.preventDefault(); e.stopPropagation();
        const canvas = canvasRef.current;
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const block = liveBlocksRef.current.find(b => b.id === blockId);
        if (!block) return;
        setSelectedBlockId(blockId);
        setCanvasTextEditId(null);
        dragRef.current = {
          blockId, isResize, handle,
          startMX: e.clientX, startMY: e.clientY,
          startProps: { x: block.x, y: block.y, w: block.w, h: block.h },
          canvasW: rect.width, canvasH: rect.height,
          current: null,
          el: canvas.querySelector(`[data-block="${blockId}"]`),
        };
        // Capture on the block/handle element so click/dblclick fire on the block,
        // not the canvas â€” this prevents the canvas onClick from deselecting.
        e.currentTarget.setPointerCapture(e.pointerId);
      };
      const handleCanvasPointerMove = (e) => {
        const d = dragRef.current;
        if (!d) return;
        const dx = (e.clientX - d.startMX) / d.canvasW * 100;
        const dy = (e.clientY - d.startMY) / d.canvasH * 100;
        const { x: sx, y: sy, w: sw, h: sh } = d.startProps;
        let nx = sx, ny = sy, nw = sw, nh = sh;
        if (!d.isResize) {
          nx = Math.max(0, Math.min(100 - sw, sx + dx));
          ny = Math.max(0, Math.min(100 - sh, sy + dy));
        } else {
          const h = d.handle;
          if (h.includes('e')) nw = Math.max(5, sw + dx);
          if (h.includes('w')) { nw = Math.max(5, sw - dx); nx = sx + sw - nw; }
          if (h.includes('s')) nh = Math.max(5, sh + dy);
          if (h.includes('n')) { nh = Math.max(5, sh - dy); ny = sy + sh - nh; }
        }
        d.current = { x: nx, y: ny, w: nw, h: nh };
        if (d.el) { d.el.style.left = `${nx}%`; d.el.style.top = `${ny}%`; d.el.style.width = `${nw}%`; d.el.style.height = `${nh}%`; }
      };
      const handleCanvasPointerUp = () => {
        const d = dragRef.current;
        if (!d || !d.current) { dragRef.current = null; return; }
        const final = d.current;
        dragRef.current = null;
        setLiveBlocks(prev => {
          const updated = prev.map(b => b.id === d.blockId ? { ...b, ...final } : b);
          _saveBlocks(updated);
          return updated;
        });
      };

      // â”€â”€ Image browser â”€â”€
      const openImageBrowser = async (blockId) => {
        setShowImageBrowser(blockId);
        try {
          const [fr, ar] = await Promise.all([fetch(`${API_BASE}/api/frames/`), fetch(`${API_BASE}/api/attachments/`)]);
          const frames = fr.ok ? await fr.json() : [];
          const atts = ar.ok ? await ar.json() : [];
          setImageBrowserFiles([
            ...frames.map(f => ({ url: `${API_BASE}/api/frames/${f}`, name: f, kind: 'frame' })),
            ...atts.map(a => ({ url: `${API_BASE}/api/attachments/${a}`, name: a, kind: 'attachment' })),
          ]);
        } catch { setImageBrowserFiles([]); }
      };

      // â”€â”€ AI Presentation generation â”€â”€
      // selectedSlideIds: optional Set of slide IDs to regenerate (null = regenerate all)
      const generateAiPresentation = async (pId, selectedSlideIds = null) => {
        const pres = presentations.find(p => p.id === pId);
        if (!pres) return;
        const isSelective = selectedSlideIds && selectedSlideIds.size > 0;
        const targetSlides = isSelective ? pres.slides.filter(s => selectedSlideIds.has(s.id)) : pres.slides;
        if (targetSlides.length === 0) { alert('Add at least one slide first, then run AI generation.'); return; }
        const focuses = presAiFocuses.filter(f => f.trim());
        setPresAiLoading(true);
        try {
          // Gather event data from target slides
          const eventIds = [...new Set(targetSlides.flatMap(s => s.blocks.map(b => b.eventId).filter(Boolean)))];
          let eventsPayload = eventIds.map(id => data.events.find(e => e.id === id)).filter(Boolean)
            .map(e => ({ id: e.id, title: e.title, date: e.date, summary: e.aiSummary || e.description, topics: e.topics||[], people: e.people||[], organizations: e.organizations||[] }));
          // Fallback: extract text from target slide blocks (handles previously AI-generated slides)
          if (eventsPayload.length === 0) {
            eventsPayload = targetSlides.map((s, i) => {
              const heading   = s.blocks.find(b => b.type === 'heading');
              const dateBlock = s.blocks.find(b => b.type === 'text' && (b.color === PRES_ACCENT || b.color === '#60a5fa' || b.color === PRES_MUTED));
              const bodyBlocks = s.blocks.filter(b => b.type === 'text' && b.color !== PRES_ACCENT && b.color !== '#60a5fa' && b.color !== PRES_MUTED);
              return { id: `slide-${i}`, title: heading?.text || `Slide ${i+1}`, date: dateBlock?.text || '', summary: bodyBlocks.map(b => b.text||'').join(' ').trim(), topics: [], people: [], organizations: [] };
            }).filter(e => e.title);
          }
          if (eventsPayload.length === 0) { alert('No content found to regenerate from. Add events via the spreadsheet first.'); setPresAiLoading(false); return; }
          // Truncate long summaries to keep payload manageable
          const trimmedPayload = eventsPayload.map(e => ({ ...e, summary: e.summary ? e.summary.slice(0, 800) : '' }));

          // Gather entity profiles for all people/topics/orgs in these events
          const entityProfilesMap = { ...entityProfiles };
          if (supabaseClient) {
            const allNames = [...new Set(trimmedPayload.flatMap(e => [...(e.people||[]), ...(e.topics||[]), ...(e.organizations||[])]))];
            if (allNames.length > 0) {
              const { data: fetchedProfiles } = await supabaseClient.from('entity_profiles').select('*').in('entity_name', allNames);
              if (fetchedProfiles) {
                fetchedProfiles.forEach(p => { entityProfilesMap[`${p.entity_type}:${p.entity_name}`] = p; });
                setEntityProfiles(prev => ({ ...prev, ...entityProfilesMap }));
              }
            }
          }

          const payload = { events: trimmedPayload, focuses, detail_level: presAiDetail, presentation_name: pres.name, entity_profiles: entityProfilesMap };
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 120000);
          let res;
          try {
            res = await fetch(`${API_BASE}/api/generate-presentation`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          } catch (fetchErr) {
            clearTimeout(timeoutId);
            if (fetchErr.name === 'AbortError') throw new Error('Request timed out after 2 minutes. The backend (free tier) takes ~30s to wake up â€” please wait a moment and try again.');
            throw new Error('Failed to reach the backend. Check your connection or try again in ~30 seconds (server may be waking up).');
          }
          clearTimeout(timeoutId);
          if (!res.ok) { const detail = await res.text().catch(()=>''); throw new Error(`Backend returned ${res.status}${detail ? ': ' + detail : ''}`); }
          const result = await res.json();
          if (!result.slides || result.slides.length === 0) throw new Error('Backend returned no slides. The server may have timed out internally â€” please try again.');
          if (result.slides) {
            const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
            let evtIdx = 0;
            const aiSlides = result.slides.map((s) => {
              const isEventSlide = s.layout === 'content' || s.layout === 'overview' || !s.layout;
              const srcIdx = Math.min(evtIdx, eventsPayload.length - 1);
              const srcEvt = data.events.find(e => e.id === eventsPayload[srcIdx]?.id) || null;
              if (isEventSlide) evtIdx++;
              return buildAiSlide(uid, s, srcEvt);
            });
            if (isSelective) {
              // Insert AI slides at the position of the first selected slide, removing selected slides
              const firstIdx = pres.slides.findIndex(s => selectedSlideIds.has(s.id));
              const kept = pres.slides.filter(s => !selectedSlideIds.has(s.id));
              const insertAt = firstIdx >= 0 ? firstIdx : kept.length;
              const newSlides = [...kept.slice(0, insertAt), ...aiSlides, ...kept.slice(insertAt)];
              await saveSlidesToPres(pId, newSlides);
              setPresSelectedSlides(new Set());
              setPresAiSelectMode(false);
            } else {
              await saveSlidesToPres(pId, aiSlides);
            }
            setEditingSlideId(aiSlides[0]?.id || null);
          }
        } catch (err) {
          alert('AI generation failed: ' + err.message);
        }
        setPresAiLoading(false);
      };

      // â”€â”€ Auth functions â”€â”€
      const login = (user) => {
        const session = { username: user.username, role: user.role };
        localStorage.setItem('hdb_session', JSON.stringify(session));
        setCurrentUser(session);
      };
      const logout = () => {
        localStorage.removeItem('hdb_session');
        setCurrentUser(null);
        setAuthScreen('login');
      };

      // â”€â”€ Visibility: what the current user can see â”€â”€
      const visibleEvents = useMemo(() => {
        if (!currentUser) return [];
        if (currentUser.role === 'admin' || currentUser.role === 'owner') return data.events;
        return data.events.filter(e => e.isPublic || e.uploadedBy === currentUser.username);
      }, [data.events, currentUser]);

      // â”€â”€ Event management â”€â”€
      const toggleEventPublic = async (eventId) => {
        const event = data.events.find(e => e.id === eventId);
        if (!event) return;
        const newVal = !event.isPublic;
        const { error } = await supabaseClient.from('events').update({ is_public: newVal }).eq('id', eventId);
        if (error) console.error('Toggle public error:', error);
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, isPublic: newVal } : e) }));
      };
      const updateEventStatus = async (eventId, status) => {
        const { error } = await supabaseClient.from('events').update({ event_status: status }).eq('id', eventId);
        if (error) console.error('Update status error:', error);
        setData(prev => ({ ...prev, events: prev.events.map(e => e.id === eventId ? { ...e, eventStatus: status } : e) }));
      };
      const deleteEvent = async (eventId) => {
        const evtTitle = data.events.find(e => e.id === eventId)?.title || 'event';
        const { error } = await supabaseClient.from('events').delete().eq('id', eventId);
        if (error) { console.error('Delete error:', error); return; }
        createNotification('event_deleted', 'Event Deleted', `"${evtTitle}" was permanently deleted.`);
        setData(prev => {
          const updated = prev.events.filter(e => e.id !== eventId);
          const agg = rebuildAggregates(updated);
          return { ...prev, events: updated, ...agg, metadata:{...prev.metadata, totalEvents:updated.length} };
        });
        setShowModal(false);
      };

      // â”€â”€ User management (admin panel, Supabase-backed) â”€â”€
      const [adminUsers, setAdminUsers] = useState([]);
      const refreshAdminUsers = async () => { const users = await getAllUsers(); setAdminUsers(users); };
      useEffect(() => { refreshAdminUsers(); }, []);
      const updateUserRole = async (username, newRole) => {
        const { error } = await supabaseClient.from('users').update({ role: newRole }).eq('username', username.toLowerCase());
        if (error) { console.error('Update role error:', error); return; }
        setAdminUsers(prev => prev.map(u => u.username === username ? { ...u, role: newRole } : u));
        if (currentUser.username === username) {
          const session = { ...currentUser, role: newRole };
          localStorage.setItem('hdb_session', JSON.stringify(session));
          setCurrentUser(session);
        }
      };
      const deleteUserAccount = async (username) => {
        const { error } = await supabaseClient.from('users').delete().eq('username', username.toLowerCase());
        if (error) { console.error('Delete user error:', error); return; }
        setAdminUsers(prev => prev.filter(u => u.username !== username));
      };

      // â”€â”€ Notification helpers â”€â”€
      const getRelativeTime = (ts) => {
        const diff = Date.now() - new Date(ts).getTime();
        const mins = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        if (mins < 1) return 'just now';
        if (mins < 60) return `${mins}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days === 1) return 'yesterday';
        if (days < 7) return `${days}d ago`;
        return new Date(ts).toLocaleDateString();
      };

      const NOTIF_META = {
        upload_success:  { icon: 'ðŸ“¤', color: '#10b981' },
        upload_error:    { icon: 'âŒ', color: '#ef4444' },
        ai_analysis:     { icon: 'ðŸ¤–', color: '#60a5fa' },
        ai_error:        { icon: 'âš ï¸', color: '#f59e0b' },
        event_saved:     { icon: 'ðŸ’¾', color: '#a78bfa' },
        event_deleted:   { icon: 'ðŸ—‘ï¸', color: '#ef4444' },
        system_health:   { icon: 'ðŸ›¡ï¸', color: '#f59e0b' },
        new_user:        { icon: 'ðŸ‘¤', color: '#10b981' },
        user_role_change:{ icon: 'ðŸ”‘', color: '#a78bfa' },
      };

      const createNotification = async (type, title, message, eventId = null, metadata = {}) => {
        if (!currentUser) return;
        const newNotif = {
          type, title, message,
          created_by: currentUser.username,
          created_by_role: currentUser.role,
          event_id: eventId,
          metadata,
          read_by: [],
          dismissed_by: [],
        };
        const { data: inserted, error } = await supabaseClient.from('notifications').insert([newNotif]).select().single();
        if (error) { console.error('Notification insert error:', error); return; }
        if (inserted) setNotifications(prev => [inserted, ...prev]);
      };

      const loadNotifications = async () => {
        if (!currentUser) return;
        const username = currentUser.username;
        const role = currentUser.role;
        try {
          let query = supabaseClient.from('notifications')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(200)
            .not('dismissed_by', 'cs', `{"${username}"}`);
          if (role === 'user') {
            query = query.eq('created_by', username);
          } else if (role === 'admin') {
            query = query.in('created_by_role', ['admin', 'user']);
          }
          // owner: no role filter â€” sees all
          const { data: rows, error } = await query;
          if (error) throw error;
          if (rows) setNotifications(rows);
          setNotifsLoaded(true);
        } catch (err) {
          console.error('Failed to load notifications:', err);
          setNotifsLoaded(true);
        }
      };

      const markNotificationRead = async (notifId) => {
        if (!currentUser) return;
        const notif = notifications.find(n => n.id === notifId);
        if (!notif || (notif.read_by||[]).includes(currentUser.username)) return;
        const newReadBy = [...(notif.read_by||[]), currentUser.username];
        await supabaseClient.from('notifications').update({ read_by: newReadBy }).eq('id', notifId);
        setNotifications(prev => prev.map(n => n.id === notifId ? {...n, read_by: newReadBy} : n));
      };

      const markAllNotificationsRead = async () => {
        if (!currentUser) return;
        const unread = notifications.filter(n => !(n.read_by||[]).includes(currentUser.username));
        if (unread.length === 0) return;
        await Promise.all(unread.map(n => {
          const newReadBy = [...(n.read_by||[]), currentUser.username];
          return supabaseClient.from('notifications').update({ read_by: newReadBy }).eq('id', n.id);
        }));
        setNotifications(prev => prev.map(n => {
          if (!(n.read_by||[]).includes(currentUser.username)) return {...n, read_by: [...(n.read_by||[]), currentUser.username]};
          return n;
        }));
      };

      const dismissNotification = async (notifId) => {
        if (!currentUser) return;
        const notif = notifications.find(n => n.id === notifId);
        if (!notif) return;
        const newDismissedBy = [...(notif.dismissed_by||[]), currentUser.username];
        await supabaseClient.from('notifications').update({ dismissed_by: newDismissedBy }).eq('id', notifId);
        setNotifications(prev => prev.filter(n => n.id !== notifId));
      };

      const clearAllNotifications = async () => {
        if (!currentUser || notifications.length === 0) return;
        await Promise.all(notifications.map(n => {
          const newDismissedBy = [...(n.dismissed_by||[]), currentUser.username];
          return supabaseClient.from('notifications').update({ dismissed_by: newDismissedBy }).eq('id', n.id);
        }));
        setNotifications([]);
      };

      // Derived: unread count
      const notifUnreadCount = React.useMemo(() => {
        if (!currentUser) return 0;
        return notifications.filter(n => !(n.read_by||[]).includes(currentUser.username)).length;
      }, [notifications, currentUser]);

      // â”€â”€ Filters â”€â”€
      const applySearch = () => setFilters(prev => ({ ...prev, appliedSearch: prev.search }));

      const clearAllFilters = () => setFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });
      const applyMySearch = () => setMyFilters(prev => ({...prev, appliedSearch: prev.search}));
      const clearMyFilters = () => setMyFilters({ search:'', appliedSearch:'', topics:[], researchLevels:[], people:[], organizations:[], dateFrom:'', dateTo:'', showMajorOnly:false });

      const filteredEvents = useMemo(() => {
        return visibleEvents.filter(e => {
          if (filters.showMajorOnly && !e.isMajorEvent) return false;
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            const match = (e.title||'').toLowerCase().includes(s) || (e.description||'').toLowerCase().includes(s) ||
              (e.topics||[]).some(t => t.toLowerCase().includes(s)) ||
              (e.people||[]).some(p => p.toLowerCase().includes(s)) ||
              (e.organizations||[]).some(o => o.toLowerCase().includes(s));
            if (!match) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          if (filters.researchLevels.length > 0 && !filters.researchLevels.includes(String(e.researchLevel))) return false;
          if (filters.dateFrom && e.date && e.date < filters.dateFrom) return false;
          if (filters.dateTo && e.date && e.date > filters.dateTo) return false;
          return true;
        });
      }, [data.events, filters]);

      const sortedEvents = useMemo(() => [...filteredEvents].sort((a,b) => {
        if (!a.date && !b.date) return 0;
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [filteredEvents]);

      const timelineEvents = useMemo(() =>
        filteredEvents.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [filteredEvents]);

      const filteredTopics = useMemo(() =>
        (data.topics||[]).map(t => ({ name:t, count: filteredEvents.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0)
      , [data.topics, filteredEvents]);

      const filteredPeople = useMemo(() =>
        (data.people||[]).map(p => ({ name:p, count: filteredEvents.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0)
      , [data.people, filteredEvents]);

      const filteredOrganizations = useMemo(() =>
        (data.organizations||[]).map(o => ({ name:o, count: filteredEvents.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0)
      , [data.organizations, filteredEvents]);

      const recentUploads = useMemo(() => {
        const cutoff = new Date(Date.now() - recentHoursFilter * 60 * 60 * 1000);
        return visibleEvents
          .filter(e => e.dateUploaded && new Date(e.dateUploaded) >= cutoff)
          .sort((a, b) => new Date(b.dateUploaded) - new Date(a.dateUploaded));
      }, [visibleEvents, recentHoursFilter]);

      const myUploads = useMemo(() =>
        data.events.filter(e => e.uploadedBy === (currentUser ? currentUser.username : '__none__'))
      , [data.events, currentUser]);

      const filteredMyUploads = useMemo(() => {
        return myUploads.filter(e => {
          if (filters.appliedSearch) {
            const s = filters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s)) return false;
          }
          if (filters.topics.length > 0 && !(e.topics||[]).some(t => filters.topics.includes(t))) return false;
          if (filters.people.length > 0 && !(e.people||[]).some(p => filters.people.includes(p))) return false;
          if (filters.organizations.length > 0 && !(e.organizations||[]).some(o => filters.organizations.includes(o))) return false;
          return true;
        });
      }, [myUploads, filters]);

      // â”€â”€ My Uploads scoped memos (for Account page) â”€â”€
      const myFiltered = useMemo(() => {
        return myUploads.filter(e => {
          if (myFilters.showMajorOnly && !e.isMajorEvent) return false;
          if (myFilters.appliedSearch) {
            const s = myFilters.appliedSearch.toLowerCase();
            if (!(e.title||'').toLowerCase().includes(s) && !(e.description||'').toLowerCase().includes(s) &&
                !(e.topics||[]).some(t=>t.toLowerCase().includes(s)) &&
                !(e.people||[]).some(p=>p.toLowerCase().includes(s)) &&
                !(e.organizations||[]).some(o=>o.toLowerCase().includes(s))) return false;
          }
          if (myFilters.topics.length > 0 && !(e.topics||[]).some(t => myFilters.topics.includes(t))) return false;
          if (myFilters.researchLevels.length > 0 && !myFilters.researchLevels.includes(String(e.researchLevel))) return false;
          if (myFilters.people.length > 0 && !(e.people||[]).some(p => myFilters.people.includes(p))) return false;
          if (myFilters.organizations.length > 0 && !(e.organizations||[]).some(o => myFilters.organizations.includes(o))) return false;
          if (myFilters.dateFrom && e.date && new Date(e.date) < new Date(myFilters.dateFrom)) return false;
          if (myFilters.dateTo && e.date && new Date(e.date) > new Date(myFilters.dateTo)) return false;
          return true;
        });
      }, [myUploads, myFilters]);

      const mySortedEvents = useMemo(() => [...myFiltered].sort((a,b) => {
        if (!a.date && !b.date) return 0; if (!a.date) return 1; if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      }), [myFiltered]);

      const myTimelineEvents = useMemo(() =>
        myFiltered.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date))
      , [myFiltered]);

      const myFilteredTopics = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        return all.map(t => ({ name:t, count: myFiltered.filter(e => (e.topics||[]).includes(t)).length })).filter(t => t.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredPeople = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        return all.map(p => ({ name:p, count: myFiltered.filter(e => (e.people||[]).includes(p)).length })).filter(p => p.count > 0);
      }, [myUploads, myFiltered]);

      const myFilteredOrgs = useMemo(() => {
        const all = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        return all.map(o => ({ name:o, count: myFiltered.filter(e => (e.organizations||[]).includes(o)).length })).filter(o => o.count > 0);
      }, [myUploads, myFiltered]);

      // â”€â”€ Network â”€â”€
      useEffect(() => {
        if (activeTab === 'network' && filteredEvents.length > 0) setTimeout(initNetwork, 100);
      }, [activeTab, filteredEvents]);

      useEffect(() => {
        if (!showAnalysisSuggestion) return;
        const t = setTimeout(() => setShowAnalysisSuggestion(false), 30000);
        return () => clearTimeout(t);
      }, [showAnalysisSuggestion]);

      const initNetwork = () => {
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = filteredEvents.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', shape:'ellipse', color:{ background:'#1e3a5f', border:'#60a5fa', highlight:{ background:'#1d4ed8', border:'#93c5fd' } }, font:{ color:'#e2e8f0', size:12 }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#3b0764', border:'#c084fc', highlight:{ background:'#6d28d9', border:'#e9d5ff' } }, font:{ color:'#f0e6ff', size:12 } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#4b5280' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#064e3b', border:'#34d399', highlight:{ background:'#059669', border:'#6ee7b7' } }, font:{ color:'#d1fae5', size:12 } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#4b5280' } });
          });
          (e.topics||[]).forEach(t => {
            if (!nodes.get('t-'+t)) nodes.add({ id:'t-'+t, label:t, shape:'triangle', color:{ background:'#7c2d12', border:'#fb923c', highlight:{ background:'#c2410c', border:'#fdba74' } }, font:{ color:'#ffedd5', size:12 } });
            edges.add({ from:e.id, to:'t-'+t, color:{ color:'#4b5280' } });
          });
        });
        const container = document.getElementById('network-graph');
        if (container) {
          const net = new vis.Network(container, { nodes, edges }, {
            nodes:{ margin:{ top:8, right:12, bottom:8, left:12 }, borderWidth:2 },
            physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 }, stabilization:{ iterations:300 } },
            interaction:{ hover:true }
          });
          net.once('stabilizationIterationsDone', () => net.setOptions({ physics:false }));
          net.on('click', params => {
            if (params.nodes.length > 0) {
              const id = params.nodes[0];
              if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
              else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
              else if (id.startsWith('t-')) openEntityDetail('topic', id.substring(2));
              else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, activeTab); }
            }
          });
        }
      };

      // â”€â”€ My Network (Account page) â”€â”€
      useEffect(() => {
        if (activeTab === 'account' && accountTab === 'uploads' && myPageTab === 'network' && myFiltered.length > 0)
          setTimeout(initMyNetwork, 100);
      }, [activeTab, accountTab, myPageTab, myFiltered]);

      const initMyNetwork = () => {
        const container = document.getElementById('my-network-graph');
        if (!container) return;
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const eventsToShow = myFiltered.slice(0, 50);
        eventsToShow.forEach(e => {
          nodes.add({ id: e.id, label: (e.title||'Untitled').substring(0,40)+'...', shape:'ellipse', color:{ background:'#1e3a5f', border:'#60a5fa', highlight:{ background:'#1d4ed8', border:'#93c5fd' } }, font:{ color:'#e2e8f0', size:12 }, title: e.title||'Untitled' });
          (e.people||[]).forEach(p => {
            if (!nodes.get('p-'+p)) nodes.add({ id:'p-'+p, label:p, shape:'box', color:{ background:'#3b0764', border:'#c084fc', highlight:{ background:'#6d28d9', border:'#e9d5ff' } }, font:{ color:'#f0e6ff', size:12 } });
            edges.add({ from:e.id, to:'p-'+p, color:{ color:'#4b5280' } });
          });
          (e.organizations||[]).forEach(o => {
            if (!nodes.get('o-'+o)) nodes.add({ id:'o-'+o, label:o, shape:'diamond', color:{ background:'#064e3b', border:'#34d399', highlight:{ background:'#059669', border:'#6ee7b7' } }, font:{ color:'#d1fae5', size:12 } });
            edges.add({ from:e.id, to:'o-'+o, color:{ color:'#4b5280' } });
          });
          (e.topics||[]).forEach(t => {
            if (!nodes.get('t-'+t)) nodes.add({ id:'t-'+t, label:t, shape:'triangle', color:{ background:'#7c2d12', border:'#fb923c', highlight:{ background:'#c2410c', border:'#fdba74' } }, font:{ color:'#ffedd5', size:12 } });
            edges.add({ from:e.id, to:'t-'+t, color:{ color:'#4b5280' } });
          });
        });
        const net = new vis.Network(container, { nodes, edges }, {
          nodes:{ margin:{ top:8, right:12, bottom:8, left:12 }, borderWidth:2 },
          physics:{ barnesHut:{ gravitationalConstant:-2000, centralGravity:0.3, springLength:95 }, stabilization:{ iterations:300 } },
          interaction:{ hover:true }
        });
        net.once('stabilizationIterationsDone', () => net.setOptions({ physics:false }));
        net.on('click', params => {
          if (params.nodes.length > 0) {
            const id = params.nodes[0];
            if (id.startsWith('p-')) openEntityDetail('person', id.substring(2));
            else if (id.startsWith('o-')) openEntityDetail('org', id.substring(2));
            else if (id.startsWith('t-')) openEntityDetail('topic', id.substring(2));
            else { const ev = eventsToShow.find(e => e.id === id); if (ev) openEventModal(ev, 'account'); }
          }
        });
      };

      // â”€â”€ AI doc analysis â”€â”€
      const analyzeDocument = (text) => {
        const words = text.toLowerCase().split(/\s+/);
        const wordFreq = {};
        words.forEach(w => { if (w.length > 4 && /^[a-z]+$/.test(w)) wordFreq[w] = (wordFreq[w]||0)+1; });
        const topicCandidates = Object.entries(wordFreq).filter(([,f]) => f >= 3).map(([w]) => w).slice(0,10);
        const names = [...new Set((text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g)||[]))].slice(0,10);
        const orgs = [...new Set((text.match(/\b[A-Z][a-zA-Z\s&]+(Inc\.|Corp\.|LLC|Agency|Department|Institute|University|Company|Foundation)\b/g)||[]))].slice(0,5);
        const sentences = text.split(/[.!?]+/).filter(s=>s.trim());
        const summary = `AI Analysis: ${words.length} words analyzed. Key topics identified: ${topicCandidates.slice(0,5).join(', ')}. ${sentences.slice(0,2).join('. ').substring(0,200)}...`;
        return { topics: topicCandidates, people: names, organizations: orgs, summary };
      };

      // â”€â”€ Bulk AI analysis (called by autoAnalysis path and suggestion popup) â”€â”€
      const triggerBulkAnalysis = (eventsToProcess) => {
        const toAnalyze = eventsToProcess.filter(e => e._backendId);
        if (toAnalyze.length === 0) return;
        setUploadMessage(`âœ“ Uploaded ${eventsToProcess.length} event(s) â€” analyzing ${toAnalyze.length} with AI...`);
        (async () => {
          for (const evt of toAnalyze) {
            try {
              const resp = await fetch(`${API_BASE}/api/analyze/${evt._backendId}?mode=${analysisMode}${analysisSearch.trim()?'&search_focus='+encodeURIComponent(analysisSearch.trim()):''}`, { method: 'POST' });
              if (resp.ok) {
                const result = await resp.json();
                const rec = result.record;
                if (rec) {
                  await supabaseClient.from('events').update({
                    ai_summary: rec.summary || '', description: rec.description || rec.summary || '',
                    topics: rec.topics || [], people: rec.people || [], organizations: rec.organizations || [],
                    source: rec.source || '', primary_source: rec.primary_source || '', main_link: rec.main_link || '',
                    ai_analyzed: true, analysis_mode: rec.analysis_mode || '', has_frames: rec.has_frames || false,
                  }).eq('id', evt.id);
                  setData(prev => ({
                    ...prev,
                    events: prev.events.map(e => e.id === evt.id ? {
                      ...e,
                      aiSummary: rec.summary || e.aiSummary,
                      description: rec.description || rec.summary || e.description,
                      topics: rec.topics && rec.topics.length > 0 ? rec.topics : e.topics,
                      people: rec.people && rec.people.length > 0 ? rec.people : e.people,
                      organizations: rec.organizations && rec.organizations.length > 0 ? rec.organizations : e.organizations,
                      source: rec.source || e.source || '',
                      primarySource: rec.primary_source || e.primarySource || '',
                      mainLink: rec.main_link || e.mainLink || '',
                      _aiAnalyzed: true,
                      _analysisMode: rec.analysis_mode || '',
                      _hasFrames: rec.has_frames || false,
                    } : e),
                    people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
                    organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
                    topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
                  }));
                }
              }
            } catch(err) {}
          }
          setUploadMessage(`âœ“ AI Analysis complete for ${toAnalyze.length} document(s).`);
          createNotification('ai_analysis', 'AI Analysis Complete', `Analyzed ${toAnalyze.length} document(s) with AI.`);
          setTimeout(()=>setUploadMessage(''),5000);
          setData(prev => {
            const updatedEvt = prev.events.find(e => e.id === eventsToProcess[0].id);
            if (updatedEvt) openEventModal(updatedEvt, 'upload');
            return prev;
          });
        })();
      };

      // â”€â”€ Hybrid spreadsheet field resolver (rigid first, flexible fallback) â”€â”€
      // Tries exact rigid keys (current behaviour) first; falls back to fuzzy normalized variants.
      const resolveField = (row, rigidKeys, fuzzyVariants) => {
        for (const k of rigidKeys) {
          const val = row[k];
          if (val !== undefined && val !== null && String(val).trim() !== '') return String(val).trim();
        }
        const norm = {};
        Object.keys(row).forEach(k => { norm[k.toLowerCase().replace(/[\s_\-]/g, '')] = row[k]; });
        for (const v of fuzzyVariants) {
          const val = norm[v];
          if (val !== undefined && val !== null && String(val).trim() !== '') return String(val).trim();
        }
        return null;
      };

      // â”€â”€ File upload â”€â”€
      const handleFileUpload = async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        setIsProcessing(true);
        setUploadMessage('Processing files...');
        const newEvents = [];
        const timeout = setTimeout(() => { setIsProcessing(false); setUploadMessage('âš ï¸ Timeout - file may be too large'); setTimeout(()=>setUploadMessage(''),3000); }, 60000);
        try {
          for (const file of files) {
            let extractedText = '';
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
              await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = ev => {
                  try {
                    const wb = XLSX.read(ev.target.result, { type:'binary' });
                    wb.SheetNames.forEach(sheetName => {
                      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                      rows.forEach(row => {
                        extractedText += JSON.stringify(row)+' ';
                        const xlTitle = resolveField(row, ['title','Title','TITLE'], ['name','eventname','event','heading','subject']);
                        const xlDesc  = resolveField(row, ['description','Description','Abstract'], ['desc','summary','detail','content','notes','body','text']);
                        const xlDate  = resolveField(row, ['date','Date','year'], ['eventdate','datetime','when','occurred']);
                        const xlTopics= resolveField(row, ['topics','Topics'], ['topic','category','categories','tags','type','keywords']) || sheetName;
                        const xlPeople= resolveField(row, ['writer','inventor','people'], ['person','author','authors','names','individuals','who']) || '';
                        const xlOrgs  = resolveField(row, ['publisher','company','organization'], ['organizations','org','orgs','companies','institution']) || '';
                        const xlLink  = resolveField(row, ['link main','link'], ['linkmain','url','source','reference','href','website']) || '';
                        const xlLevel = resolveField(row, ['srch lvl','My search lvl'], ['level','researchlevel','priority','searchlevel','srchlvl']) || '1';
                        const xlUnformatted = !xlTitle && !xlDate;
                        newEvents.push({
                          id:generateEventId(),
                          title: xlTitle || `Uploaded: ${file.name}`,
                          description: xlDesc || '',
                          date: xlDate || null,
                          dateUploaded: new Date().toISOString(),
                          topics: xlTopics.toString().split(/[,;/]/).map(t=>t.trim()).filter(t=>t),
                          people: xlPeople.toString().split(/[,;]/).map(p=>p.trim()).filter(p=>p),
                          organizations: xlOrgs.toString().split(/[,;/]/).map(o=>o.trim()).filter(o=>o),
                          links: [xlLink].filter(l=>l),
                          researchLevel: parseInt(xlLevel)||1,
                          sourceType:'Uploaded Excel', sourceSheet:sheetName, connections:[], aiSummary:'', isMajorEvent:false,
                          uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified',
                          _isUnformatted: xlUnformatted,
                        });
                      });
                    });
                  } catch(err) {}
                  resolve();
                };
                reader.onerror = ()=>resolve();
                reader.readAsBinaryString(file);
              });
            } else if (file.name.endsWith('.csv')) {
              extractedText = await file.text();
              const lines = extractedText.split('\n').filter(l=>l.trim());
              if (lines.length > 1) {
                const headers = lines[0].split(',').map(h=>h.trim());
                for (let i=1; i<Math.min(lines.length,1000); i++) {
                  const vals = lines[i].split(',');
                  const row = {};
                  headers.forEach((h,idx)=>{ row[h]=vals[idx]?.trim()||''; });
                  const csvTitle = resolveField(row, ['title','Title','TITLE'], ['name','eventname','event','heading','subject']);
                  const csvDesc  = resolveField(row, ['description','Description','Abstract'], ['desc','summary','detail','content','notes','body','text']);
                  const csvDate  = resolveField(row, ['date','Date','year'], ['eventdate','datetime','when','occurred']);
                  const csvTopics= resolveField(row, ['topics','Topics'], ['topic','category','categories','tags','type','keywords']) || 'CSV Import';
                  const csvPeople= resolveField(row, ['writer','inventor','people'], ['person','author','authors','names','individuals','who']) || '';
                  const csvOrgs  = resolveField(row, ['publisher','company','organization'], ['organizations','org','orgs','companies','institution']) || '';
                  const csvLink  = resolveField(row, ['link main','link'], ['linkmain','url','source','reference','href','website']) || '';
                  const csvLevel = resolveField(row, ['srch lvl','My search lvl'], ['level','researchlevel','priority','searchlevel','srchlvl']) || '1';
                  newEvents.push({ id:generateEventId(), title:csvTitle||`CSV Entry ${i}`, description:csvDesc||'', date:csvDate||null, dateUploaded:new Date().toISOString(), topics:csvTopics.split(/[,;]/).map(t=>t.trim()).filter(t=>t), people:csvPeople.split(/[,;]/).map(p=>p.trim()).filter(p=>p), organizations:csvOrgs.split(/[,;]/).map(o=>o.trim()).filter(o=>o), links:[csvLink].filter(l=>l), researchLevel:parseInt(csvLevel)||1, sourceType:'Uploaded CSV', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified', _isUnformatted: !csvTitle && !csvDate });
                }
              }
            } else if (file.name.endsWith('.txt')) {
              extractedText = await file.text();
              newEvents.push({ id:generateEventId(), title:file.name.replace('.txt',''), description:extractedText.substring(0,500), date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:['Text Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded Text', sourceSheet:file.name, connections:[], aiSummary:'', isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
            } else if (/\.(pdf|docx?|png|jpe?g|gif|bmp|tiff|webp)$/i.test(file.name)) {
              // Send to backend for real text extraction
              try {
                const formData = new FormData();
                formData.append('files', file);
                const resp = await fetch(`${API_BASE}/api/upload`, { method: 'POST', body: formData });
                if (resp.ok) {
                  const result = await resp.json();
                  for (const rec of (result.records || [])) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeLabel = {pdf:'PDF',doc:'Word',docx:'Word',png:'Image',jpg:'Image',jpeg:'Image',gif:'Image',bmp:'Image',tiff:'Image',webp:'Image'}[ext] || 'Document';
                    // Clean description: skip URLs, nav junk, take first meaningful sentences
                    const rawText = rec.extracted_text || '';
                    const cleanLines = rawText.split('\n').filter(l => {
                      const t = l.trim();
                      return t.length > 20 && !t.startsWith('http') && !/^(Share|Save|Click here|Recommended Stories|list of|list \d|end of list)/i.test(t);
                    });
                    const cleanDesc = cleanLines.slice(0, 3).join(' ').substring(0, 500);
                    newEvents.push({
                      id:generateEventId(),
                      title: file.name.replace(/\.[^.]+$/, ''),
                      description: cleanDesc || `${typeLabel} document uploaded: ${file.name}`,
                      date: new Date().toISOString().split('T')[0],
                      dateUploaded: new Date().toISOString(),
                      topics: [typeLabel + ' Document'],
                      people: [], organizations: [], links: [],
                      researchLevel: 1,
                      sourceType: 'Uploaded ' + typeLabel,
                      sourceSheet: file.name,
                      connections: [],
                      aiSummary: 'Text extracted â€” select and click "Analyze Selected" for AI analysis.',
                      isMajorEvent: false,
                      uploadedBy: currentUser ? currentUser.username : 'unknown',
                      isPublic: false, eventStatus: 'unverified',
                      _backendId: rec.id,
                      _backendFileName: rec.saved_filename || '',
                      _hasBackend: true,
                      mainLink: '',
                      source: '',
                      primarySource: ''
                    });
                    }
                } else {
                  // Fallback: create stub event if backend is unavailable
                  const ext = file.name.split('.').pop().toLowerCase();
                  const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                  newEvents.push({ id:generateEventId(), title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - backend unavailable for extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                }
              } catch(fetchErr) {
                const ext = file.name.split('.').pop().toLowerCase();
                const typeLabel = ext === 'pdf' ? 'PDF' : ext.startsWith('doc') ? 'Word' : 'Image';
                newEvents.push({ id:generateEventId(), title:file.name.replace(/\.[^.]+$/, ''), description:`${typeLabel} document uploaded: ${file.name}`, date:new Date().toISOString().split('T')[0], dateUploaded:new Date().toISOString(), topics:[typeLabel + ' Document'], people:[], organizations:[], links:[], researchLevel:1, sourceType:'Uploaded ' + typeLabel, sourceSheet:file.name, connections:[], aiSummary:`${typeLabel} uploaded - server not running. Start the backend to enable extraction.`, isMajorEvent:false, uploadedBy: currentUser ? currentUser.username : 'unknown', isPublic: false, eventStatus: 'unverified' });
                }
            }
            if (extractedText && newEvents.length > 0 && !newEvents[newEvents.length-1]._hasBackend) {
              // Only run client-side analysis for non-backend files (Excel, CSV, TXT)
              const analysis = analyzeDocument(extractedText);
              const last = newEvents[newEvents.length-1];
              last.aiSummary = analysis.summary;
              last.topics = [...new Set([...last.topics, ...analysis.topics])];
              last.people = [...new Set([...last.people, ...analysis.people])];
              last.organizations = [...new Set([...last.organizations, ...analysis.organizations])];
            }
          }
          clearTimeout(timeout);
          if (newEvents.length > 0) {
            const hasUnformatted = newEvents.some(e => e._isUnformatted);
            // Insert to Supabase
            const { error: sbErr } = await supabaseClient.from('events').insert(newEvents.map(toDbRow));
            if (sbErr) console.error('Supabase insert error:', sbErr);
            const updated = {
              events:[...data.events,...newEvents],
              people:Array.from(new Set([...data.people,...newEvents.flatMap(e=>e.people)])).sort(),
              organizations:Array.from(new Set([...data.organizations,...newEvents.flatMap(e=>e.organizations)])).sort(),
              topics:Array.from(new Set([...data.topics,...newEvents.flatMap(e=>e.topics)])).sort(),
              metadata:{...data.metadata, totalEvents:data.events.length+newEvents.length, lastUpdated:new Date().toISOString()}
            };
            setData(updated);
            // Auto AI Analysis: trigger backend analysis and sync results back
            if (autoAnalysis) {
              triggerBulkAnalysis(newEvents);
            }
            setIsProcessing(false);
            createNotification('upload_success', 'Upload Successful', `Uploaded ${newEvents.length} event(s) from "${files[0]?.name || 'file'}".`, newEvents[0]?.id || null);
            if (!autoAnalysis) {
              setUploadMessage(`âœ“ Successfully uploaded ${newEvents.length} event(s)!`);
              setAnalysisSuggestionCtx({ events: newEvents, source: 'file', unformatted: hasUnformatted, fileName: files[0]?.name || '' });
              setShowAnalysisSuggestion(true);
            }
            setTimeout(()=>setUploadMessage(''),5000);
          } else { setIsProcessing(false); setUploadMessage('âš ï¸ No valid data found'); setTimeout(()=>setUploadMessage(''),3000); }
        } catch(err) { clearTimeout(timeout); setIsProcessing(false); setUploadMessage(`âŒ Error: ${err.message}`); createNotification('upload_error', 'Upload Failed', err.message); setTimeout(()=>setUploadMessage(''),5000); }
        event.target.value='';
      };

      const parseTimeToSeconds = (str) => {
        if (!str || !str.trim()) return null;
        const s = str.trim();
        if (/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);
        const parts = s.split(':').map(Number);
        if (parts.some(isNaN)) return null;
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        return null;
      };

      const handleUrlSubmit = async () => {
        if (!urlInput.trim()) return;
        setIsProcessing(true);
        const isVideo = /youtube|youtu\.be|vimeo|dailymotion/i.test(urlInput);
        const doAnalysis = autoAnalysis;

        // If using remote backend, ping it first â€” free tier sleeps after inactivity
        if (API_BASE) {
          setUploadMessage('â³ Connecting to analysis server...');
          const pingStart = Date.now();
          try { await fetch(`${API_BASE}/api/records`, { method: 'GET' }); } catch(e) {}
          if (Date.now() - pingStart > 3000) {
            setUploadMessage('ðŸ”„ Backend is waking up â€” it\'ll be ready in just a moment. Subsequent requests will be instant.');
            await new Promise(r => setTimeout(r, 1500));
          }
        }

        const startSecs = parseTimeToSeconds(timestampStart);
        const endSecs = parseTimeToSeconds(timestampEnd);

        if (doAnalysis) {
          const modeLabel = {fast:'Fast',quick:'Quick',short:'Short',long:'Detailed'}[analysisMode]||'';
          const frameLabel = skipFrames ? ', no frames' : '';
          const rangeLabel = isVideo && (startSecs !== null || endSecs !== null)
            ? ` [${timestampStart||'0:00'}â€“${timestampEnd||'end'}]` : '';
          setUploadMessage(isVideo ? `Analyzing video (${modeLabel}${frameLabel}${rangeLabel})...` : 'Scraping & analyzing web page...');
        } else {
          setUploadMessage(isVideo ? 'Fetching video info (no AI analysis)...' : 'Fetching page info (no AI analysis)...');
        }
        try {
          const resp = await fetch(`${API_BASE}/api/analyze-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: urlInput, mode: analysisMode, skip_frames: skipFrames, skip_analysis: !doAnalysis,
              ...(startSecs !== null && { start_time: startSecs }),
              ...(endSecs !== null && { end_time: endSecs }),
              ...(analysisSearch.trim() && { search_focus: analysisSearch.trim() }),
            }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(()=>({}));
            throw new Error(err.detail || `Server error ${resp.status}`);
          }
          const result = await resp.json();
          const rec = result.record;

          // Build transcript chapters from segments if available
          let transcription = null;
          if (rec.transcript && rec.transcript.length > 50) {
            // Create a simple chapter structure from the transcript
            const lines = rec.transcript.split(/[.!?]\s+/).filter(l=>l.trim().length > 20);
            const chunkSize = Math.max(1, Math.floor(lines.length / 5));
            const chapters = [];
            for (let i = 0; i < Math.min(lines.length, 10); i += chunkSize) {
              const chunk = lines.slice(i, i + chunkSize).join('. ');
              if (chunk.trim()) {
                const mins = Math.floor((i / lines.length) * (rec.video_metadata?.duration || 300) / 60);
                const secs = Math.floor((i / lines.length) * (rec.video_metadata?.duration || 300) % 60);
                chapters.push({ timestamp: `${mins}:${String(secs).padStart(2,'0')}`, title: `Section ${chapters.length+1}`, text: chunk.substring(0,500) });
              }
            }
            if (chapters.length > 0) transcription = { chapters };
          }

          // Build visual content description
          let visualDesc = rec.visual_content || '';
          if (rec.frames_data && rec.frames_data.length > 0) {
            visualDesc += (visualDesc ? '\n' : '') + `${rec.frames_data.length} visual frame(s) captured and saved.`;
          }

          const newEvent = {
            id: generateEventId(),
            title: rec.file_name || urlInput,
            description: rec.description || (result.metadata_only && rec.video_metadata?.description ? rec.video_metadata.description.substring(0, 500) : ''),
            aiSummary: rec.summary || (result.metadata_only ? 'Not yet analyzed â€” select and click "Analyze Selected" for AI analysis.' : ''),
            date: new Date().toISOString().split('T')[0],
            dateUploaded: new Date().toISOString(),
            topics: rec.topics || [],
            people: rec.people || [],
            organizations: rec.organizations || [],
            links: [urlInput],
            mainLink: rec.main_link || urlInput,
            researchLevel: 1,
            sourceType: rec.content_type === 'video' ? 'Video URL' : 'Web URL',
            source: rec.source || '',
            primarySource: rec.primary_source || '',
            sourceSheet: 'URL Import',
            connections: [],
            isMajorEvent: false,
            isVideo: rec.content_type === 'video',
            uploadedBy: currentUser ? currentUser.username : 'unknown',
            isPublic: false,
            eventStatus: 'unverified',
            _aiAnalyzed: !result.metadata_only,
            _analysisMode: rec.analysis_mode || '',
            _hasFrames: rec.has_frames || false,
            _backendId: rec.id,
            _backendFileName: rec.saved_filename || '',
            _visualContent: visualDesc,
            _framesData: rec.frames_data || [],
            _transcriptFile: rec.transcript_file || result.transcript_file || '',
            _attachments: rec.attachments || [],
            transcription,
          };

          // Insert to Supabase
          const { error: sbErr } = await supabaseClient.from('events').insert([toDbRow(newEvent)]);
          if (sbErr) console.error('Supabase insert error:', sbErr);

          setData(prev => ({
            events: [...prev.events, newEvent],
            people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
            organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
            topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
            metadata: {...prev.metadata, totalEvents: prev.events.length+1, lastUpdated: new Date().toISOString()},
          }));
          setIsProcessing(false);
          const capturedUrl = urlInput.trim();
          if (result.metadata_only) {
            setUploadMessage('âœ“ URL added (no AI analysis). Select it and click "Analyze Selected" to analyze later.');
            createNotification('upload_success', 'URL Added', `Added: ${capturedUrl.substring(0,80)}${capturedUrl.length>80?'â€¦':''}`, newEvent.id);
          } else {
            setUploadMessage(`âœ“ URL analyzed successfully!${result.has_visual_analysis ? ` (${result.frames_count} visual frames captured)` : ''}`);
            createNotification('upload_success', 'URL Analyzed', `Successfully analyzed: ${capturedUrl.substring(0,80)}${capturedUrl.length>80?'â€¦':''}${result.has_visual_analysis?` (${result.frames_count} frames)`:''}.`, newEvent.id);
          }
          setUrlInput('');
          if (!autoAnalysis) {
            setAnalysisSuggestionCtx({ events: [newEvent], source: 'url', unformatted: false, fileName: capturedUrl });
            setShowAnalysisSuggestion(true);
          } else {
            openEventModal(newEvent, 'upload');
          }
          setTimeout(()=>setUploadMessage(''),5000);
        } catch(err) { setIsProcessing(false); setUploadMessage(`âŒ Error: ${err.message}`); createNotification('upload_error', 'URL Analysis Failed', err.message); setTimeout(()=>setUploadMessage(''),15000); }
      };

      const cancelProcessing = () => { setIsProcessing(false); setUploadMessage('Processing cancelled'); setTimeout(()=>setUploadMessage(''),2000); };

      // â”€â”€ Modal â”€â”€
      const openEventModal = (event, fromTab) => {
        setModalData(event);
        setEditedEvent({...event});
        setIsEditing(false);
        setShowModal(true);
      };

      const openEntityDetail = (type, name) => {
        const relEvents = data.events.filter(e => {
          if (type === 'person') return (e.people||[]).includes(name);
          if (type === 'org') return (e.organizations||[]).includes(name);
          if (type === 'topic') return (e.topics||[]).includes(name);
          return false;
        });
        const coTopics = {}, coPeople = {}, coOrgs = {};
        relEvents.forEach(e => {
          (e.topics||[]).forEach(t => { coTopics[t] = (coTopics[t]||0)+1; });
          (e.people||[]).forEach(p => { coPeople[p] = (coPeople[p]||0)+1; });
          (e.organizations||[]).forEach(o => { coOrgs[o] = (coOrgs[o]||0)+1; });
        });
        if (type==='topic') delete coTopics[name];
        if (type==='person') delete coPeople[name];
        if (type==='org') delete coOrgs[name];
        const sortByCount = obj => Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([n,c])=>({name:n,count:c}));
        const cacheKey = `${type}:${name}`;
        setEntityModalData({
          type, name, relEvents,
          connections: { topics: sortByCount(coTopics), people: sortByCount(coPeople), orgs: sortByCount(coOrgs) },
          profile: entityProfiles[cacheKey] || null
        });
        setEntityModalEditing(false);
        setEntityModalOpen(true);
        setShowModal(false);
        if (!entityProfiles[cacheKey] && supabaseClient) {
          supabaseClient.from('entity_profiles').select('*')
            .eq('entity_type', type).eq('entity_name', name).maybeSingle()
            .then(({data: p}) => {
              if (p) {
                setEntityProfiles(prev => ({...prev, [cacheKey]: p}));
                setEntityModalData(prev => prev && prev.type===type && prev.name===name ? {...prev, profile: p} : prev);
              }
            });
        }
      };

      const saveEntityProfile = async () => {
        if (!entityModalData) return;
        const {type, name} = entityModalData;
        const cacheKey = `${type}:${name}`;
        const profileData = {
          entity_type: type, entity_name: name,
          description: entityModalDraft.description || '',
          date_start: entityModalDraft.date_start || '',
          date_end: entityModalDraft.date_end || '',
          updated_by: currentUser.username,
          updated_at: new Date().toISOString()
        };
        const {data: saved, error} = await supabaseClient.from('entity_profiles')
          .upsert(profileData, {onConflict: 'entity_type,entity_name'}).select().single();
        if (error) { setUploadMessage('âŒ Save failed: ' + error.message); setTimeout(()=>setUploadMessage(''),4000); return; }
        const prof = saved || profileData;
        setEntityProfiles(prev => ({...prev, [cacheKey]: prof}));
        setEntityModalData(prev => prev ? {...prev, profile: prof} : prev);
        setEntityModalEditing(false);
      };

      const analyzeEntityProfile = async () => {
        if (!entityModalData) return;
        const { type, name, relEvents } = entityModalData;
        setEntityModalAnalyzing(true);
        try {
          const eventsPayload = relEvents.slice(0, 25).map(e => ({
            title: e.title, date: e.date,
            summary: (e.aiSummary || e.description || '').slice(0, 500),
            topics: e.topics || [], people: e.people || [], organizations: e.organizations || []
          }));
          const resp = await fetch(`${API_BASE}/api/analyze-entity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ entity_type: type, entity_name: name, related_events: eventsPayload })
          });
          if (!resp.ok) {
            const detail = await resp.text().catch(() => '');
            throw new Error(`Backend returned ${resp.status}${detail ? ': ' + detail : ''}`);
          }
          const result = await resp.json();
          const cacheKey = `${type}:${name}`;
          const profileData = {
            entity_type: type, entity_name: name,
            description: result.description || '',
            date_start: result.date_start || '',
            date_end: result.date_end || '',
            updated_by: 'ai',
            updated_at: new Date().toISOString()
          };
          const { data: saved, error } = await supabaseClient.from('entity_profiles')
            .upsert(profileData, { onConflict: 'entity_type,entity_name' }).select().single();
          if (error) throw new Error('Supabase save failed: ' + error.message);
          const prof = saved || profileData;
          setEntityProfiles(prev => ({ ...prev, [cacheKey]: prof }));
          setEntityModalData(prev => prev ? { ...prev, profile: prof } : prev);
          setUploadMessage('âœ“ AI profile generated and saved!');
          setTimeout(() => setUploadMessage(''), 3000);
        } catch (err) {
          setUploadMessage('âŒ AI profile failed: ' + err.message);
          setTimeout(() => setUploadMessage(''), 5000);
        } finally {
          setEntityModalAnalyzing(false);
        }
      };

      const goBack = () => {
        setSelectedEntity(null);
        setBreadcrumbs(prev => prev.slice(0,-1));
      };

      const saveEditedEvent = async () => {
        const cleaned = {...editedEvent, links: (editedEvent.links||[]).filter(l=>l.trim())};
        const { error } = await supabaseClient.from('events').update(toDbRow(cleaned)).eq('id', cleaned.id);
        if (error) { setUploadMessage('âŒ Save failed: ' + error.message); setTimeout(()=>setUploadMessage(''),5000); return; }
        const updatedEvents = data.events.map(e => e.id === cleaned.id ? cleaned : e);
        const agg = rebuildAggregates(updatedEvents);
        setData({...data, events:updatedEvents, ...agg});
        setModalData(cleaned);
        setIsEditing(false);
        setUploadMessage('âœ“ Event updated!');
        createNotification('event_saved', 'Event Saved', `"${cleaned.title}" was updated.`, cleaned.id);
        setTimeout(()=>setUploadMessage(''),3000);
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(()=>{ setUploadMessage('ðŸ“‹ Copied!'); setTimeout(()=>setUploadMessage(''),2000); });
      };

      // â”€â”€ Download helpers â”€â”€
      const downloadEvents = (events, format) => {
        const dateStr = new Date().toISOString().split('T')[0];
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source Type','Source','Primary Source','Main Link','Links'];
        const rows = events.map(e => [e.id,e.title,e.description||'',e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType||'',e.source||'',e.primarySource||'',e.mainLink||'',(e.links||[]).join('; ')]);
        if (format === 'csv') {
          const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
          a.download = `events-${dateStr}.csv`;
          a.click();
        } else if (format === 'excel') {
          const ws = XLSX.utils.aoa_to_sheet([headers,...rows]);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Events');
          XLSX.writeFile(wb, `events-${dateStr}.xlsx`);
        } else if (format === 'json') {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([JSON.stringify({events,exportDate:dateStr},null,2)],{type:'application/json'}));
          a.download = `events-${dateStr}.json`;
          a.click();
        } else if (format === 'pdf') {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: 'landscape' });
          doc.setFontSize(14);
          doc.text('Historical Events Database Export', 14, 15);
          doc.setFontSize(8);
          doc.text(`Exported: ${dateStr}  |  ${events.length} event(s)`, 14, 21);
          const pdfHeaders = ['ID','Title','Date','Topics','Level','Source'];
          const pdfRows = events.map(e => [String(e.id),(e.title||'').substring(0,60),e.date||'',(e.topics||[]).join(', ').substring(0,50),`L${e.researchLevel}`,e.source||'']);
          doc.autoTable({ head:[pdfHeaders], body:pdfRows, startY:25, styles:{fontSize:7,cellPadding:2}, headStyles:{fillColor:[37,99,235]}, alternateRowStyles:{fillColor:[240,242,248]} });
          doc.save(`events-${dateStr}.pdf`);
        } else if (format === 'word') {
          let html = `<html><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:10pt}th,td{border:1px solid #999;padding:6px 8px;text-align:left}th{background:#2563eb;color:#fff}tr:nth-child(even){background:#f0f2f8}h1{font-size:16pt;color:#1a1f3a}</style></head><body>`;
          html += `<h1>Historical Events Database Export</h1><p>Exported: ${dateStr} | ${events.length} event(s)</p>`;
          html += '<table><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
          rows.forEach(r => { html += '<tr>' + r.map(c=>`<td>${String(c||'').replace(/</g,'&lt;')}</td>`).join('') + '</tr>'; });
          html += '</table></body></html>';
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([html],{type:'application/msword'}));
          a.download = `events-${dateStr}.doc`;
          a.click();
        }
        setShowDownloadPopup(null);
      };

      const exportToCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source','Link'];
        const rows = filteredEvents.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType,(e.links&&e.links[0])||'']);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const exportToJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:filteredEvents,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `historical-events-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const myExportCSV = () => {
        const headers = ['ID','Title','Description','AI Summary','Date','Topics','People','Organizations','Research Level','Source'];
        const rows = myFiltered.map(e => [e.id,e.title,e.description,e.aiSummary||'',e.date||'',(e.topics||[]).join('; '),(e.people||[]).join('; '),(e.organizations||[]).join('; '),e.researchLevel,e.sourceType]);
        const csv = [headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };
      const myExportJSON = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({events:myFiltered,metadata:data.metadata},null,2)],{type:'application/json'}));
        a.download = `my-uploads-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      // â”€â”€ Shared filter props â”€â”€
      const filterProps = { filters, setFilters, data, activeTab, onSearch:applySearch, onClear:clearAllFilters, onExportCSV:exportToCSV, onExportJSON:exportToJSON };

      // â”€â”€ Uploads grid component (reused in tab and page) â”€â”€
      const UploadsContent = () => (
        <div>
          <FiltersComponent {...filterProps} />
          {filteredMyUploads.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">ðŸ“‚</div>
              <p>No uploads yet â€” use the Upload page to add files or URLs.</p>
            </div>
          ) : (
            <div className="spreadsheet">
              <table className="table">
                <thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Visibility</th><th>Type</th><th>Date</th><th>Topics</th></tr></thead>
                <tbody>
                  {filteredMyUploads.map(e => (
                    <tr key={e.id} style={{cursor:'pointer'}}>
                      <td onClick={()=>openEventModal(e,'my uploads')}>{e.id}</td>
                      <td onClick={()=>openEventModal(e,'my uploads')} style={{fontWeight:600}}>{e.title}</td>
                      <td><span className={`status-${e.eventStatus||'unverified'}`}>{e.eventStatus==='historical_record'?'Historical Record':e.eventStatus==='contested'?'Contested':'Unverified'}</span></td>
                      <td>
                        <button onClick={()=>toggleEventPublic(e.id)} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                          <span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'ðŸŒ Public' : 'ðŸ”’ Private'}</span>
                        </button>
                      </td>
                      <td><span style={{padding:'0.25rem 0.6rem',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'6px',fontSize:'0.75rem',color:'#60a5fa'}}>{e.sourceType}</span></td>
                      <td>{e.dateUploaded ? new Date(e.dateUploaded).toLocaleDateString() : 'â€”'}</td>
                      <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );

      // â”€â”€ Modal â”€â”€
      const modalTabLabel = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);
      const modalCrumbs = selectedEntity
          ? [
              { label: 'ðŸ  Home', action: () => { setShowModal(false); setSelectedEntity(null); setBreadcrumbs([]); setActiveTab('timeline'); } },
              ...breadcrumbs.map((b, i) => ({ label: b.label, action: () => { setShowModal(false); goToBreadcrumb(i); } })),
              { label: selectedEntity.name, action: () => setShowModal(false) }
            ]
          : [
              { label: 'ðŸ  Home', action: () => { setShowModal(false); navigateToTab('timeline'); } },
              { label: modalTabLabel, action: () => setShowModal(false) }
            ];
      const modalViewJSX = (!showModal || !modalData || !currentUser) ? null : (
        <div className="modal" onClick={()=>setShowModal(false)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            {/* Breadcrumb trail inside modal â€” always visible, Notion/ClickUp style */}
            <div style={{display:'flex',alignItems:'center',gap:'0.3rem',marginBottom:'1.25rem',flexWrap:'wrap',borderBottom:'1px solid rgba(61,69,99,0.4)',paddingBottom:'0.75rem'}}>
              {modalCrumbs.map((crumb, i) => (
                <React.Fragment key={i}>
                  {i > 0 && <span className="bc-sep">â€º</span>}
                  <span className="bc-item" style={{fontSize:'0.8rem'}} onClick={crumb.action}>{crumb.label}</span>
                </React.Fragment>
              ))}
              <span className="bc-sep">â€º</span>
              <span className="bc-current" style={{fontSize:'0.8rem'}}>{isEditing ? 'Edit Event' : (modalData.title.length > 60 ? modalData.title.substring(0,60)+'â€¦' : modalData.title)}</span>
            </div>
            <div className="modal-header">
              <h2 className="modal-title">{isEditing ? 'Edit Event' : modalData.title}</h2>
              <div className="modal-actions">
                {!isEditing && <button className="edit-btn" onClick={()=>setIsEditing(true)}>âœï¸ Edit</button>}
                {isEditing && <button className="btn btn-primary" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={saveEditedEvent}>ðŸ’¾ Save</button>}
                {isEditing && <button className="btn btn-danger" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={()=>setIsEditing(false)}>Cancel</button>}
                {!isEditing && (currentUser.role === 'admin' || currentUser.role === 'owner') && <button className="btn btn-danger" style={{padding:'0.4rem 0.75rem',fontSize:'0.8rem'}} onClick={()=>{if(window.confirm('Delete this event permanently?'))deleteEvent(modalData.id);}}>ðŸ—‘ï¸</button>}
                <button className="close" onClick={()=>setShowModal(false)}>Ã—</button>
              </div>
            </div>
            {!isEditing ? (
              <>
                {/* Article Info â€” compact 3-column grid */}
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.4rem 1.5rem',marginBottom:'1rem',padding:'0.75rem 1rem',background:'rgba(26,31,58,0.5)',borderRadius:'10px',border:'1px solid rgba(61,69,99,0.3)',fontSize:'0.8rem',lineHeight:1.6}}>
                  <div><span style={{color:'#6b7394'}}>ID:</span> <span style={{color:'#c0c7d8'}}>{modalData.id}</span></div>
                  <div><span style={{color:'#6b7394'}}>Date:</span> <span style={{color:'#c0c7d8'}}>{modalData.date||'Unknown'}</span></div>
                  <div><span style={{color:'#6b7394'}}>Type:</span> <span style={{color:'#c0c7d8'}}>{modalData.sourceType}</span></div>
                  <div><span style={{color:'#6b7394'}}>Level:</span> <span className={`level-${modalData.researchLevel}`} style={{fontSize:'0.8rem'}}>Level {modalData.researchLevel}</span></div>
                  <div><span style={{color:'#6b7394'}}>Status:</span>{' '}
                    {(currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                      <select className="status-select" style={{marginLeft:'0.3rem',fontSize:'0.75rem',padding:'0.1rem 0.3rem'}} value={modalData.eventStatus||'unverified'}
                        onChange={ev=>{updateEventStatus(modalData.id, ev.target.value); setModalData({...modalData, eventStatus:ev.target.value});}}>
                        <option value="historical_record">Historical Record</option>
                        <option value="contested">Contested</option>
                        <option value="unverified">Unverified</option>
                      </select>
                    ) : (
                      <span className={`status-${modalData.eventStatus||'unverified'}`} style={{fontSize:'0.75rem'}}>{modalData.eventStatus==='historical_record'?'Historical Record':modalData.eventStatus==='contested'?'Contested':'Unverified'}</span>
                    )}
                  </div>
                  <div><span style={{color:'#6b7394'}}>Visibility:</span>{' '}
                    {(modalData.uploadedBy === currentUser.username || currentUser.role === 'admin' || currentUser.role === 'owner') ? (
                      <button onClick={()=>{toggleEventPublic(modalData.id); setModalData({...modalData, isPublic:!modalData.isPublic});}} style={{background:'none',border:'none',cursor:'pointer',padding:0,fontSize:'0.8rem'}}>
                        <span className={modalData.isPublic ? 'vis-public' : 'vis-private'}>{modalData.isPublic ? 'Public' : 'Private'}</span>
                      </button>
                    ) : (
                      <span className={modalData.isPublic ? 'vis-public' : 'vis-private'} style={{fontSize:'0.8rem'}}>{modalData.isPublic ? 'Public' : 'Private'}</span>
                    )}
                  </div>
                  {modalData.source && <div style={{gridColumn: modalData.primarySource ? 'auto' : 'span 3'}}><span style={{color:'#6b7394'}}>Source:</span> <span style={{color:'#c0c7d8'}}>{modalData.source}</span></div>}
                  {modalData.primarySource && <div style={{gridColumn: modalData.source ? 'span 2' : 'span 3'}}><span style={{color:'#6b7394'}}>Primary Source:</span> <span style={{color:'#c0c7d8'}}>{modalData.primarySource}</span></div>}
                </div>
                {/* AI Summary */}
                {modalData.aiSummary && <div className="ai-summary-box"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div className="ai-summary-label">AI Summary</div>{modalData._aiAnalyzed && <span style={{fontSize:'0.7rem',padding:'0.2rem 0.6rem',background:'rgba(16,185,129,0.2)',color:'#10b981',border:'1px solid rgba(16,185,129,0.4)',borderRadius:'6px',fontWeight:600}}>AI Analyzed{modalData._analysisMode ? ` Â· ${modalData._analysisMode.charAt(0).toUpperCase()+modalData._analysisMode.slice(1)}` : ''}{modalData._hasFrames ? ' + Frames' : ''}</span>}</div><p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.aiSummary}</p></div>}
                {/* Description â€” bullet points from AI + human notes */}
                <div className="form-group">
                  <label className="form-label">Description</label>
                  {modalData.description && modalData.description.includes('- ') ? (
                    <ul style={{color:'#e0e6ed',lineHeight:1.8,paddingLeft:'1.25rem',margin:0}}>
                      {modalData.description.split('\n').filter(l=>l.trim()).map((line,i)=>(
                        <li key={i} style={{marginBottom:'0.3rem'}}>{line.replace(/^[-â€¢]\s*/,'')}</li>
                      ))}
                    </ul>
                  ) : (
                    <p style={{color:'#e0e6ed',lineHeight:1.6}}>{modalData.description}</p>
                  )}
                </div>
                {modalData.transcription && (
                  <div style={{background:'rgba(16,185,129,0.1)',border:'2px solid rgba(16,185,129,0.3)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#10b981',marginBottom:'1rem'}}>Video Transcription</h3>
                    {modalData.transcription.chapters.map((ch,i)=>(
                      <div key={i} style={{padding:'1rem',marginBottom:'0.75rem',background:'rgba(26,31,58,0.5)',borderLeft:'4px solid #10b981',borderRadius:'8px'}}>
                        <div style={{fontWeight:700,color:'#10b981',marginBottom:'0.4rem'}}>{ch.timestamp} â€” {ch.title}</div>
                        <p style={{color:'#8b92b0',fontSize:'0.875rem'}}>{ch.text}</p>
                      </div>
                    ))}
                  </div>
                )}
                {/* Visual Content from video frames */}
                {modalData._visualContent && (
                  <div style={{background:'rgba(124,58,237,0.1)',border:'2px solid rgba(124,58,237,0.3)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#a78bfa',marginBottom:'1rem'}}>Visual Content Analysis</h3>
                    {modalData._visualContent.includes('- ') ? (
                      <ul style={{color:'#c0c7d8',lineHeight:1.8,paddingLeft:'1.25rem',margin:0}}>
                        {modalData._visualContent.split('\n').filter(l=>l.trim()).map((line,i)=>(
                          <li key={i} style={{marginBottom:'0.3rem'}}>{line.replace(/^[-â€¢]\s*/,'')}</li>
                        ))}
                      </ul>
                    ) : (
                      <p style={{color:'#c0c7d8',lineHeight:1.6}}>{modalData._visualContent}</p>
                    )}
                  </div>
                )}
                {/* Analysis Attachments â€” auto-generated files from AI analysis */}
                {(modalData._transcriptFile || (modalData._framesData||[]).length > 0) && (
                  <div style={{background:'rgba(245,158,11,0.08)',border:'2px solid rgba(245,158,11,0.25)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                    <h3 style={{color:'#f59e0b',marginBottom:'1rem',fontSize:'1rem'}}>Analysis Attachments</h3>
                    {modalData._transcriptFile && (
                      <div style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.6rem 0.75rem',background:'rgba(26,31,58,0.5)',borderRadius:'8px',marginBottom:'0.75rem',border:'1px solid rgba(245,158,11,0.2)'}}>
                        <span style={{fontSize:'1.2rem'}}>ðŸ“</span>
                        <span style={{color:'#e0e6ed',flex:1,fontSize:'0.85rem'}}>Transcript</span>
                        <a href={`${API_BASE}/api/transcripts/${modalData._transcriptFile}`} download style={{padding:'0.3rem 0.6rem',background:'rgba(245,158,11,0.2)',border:'1px solid rgba(245,158,11,0.4)',borderRadius:'6px',color:'#f59e0b',fontSize:'0.75rem',textDecoration:'none',fontWeight:600}}>Download</a>
                      </div>
                    )}
                    {(modalData._framesData||[]).length > 0 && (
                      <>
                        <div style={{color:'#c0c7d8',fontSize:'0.8rem',marginBottom:'0.5rem'}}>{modalData._framesData.length} frame(s) captured</div>
                        <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                          {modalData._framesData.map((f,i) => (
                            <div key={i} style={{position:'relative'}}>
                              <img src={f.base64 ? `data:image/jpeg;base64,${f.base64}` : `${API_BASE}/api/frames/${f.filename}`} alt={`Frame at ${f.timestamp}`} style={{width:'120px',height:'68px',objectFit:'cover',borderRadius:'6px',border:'1px solid rgba(245,158,11,0.3)',cursor:'pointer'}} onClick={()=>window.open(f.base64 ? `data:image/jpeg;base64,${f.base64}` : `${API_BASE}/api/frames/${f.filename}`,'_blank')} />
                              <span style={{position:'absolute',bottom:'2px',left:'2px',fontSize:'0.6rem',color:'#fff',background:'rgba(0,0,0,0.7)',padding:'1px 4px',borderRadius:'3px'}}>{f.timestamp}</span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                )}
                {/* User Attachments â€” manually uploaded files */}
                <div style={{background:'rgba(59,130,246,0.08)',border:'2px solid rgba(59,130,246,0.25)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                    <h3 style={{color:'#3b82f6',margin:0,fontSize:'1rem'}}>Attachments</h3>
                    {modalData._backendId && (
                      <label style={{padding:'0.3rem 0.8rem',background:'rgba(59,130,246,0.2)',border:'1px solid rgba(59,130,246,0.4)',borderRadius:'6px',color:'#3b82f6',fontSize:'0.75rem',fontWeight:600,cursor:'pointer'}}>
                        + Add File
                        <input type="file" multiple style={{display:'none'}} onChange={async (e)=>{
                          const files = e.target.files;
                          if (!files || files.length === 0) return;
                          const formData = new FormData();
                          for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
                          try {
                            const resp = await fetch(`${API_BASE}/api/attachments/${modalData._backendId}`, {method:'POST',body:formData});
                            if (resp.ok) {
                              const result = await resp.json();
                              const updatedAttachments = result.record.attachments || [];
                              setModalData({...modalData, _attachments: updatedAttachments});
                              setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                            }
                          } catch(err) { console.error('Upload failed:', err); }
                          e.target.value = '';
                        }} />
                      </label>
                    )}
                  </div>
                  {(modalData._attachments||[]).length === 0 ? (
                    <p style={{color:'#6b7394',fontSize:'0.85rem',margin:0}}>No attachments yet. Click "Add File" to upload.</p>
                  ) : (
                    <div style={{display:'flex',flexDirection:'column',gap:'0.5rem'}}>
                      {(modalData._attachments||[]).map((att,i) => (
                        <div key={i} style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.5)',borderRadius:'8px',border:'1px solid rgba(59,130,246,0.2)'}}>
                          <span style={{fontSize:'1.2rem'}}>{att.type==='image'?'ðŸ–¼ï¸':att.type==='video'?'ðŸŽ¬':att.type==='audio'?'ðŸŽµ':att.type==='pdf'?'ðŸ“„':att.type==='document'?'ðŸ“ƒ':'ðŸ“Ž'}</span>
                          {att.type==='image' && <img src={`/api/attachments/${att.filename}`} alt={att.original_name} style={{width:'48px',height:'48px',objectFit:'cover',borderRadius:'4px'}} />}
                          <span style={{color:'#e0e6ed',flex:1,fontSize:'0.85rem'}}>{att.original_name}</span>
                          <span style={{color:'#6b7394',fontSize:'0.7rem'}}>{att.size > 1048576 ? (att.size/1048576).toFixed(1)+'MB' : (att.size/1024).toFixed(0)+'KB'}</span>
                          <a href={`/api/attachments/${att.filename}`} download style={{padding:'0.25rem 0.5rem',background:'rgba(59,130,246,0.2)',border:'1px solid rgba(59,130,246,0.4)',borderRadius:'4px',color:'#3b82f6',fontSize:'0.7rem',textDecoration:'none'}}>Download</a>
                          {(modalData.uploadedBy === (currentUser||{}).username || (currentUser||{}).role === 'admin' || (currentUser||{}).role === 'owner') && (
                            <button onClick={async ()=>{
                              if (!window.confirm('Remove this attachment?')) return;
                              try {
                                const resp = await fetch(`${API_BASE}/api/attachments/${modalData._backendId}/${att.filename}`, {method:'DELETE'});
                                if (resp.ok) {
                                  const result = await resp.json();
                                  const updatedAttachments = result.record.attachments || [];
                                  setModalData({...modalData, _attachments: updatedAttachments});
                                  setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                                }
                              } catch(err) { console.error('Delete failed:', err); }
                            }} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',fontSize:'1rem',padding:'0.1rem 0.3rem'}}>Ã—</button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                {(modalData.topics||[]).length > 0 && <div className="form-group"><label className="form-label">Topics</label><div className="tags">{modalData.topics.map((t,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('topic',t);}}>{t}</span>)}</div></div>}
                {(modalData.people||[]).length > 0 && <div className="form-group"><label className="form-label">People</label><div className="tags">{modalData.people.map((p,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('person',p);}}>{p}</span>)}</div></div>}
                {(modalData.organizations||[]).length > 0 && <div className="form-group"><label className="form-label">Organizations</label><div className="tags">{modalData.organizations.map((o,i)=><span key={i} className="tag" onClick={()=>{setShowModal(false);openEntityDetail('org',o);}}>{o}</span>)}</div></div>}
                {/* Links â€” main link first, then additional */}
                {(modalData.mainLink || (modalData.links||[]).length > 0) && (
                  <div className="form-group"><label className="form-label">Links</label>
                    {modalData.mainLink && (
                      <div style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem',padding:'0.5rem',background:'rgba(96,165,250,0.08)',borderRadius:'8px',border:'1px solid rgba(96,165,250,0.2)'}}>
                        <span style={{color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,whiteSpace:'nowrap'}}>MAIN</span>
                        <a href={modalData.mainLink} target="_blank" rel="noopener noreferrer" style={{color:'#60a5fa',wordBreak:'break-all',flex:1}}>{modalData.mainLink}</a>
                        <button onClick={()=>copyToClipboard(modalData.mainLink)} className="btn btn-secondary" style={{padding:'0.4rem 0.75rem',fontSize:'0.75rem'}}>Copy</button>
                      </div>
                    )}
                    {(modalData.links||[]).filter(l=>l && l !== modalData.mainLink).map((l,i)=>(
                      <div key={i} style={{marginBottom:'0.5rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                        <a href={l} target="_blank" rel="noopener noreferrer" style={{color:'#60a5fa',wordBreak:'break-all',flex:1}}>{l}</a>
                        <button onClick={()=>copyToClipboard(l)} className="btn btn-secondary" style={{padding:'0.4rem 0.75rem',fontSize:'0.75rem'}}>Copy</button>
                      </div>
                    ))}
                  </div>
                )}
                {/* Download original document */}
                {modalData._backendFileName && (
                  <div className="form-group">
                    <a href={`/api/uploads/${modalData._backendFileName}`} download style={{display:'inline-block',padding:'0.5rem 1rem',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'8px',color:'#60a5fa',fontSize:'0.85rem',textDecoration:'none',fontWeight:600}}>Download Original Document</a>
                  </div>
                )}
              </>
            ) : (
              <>
                {/* â”€â”€ Section: Basic Info â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,basic:!s.basic}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.basic?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Basic Info</span>
                  </div>
                  {editSections.basic && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Title</label><input className="edit-input" value={editedEvent.title||''} onChange={e=>setEditedEvent({...editedEvent,title:e.target.value})} /></div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0 1rem'}}>
                      <div className="form-group"><label className="form-label">Date</label><input type="date" className="edit-input" value={editedEvent.date||''} onChange={e=>setEditedEvent({...editedEvent,date:e.target.value})} /></div>
                      <div className="form-group"><label className="form-label">Research Level</label>
                        <select className="edit-input" value={editedEvent.researchLevel||1} onChange={e=>setEditedEvent({...editedEvent,researchLevel:parseInt(e.target.value)})}>
                          <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option>
                        </select>
                      </div>
                    </div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0 1rem'}}>
                      <div className="form-group"><label className="form-label">Source (publisher)</label><input className="edit-input" value={editedEvent.source||''} onChange={e=>setEditedEvent({...editedEvent,source:e.target.value})} placeholder="e.g., Al Jazeera, CDC" /></div>
                      <div className="form-group"><label className="form-label">Primary Source</label><input className="edit-input" value={editedEvent.primarySource||''} onChange={e=>setEditedEvent({...editedEvent,primarySource:e.target.value})} placeholder="Original source of info" /></div>
                    </div>
                  </div>}
                </div>

                {/* â”€â”€ Section: AI Summary & Description â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,ai:!s.ai}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.ai?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>AI Summary & Description</span>
                  </div>
                  {editSections.ai && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group">
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                        <label className="form-label" style={{marginBottom:0}}>AI Summary</label>
                        <button disabled={isCondensing} onClick={async ()=>{
                          if (!editedEvent.aiSummary) return;
                          setIsCondensing(true);
                          try {
                            const resp = await fetch(`${API_BASE}/api/condense`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:editedEvent.aiSummary})});
                            if (resp.ok) { const r = await resp.json(); setEditedEvent({...editedEvent, aiSummary: r.condensed}); }
                          } catch(e) {}
                          setIsCondensing(false);
                        }} style={{padding:'0.3rem 0.7rem',fontSize:'0.75rem',fontWeight:600,color:'#fff',background:isCondensing?'#6b7394':'linear-gradient(135deg,#7c3aed,#6d28d9)',border:'none',borderRadius:'6px',cursor:isCondensing?'wait':'pointer',fontFamily:'inherit'}}>
                          {isCondensing ? 'Condensing...' : 'Condense'}
                        </button>
                      </div>
                      <textarea className="edit-input" rows={3} value={editedEvent.aiSummary||''} onChange={e=>setEditedEvent({...editedEvent,aiSummary:e.target.value})} style={{marginTop:'0.4rem'}} />
                    </div>
                    <div className="form-group"><label className="form-label">Description (bullet points or notes)</label><textarea className="edit-input" rows={3} value={editedEvent.description||''} onChange={e=>setEditedEvent({...editedEvent,description:e.target.value})} placeholder="- Key fact 1&#10;- Key fact 2&#10;Or free-form notes..." /></div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Tags â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,tags:!s.tags}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.tags?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Tags</span>
                  </div>
                  {editSections.tags && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Topics</label><MultiSelectDropdown options={data.topics||[]} selected={editedEvent.topics||[]} onChange={v=>setEditedEvent({...editedEvent,topics:v})} placeholder="Select or add topics..." /></div>
                    <div className="form-group"><label className="form-label">People</label><MultiSelectDropdown options={data.people||[]} selected={editedEvent.people||[]} onChange={v=>setEditedEvent({...editedEvent,people:v})} placeholder="Select or add people..." /></div>
                    <div className="form-group"><label className="form-label">Organizations</label><MultiSelectDropdown options={data.organizations||[]} selected={editedEvent.organizations||[]} onChange={v=>setEditedEvent({...editedEvent,organizations:v})} placeholder="Select or add organizations..." /></div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Links â”€â”€ */}
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,links:!s.links}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.links?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Links</span>
                  </div>
                  {editSections.links && <div style={{padding:'0.75rem 1rem'}}>
                    <div className="form-group"><label className="form-label">Main Link</label><input className="edit-input" value={editedEvent.mainLink||''} onChange={e=>setEditedEvent({...editedEvent,mainLink:e.target.value})} placeholder="https://..." /></div>
                    <div className="form-group">
                      <label className="form-label">Additional Links</label>
                      {(editedEvent.links||[]).map((link,i) => (
                        <div key={i} style={{display:'flex',gap:'0.5rem',marginBottom:'0.4rem',alignItems:'center'}}>
                          <input className="edit-input" style={{flex:1,marginBottom:0}} value={link} onChange={e=>{const newLinks=[...(editedEvent.links||[])];newLinks[i]=e.target.value;setEditedEvent({...editedEvent,links:newLinks});}} placeholder={`Link ${i+2}`} />
                          <button onClick={()=>{const newLinks=[...(editedEvent.links||[])];newLinks.splice(i,1);setEditedEvent({...editedEvent,links:newLinks});}} style={{padding:'0.3rem 0.6rem',background:'rgba(248,113,113,0.15)',color:'#f87171',border:'1px solid rgba(248,113,113,0.3)',borderRadius:'6px',cursor:'pointer',fontSize:'0.8rem',fontWeight:700,fontFamily:'inherit'}}>Ã—</button>
                        </div>
                      ))}
                      <button onClick={()=>setEditedEvent({...editedEvent,links:[...(editedEvent.links||[]),'']}) } style={{padding:'0.35rem 0.8rem',fontSize:'0.8rem',fontWeight:600,color:'#60a5fa',background:'rgba(96,165,250,0.1)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',marginTop:'0.25rem'}}>+ Add Link</button>
                    </div>
                  </div>}
                </div>

                {/* â”€â”€ Section: Attachments â”€â”€ */}
                {editedEvent._backendId && (
                <div style={{marginBottom:'0.75rem',border:'1px solid rgba(61,69,99,0.3)',borderRadius:'10px',overflow:'hidden'}}>
                  <div onClick={()=>setEditSections(s=>({...s,attachments:!s.attachments}))} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.6rem 1rem',background:'rgba(26,31,58,0.5)',cursor:'pointer',userSelect:'none'}}>
                    <span style={{color:'#6b7394',fontSize:'0.75rem'}}>{editSections.attachments?'â–¼':'â–¶'}</span>
                    <span style={{color:'#c0c7d8',fontWeight:700,fontSize:'0.85rem'}}>Attachments</span>
                    <span style={{color:'#6b7394',fontSize:'0.75rem',marginLeft:'auto'}}>{(editedEvent._attachments||[]).length} file(s)</span>
                  </div>
                  {editSections.attachments && <div style={{padding:'0.75rem 1rem'}}>
                    {(editedEvent._attachments||[]).map((att,i) => (
                      <div key={i} style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.4rem',padding:'0.4rem 0.5rem',background:'rgba(26,31,58,0.5)',borderRadius:'6px'}}>
                        <span style={{fontSize:'1rem'}}>{att.type==='image'?'ðŸ–¼ï¸':att.type==='video'?'ðŸŽ¬':att.type==='audio'?'ðŸŽµ':'ðŸ“Ž'}</span>
                        <span style={{color:'#e0e6ed',flex:1,fontSize:'0.8rem'}}>{att.original_name}</span>
                        <button onClick={async ()=>{
                          if (!window.confirm('Remove this attachment?')) return;
                          try {
                            const resp = await fetch(`${API_BASE}/api/attachments/${editedEvent._backendId}/${att.filename}`, {method:'DELETE'});
                            if (resp.ok) {
                              const result = await resp.json();
                              const updatedAttachments = result.record.attachments || [];
                              setEditedEvent({...editedEvent, _attachments: updatedAttachments});
                              setModalData({...modalData, _attachments: updatedAttachments});
                              setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                            }
                          } catch(err) { console.error('Delete failed:', err); }
                        }} style={{padding:'0.2rem 0.4rem',background:'rgba(248,113,113,0.15)',color:'#f87171',border:'1px solid rgba(248,113,113,0.3)',borderRadius:'4px',cursor:'pointer',fontSize:'0.75rem',fontWeight:700,fontFamily:'inherit'}}>Ã—</button>
                      </div>
                    ))}
                    <label style={{display:'inline-block',padding:'0.35rem 0.8rem',fontSize:'0.8rem',fontWeight:600,color:'#3b82f6',background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.3)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',marginTop:'0.25rem'}}>
                      + Add File
                      <input type="file" multiple style={{display:'none'}} onChange={async (e)=>{
                        const files = e.target.files;
                        if (!files || files.length === 0) return;
                        const formData = new FormData();
                        for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
                        try {
                          const resp = await fetch(`${API_BASE}/api/attachments/${editedEvent._backendId}`, {method:'POST',body:formData});
                          if (resp.ok) {
                            const result = await resp.json();
                            const updatedAttachments = result.record.attachments || [];
                            setEditedEvent({...editedEvent, _attachments: updatedAttachments});
                            setModalData({...modalData, _attachments: updatedAttachments});
                            setData(prev=>({...prev, events: prev.events.map(ev=>ev.id===modalData.id?{...ev,_attachments:updatedAttachments}:ev)}));
                          }
                        } catch(err) { console.error('Upload failed:', err); }
                        e.target.value = '';
                      }} />
                    </label>
                  </div>}
                </div>
                )}
              </>
            )}
          </div>
        </div>
      );

      // â”€â”€ Entity Profile Modal â”€â”€
      const entityProfileModalJSX = !entityModalOpen || !entityModalData ? null : (() => {
        const em = entityModalData;
        const canEdit = currentUser && (currentUser.role === 'owner' || currentUser.role === 'admin');
        const typeLabel = em.type === 'person' ? 'PERSON' : em.type === 'org' ? 'ORGANIZATION' : 'TOPIC';
        const typeBadgeBg = em.type === 'person' ? 'rgba(96,165,250,0.15)' : em.type === 'org' ? 'rgba(16,185,129,0.15)' : 'rgba(167,139,250,0.15)';
        const typeBadgeBorder = em.type === 'person' ? 'rgba(96,165,250,0.5)' : em.type === 'org' ? 'rgba(16,185,129,0.5)' : 'rgba(167,139,250,0.5)';
        const typeBadgeText = em.type === 'person' ? '#60a5fa' : em.type === 'org' ? '#10b981' : '#a78bfa';
        const dateStartLabel = em.type === 'person' ? 'Born' : em.type === 'org' ? 'Founded' : 'Active From';
        const dateEndLabel = em.type === 'person' ? 'Died' : em.type === 'org' ? 'Dissolved' : 'Active Until';
        const profile = em.profile || {};
        return (
          <div className="modal" onClick={() => setEntityModalOpen(false)}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'860px'}}>
              {/* Header */}
              <div className="modal-header">
                <div style={{flex:1}}>
                  <span style={{display:'inline-block',marginBottom:'0.6rem',padding:'0.2rem 0.75rem',background:typeBadgeBg,border:`1px solid ${typeBadgeBorder}`,borderRadius:'20px',color:typeBadgeText,fontSize:'0.68rem',fontWeight:700,letterSpacing:'1.5px'}}>{typeLabel}</span>
                  <h2 className="modal-title">{em.name}</h2>
                  <p style={{color:'#8b92b0',fontSize:'0.85rem',marginTop:'0.25rem'}}>{em.relEvents.length} related event{em.relEvents.length!==1?'s':''}</p>
                </div>
                <div className="modal-actions">
                  {canEdit && !entityModalEditing && (
                    <>
                      <div className="tooltip-wrapper">
                        <button className="btn btn-primary" style={{padding:'0.5rem 1rem',fontSize:'0.875rem',opacity:entityModalAnalyzing||em.relEvents.length===0?0.55:1,cursor:entityModalAnalyzing||em.relEvents.length===0?'not-allowed':'pointer',background:profile.description?'rgba(96,165,250,0.15)':undefined,border:profile.description?'1px solid rgba(96,165,250,0.4)':undefined}} onClick={analyzeEntityProfile} disabled={entityModalAnalyzing||em.relEvents.length===0}>
                          {entityModalAnalyzing ? 'â³ Analyzingâ€¦' : profile.description ? 'ðŸ”„ Refresh AI Profile' : 'âœ¨ AI Profile'}
                        </button>
                        <div className="tooltip-content" style={{right:0,width:'260px'}}>
                          {profile.description
                            ? 'Re-run AI analysis using the latest related events. This will overwrite the current profile description and dates.'
                            : 'Auto-generate a research profile using Claude AI. It will synthesize all related events to create a summary, key facts, and dates for this ' + (em.type==='person'?'person':em.type==='org'?'organization':'topic') + '.'}
                          {em.relEvents.length===0 && ' (Disabled â€” no related events found.)'}
                        </div>
                      </div>
                      <button className="edit-btn" onClick={() => { setEntityModalDraft({description:profile.description||'', date_start:profile.date_start||'', date_end:profile.date_end||''}); setEntityModalEditing(true); }}>âœï¸ Edit</button>
                    </>
                  )}
                  {entityModalEditing && <>
                    <button className="btn btn-primary" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={saveEntityProfile}>ðŸ’¾ Save</button>
                    <button className="btn btn-danger" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}} onClick={() => setEntityModalEditing(false)}>Cancel</button>
                  </>}
                  <button className="close" onClick={() => setEntityModalOpen(false)}>Ã—</button>
                </div>
              </div>

              {/* Dates */}
              {(entityModalEditing || profile.date_start || profile.date_end) && (
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1.5rem',padding:'1rem 1.25rem',background:'rgba(26,31,58,0.5)',borderRadius:'10px',border:'1px solid rgba(61,69,99,0.3)'}}>
                  <div>
                    <div style={{fontSize:'0.7rem',color:'#8b92b0',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.5px',marginBottom:'0.5rem'}}>{dateStartLabel}</div>
                    {entityModalEditing
                      ? <input value={entityModalDraft.date_start} onChange={e=>setEntityModalDraft(prev=>({...prev,date_start:e.target.value}))} placeholder="e.g. January 1, 1950" style={{width:'100%'}} />
                      : <div style={{color:'#e0e6ed',fontSize:'1rem',fontWeight:600,fontFamily:"'Space Mono',monospace"}}>{profile.date_start||'â€”'}</div>
                    }
                  </div>
                  <div>
                    <div style={{fontSize:'0.7rem',color:'#8b92b0',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.5px',marginBottom:'0.5rem'}}>{dateEndLabel}</div>
                    {entityModalEditing
                      ? <input value={entityModalDraft.date_end} onChange={e=>setEntityModalDraft(prev=>({...prev,date_end:e.target.value}))} placeholder="e.g. March 12, 2010 or Present" style={{width:'100%'}} />
                      : <div style={{color:'#e0e6ed',fontSize:'1rem',fontWeight:600,fontFamily:"'Space Mono',monospace"}}>{profile.date_end||'â€”'}</div>
                    }
                  </div>
                </div>
              )}

              {/* Description / About */}
              <div className="form-group">
                <label className="form-label">About</label>
                {entityModalEditing
                  ? <textarea value={entityModalDraft.description} onChange={e=>setEntityModalDraft(prev=>({...prev,description:e.target.value}))} rows={5} placeholder="Write a description of this entity..." style={{width:'100%',background:'rgba(10,14,39,0.8)',border:'2px solid rgba(45,53,97,0.5)',borderRadius:'10px',color:'#e0e6ed',padding:'0.875rem',fontSize:'0.875rem',fontFamily:'Karla,sans-serif',resize:'vertical',boxSizing:'border-box'}} />
                  : profile.description
                    ? (profile.description.includes('\n') || profile.description.startsWith('- ')
                        ? <ul style={{color:'#e0e6ed',lineHeight:1.8,paddingLeft:'1.25rem',margin:0}}>{profile.description.split('\n').filter(l=>l.trim()).map((line,i)=><li key={i} style={{marginBottom:'0.3rem'}}>{line.replace(/^[-â€¢]\s*/,'')}</li>)}</ul>
                        : <p style={{color:'#e0e6ed',lineHeight:1.7}}>{profile.description}</p>
                      )
                    : <p style={{color:'#4a5270',fontStyle:'italic',fontSize:'0.875rem'}}>{canEdit?'No description yet â€” click âœ¨ AI Profile to auto-generate one, or âœï¸ Edit to write one manually.':'No description available.'}</p>
                }
              </div>

              {/* Connections */}
              {(em.connections.topics.length > 0 || em.connections.people.length > 0 || em.connections.orgs.length > 0) && (
                <div className="form-group">
                  <label className="form-label">Connected To</label>
                  <div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>
                    {em.connections.topics.length > 0 && (
                      <div>
                        <div style={{fontSize:'0.68rem',color:'#a78bfa',fontWeight:700,letterSpacing:'1px',textTransform:'uppercase',marginBottom:'0.4rem'}}>Topics</div>
                        <div className="tags">
                          {em.connections.topics.slice(0,20).map(({name:t,count:c})=>(
                            <span key={t} className="tag" style={{background:'rgba(167,139,250,0.15)',borderColor:'rgba(167,139,250,0.3)',cursor:'pointer'}} onClick={()=>openEntityDetail('topic',t)}>{t}<span style={{opacity:0.55,fontSize:'0.68rem',marginLeft:'0.3rem'}}>Ã—{c}</span></span>
                          ))}
                        </div>
                      </div>
                    )}
                    {em.connections.people.length > 0 && (
                      <div>
                        <div style={{fontSize:'0.68rem',color:'#60a5fa',fontWeight:700,letterSpacing:'1px',textTransform:'uppercase',marginBottom:'0.4rem'}}>People</div>
                        <div className="tags">
                          {em.connections.people.slice(0,20).map(({name:p,count:c})=>(
                            <span key={p} className="tag" style={{cursor:'pointer'}} onClick={()=>openEntityDetail('person',p)}>{p}<span style={{opacity:0.55,fontSize:'0.68rem',marginLeft:'0.3rem'}}>Ã—{c}</span></span>
                          ))}
                        </div>
                      </div>
                    )}
                    {em.connections.orgs.length > 0 && (
                      <div>
                        <div style={{fontSize:'0.68rem',color:'#10b981',fontWeight:700,letterSpacing:'1px',textTransform:'uppercase',marginBottom:'0.4rem'}}>Organizations</div>
                        <div className="tags">
                          {em.connections.orgs.slice(0,20).map(({name:o,count:c})=>(
                            <span key={o} className="tag" style={{background:'rgba(16,185,129,0.1)',borderColor:'rgba(16,185,129,0.3)',cursor:'pointer'}} onClick={()=>openEntityDetail('org',o)}>{o}<span style={{opacity:0.55,fontSize:'0.68rem',marginLeft:'0.3rem'}}>Ã—{c}</span></span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Related Events */}
              <div className="form-group" style={{marginBottom:0}}>
                <label className="form-label">Related Events ({em.relEvents.length})</label>
                {em.relEvents.length === 0
                  ? <p style={{color:'#4a5270',fontStyle:'italic',fontSize:'0.875rem'}}>No events found.</p>
                  : <div style={{display:'flex',flexDirection:'column',gap:'0.6rem',maxHeight:'320px',overflowY:'auto',paddingRight:'0.25rem'}}>
                      {em.relEvents.map(e=>(
                        <div key={e.id} style={{background:'rgba(26,31,58,0.6)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'10px',padding:'0.9rem 1rem',cursor:'pointer',transition:'border-color 0.15s'}}
                          onClick={()=>{ setEntityModalOpen(false); openEventModal(e,'entity'); }}
                          onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(96,165,250,0.5)'}
                          onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                          <div style={{color:'#60a5fa',fontSize:'0.78rem',marginBottom:'0.25rem',fontFamily:"'Space Mono',monospace"}}>{e.date||'Date Unknown'}</div>
                          <div style={{fontWeight:700,marginBottom:'0.35rem',fontSize:'0.95rem'}}>{e.title}</div>
                          {e.description && <div style={{color:'#8b92b0',fontSize:'0.82rem',lineHeight:1.4}}>{e.description.substring(0,160)}{e.description.length>160?'â€¦':''}</div>}
                          {(e.topics||[]).length>0 && <div className="tags" style={{marginTop:'0.4rem'}}>{(e.topics||[]).slice(0,4).map((t,i)=><span key={i} className="tag" style={{fontSize:'0.68rem',padding:'0.15rem 0.5rem'}}>{t}</span>)}</div>}
                        </div>
                      ))}
                    </div>
                }
              </div>
            </div>
          </div>
        );
      })();

      // â”€â”€ Account Page â”€â”€
      // NOTE: accountTab, myFilters, myPageTab all live in App scope to prevent reset on re-render
      const AccountPage = () => {
        const isAdminOrOwner = currentUser.role === 'admin' || currentUser.role === 'owner';
        const myPublicCount = myUploads.filter(e => e.isPublic).length;
        const myPrivateCount = myUploads.length - myPublicCount;
        const initials = currentUser.username.substring(0, 2).toUpperCase();
        const matchedUser = adminUsers.find(u => u.username === currentUser.username);
        const memberSince = matchedUser && matchedUser.created_at
          ? new Date(matchedUser.created_at).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' })
          : 'Member';
        // Scoped data: only user's own topics/people/orgs appear in FiltersComponent checkboxes
        const userTopics = [...new Set(myUploads.flatMap(e => e.topics||[]))].sort();
        const userPeople = [...new Set(myUploads.flatMap(e => e.people||[]))].sort();
        const userOrgs   = [...new Set(myUploads.flatMap(e => e.organizations||[]))].sort();
        const accountScopedData = { ...data, topics: userTopics, people: userPeople, organizations: userOrgs };
        const myFilterProps = { filters: myFilters, setFilters: setMyFilters, data: accountScopedData, activeTab: myPageTab, onSearch: applyMySearch, onClear: clearMyFilters, onExportCSV: myExportCSV, onExportJSON: myExportJSON };
        const statusLabel = s => s==='historical_record'?'Historical Record':s==='contested'?'Contested':'Unverified';
        // Research Sessions state (loaded on demand when the Sessions tab is opened)
        const [researchSessions, setResearchSessions] = React.useState([]);
        const [sessionsLoading, setSessionsLoading] = React.useState(false);
        const [sessionsLoaded, setSessionsLoaded] = React.useState(false);
        const [expandedSession, setExpandedSession] = React.useState(null);
        const loadResearchSessions = async () => {
          if (sessionsLoaded) return;
          setSessionsLoading(true);
          try {
            const { data: rows, error } = await supabaseClient
              .from('research_sessions')
              .select('*')
              .eq('uploaded_by', currentUser.username)
              .order('started_at', { ascending: false });
            if (!error && rows) setResearchSessions(rows);
          } catch(e) { /* table may not exist yet */ }
          setSessionsLoading(false);
          setSessionsLoaded(true);
        };
        React.useEffect(() => { if (accountTab === 'sessions') loadResearchSessions(); }, [accountTab]);
        return (
          <div>
            {/* Profile card */}
            <div className="account-profile-card">
              <div className="account-avatar">{initials}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem',flexWrap:'wrap'}}>
                  <h2 style={{fontSize:'1.75rem',fontFamily:"'Space Mono',monospace",color:'#e0e6ed',margin:0}}>{currentUser.username}</h2>
                  <span className={`role-badge role-${currentUser.role}`} style={{fontSize:'0.8rem',padding:'0.3rem 0.75rem'}}>{currentUser.role}</span>
                </div>
                <div style={{color:'#8b92b0',fontSize:'0.875rem',marginBottom:'1.25rem'}}>Member since: {memberSince}</div>
                <div style={{display:'flex',gap:'2rem',flexWrap:'wrap'}}>
                  {[
                    {label:'Total Uploads', value:myUploads.length, color:'#60a5fa'},
                    {label:'Public',        value:myPublicCount,     color:'#10b981'},
                    {label:'Private',       value:myPrivateCount,    color:'#9ca3af'},
                  ].map(s=>(
                    <div key={s.label} style={{textAlign:'center'}}>
                      <div style={{fontSize:'1.5rem',fontWeight:700,color:s.color,fontFamily:"'Space Mono',monospace"}}>{s.value}</div>
                      <div style={{fontSize:'0.7rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'0.5px'}}>{s.label}</div>
                    </div>
                  ))}
                </div>
              </div>
              <button className="logout-btn" style={{alignSelf:'flex-start',padding:'0.5rem 1.25rem',fontSize:'0.875rem'}} onClick={logout}>Logout</button>
            </div>
            {/* Sub-tabs */}
            <div className="account-tabs">
              <button className={`account-tab ${accountTab==='uploads'?'active':''}`} onClick={()=>setAccountTab('uploads')}>ðŸ“‚ My Uploads</button>
              <button className={`account-tab ${accountTab==='sessions'?'active':''}`} onClick={()=>setAccountTab('sessions')}>ðŸ—º Research Sessions</button>
              {isAdminOrOwner && (
                <button className={`account-tab ${accountTab==='admin'?'active-admin':''}`} onClick={()=>setAccountTab('admin')}>
                  ðŸ›¡ï¸ {currentUser.role==='owner'?'Owner Panel':'Admin Panel'}
                </button>
              )}
              {currentUser.role === 'owner' && (
                <button className={`account-tab ${accountTab==='manual'?'active-admin':''}`} onClick={()=>setAccountTab('manual')} style={{position:'relative'}}>
                  ðŸ“– Owner's Manual
                  {ownerAlerts.length > 0 && (
                    <span style={{position:'absolute',top:'4px',right:'4px',minWidth:'16px',height:'16px',borderRadius:'50%',background:'#ef4444',color:'#fff',fontSize:'0.6rem',fontWeight:700,display:'flex',alignItems:'center',justifyContent:'center',lineHeight:1,padding:'0 3px'}}>
                      {ownerAlerts.length}
                    </span>
                  )}
                </button>
              )}
            </div>
            {/* My Uploads â€” Pages nav + FiltersComponent + page content, scoped to user's own uploads */}
            {accountTab === 'uploads' && (
              <div>
                {/* Pages section */}
                <div style={{marginBottom:'0'}}>
                  <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem'}}>Pages</div>
                  <nav className="nav">
                    {['timeline','network','spreadsheet','presentations','topics','people','organizations'].map(tab => (
                      <button key={tab} className={`nav-btn ${myPageTab===tab?'active':''}`}
                        onClick={() => setMyPageTab(tab)}>
                        {tab==='timeline'?'ðŸ“…':tab==='network'?'ðŸ”—':tab==='spreadsheet'?'ðŸ“Š':tab==='presentations'?'ðŸŽžï¸':tab==='topics'?'ðŸ·ï¸':tab==='people'?'ðŸ‘¤':'ðŸ›ï¸'}{' '}{tab.charAt(0).toUpperCase()+tab.slice(1)}
                      </button>
                    ))}
                    <button className="nav-btn" onClick={() => setActiveTab('upload')}>
                      ðŸ“¤ Upload
                    </button>
                  </nav>
                </div>

                {/* Full FiltersComponent scoped to user's uploads */}
                <FiltersComponent {...myFilterProps} />

                {/* Timeline */}
                {myPageTab === 'timeline' && (
                  <div className="timeline-wrapper">
                    <div className="timeline-container">
                      <div className="timeline-line"></div>
                      <div className="timeline-events">
                        {myTimelineEvents.length === 0 ? (
                          <div className="empty-state"><div className="empty-state-icon">ðŸ“…</div><p>{myUploads.length===0?'No uploads yet â€” go to Upload to add events.':'No dated events match your filters.'}</p></div>
                        ) : myTimelineEvents.map((e,index) => {
                          const dateStr = String(e.date||'');
                          const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                          const prevYear = index>0 ? String(myTimelineEvents[index-1].date||'').substring(0,4) : null;
                          const showYear = index===0 || year!==prevYear;
                          return (
                            <div key={e.id} className={`timeline-event ${index%2===0?'above':'below'} ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'account')}>
                              {showYear && <div className="tl-year">{year}</div>}
                              <div className="tl-dot"></div>
                              <div className="tl-connector"></div>
                              <div className="tl-card">
                                <div className="tl-card-title">{e.title||''}</div>
                                <div className="tl-card-date">{year!=='?'?year:''}</div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {/* Network */}
                {myPageTab === 'network' && (
                  <div className="network">
                    <div style={{position:'absolute',top:'12px',right:'12px',zIndex:10,background:'rgba(10,13,28,0.93)',border:'1px solid rgba(96,165,250,0.25)',borderRadius:'10px',padding:'0.7rem 1rem',backdropFilter:'blur(12px)',minWidth:'148px'}}>
                      <div style={{color:'#64748b',fontSize:'0.65rem',fontWeight:700,letterSpacing:'0.1em',textTransform:'uppercase',marginBottom:'0.55rem'}}>Legend</div>
                      {[{symbol:'â—',color:'#60a5fa',label:'Event'},{symbol:'â– ',color:'#c084fc',label:'Person'},{symbol:'â—†',color:'#34d399',label:'Organization'},{symbol:'â–²',color:'#fb923c',label:'Topic'}].map(item=>(
                        <div key={item.label} style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.3rem'}}>
                          <span style={{color:item.color,fontSize:'0.85rem',lineHeight:1,flexShrink:0}}>{item.symbol}</span>
                          <span style={{color:'#cbd5e1',fontSize:'0.76rem'}}>{item.label}</span>
                        </div>
                      ))}
                    </div>
                    <div id="my-network-graph" style={{width:'100%',height:'100%',borderRadius:'16px'}}></div>
                  </div>
                )}

                {/* Spreadsheet */}
                {myPageTab === 'spreadsheet' && (
                  <div className="spreadsheet">
                    {selectedMyEvents.size > 0 && (
                      <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem',alignItems:'center'}}>
                        <span style={{color:'#a78bfa',fontSize:'0.85rem',fontWeight:600}}>{selectedMyEvents.size} selected</span>
                        <button onClick={()=>setShowDownloadPopup('myuploads')} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#fff',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>Download Selected</button>
                        <button onClick={()=>setSelectedMyEvents(new Set())} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#8b92b0',background:'rgba(61,69,99,0.3)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit'}}>Clear</button>
                      </div>
                    )}
                    <table className="table">
                      <thead><tr>
                        <th style={{width:'40px',textAlign:'center'}}>
                          <button onClick={()=>{if(selectedMyEvents.size===mySortedEvents.length)setSelectedMyEvents(new Set());else setSelectedMyEvents(new Set(mySortedEvents.map(e=>e.id)));}} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit'}}>{selectedMyEvents.size===mySortedEvents.length&&mySortedEvents.length>0?'âœ“ All':'All'}</button>
                        </th>
                        <th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Status</th><th>Visibility</th>
                      </tr></thead>
                      <tbody>
                        {mySortedEvents.length === 0 ? (
                          <tr><td colSpan="10" style={{textAlign:'center',padding:'2rem',color:'#8b92b0'}}>No events match your filters.</td></tr>
                        ) : mySortedEvents.map(e=>(
                          <tr key={e.id} onClick={()=>openEventModal(e,'account')} style={{cursor:'pointer'}}>
                            <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                              <input type="checkbox" checked={selectedMyEvents.has(e.id)} onChange={()=>setSelectedMyEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                            </td>
                            <td>{e.id}</td>
                            <td style={{fontWeight:600}}>{e.title}</td>
                            <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                            <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                            <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                            <td>{e.date||'â€”'}</td>
                            <td><span className={`status-${e.eventStatus||'unverified'}`}>{statusLabel(e.eventStatus)}</span></td>
                            <td>
                              <button onClick={ev=>{ev.stopPropagation();toggleEventPublic(e.id);}} style={{background:'none',border:'none',cursor:'pointer',padding:0}}>
                                <span className={e.isPublic?'vis-public':'vis-private'}>{e.isPublic?'ðŸŒ Public':'ðŸ”’ Private'}</span>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}

                {/* Topics */}
                {myPageTab === 'topics' && (
                  <div className="grid">
                    {myFilteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ·ï¸</div><p>No topics in your uploads yet.</p></div> :
                    myFilteredTopics.map(t=>{
                      const relEvents = myFiltered.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                      return (
                        <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                          <div className="card-title">{t.name}</div>
                          <div className="card-count">{t.count} event{t.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* People */}
                {myPageTab === 'people' && (
                  <div className="grid">
                    {myFilteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ‘¤</div><p>No people in your uploads yet.</p></div> :
                    myFilteredPeople.map(p=>{
                      const relEvents = myFiltered.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                      return (
                        <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                          <div className="card-title">{p.name}</div>
                          <div className="card-count">{p.count} event{p.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Organizations */}
                {myPageTab === 'organizations' && (
                  <div className="grid">
                    {myFilteredOrgs.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ›ï¸</div><p>No organizations in your uploads yet.</p></div> :
                    myFilteredOrgs.map(o=>{
                      const relEvents = myFiltered.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                      return (
                        <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                          <div className="card-title">{o.name}</div>
                          <div className="card-count">{o.count} event{o.count!==1?'s':''} â†’</div>
                          <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* My Uploads â€” Presentations */}
                {myPageTab === 'presentations' && (() => {
                  const myPresns2 = presentations.filter(p => p.user_id === currentUser?.username);
                  const publicGallery2 = presentations.filter(p => p.is_public && p.user_id !== currentUser?.username);
                  return (
                    <div>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1.5rem',gap:'1rem',flexWrap:'wrap'}}>
                        <div>
                          <h2 style={{fontSize:'1.5rem',color:'#e0e6ed',fontFamily:"'Space Mono',monospace",marginBottom:'0.25rem',marginTop:0}}>My Presentations</h2>
                          <p style={{color:'#8b92b0',fontSize:'0.85rem',margin:0}}>Use the Presentations tab to create and edit your slides.</p>
                        </div>
                        <button onClick={()=>{setActiveTab('presentations');}} style={{padding:'0.6rem 1.2rem',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:700,cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem',flexShrink:0,alignSelf:'flex-start'}}>Open Presentations â†’</button>
                      </div>
                      {myPresns2.length === 0 ? (
                        <div className="empty-state" style={{marginBottom:'2rem'}}><div className="empty-state-icon">ðŸŽžï¸</div><p>No presentations yet. Go to the Presentations tab to get started.</p></div>
                      ) : (
                        <div style={{display:'flex',flexDirection:'column',gap:'0.75rem',marginBottom:'2rem'}}>
                          {myPresns2.map(p=>(
                            <div key={p.id} style={{display:'flex',alignItems:'center',gap:'1rem',padding:'1rem 1.25rem',background:'rgba(26,31,58,0.7)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'12px',cursor:'pointer',transition:'border-color 0.15s'}}
                              onClick={()=>{setActivePresentationId(p.id);setActiveTab('presentations');}}
                              onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(96,165,250,0.4)'}
                              onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                              <div style={{fontSize:'1.5rem',flexShrink:0}}>ðŸŽžï¸</div>
                              <div style={{flex:1,minWidth:0}}>
                                <div style={{fontWeight:700,color:'#e0e6ed',marginBottom:'0.2rem',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</div>
                                <div style={{fontSize:'0.8rem',color:'#8b92b0'}}>{(p.slides||[]).length} slide{(p.slides||[]).length!==1?'s':''} Â· {new Date(p.created_at).toLocaleDateString()}</div>
                              </div>
                              <span style={{padding:'0.2rem 0.65rem',borderRadius:'20px',fontSize:'0.72rem',fontWeight:600,flexShrink:0,background:p.is_public?'rgba(16,185,129,0.15)':'rgba(61,69,99,0.3)',color:p.is_public?'#10b981':'#8b92b0',border:`1px solid ${p.is_public?'rgba(16,185,129,0.3)':'rgba(61,69,99,0.5)'}`}}>
                                {p.is_public?'ðŸŒ Public':'ðŸ”’ Private'}
                              </span>
                              <button onClick={ev=>{ev.stopPropagation();deletePresentationById(p.id);}} style={{padding:'0.3rem 0.7rem',background:'rgba(239,68,68,0.12)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:'7px',color:'#f87171',cursor:'pointer',fontSize:'0.8rem',fontFamily:'inherit',flexShrink:0}}>Delete</button>
                            </div>
                          ))}
                        </div>
                      )}
                      {publicGallery2.length > 0 && (
                        <>
                          <div style={{marginBottom:'0.75rem',fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600}}>Public Gallery</div>
                          <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                            {publicGallery2.map(p=>(
                              <div key={p.id} style={{display:'flex',alignItems:'center',gap:'1rem',padding:'1rem 1.25rem',background:'rgba(26,31,58,0.7)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'12px',cursor:'pointer',transition:'border-color 0.15s'}}
                                onClick={()=>{setActivePresentationId(p.id);setActiveTab('presentations');}}
                                onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(16,185,129,0.4)'}
                                onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                                <div style={{fontSize:'1.5rem',flexShrink:0}}>ðŸŽžï¸</div>
                                <div style={{flex:1,minWidth:0}}>
                                  <div style={{fontWeight:700,color:'#e0e6ed',marginBottom:'0.2rem',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</div>
                                  <div style={{fontSize:'0.8rem',color:'#8b92b0'}}>{(p.slides||[]).length} slide{(p.slides||[]).length!==1?'s':''} Â· by {p.user_id} Â· {new Date(p.created_at).toLocaleDateString()}</div>
                                </div>
                                <span style={{padding:'0.2rem 0.65rem',borderRadius:'20px',fontSize:'0.72rem',fontWeight:600,flexShrink:0,background:'rgba(16,185,129,0.15)',color:'#10b981',border:'1px solid rgba(16,185,129,0.3)'}}>ðŸŒ Public</span>
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                    </div>
                  );
                })()}
              </div>
            )}
                        {/* Research Sessions â€” moved to dedicated Sessions page */}
            {accountTab === 'sessions' && (
              <div style={{padding:'1.5rem 2rem'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1.25rem'}}>
                  <span style={{fontSize:'1.1rem',fontWeight:700,color:'#e2e8f8'}}>Research Sessions</span>
                  <span style={{fontSize:'0.72rem',color:'#8b92b0',background:'rgba(96,165,250,0.08)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'6px',padding:'2px 8px'}}>Chrome Extension &amp; Companion App</span>
                </div>
                <div style={{background:'rgba(96,165,250,0.05)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'2rem 2.5rem',textAlign:'center'}}>
                  <div style={{fontSize:'2rem',marginBottom:'0.6rem',opacity:0.7}}>&#128506;</div>
                  <div style={{fontSize:'0.95rem',fontWeight:700,color:'#e2e8f8',marginBottom:'0.5rem'}}>Research Sessions has its own page</div>
                  <div style={{fontSize:'0.82rem',color:'#8b92b0',lineHeight:1.6,maxWidth:'420px',margin:'0 auto 1.25rem'}}>
                    View, expand, and analyze your research sessions &mdash; including the full AI pipeline to save captured pages and video timestamps as complete event records.
                  </div>
                  <button onClick={()=>setActiveTab('sessions')}
                    style={{background:'linear-gradient(135deg,rgba(59,130,246,0.25),rgba(99,102,241,0.25))',border:'1px solid rgba(96,165,250,0.35)',borderRadius:'8px',color:'#60a5fa',fontSize:'0.85rem',fontWeight:700,padding:'0.5rem 1.25rem',cursor:'pointer'}}>
                    Go to Research Sessions &#8594;
                  </button>
                </div>
              </div>
            )}
                        {/* Admin / Owner Panel */}
            {accountTab === 'admin' && isAdminOrOwner && <AdminPanel />}

            {/* Owner's Manual Tab */}
            {accountTab === 'manual' && currentUser.role === 'owner' && (
              <div style={{padding:'1.5rem 2rem',maxWidth:'860px'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1.5rem'}}>
                  <span style={{fontSize:'1.1rem',fontWeight:700,color:'#e2e8f8'}}>Owner's Manual</span>
                  <span style={{fontSize:'0.72rem',color:'#8b92b0',background:'rgba(96,165,250,0.08)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'6px',padding:'2px 8px'}}>Last Updated: February 2026</span>
                </div>

                {/* â”€â”€ System Status Panel â”€â”€ */}
                <div style={{background:'rgba(15,18,35,0.7)',border:`1px solid ${ownerAlerts.length>0?'rgba(239,68,68,0.35)':'rgba(96,165,250,0.2)'}`,borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.85rem',flexWrap:'wrap'}}>
                    <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700}}>Live System Status</div>
                    {systemHealth && (
                      <span style={{fontSize:'0.7rem',color:'#8b92b0'}}>
                        Last checked: {new Date(systemHealth.checkedAt).toLocaleString()}
                      </span>
                    )}
                    <button onClick={runHealthCheck} disabled={healthChecking}
                      style={{marginLeft:'auto',fontSize:'0.72rem',fontWeight:700,color:healthChecking?'#8b92b0':'#60a5fa',background:'rgba(96,165,250,0.08)',border:'1px solid rgba(96,165,250,0.25)',borderRadius:'6px',padding:'3px 10px',cursor:healthChecking?'default':'pointer'}}>
                      {healthChecking ? 'âŸ³ Checkingâ€¦' : 'â†» Re-check Now'}
                    </button>
                  </div>

                  {/* Status rows */}
                  {(() => {
                    const dot = (status) => {
                      const c = status==='ok'?'#10b981':status==='offline'?'#f59e0b':status==='checking'?'#8b92b0':'#ef4444';
                      return <span style={{display:'inline-block',width:'8px',height:'8px',borderRadius:'50%',background:c,flexShrink:0,marginTop:'4px'}}></span>;
                    };
                    const label = (status, note) => {
                      if (!systemHealth) return <span style={{color:'#8b92b0',fontSize:'0.78rem'}}>Not checked yet</span>;
                      const map = {ok:'Operational',offline:'Sleeping (auto-wakes on upload)',checking:'Checkingâ€¦',error:'Issue detected',unknown:'Unknown',warning:'Degraded'};
                      return <span style={{color:status==='ok'?'#10b981':status==='offline'?'#f59e0b':status==='checking'?'#8b92b0':'#ef4444',fontSize:'0.78rem',fontWeight:600}}>{map[status]||status}{note?<span style={{color:'#8b92b0',fontWeight:400}}> â€” {note}</span>:null}</span>;
                    };
                    const rows = [
                      {name:'Netlify (website)',status:'ok',note:'Auto-monitored by Netlify â€” check app.netlify.com if site is down'},
                      {name:'GitHub (code)',status:'ok',note:'No action needed unless a push fails'},
                      {name:'Supabase (database)',status:systemHealth?.supabase||'checking'},
                      {name:'Render (backend server)',status:systemHealth?.backend||'checking',note:systemHealth?.backendNote},
                      {name:'Anthropic (AI)',status:systemHealth?.anthropic||'checking'},
                    ];
                    return (
                      <div style={{display:'flex',flexDirection:'column',gap:'0.45rem'}}>
                        {rows.map(r => (
                          <div key={r.name} style={{display:'flex',alignItems:'flex-start',gap:'0.6rem'}}>
                            {dot(r.status)}
                            <span style={{fontSize:'0.82rem',color:'#c0c7d8',minWidth:'200px'}}>{r.name}</span>
                            {label(r.status, r.note)}
                          </div>
                        ))}
                      </div>
                    );
                  })()}

                  {/* Alerts requiring owner action */}
                  {ownerAlerts.length > 0 && (
                    <div style={{marginTop:'1rem',borderTop:'1px solid rgba(239,68,68,0.2)',paddingTop:'1rem'}}>
                      <div style={{fontSize:'0.72rem',color:'#ef4444',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.6rem'}}>
                        âš  {ownerAlerts.length} Item{ownerAlerts.length>1?'s':''} Requiring Your Attention
                      </div>
                      {ownerAlerts.map(alert => (
                        <div key={alert.id} style={{background:'rgba(239,68,68,0.07)',border:'1px solid rgba(239,68,68,0.25)',borderRadius:'8px',padding:'0.75rem 1rem',marginBottom:'0.5rem',display:'flex',alignItems:'flex-start',gap:'0.85rem',flexWrap:'wrap'}}>
                          <div style={{flex:1,minWidth:'200px'}}>
                            <div style={{fontSize:'0.82rem',color:'#f87171',fontWeight:700,marginBottom:'0.2rem'}}>{alert.title}</div>
                            <div style={{fontSize:'0.78rem',color:'#c0c7d8',lineHeight:1.5}}>{alert.message}</div>
                          </div>
                          <a href={alert.url} target="_blank" rel="noopener noreferrer"
                            style={{flexShrink:0,fontSize:'0.75rem',fontWeight:700,color:'#f87171',background:'rgba(239,68,68,0.12)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:'6px',padding:'4px 12px',textDecoration:'none',whiteSpace:'nowrap',alignSelf:'center'}}>
                            {alert.action} â†—
                          </a>
                        </div>
                      ))}
                    </div>
                  )}

                  {ownerAlerts.length === 0 && systemHealth && (
                    <div style={{marginTop:'0.75rem',fontSize:'0.78rem',color:'#10b981',display:'flex',alignItems:'center',gap:'0.4rem'}}>
                      <span>âœ“</span> All systems normal â€” no owner action needed.
                    </div>
                  )}
                </div>

                {/* Quick System Map */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 1 â€” Quick System Map</div>
                  <div style={{fontSize:'0.82rem',color:'#8b92b0',marginBottom:'0.6rem'}}>5 external services power the database:</div>
                  {[
                    {num:'1',name:'GitHub',desc:'Stores the code. The "master copy" of the project.'},
                    {num:'2',name:'Netlify',desc:'Puts the website online. Reads from GitHub automatically.'},
                    {num:'3',name:'Supabase',desc:'The database. Stores all events, research, and user data.'},
                    {num:'4',name:'Render',desc:'The AI brain server. Runs the Python backend (analysis, video transcription, file reading).'},
                    {num:'5',name:'Anthropic',desc:'The AI company (makes Claude). Used for document & video analysis. You pay per use.'},
                  ].map(s => (
                    <div key={s.num} style={{display:'flex',gap:'0.75rem',alignItems:'flex-start',marginBottom:'0.4rem'}}>
                      <span style={{minWidth:'22px',height:'22px',borderRadius:'50%',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.3)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,marginTop:'1px'}}>{s.num}</span>
                      <span style={{fontSize:'0.82rem',color:'#c0c7d8'}}><strong style={{color:'#e2e8f8'}}>{s.name}</strong> â€” {s.desc}</span>
                    </div>
                  ))}
                </div>

                {/* Flowchart */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 2 â€” How Everything Connects</div>
                  <div style={{display:'flex',flexDirection:'column',gap:'0.5rem',alignItems:'flex-start'}}>
                    <div style={{display:'flex',gap:'0.75rem',flexWrap:'wrap',alignItems:'center'}}>
                      {['GitHub','â†’ auto-deploy on push â†’','Netlify (live site)','â†’ user saves/loads data â†’','Supabase (database)'].map((s,i) => (
                        <span key={i} style={{fontSize:'0.82rem',color:s.startsWith('â†’')?'#8b92b0':'#e2e8f8',background:s.startsWith('â†’')?'transparent':'rgba(96,165,250,0.08)',border:s.startsWith('â†’')?'none':'1px solid rgba(96,165,250,0.2)',borderRadius:'6px',padding:s.startsWith('â†’')?'0':'3px 10px'}}>{s}</span>
                      ))}
                    </div>
                    <div style={{fontSize:'0.75rem',color:'#8b92b0',margin:'0.25rem 0 0.25rem 0'}}>When a user uploads a file or URL, a separate path fires:</div>
                    <div style={{display:'flex',gap:'0.75rem',flexWrap:'wrap',alignItems:'center'}}>
                      {['Browser upload','â†’','Render (backend server)','â†’ sends text â†’','Anthropic (Claude AI)','â†’ results â†’','Supabase'].map((s,i) => (
                        <span key={i} style={{fontSize:'0.82rem',color:s==='â†’'?'#8b92b0':'#e2e8f8',background:s==='â†’'?'transparent':'rgba(96,165,250,0.08)',border:s==='â†’'?'none':'1px solid rgba(96,165,250,0.2)',borderRadius:'6px',padding:s==='â†’'?'0':'3px 10px'}}>{s}</span>
                      ))}
                    </div>
                    <div style={{fontSize:'0.75rem',color:'#8b92b0',marginTop:'0.4rem'}}>Render also runs: yt-dlp (YouTube download) Â· Whisper (transcription) Â· OpenCV (video frames) Â· pdfplumber Â· pytesseract</div>
                  </div>
                </div>

                {/* Service Details */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 3 â€” Service Details (Logins, Limits, Billing)</div>
                  {[
                    {
                      name:'GitHub', url:'github.com', emoji:'ðŸ™',
                      what:'Stores all project code with full version history. Every push here auto-updates the live site via Netlify.',
                      signup:'Email/password or Google account.',
                      limit:'Free forever for public repos. No concerns at this project scale.',
                      connected:'Netlify (watches GitHub and auto-deploys)',
                      check:'If the live site doesn\'t update after a code change.',
                    },
                    {
                      name:'Netlify', url:'app.netlify.com', emoji:'ðŸŸ©',
                      what:'Makes the HTML file available as a live website. Auto-rebuilds (~1-2 min) whenever GitHub is updated.',
                      signup:'Almost certainly "Sign in with GitHub."',
                      limit:'100 GB bandwidth/month Â· 300 build minutes/month Â· 1 free site. Very generous â€” thousands of users before hitting limits.',
                      connected:'GitHub (reads code) Â· Your browser (serves the website)',
                      check:'If site is down or showing an old version. Go to app.netlify.com â†’ Deploys tab.',
                    },
                    {
                      name:'Supabase', url:'supabase.com/dashboard', emoji:'ðŸ—„ï¸',
                      what:'The actual database â€” stores all events, people, topics, orgs, and user data.',
                      signup:'GitHub OAuth or email/password.',
                      limit:'500 MB database Â· 5 GB file storage Â· 5 GB bandwidth/month Â· 50k monthly active users. âš  Free projects PAUSE after 7 days of inactivity. Fix: Dashboard â†’ your project â†’ "Restore project" (takes ~2 min).',
                      connected:'Netlify frontend (read/write events) Â· Render backend (writes analysis results)',
                      check:'If events aren\'t loading â€” likely paused. Also check monthly database size under Database settings.',
                    },
                    {
                      name:'Render', url:'dashboard.render.com', emoji:'âš™ï¸',
                      what:'Hosts the Python backend server that handles file reading, web scraping, video transcription, and AI calls.',
                      signup:'Almost certainly "Sign in with GitHub."',
                      limit:'âš  SERVICE SLEEPS after 15 min of inactivity â€” first request after sleep takes ~30 sec (normal). 750 hrs/month free (enough for 1 service running 24/7). No persistent disk on free plan (uploaded temp files wiped on restart â€” event data is safe in Supabase).',
                      connected:'Supabase (writes results) Â· Anthropic (sends text for AI) Â· Netlify frontend (receives upload requests)',
                      check:'If AI analysis is failing repeatedly. Go to dashboard.render.com â†’ your service â†’ Logs tab for error details.',
                    },
                    {
                      name:'Anthropic (Claude AI)', url:'console.anthropic.com', emoji:'ðŸ¤–',
                      what:'Provides the AI that reads and analyzes uploaded documents, web pages, and video transcripts. Returns structured summaries, topics, people, and orgs.',
                      signup:'Email/password only â€” Anthropic does NOT offer GitHub login.',
                      limit:'âš  NO FREE TIER â€” pay per use. Approx. costs: short doc ~$0.01â€“0.05 Â· long doc/web page ~$0.05â€“0.15 Â· video with transcript ~$0.10â€“0.30. Pre-load credits and set a monthly spending cap at console.anthropic.com â†’ Settings â†’ Limits.',
                      connected:'Render (Render calls Anthropic on every analysis)',
                      check:'Monthly â€” review spending at console.anthropic.com â†’ Usage. If analysis fails with "invalid API key" â€” regenerate at console.anthropic.com â†’ API Keys.',
                    },
                  ].map(s => (
                    <div key={s.name} style={{marginBottom:'1rem',paddingBottom:'1rem',borderBottom:'1px solid rgba(96,165,250,0.1)'}}>
                      <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                        <span style={{fontSize:'1rem'}}>{s.emoji}</span>
                        <span style={{fontSize:'0.9rem',fontWeight:700,color:'#e2e8f8'}}>{s.name}</span>
                        <span style={{fontSize:'0.72rem',color:'#60a5fa',fontFamily:"'Space Mono',monospace"}}>{s.url}</span>
                      </div>
                      {[
                        {label:'What it does',val:s.what},
                        {label:'Signed up with',val:s.signup},
                        {label:'Free limits',val:s.limit},
                        {label:'Connected to',val:s.connected},
                        {label:'When to check',val:s.check},
                      ].map(row => (
                        <div key={row.label} style={{display:'grid',gridTemplateColumns:'110px 1fr',gap:'0.4rem',marginBottom:'0.2rem'}}>
                          <span style={{fontSize:'0.72rem',color:'#8b92b0',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.5px',paddingTop:'1px'}}>{row.label}</span>
                          <span style={{fontSize:'0.8rem',color:'#c0c7d8',lineHeight:1.5}}>{row.val}</span>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>

                {/* App Accounts */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 4 â€” App User Accounts</div>
                  <div style={{fontSize:'0.82rem',color:'#8b92b0',marginBottom:'0.75rem'}}>The database has its own internal login system (separate from all platforms above). Default hardcoded accounts:</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 2fr',gap:'0.5rem',marginBottom:'0.75rem'}}>
                    <div style={{fontSize:'0.7rem',color:'#8b92b0',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.5px'}}>Username</div>
                    <div style={{fontSize:'0.7rem',color:'#8b92b0',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.5px'}}>Password</div>
                    <div style={{fontSize:'0.7rem',color:'#8b92b0',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.5px'}}>Role</div>
                    {[
                      {u:'owner',p:'owner123',r:'Full access. Your main account.',c:'#60a5fa'},
                      {u:'admin',p:'admin123',r:'Can manage users and events',c:'#a78bfa'},
                      {u:'testuser',p:'test123',r:'Basic user â€” for testing only',c:'#9ca3af'},
                    ].map(a=>(
                      <React.Fragment key={a.u}>
                        <div style={{fontSize:'0.82rem',color:a.c,fontFamily:"'Space Mono',monospace"}}>{a.u}</div>
                        <div style={{fontSize:'0.82rem',color:'#c0c7d8',fontFamily:"'Space Mono',monospace"}}>{a.p}</div>
                        <div style={{fontSize:'0.82rem',color:'#8b92b0'}}>{a.r}</div>
                      </React.Fragment>
                    ))}
                  </div>
                  <div style={{background:'rgba(239,68,68,0.08)',border:'1px solid rgba(239,68,68,0.25)',borderRadius:'8px',padding:'0.6rem 0.85rem',fontSize:'0.8rem',color:'#f87171'}}>
                    âš  Change these passwords before sharing the site. Open <span style={{fontFamily:"'Space Mono',monospace",fontSize:'0.75rem'}}>historical-events-v2.2.html</span> and search for <span style={{fontFamily:"'Space Mono',monospace",fontSize:'0.75rem'}}>HARDCODED_USERS</span>.
                  </div>
                </div>

                {/* Monthly Checklist */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 5 â€” Monthly Maintenance Checklist</div>
                  {[
                    {task:'Check Anthropic usage + spending',where:'console.anthropic.com â†’ Usage Â· Make sure you have credits and haven\'t hit your limit'},
                    {task:'Check Netlify bandwidth',where:'app.netlify.com â†’ your site â†’ Analytics Â· Stays well under 100 GB unless thousands of daily users'},
                    {task:'Check Supabase database size',where:'supabase.com/dashboard â†’ your project â†’ Database Â· 500 MB free, text data is tiny'},
                    {task:'Check Render logs if AI has been failing',where:'dashboard.render.com â†’ your service â†’ Logs tab'},
                    {task:'If Supabase paused (site loads but no data)',where:'supabase.com/dashboard â†’ your project â†’ click "Restore project"'},
                  ].map((item,i) => (
                    <div key={i} style={{display:'flex',gap:'0.75rem',alignItems:'flex-start',marginBottom:'0.6rem'}}>
                      <span style={{minWidth:'18px',height:'18px',borderRadius:'3px',border:'1px solid rgba(96,165,250,0.3)',flexShrink:0,marginTop:'2px'}}></span>
                      <div>
                        <div style={{fontSize:'0.82rem',color:'#e2e8f8',fontWeight:600}}>{item.task}</div>
                        <div style={{fontSize:'0.76rem',color:'#8b92b0',marginTop:'1px'}}>{item.where}</div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Troubleshooting */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem',marginBottom:'1rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 6 â€” Quick Troubleshooting</div>
                  {[
                    {problem:'Site is down / won\'t load',cause:'Netlify outage or deploy failed',fix:'app.netlify.com â†’ look for failed deploy in red'},
                    {problem:'Events not loading / blank database',cause:'Supabase paused (inactive 7+ days)',fix:'supabase.com/dashboard â†’ restore the project'},
                    {problem:'AI analysis not working',cause:'Render asleep OR Anthropic API key/credits issue',fix:'Wait 30 sec and retry Â· then check console.anthropic.com â†’ API Keys + Usage'},
                    {problem:'First upload takes ~30 seconds',cause:'Normal â€” Render backend is waking from sleep',fix:'Nothing is broken. Retry once it\'s awake.'},
                    {problem:'Code changes not showing on live site',cause:'GitHub push may have failed or Netlify deploy errored',fix:'Check GitHub push was successful Â· then app.netlify.com â†’ Deploys'},
                  ].map((item,i) => (
                    <div key={i} style={{marginBottom:'0.75rem',paddingBottom:'0.75rem',borderBottom:'1px solid rgba(96,165,250,0.08)'}}>
                      <div style={{fontSize:'0.82rem',color:'#f87171',fontWeight:700,marginBottom:'0.2rem'}}>Problem: {item.problem}</div>
                      <div style={{display:'grid',gridTemplateColumns:'80px 1fr',gap:'0.3rem'}}>
                        <span style={{fontSize:'0.72rem',color:'#8b92b0',fontWeight:600}}>Cause</span>
                        <span style={{fontSize:'0.78rem',color:'#c0c7d8'}}>{item.cause}</span>
                        <span style={{fontSize:'0.72rem',color:'#8b92b0',fontWeight:600}}>Fix</span>
                        <span style={{fontSize:'0.78rem',color:'#c0c7d8'}}>{item.fix}</span>
                      </div>
                    </div>
                  ))}
                </div>

                {/* All URLs */}
                <div style={{background:'rgba(15,18,35,0.6)',border:'1px solid rgba(96,165,250,0.2)',borderRadius:'12px',padding:'1.25rem 1.5rem'}}>
                  <div style={{fontSize:'0.72rem',color:'#60a5fa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:700,marginBottom:'0.75rem'}}>Section 7 â€” All Important URLs</div>
                  {[
                    {label:'YOUR LIVE WEBSITE',url:'https://historical-events-databse.netlify.app',highlight:true},
                    {label:'YOUR BACKEND API',url:'https://historical-events-api-n45u.onrender.com',highlight:true},
                    {label:'GitHub dashboard',url:'https://github.com'},
                    {label:'Netlify dashboard',url:'https://app.netlify.com'},
                    {label:'Supabase dashboard',url:'https://supabase.com/dashboard'},
                    {label:'Render dashboard',url:'https://dashboard.render.com'},
                    {label:'Anthropic / Claude console',url:'https://console.anthropic.com'},
                  ].map(item => (
                    <div key={item.url} style={{display:'grid',gridTemplateColumns:'200px 1fr',gap:'0.5rem',marginBottom:'0.35rem',alignItems:'center'}}>
                      <span style={{fontSize:'0.75rem',color: item.highlight?'#e2e8f8':'#8b92b0',fontWeight:item.highlight?700:400}}>{item.label}</span>
                      <a href={item.url} target="_blank" rel="noopener noreferrer"
                        style={{fontSize:'0.78rem',color:'#60a5fa',fontFamily:"'Space Mono',monospace",textDecoration:'none',wordBreak:'break-all'}}
                        onMouseOver={e=>e.target.style.textDecoration='underline'}
                        onMouseOut={e=>e.target.style.textDecoration='none'}>
                        {item.url}
                      </a>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      // â”€â”€ Auth gate â”€â”€
      if (!currentUser) {
        if (authScreen === 'signup') return <SignupScreen onGoLogin={() => setAuthScreen('login')} />;
        return <LoginScreen onLogin={login} onGoSignup={() => setAuthScreen('signup')} />;
      }

      // â”€â”€ Admin Panel â”€â”€
      const AdminPanel = () => {
        const [users, setUsers] = React.useState([]);
        const isOwner = currentUser.role === 'owner';
        React.useEffect(() => { getAllUsers().then(u => setUsers(u)); }, []);
        const handleRoleChange = async (username, newRole) => {
          await updateUserRole(username, newRole);
          createNotification('user_role_change', 'Role Changed', `${username}'s role was changed to ${newRole}.`);
          const updated = await getAllUsers();
          setUsers(updated);
        };
        const handleDelete = async (username) => {
          await deleteUserAccount(username);
          const updated = await getAllUsers();
          setUsers(updated);
        };
        const allUsers = users;
        const publicCount = data.events.filter(e => e.isPublic).length;
        const privateCount = data.events.filter(e => !e.isPublic).length;
        return (
          <div>
            <div style={{display:'flex',gap:'1.5rem',marginBottom:'2rem',flexWrap:'wrap'}}>
              {[
                { label:'Total Users', value: allUsers.length, color:'#60a5fa' },
                { label:'Public Events', value: publicCount, color:'#10b981' },
                { label:'Private Events', value: privateCount, color:'#9ca3af' },
                { label:'Total Events', value: data.events.length, color:'#a78bfa' }
              ].map(s=>(
                <div key={s.label} className="stat" style={{background:'rgba(26,31,58,0.6)',padding:'1.25rem 1.75rem',borderRadius:'12px',border:'2px solid rgba(61,69,99,0.5)'}}>
                  <span className="stat-label">{s.label}</span>
                  <span className="stat-value" style={{color:s.color,fontSize:'1.5rem'}}>{s.value}</span>
                </div>
              ))}
            </div>
            <div className="admin-section">
              <div className="admin-section-title">ðŸ‘¥ User Management</div>
              <table className="admin-table">
                <thead><tr><th>Username</th><th>Role</th><th>Type</th><th>Joined</th><th>Actions</th></tr></thead>
                <tbody>
                  {allUsers.map(u => {
                    const isSelf = u.username === currentUser.username;
                    const canChange = !isSelf && (isOwner ? u.role !== 'owner' : u.role === 'user');
                    return (
                      <tr key={u.username}>
                        <td style={{fontWeight:600}}>{u.username}{isSelf ? <span style={{color:'#8b92b0',fontWeight:400,marginLeft:'0.5rem'}}>(you)</span> : ''}</td>
                        <td><span className={`role-badge role-${u.role}`}>{u.role}</span></td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>Registered</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{u.created_at ? new Date(u.created_at).toLocaleDateString() : 'â€”'}</td>
                        <td>
                          {canChange && (
                            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                              {u.role === 'user' && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'admin')}>â†‘ Make Admin</button>}
                              {u.role === 'admin' && isOwner && <button className="btn btn-secondary" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>handleRoleChange(u.username,'user')}>â†“ Demote</button>}
                              <button className="btn btn-danger" style={{padding:'0.3rem 0.75rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm(`Delete account "${u.username}"?`))handleDelete(u.username);}}>ðŸ—‘ Delete</button>
                            </div>
                          )}
                          {!canChange && <span style={{color:'#3d4563',fontSize:'0.8rem'}}>â€”</span>}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="admin-section">
              <div className="admin-section-title">ðŸ“‹ All Events</div>
              <table className="admin-table">
                <thead><tr><th>ID</th><th>Title</th><th>Uploaded By</th><th>Status</th><th>Visibility</th><th>Actions</th></tr></thead>
                <tbody>
                  {data.events.slice().reverse().map(e => (
                    <tr key={e.id}>
                      <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.id}</td>
                      <td style={{fontWeight:600,cursor:'pointer',color:'#60a5fa'}} onClick={()=>openEventModal(e,'admin panel')}>{(e.title||'').substring(0,50)}{e.title&&e.title.length>50?'â€¦':''}</td>
                      <td style={{color:'#8b92b0'}}>{e.uploadedBy||'system'}</td>
                      <td>
                        <select className="status-select" value={e.eventStatus||'unverified'} onChange={ev=>updateEventStatus(e.id, ev.target.value)}>
                          <option value="historical_record">Historical Record</option>
                          <option value="contested">Contested</option>
                          <option value="unverified">Unverified</option>
                        </select>
                      </td>
                      <td><span className={e.isPublic ? 'vis-public' : 'vis-private'}>{e.isPublic ? 'ðŸŒ Public' : 'ðŸ”’ Private'}</span></td>
                      <td>
                        <div style={{display:'flex',gap:'0.4rem'}}>
                          <button className="btn btn-secondary" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>toggleEventPublic(e.id)}>{e.isPublic ? 'Make Private' : 'Make Public'}</button>
                          <button className="btn btn-danger" style={{padding:'0.25rem 0.6rem',fontSize:'0.75rem'}} onClick={()=>{if(window.confirm('Delete this event?'))deleteEvent(e.id);}}>ðŸ—‘</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // â”€â”€ Account page â€” own layout (no nav bar) â”€â”€
      if (activeTab === 'account') {
        return (
          <div className="app">
            <header className="header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                  <button className="bell-btn" onClick={()=>setActiveTab('notifications')} title={notifUnreadCount>0?`${notifUnreadCount} unread notification${notifUnreadCount>1?'s':''}` : 'Notifications'}>
                    <span className={notifUnreadCount>0?'bell-icon bell-shake':'bell-icon'}>ðŸ””</span>
                    {notifUnreadCount>0 && <span className="notif-badge">{notifUnreadCount>99?'99+':notifUnreadCount}</span>}
                  </button>
                  <div className="user-chip">
                    <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                      <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                      <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                      <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                    </div>
                    <button className="logout-btn" onClick={logout}>Logout</button>
                  </div>
                </div>
              </div>
            </header>
            <div className="breadcrumb-bar">
              <span className="bc-item" onClick={()=>navigateToTab('timeline')}>ðŸ  Home</span>
              <span className="bc-sep">â€º</span>
              <span className="bc-current">ðŸ‘¤ {currentUser.username}</span>
            </div>
            <main className="content">
              <AccountPage />
            </main>
            {showModal && modalData && modalViewJSX}
            {entityProfileModalJSX}
          </div>
        );
      }

      // â”€â”€ Main layout â”€â”€
      return (
        <div className="app">
          <header className="header">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
              <h1 style={{cursor:'pointer'}} onClick={()=>navigateToTab('timeline')}>Historical Events Database</h1>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                <button className="bell-btn" onClick={()=>setActiveTab('notifications')} title={notifUnreadCount>0?`${notifUnreadCount} unread notification${notifUnreadCount>1?'s':''}` : 'Notifications'}>
                  <span className={notifUnreadCount>0?'bell-icon bell-shake':'bell-icon'}>ðŸ””</span>
                  {notifUnreadCount>0 && <span className="notif-badge">{notifUnreadCount>99?'99+':notifUnreadCount}</span>}
                </button>
                <div className="user-chip">
                  <div className="user-chip-btn" onClick={()=>navigateToTab('account')}>
                    <div className="user-chip-avatar">{currentUser.username.substring(0,2).toUpperCase()}</div>
                    <span style={{color:'#e0e6ed',fontSize:'0.875rem',fontWeight:600}}>{currentUser.username}</span>
                    <span className={`role-badge role-${currentUser.role}`}>{currentUser.role}</span>
                  </div>
                  <button className="logout-btn" onClick={logout}>Logout</button>
                </div>
              </div>
            </div>
            <div className="stats">
              <div className="stat"><span className="stat-label">Total Events</span><span className="stat-value">{data.events.length}</span></div>
              <div className="stat"><span className="stat-label">Visible</span><span className="stat-value">{filteredEvents.length}</span></div>
              <div className="stat"><span className="stat-label">People</span><span className="stat-value">{data.people.length}</span></div>
              <div className="stat"><span className="stat-label">Organizations</span><span className="stat-value">{data.organizations.length}</span></div>
              <div className="stat"><span className="stat-label">Topics</span><span className="stat-value">{data.topics.length}</span></div>
            </div>
          </header>

          {/* Breadcrumb bar */}
          <div className="breadcrumb-bar">
            <span className="bc-item" onClick={()=>navigateToTab('timeline')}>ðŸ  Home</span>
            <span className="bc-sep">â€º</span>
            <span className="bc-current">{activeTab==='account'?`ðŸ‘¤ ${currentUser.username}`:activeTab.charAt(0).toUpperCase()+activeTab.slice(1)}</span>
          </div>

          <div className="controls-bar">
            <button className="save-btn" onClick={refreshFromServer}>ðŸ”„ Refresh</button>
            <span className="save-status">{saveStatus}</span>
          </div>

          <div style={{marginBottom:'0'}}>
            <div style={{fontSize:'0.75rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem',paddingLeft:'3rem',paddingTop:'1rem',background:'rgba(21,25,50,0.4)'}}>Pages</div>
            <nav className="nav" style={{paddingTop:'0.75rem'}}>
              {TABS.map(tab=>(
                <button key={tab} className={`nav-btn ${activeTab===tab?'active':''}`} onClick={()=>navigateToTab(tab)}
                  style={tab==='notifications'&&notifUnreadCount>0&&activeTab!==tab?{background:'rgba(96,165,250,0.08)',borderColor:'rgba(96,165,250,0.35)'}:{}}>
                  {tab==='companion' ? 'ðŸ”¬ Research Companion'
                   : tab==='sessions' ? 'ðŸ—º Research Sessions'
                   : tab==='notifications' ? `ðŸ”” Notifications${notifUnreadCount>0?' ('+notifUnreadCount+')':''}`
                   : tab.charAt(0).toUpperCase()+tab.slice(1)}
                </button>
              ))}
            </nav>
          </div>

          <main className="content">
            {uploadMessage && <div className={uploadMessage.includes('âŒ')||uploadMessage.includes('âš ï¸')?'error-msg':'success-msg'} style={{position:'relative',paddingRight:'2.5rem'}}>{uploadMessage}<button onClick={()=>setUploadMessage('')} style={{position:'absolute',top:'50%',right:'0.75rem',transform:'translateY(-50%)',background:'none',border:'none',color:'inherit',fontSize:'1.2rem',cursor:'pointer',opacity:0.7,padding:'0.25rem'}}>Ã—</button></div>}

            {/* AI Analysis Suggestion Popup */}
            {showAnalysisSuggestion && analysisSuggestionCtx && activeTab === 'upload' && (
              <div style={{background:'rgba(96,165,250,0.08)',border:'1px solid rgba(96,165,250,0.35)',borderRadius:'12px',padding:'1rem 1.25rem',marginBottom:'0.75rem',display:'flex',flexDirection:'column',gap:'0.6rem'}}>
                <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:'1rem'}}>
                  <div>
                    <div style={{color:'#60a5fa',fontWeight:700,fontSize:'0.9rem',marginBottom:'0.25rem'}}>âš¡ AI Analysis Available</div>
                    <div style={{color:'#8b92b0',fontSize:'0.82rem',lineHeight:1.5}}>
                      {analysisSuggestionCtx.unformatted
                        ? `Some rows in "${analysisSuggestionCtx.fileName}" couldn't be auto-mapped to standard fields. AI can extract structured data from the raw content.`
                        : `Would you like AI to analyze the uploaded content and enrich the event data with topics, people, and a summary?`}
                    </div>
                  </div>
                  <button onClick={()=>setShowAnalysisSuggestion(false)} style={{background:'rgba(239,68,68,0.15)',border:'1px solid rgba(239,68,68,0.4)',borderRadius:'6px',color:'#f87171',cursor:'pointer',fontSize:'1rem',fontWeight:700,lineHeight:1,padding:'0.25rem 0.5rem',flexShrink:0}}>Ã—</button>
                </div>
                <div style={{display:'flex',gap:'0.5rem'}}>
                  <button className="btn btn-primary" style={{fontSize:'0.82rem',padding:'0.4rem 0.9rem'}}
                    onClick={()=>{
                      setShowAnalysisSuggestion(false);
                      const backendEvts = analysisSuggestionCtx.events.filter(e=>e._backendId);
                      if (backendEvts.length > 0) {
                        triggerBulkAnalysis(analysisSuggestionCtx.events);
                      } else if (analysisSuggestionCtx.events[0]) {
                        openEventModal(analysisSuggestionCtx.events[0], 'upload');
                      }
                    }}>
                    Analyze with AI
                  </button>
                  <button className="btn" style={{fontSize:'0.82rem',padding:'0.4rem 0.9rem',background:'rgba(30,34,60,0.5)',border:'1px solid rgba(61,69,99,0.5)'}}
                    onClick={()=>{
                      setShowAnalysisSuggestion(false);
                      if (analysisSuggestionCtx.events[0]) openEventModal(analysisSuggestionCtx.events[0], 'upload');
                    }}>
                    View Upload
                  </button>
                  <button className="btn" style={{fontSize:'0.82rem',padding:'0.4rem 0.9rem',background:'none',border:'1px solid rgba(61,69,99,0.4)',color:'#8b92b0'}}
                    onClick={()=>setShowAnalysisSuggestion(false)}>
                    Skip
                  </button>
                </div>
              </div>
            )}

            {/* Show filters on all tabs except upload, account, presentations, companion, and notifications */}
            {activeTab !== 'upload' && activeTab !== 'account' && activeTab !== 'presentations' && activeTab !== 'companion' && activeTab !== 'notifications' && <FiltersComponent {...filterProps} />}

            {/* TIMELINE */}
            {activeTab === 'timeline' && (
              <div className={`timeline-wrapper ${isTimelineFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsTimelineFullscreen(!isTimelineFullscreen)}>
                  {isTimelineFullscreen?'âœ• Exit':'â›¶ Fullscreen'}
                </button>
                <div className="timeline-container">
                  <div className="timeline-line"></div>
                  <div className="timeline-events">
                    {timelineEvents.length===0 ? (
                      <div className="empty-state"><div className="empty-state-icon">ðŸ“…</div><p>No dated events to display. Try clearing filters.</p></div>
                    ) : timelineEvents.map((e,index)=>{
                      const dateStr = String(e.date||'');
                      const year = dateStr.length>=4 ? dateStr.substring(0,4) : '?';
                      const prevYear = index>0 ? String(timelineEvents[index-1].date||'').substring(0,4) : null;
                      const showYear = index===0 || year!==prevYear;
                      return (
                        <div key={e.id} className={`timeline-event ${index%2===0?'above':'below'} ${e.isMajorEvent?'major':''}`} onClick={()=>openEventModal(e,'timeline')}>
                          {showYear && <div className="tl-year">{year}</div>}
                          <div className="tl-dot"></div>
                          <div className="tl-connector"></div>
                          <div className="tl-card">
                            <div className="tl-card-title">{e.title||''}</div>
                            <div className="tl-card-date">{year!=='?'?year:''}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* NETWORK */}
            {activeTab === 'network' && (
              <div className={`network ${isNetworkFullscreen?'fullscreen':''}`}>
                <button className="btn btn-primary fullscreen-btn" onClick={()=>setIsNetworkFullscreen(!isNetworkFullscreen)}>
                  {isNetworkFullscreen?'âœ• Exit':'â›¶ Fullscreen'}
                </button>
                <div style={{position:'absolute',top:'12px',right:'12px',zIndex:10,background:'rgba(10,13,28,0.93)',border:'1px solid rgba(96,165,250,0.25)',borderRadius:'10px',padding:'0.7rem 1rem',backdropFilter:'blur(12px)',minWidth:'148px'}}>
                  <div style={{color:'#64748b',fontSize:'0.65rem',fontWeight:700,letterSpacing:'0.1em',textTransform:'uppercase',marginBottom:'0.55rem'}}>Legend</div>
                  {[{symbol:'â—',color:'#60a5fa',label:'Event'},{symbol:'â– ',color:'#c084fc',label:'Person'},{symbol:'â—†',color:'#34d399',label:'Organization'},{symbol:'â–²',color:'#fb923c',label:'Topic'}].map(item=>(
                    <div key={item.label} style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.3rem'}}>
                      <span style={{color:item.color,fontSize:'0.85rem',lineHeight:1,flexShrink:0}}>{item.symbol}</span>
                      <span style={{color:'#cbd5e1',fontSize:'0.76rem'}}>{item.label}</span>
                    </div>
                  ))}
                </div>
                <div id="network-graph"></div>
              </div>
            )}

            {/* SPREADSHEET */}
            {activeTab === 'spreadsheet' && (
              <div className="spreadsheet">
                {selectedEvents.size > 0 && (
                  <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem',alignItems:'center'}}>
                    <span style={{color:'#a78bfa',fontSize:'0.85rem',fontWeight:600}}>{selectedEvents.size} selected</span>
                    <button onClick={()=>setShowDownloadPopup('spreadsheet')} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#fff',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>Download Selected</button>
                    <button onClick={()=>setSelectedEvents(new Set())} style={{padding:'0.4rem 0.8rem',fontSize:'0.8rem',color:'#8b92b0',background:'rgba(61,69,99,0.3)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit'}}>Clear</button>
                  </div>
                )}
                <table className="table">
                  <thead><tr>
                    <th style={{width:'40px',textAlign:'center'}}>
                      <button onClick={()=>{if(selectedEvents.size===sortedEvents.length)setSelectedEvents(new Set());else setSelectedEvents(new Set(sortedEvents.map(e=>e.id)));}} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit'}}>{selectedEvents.size===sortedEvents.length&&sortedEvents.length>0?'âœ“ All':'All'}</button>
                    </th>
                    <th>ID</th><th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th><th>Source</th><th>Link</th>
                  </tr></thead>
                  <tbody>
                    {sortedEvents.map(e=>(
                      <tr key={e.id} onClick={()=>openEventModal(e,'spreadsheet')} style={{cursor:'pointer'}}>
                        <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                          <input type="checkbox" checked={selectedEvents.has(e.id)} onChange={()=>setSelectedEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                        </td>
                        <td>{e.id}</td>
                        <td style={{fontWeight:600}}>{e.title}</td>
                        <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                        <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                        <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                        <td>{e.date||'â€”'}</td>
                        <td>{e.sourceType}</td>
                        <td>
                          {(e.mainLink||e.links&&e.links[0])&&(
                            <><a href={e.mainLink||e.links[0]} target="_blank" rel="noopener noreferrer" onClick={ev=>ev.stopPropagation()}>{(e.mainLink||e.links[0]).substring(0,28)}...</a>
                            <span className="copy-link" onClick={ev=>{ev.stopPropagation();copyToClipboard(e.mainLink||e.links[0]);}}>ðŸ“‹</span></>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {/* TOPICS */}
            {activeTab === 'topics' && (
              <div className="grid">
                {filteredTopics.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ·ï¸</div><p>No topics match the current filters.</p></div> :
                filteredTopics.map(t=>{
                  const relEvents = filteredEvents.filter(e=>(e.topics||[]).includes(t.name)).slice(0,3);
                  return (
                    <div key={t.name} className="card" onClick={()=>openEntityDetail('topic',t.name)}>
                      <div className="card-title">{t.name}</div>
                      <div className="card-count">{t.count} event{t.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* PEOPLE */}
            {activeTab === 'people' && (
              <div className="grid">
                {filteredPeople.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ‘¤</div><p>No people match the current filters.</p></div> :
                filteredPeople.map(p=>{
                  const relEvents = filteredEvents.filter(e=>(e.people||[]).includes(p.name)).slice(0,3);
                  return (
                    <div key={p.name} className="card" onClick={()=>openEntityDetail('person',p.name)}>
                      <div className="card-title">{p.name}</div>
                      <div className="card-count">{p.count} event{p.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* ORGANIZATIONS */}
            {activeTab === 'organizations' && (
              <div className="grid">
                {filteredOrganizations.length===0 ? <div className="empty-state"><div className="empty-state-icon">ðŸ›ï¸</div><p>No organizations match the current filters.</p></div> :
                filteredOrganizations.map(o=>{
                  const relEvents = filteredEvents.filter(e=>(e.organizations||[]).includes(o.name)).slice(0,3);
                  return (
                    <div key={o.name} className="card" onClick={()=>openEntityDetail('org',o.name)}>
                      <div className="card-title">{o.name}</div>
                      <div className="card-count">{o.count} event{o.count!==1?'s':''} â†’</div>
                      <div className="card-tags">{relEvents.map((e,i)=><div key={i} className="card-tag">{e.title.substring(0,22)}â€¦</div>)}</div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* PRESENTATIONS */}
            {activeTab === 'presentations' && (() => {
              const activePres = activePresentationId ? presentations.find(p => p.id === activePresentationId) : null;
              const isPresOwner = activePres && activePres.user_id === currentUser?.username;
              const editSlide = editingSlideId && activePres ? activePres.slides.find(s => s.id === editingSlideId) : null;
              const selBlock = selectedBlockId ? liveBlocks.find(b => b.id === selectedBlockId) : null;
              const btnSm = {padding:'0.3rem 0.6rem',fontSize:'0.78rem',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',cursor:'pointer',fontFamily:'inherit',background:'rgba(26,31,58,0.7)',color:'#8b92b0'};
              const hpos = {nw:{top:'-4px',left:'-4px',cursor:'nw-resize'},n:{top:'-4px',left:'calc(50% - 4px)',cursor:'n-resize'},ne:{top:'-4px',right:'-4px',cursor:'ne-resize'},e:{top:'calc(50% - 4px)',right:'-4px',cursor:'e-resize'},se:{bottom:'-4px',right:'-4px',cursor:'se-resize'},s:{bottom:'-4px',left:'calc(50% - 4px)',cursor:'s-resize'},sw:{bottom:'-4px',left:'-4px',cursor:'sw-resize'},w:{top:'calc(50% - 4px)',left:'-4px',cursor:'w-resize'}};
              const hStyle = h => ({width:'8px',height:'8px',background:'#60a5fa',border:'1px solid rgba(255,255,255,0.8)',borderRadius:'2px',position:'absolute',zIndex:10,...hpos[h]});

              // â”€â”€ EDITOR VIEW â”€â”€
              if (activePres) {
                return (
                  <div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>
                    {/* Header */}
                    <div style={{display:'flex',alignItems:'center',gap:'0.75rem',flexWrap:'wrap'}}>
                      <button onClick={()=>{setActivePresentationId(null);setEditingSlideId(null);}} style={btnSm}>â† Back</button>
                      <h2 style={{flex:1,fontSize:'1.4rem',color:'#e0e6ed',fontFamily:"'Space Mono',monospace",margin:0,minWidth:0,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activePres.name}</h2>
                      {isPresOwner && <button onClick={()=>togglePresentationPublic(activePres.id,activePres.is_public)} style={{...btnSm,background:activePres.is_public?'rgba(16,185,129,0.15)':'rgba(61,69,99,0.3)',color:activePres.is_public?'#10b981':'#8b92b0',border:`1px solid ${activePres.is_public?'rgba(16,185,129,0.3)':'rgba(61,69,99,0.5)'}`}}>{activePres.is_public?'ðŸŒ Public':'ðŸ”’ Private'}</button>}
                      {activePres.slides.length>0 && <button onClick={()=>setShowExportModal(true)} style={{padding:'0.5rem 1.1rem',background:'rgba(16,185,129,0.12)',border:'1px solid rgba(16,185,129,0.4)',borderRadius:'10px',color:'#10b981',fontWeight:700,cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem',flexShrink:0}}>â¬‡ Export</button>}
                      {activePres.slides.length>0 && <button onClick={()=>setPresentationMode({pId:activePres.id,idx:Math.max(0,activePres.slides.findIndex(s=>s.id===editingSlideId))})} style={{padding:'0.5rem 1.2rem',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:700,cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem',flexShrink:0}}>â–¶ Present</button>}
                    </div>

                    {/* Slide strip */}
                    <div style={{display:'flex',gap:'0.5rem',overflowX:'auto',paddingBottom:'0.25rem',alignItems:'flex-end'}}>
                      {activePres.slides.map((s,i)=>{
                        const isSel = presSelectedSlides.has(s.id);
                        return (
                        <div key={s.id} style={{flexShrink:0,width:'130px',position:'relative',cursor:'pointer'}}>
                          <div onClick={()=>{
                            if (presAiSelectMode && isPresOwner) {
                              const ns = new Set(presSelectedSlides);
                              if (ns.has(s.id)) ns.delete(s.id); else ns.add(s.id);
                              setPresSelectedSlides(ns);
                            } else {
                              setEditingSlideId(s.id);
                            }
                          }} style={{width:'130px',height:'73px',background:s.bg||'#0a0d1e',borderRadius:'6px',border:`2px solid ${isSel?PRES_ACCENT:editingSlideId===s.id?'#60a5fa':'rgba(61,69,99,0.4)'}`,overflow:'hidden',position:'relative',boxShadow:isSel?`0 0 8px rgba(212,175,55,0.4)`:'none',transition:'border-color 0.15s,box-shadow 0.15s'}}>
                            {s.blocks.map(b=>(
                              <div key={b.id} style={{position:'absolute',left:`${b.x}%`,top:`${b.y}%`,width:`${b.w}%`,height:`${b.h}%`,background:b.type==='shape'?(b.fill||'rgba(212,175,55,0.4)'):b.type==='image'?(b.background&&b.background!=='transparent'?b.background:'rgba(96,165,250,0.25)'):b.type==='heading'?'rgba(255,255,255,0.2)':b.type==='tags'?'rgba(124,58,237,0.2)':b.type==='sources'?'rgba(16,185,129,0.12)':'rgba(192,199,216,0.12)',borderRadius:'1px'}} />
                            ))}
                            {/* Selection checkbox overlay */}
                            {isPresOwner && presAiSelectMode && (
                              <div style={{position:'absolute',top:'4px',left:'4px',width:'16px',height:'16px',borderRadius:'4px',background:isSel?PRES_ACCENT:'rgba(15,18,35,0.7)',border:`2px solid ${isSel?PRES_ACCENT:'rgba(212,175,55,0.5)'}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.6rem',fontWeight:700,color:'#1E1E2F',zIndex:5,pointerEvents:'none'}}>
                                {isSel ? 'âœ“' : ''}
                              </div>
                            )}
                          </div>
                          <div style={{fontSize:'0.6rem',color:isSel?PRES_ACCENT:'#8b92b0',textAlign:'center',marginTop:'0.2rem',fontWeight:isSel?700:400}}>Slide {i+1}</div>
                          {isPresOwner && !presAiSelectMode && <button onClick={e=>{e.stopPropagation();removeSlide(activePres.id,s.id);}} style={{position:'absolute',top:'-5px',right:'-5px',width:'16px',height:'16px',borderRadius:'50%',background:'rgba(239,68,68,0.85)',border:'none',color:'#fff',cursor:'pointer',fontSize:'0.6rem',lineHeight:1,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>âœ•</button>}
                        </div>
                        );
                      })}
                      {isPresOwner && <button onClick={()=>addSlide(activePres.id)} style={{flexShrink:0,width:'130px',height:'73px',background:'rgba(26,31,58,0.4)',border:'1px dashed rgba(96,165,250,0.3)',borderRadius:'6px',color:'#60a5fa',cursor:'pointer',fontSize:'1.8rem',display:'flex',alignItems:'center',justifyContent:'center'}}>+</button>}
                    </div>

                    {/* Events in presentation */}
                    {(() => {
                      const refEventIds = [...new Set(activePres.slides.flatMap(s => s.blocks.map(b => b.eventId).filter(Boolean)))];
                      const refEvents = refEventIds.map(id => data.events.find(e => e.id === id)).filter(Boolean);
                      if (refEvents.length === 0) return null;
                      return (
                        <div style={{padding:'0.6rem 0.85rem',background:'rgba(26,31,58,0.5)',border:'1px solid rgba(61,69,99,0.4)',borderRadius:'10px'}}>
                          <div style={{fontSize:'0.68rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:'0.5rem'}}>Events in this Presentation ({refEvents.length})</div>
                          <div style={{display:'flex',flexWrap:'wrap',gap:'0.4rem'}}>
                            {refEvents.map(evt => (
                              <div key={evt.id} style={{display:'flex',alignItems:'center',gap:'0.35rem',padding:'0.25rem 0.55rem',background:'rgba(96,165,250,0.08)',border:'1px solid rgba(96,165,250,0.22)',borderRadius:'7px',maxWidth:'220px'}}>
                                <span style={{fontSize:'0.78rem',color:'#c0c7d8',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1,minWidth:0}}>{evt.title}</span>
                                {isPresOwner && <button onClick={()=>removeEventFromPresentation(activePres.id,evt.id)} title="Remove event from presentation" style={{flexShrink:0,width:'16px',height:'16px',borderRadius:'50%',background:'rgba(239,68,68,0.7)',border:'none',color:'#fff',cursor:'pointer',fontSize:'0.6rem',lineHeight:1,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>âœ•</button>}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })()}

                    {/* Canvas area */}
                    {editSlide ? (
                      <div>
                        {/* Block toolbar */}
                        {isPresOwner && (
                          <div style={{display:'flex',gap:'0.35rem',marginBottom:'0.5rem',flexWrap:'wrap',alignItems:'center'}}>
                            {/* Text blocks */}
                            <button onClick={()=>addBlock('heading')} style={{...btnSm,color:'#60a5fa',borderColor:'rgba(96,165,250,0.3)',background:'rgba(96,165,250,0.08)',fontSize:'0.72rem'}}>+ Heading</button>
                            <button onClick={()=>addBlock('text')} style={{...btnSm,color:'#60a5fa',borderColor:'rgba(96,165,250,0.3)',background:'rgba(96,165,250,0.08)',fontSize:'0.72rem'}}>+ Text</button>
                            <button onClick={()=>addBlock('callout')} style={{...btnSm,color:'#f59e0b',borderColor:'rgba(245,158,11,0.35)',background:'rgba(245,158,11,0.08)',fontSize:'0.72rem'}}>+ Callout</button>
                            <button onClick={()=>addBlock('image')} style={{...btnSm,color:'#60a5fa',borderColor:'rgba(96,165,250,0.3)',background:'rgba(96,165,250,0.08)',fontSize:'0.72rem'}}>+ Image</button>
                            {/* Shapes dropdown */}
                            <div style={{position:'relative',display:'inline-flex'}}>
                              <button onClick={()=>{setShowShapeMenu(v=>!v);setShowThemeMenu(false);setShowGradMenu(false);}} style={{...btnSm,color:'#a78bfa',borderColor:'rgba(167,139,250,0.3)',background:'rgba(167,139,250,0.08)',fontSize:'0.72rem'}}>+ Shape â–¾</button>
                              {showShapeMenu && (
                                <div style={{position:'absolute',top:'100%',left:0,zIndex:200,marginTop:'4px',background:'rgba(15,18,35,0.98)',border:'1px solid rgba(61,69,99,0.6)',borderRadius:'10px',padding:'0.4rem',display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.3rem',width:'160px',boxShadow:'0 8px 24px rgba(0,0,0,0.5)'}}>
                                  {[['rectangle','â–­ Rect'],['circle','â— Circle'],['triangle','â–² Triangle'],['diamond','â—† Diamond'],['line','â€” Line'],['arrow','â†’ Arrow'],['star','â˜… Star'],['hexagon','â¬¡ Hex']].map(([st,lbl])=>(
                                    <button key={st} onClick={()=>{addBlock(st);setShowShapeMenu(false);}} style={{...btnSm,fontSize:'0.7rem',color:'#c0c7d8',textAlign:'left',justifyContent:'flex-start',padding:'0.25rem 0.5rem'}}>{lbl}</button>
                                  ))}
                                </div>
                              )}
                            </div>
                            <div style={{flex:1}}/>
                            {/* Theme picker */}
                            <div style={{position:'relative',display:'inline-flex'}}>
                              <button onClick={()=>{setShowThemeMenu(v=>!v);setShowShapeMenu(false);setShowGradMenu(false);}} style={{...btnSm,color:'#a78bfa',borderColor:'rgba(167,139,250,0.3)',background:'rgba(167,139,250,0.08)',fontSize:'0.72rem'}}>ðŸŽ¨ Theme â–¾</button>
                              {showThemeMenu && (
                                <div style={{position:'absolute',top:'100%',right:0,zIndex:200,marginTop:'4px',background:'rgba(15,18,35,0.98)',border:'1px solid rgba(61,69,99,0.6)',borderRadius:'10px',padding:'0.5rem',display:'flex',flexDirection:'column',gap:'0.25rem',width:'215px',boxShadow:'0 8px 24px rgba(0,0,0,0.5)'}}>
                                  <div style={{fontSize:'0.65rem',color:'#5a6180',textTransform:'uppercase',letterSpacing:'1px',marginBottom:'0.2rem',paddingLeft:'0.2rem'}}>Apply to all slides</div>
                                  {SLIDE_THEMES.map(t=>(
                                    <button key={t.id} onClick={()=>{applyThemeToPresentation(activePres.id,t.id);setShowThemeMenu(false);}} style={{display:'flex',alignItems:'center',gap:'0.5rem',...btnSm,fontSize:'0.75rem',color:'#e0e6ed',borderColor:'rgba(61,69,99,0.4)'}}>
                                      <span style={{width:'14px',height:'14px',borderRadius:'3px',background:t.swatch,border:`1px solid ${t.accentColor||'rgba(255,255,255,0.15)'}`,flexShrink:0,display:'inline-block'}}/>
                                      <span style={{flex:1,textAlign:'left'}}>{t.label}</span>
                                      <span style={{width:'8px',height:'8px',borderRadius:'50%',background:t.accentColor,flexShrink:0,border:'1px solid rgba(255,255,255,0.2)',display:'inline-block'}}/>
                                    </button>
                                  ))}
                                  <div style={{height:'1px',background:'rgba(61,69,99,0.4)',margin:'0.15rem 0'}}/>
                                  <button onClick={()=>{clearThemeDecorations(activePres.id);setShowThemeMenu(false);}} style={{...btnSm,fontSize:'0.7rem',color:'#8b92b0',borderColor:'rgba(61,69,99,0.3)',justifyContent:'center'}}>âœ• Clear theme decorations</button>
                                </div>
                              )}
                            </div>
                            {/* Slide BG color + gradient */}
                            <span style={{fontSize:'0.68rem',color:'#8b92b0'}}>BG:</span>
                            <input type="color" value={(editSlide.bg||'#0a0d1e').startsWith('#')?(editSlide.bg||'#0a0d1e'):'#0a0d1e'} onChange={e=>{const sId=editingSlideId,pId=activePresentationId;const ns=activePres.slides.map(s=>s.id===sId?{...s,bg:e.target.value}:s);saveSlidesToPres(pId,ns);}} style={{width:'26px',height:'22px',border:'none',borderRadius:'4px',cursor:'pointer',padding:0}} />
                            <div style={{position:'relative',display:'inline-flex'}}>
                              <button onClick={()=>{setShowGradMenu(v=>!v);setShowShapeMenu(false);setShowThemeMenu(false);}} title="Gradient presets" style={{...btnSm,fontSize:'0.68rem',color:'#60a5fa',borderColor:'rgba(96,165,250,0.3)',background:'rgba(96,165,250,0.08)',padding:'0.2rem 0.5rem'}}>â–¦</button>
                              {showGradMenu && (
                                <div style={{position:'absolute',top:'100%',right:0,zIndex:200,marginTop:'4px',background:'rgba(15,18,35,0.98)',border:'1px solid rgba(61,69,99,0.6)',borderRadius:'10px',padding:'0.5rem',display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'0.35rem',boxShadow:'0 8px 24px rgba(0,0,0,0.5)'}}>
                                  {GRAD_PRESETS.map((g,i)=>(
                                    <div key={i} onClick={()=>{const sId=editingSlideId,pId=activePresentationId;const ns=activePres.slides.map(s=>s.id===sId?{...s,bg:g}:s);saveSlidesToPres(pId,ns);setShowGradMenu(false);}} style={{width:'30px',height:'22px',borderRadius:'4px',background:g,border:'1px solid rgba(255,255,255,0.1)',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.border='1px solid rgba(96,165,250,0.6)'} onMouseLeave={e=>e.currentTarget.style.border='1px solid rgba(255,255,255,0.1)'}/>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                        {/* Canvas */}
                        <div style={{position:'relative',width:'100%',paddingBottom:'56.25%',background:editSlide.bg||'#0a0d1e',borderRadius:'10px',overflow:'hidden',border:'2px solid rgba(61,69,99,0.5)',touchAction:'none'}}
                          ref={canvasRef}
                          onPointerMove={handleCanvasPointerMove}
                          onPointerUp={handleCanvasPointerUp}
                          onClick={()=>{setSelectedBlockId(null);setCanvasTextEditId(null);}}>
                          <div style={{position:'absolute',inset:0}}>
                            {liveBlocks.map(block=>{
                              const isSel = selectedBlockId===block.id;
                              const isTxt = canvasTextEditId===block.id;
                              const evt = block.eventId ? data.events.find(e=>e.id===block.eventId) : null;
                              const dispText = block.text || (evt ? (block.eventField==='summary'?(evt.aiSummary||evt.description||''):block.eventField==='title'?evt.title:block.eventField==='date'?evt.date:(evt.topics||[]).join(', ')) : '');
                              return (
                                <div key={block.id} data-block={block.id}
                                  style={{position:'absolute',left:`${block.x}%`,top:`${block.y}%`,width:`${block.w}%`,height:`${block.h}%`,outline:isSel?'2px solid #60a5fa':isTxt?'2px solid #a78bfa':'none',outlineOffset:'-1px',background:block.background==='transparent'||!block.background?'transparent':block.background,boxSizing:'border-box',userSelect:'none',cursor:isPresOwner&&!isTxt?'move':'default'}}
                                  onPointerDown={isPresOwner&&!isTxt?e=>handleBlockPointerDown(e,block.id,false,''):undefined}
                                  onClick={e=>{e.stopPropagation();if(isPresOwner&&(block.type==='text'||block.type==='heading'||block.type==='callout')&&selectedBlockId===block.id){setCanvasTextEditId(block.id);}else{setSelectedBlockId(block.id);}}}
                                  onDoubleClick={e=>{e.stopPropagation();if(isPresOwner&&block.type!=='image'&&block.type!=='tags'&&block.type!=='sources'&&block.type!=='shape'){setCanvasTextEditId(block.id);}}}
                                  onDragOver={block.type==='image'&&isPresOwner?e=>{e.preventDefault();e.stopPropagation();}:undefined}
                                  onDrop={block.type==='image'&&isPresOwner?e=>{
                                    e.preventDefault();e.stopPropagation();
                                    const files=e.dataTransfer.files;
                                    if(files?.length>0){
                                      const f=files[0];
                                      if(f.type.startsWith('image/')||/\.(png|jpe?g|gif|webp|svg|bmp|tiff?|avif|ico)$/i.test(f.name)){
                                        const reader=new FileReader();
                                        reader.onload=ev=>updateBlock(block.id,{imageUrl:ev.target.result});
                                        reader.readAsDataURL(f);
                                      }
                                      return;
                                    }
                                    const url=(e.dataTransfer.getData('text/uri-list')||e.dataTransfer.getData('text/plain')||'').trim();
                                    if(url&&/^https?:\/\//i.test(url))updateBlock(block.id,{imageUrl:url});
                                  }:undefined}>
                                  {block.type==='image' ? (
                                    block.imageUrl
                                      ? <img src={block.imageUrl} style={{width:'100%',height:'100%',objectFit:block.imageFit||'cover',display:'block',pointerEvents:'none'}} alt="" />
                                      : block.noImagePrompt ? null
                                      : <div onClick={isPresOwner?e=>{e.stopPropagation();openImageBrowser(block.id);}:undefined} style={{width:'100%',height:'100%',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'rgba(96,165,250,0.5)',fontSize:'0.75rem',border:'1px dashed rgba(96,165,250,0.3)',borderRadius:'4px',gap:'0.2rem',cursor:isPresOwner?'pointer':'default'}}>
                                          <span style={{fontSize:'1.4rem'}}>ðŸ–¼ï¸</span>
                                          {isPresOwner && <span>Click to browse or drop image here</span>}
                                        </div>
                                  ) : block.type==='tags' ? (
                                    <div style={{padding:'4% 5%',height:'100%',overflow:'hidden',display:'flex',flexDirection:'column',gap:'0.45em',fontSize:'clamp(8px,1.2vw,13px)'}}>
                                      {block.topics?.length>0 && <><div style={{color:'#a78bfa',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>Topics</div><div style={{display:'flex',flexWrap:'wrap',gap:'0.3em',marginBottom:'0.25em'}}>{block.topics.slice(0,5).map(t=><span key={t} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(124,58,237,0.2)',color:'#c4b5fd',border:'1px solid rgba(124,58,237,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{t}</span>)}</div></>}
                                      {block.people?.length>0 && <><div style={{color:'#60a5fa',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>People</div><div style={{display:'flex',flexWrap:'wrap',gap:'0.3em',marginBottom:'0.25em'}}>{block.people.slice(0,4).map(p=><span key={p} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(96,165,250,0.15)',color:'#93c5fd',border:'1px solid rgba(96,165,250,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{p}</span>)}</div></>}
                                      {block.orgs?.length>0 && <><div style={{color:'#34d399',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>Organizations</div><div style={{display:'flex',flexWrap:'wrap',gap:'0.3em'}}>{block.orgs.slice(0,4).map(o=><span key={o} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(16,185,129,0.15)',color:'#6ee7b7',border:'1px solid rgba(16,185,129,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{o}</span>)}</div></>}
                                    </div>
                                  ) : block.type==='sources' ? (
                                    <div style={{padding:'2% 3%',height:'100%',overflow:'hidden',display:'flex',gap:'3%',alignItems:'center',flexWrap:'wrap',borderTop:'1px solid rgba(96,165,250,0.15)',fontSize:'clamp(7px,0.95vw,11px)'}}>
                                      {(block.items||[]).map((item,i)=>item.eventId?(
                                        <button key={i} onClick={e=>{e.stopPropagation();const ev=data.events.find(e2=>e2.id===item.eventId);if(ev)openEventModal(ev,'presentations');}} style={{padding:'0.1em 0.5em',borderRadius:'3px',background:'rgba(96,165,250,0.12)',color:'#60a5fa',border:'1px solid rgba(96,165,250,0.25)',cursor:'pointer',fontFamily:'inherit',fontSize:'inherit',lineHeight:1.4,fontWeight:600}}>â†’ {item.label}</button>
                                      ):(
                                        <span key={i} style={{padding:'1px 4px',borderRadius:'3px',background:'rgba(16,185,129,0.1)',color:'#10b981',border:'1px solid rgba(16,185,129,0.25)'}}>ðŸ”— {item.label}</span>
                                      ))}
                                    </div>
                                  ) : block.type==='shape' ? (
                                    <div style={{width:'100%',height:'100%',opacity:block.opacity!=null?block.opacity/100:1,pointerEvents:'none'}}>{renderShapeSVG(block)}</div>
                                  ) : block.type==='callout' ? (
                                    isTxt ? (
                                      <div style={{width:'100%',height:'100%',display:'flex',gap:'4%',alignItems:'stretch'}}>
                                        <div style={{width:'3px',flexShrink:0,borderRadius:'2px',background:block.accentColor||'#f59e0b'}}/>
                                        <textarea value={block.text||''} onChange={e=>{e.stopPropagation();updateBlock(block.id,{text:e.target.value});}} onBlur={()=>setCanvasTextEditId(null)} onPointerDown={e=>e.stopPropagation()} autoFocus style={{flex:1,background:'transparent',border:'none',color:block.color||'#f0f4ff',fontSize:`${block.fontSize||15}px`,fontWeight:block.fontWeight||'normal',fontStyle:block.fontStyle||'italic',textAlign:block.textAlign||'left',resize:'none',outline:'none',fontFamily:'inherit',padding:'2px 4px',lineHeight:1.4,boxSizing:'border-box'}}/>
                                      </div>
                                    ) : (
                                      <div style={{width:'100%',height:'100%',display:'flex',gap:'4%',alignItems:'stretch',pointerEvents:'none'}}>
                                        <div style={{width:'3px',flexShrink:0,borderRadius:'2px',background:block.accentColor||'#f59e0b'}}/>
                                        <div style={{flex:1,color:block.color||'#f0f4ff',fontSize:`${block.fontSize||15}px`,fontWeight:block.fontWeight||'normal',fontStyle:block.fontStyle||'italic',textAlign:block.textAlign||'left',overflow:'hidden',lineHeight:1.4,padding:'2px 4px',boxSizing:'border-box',whiteSpace:'pre-wrap',wordBreak:'break-word'}}>
                                          {block.text||(isPresOwner?<span style={{opacity:0.3,fontStyle:'italic'}}>click to edit calloutâ€¦</span>:'')}
                                        </div>
                                      </div>
                                    )
                                  ) : isTxt ? (
                                    <textarea value={block.text||''} onChange={e=>{e.stopPropagation();updateBlock(block.id,{text:e.target.value});}} onBlur={()=>setCanvasTextEditId(null)} onPointerDown={e=>e.stopPropagation()} autoFocus style={{width:'100%',height:'100%',background:'transparent',border:'none',color:block.color||'#e0e6ed',fontSize:`${block.fontSize||16}px`,fontWeight:block.fontWeight||'normal',fontStyle:block.fontStyle||'normal',textAlign:block.textAlign||'left',resize:'none',outline:'none',fontFamily:'inherit',padding:'2px',lineHeight:1.4,boxSizing:'border-box'}} />
                                  ) : (
                                    <div style={{width:'100%',height:'100%',color:block.color||'#e0e6ed',fontSize:`${block.fontSize||16}px`,fontWeight:block.fontWeight||'normal',fontStyle:block.fontStyle||'normal',textAlign:block.textAlign||'left',overflow:'hidden',lineHeight:1.4,padding:'2px',boxSizing:'border-box',whiteSpace:'pre-wrap',wordBreak:'break-word',pointerEvents:'none'}}>
                                      {dispText || (isPresOwner ? <span style={{opacity:0.25,fontStyle:'italic'}}>click to select Â· click again to edit</span> : '')}
                                    </div>
                                  )}
                                  {isSel && isPresOwner && ['nw','n','ne','e','se','s','sw','w'].map(h=>(
                                    <div key={h} style={hStyle(h)} onPointerDown={e=>{e.stopPropagation();handleBlockPointerDown(e,block.id,true,h);}} />
                                  ))}
                                </div>
                              );
                            })}
                            {liveBlocks.length===0 && isPresOwner && <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',color:'rgba(255,255,255,0.15)',fontSize:'0.85rem',pointerEvents:'none'}}>Add blocks using the toolbar above</div>}
                          </div>
                        </div>
                        {/* Properties panel */}
                        {selBlock && isPresOwner && (
                          <div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap',padding:'0.5rem 0.75rem',background:'rgba(21,25,50,0.85)',borderRadius:'8px',alignItems:'center',marginTop:'0.4rem',border:'1px solid rgba(61,69,99,0.4)'}}>
                            {/* Text / Heading / Callout properties */}
                            {(selBlock.type==='text'||selBlock.type==='heading'||selBlock.type==='callout') && (<>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Size</label>
                              <input type="number" value={selBlock.fontSize||16} min={6} max={120} onChange={e=>updateBlock(selectedBlockId,{fontSize:Number(e.target.value)})} style={{width:'46px',padding:'0.18rem 0.3rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'5px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.78rem'}} />
                              <button onClick={()=>updateBlock(selectedBlockId,{fontWeight:selBlock.fontWeight==='bold'?'normal':'bold'})} style={{...btnSm,fontWeight:'bold',color:selBlock.fontWeight==='bold'?'#60a5fa':'#8b92b0',background:selBlock.fontWeight==='bold'?'rgba(96,165,250,0.15)':'rgba(26,31,58,0.5)',minWidth:'26px'}}>B</button>
                              <button onClick={()=>updateBlock(selectedBlockId,{fontStyle:selBlock.fontStyle==='italic'?'normal':'italic'})} style={{...btnSm,fontStyle:'italic',color:selBlock.fontStyle==='italic'?'#60a5fa':'#8b92b0',background:selBlock.fontStyle==='italic'?'rgba(96,165,250,0.15)':'rgba(26,31,58,0.5)',minWidth:'26px'}}>I</button>
                              {['left','center','right'].map((a,ai)=>(
                                <button key={a} title={a} onClick={()=>updateBlock(selectedBlockId,{textAlign:a})} style={{...btnSm,color:selBlock.textAlign===a?'#60a5fa':'#8b92b0',background:selBlock.textAlign===a?'rgba(96,165,250,0.15)':'rgba(26,31,58,0.5)',minWidth:'24px',textAlign:'center',fontSize:'0.7rem'}}>{ai===0?'â‰¡':ai===1?'â˜°':'â‰¡'}</button>
                              ))}
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Color</label>
                              <input type="color" value={selBlock.color||'#ffffff'} onChange={e=>updateBlock(selectedBlockId,{color:e.target.value})} style={{width:'24px',height:'20px',border:'none',borderRadius:'3px',cursor:'pointer',padding:0}} />
                              {selBlock.type==='callout' && <>
                                <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Accent</label>
                                <input type="color" value={selBlock.accentColor||'#f59e0b'} onChange={e=>updateBlock(selectedBlockId,{accentColor:e.target.value})} style={{width:'24px',height:'20px',border:'none',borderRadius:'3px',cursor:'pointer',padding:0}} />
                              </>}
                            </>)}
                            {/* Shape properties */}
                            {selBlock.type==='shape' && (<>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Shape</label>
                              <select value={selBlock.shapeType||'rectangle'} onChange={e=>updateBlock(selectedBlockId,{shapeType:e.target.value})} style={{padding:'0.18rem 0.3rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'5px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.72rem',cursor:'pointer'}}>
                                {['rectangle','circle','triangle','diamond','line','arrow','star','hexagon'].map(s=><option key={s} value={s}>{s.charAt(0).toUpperCase()+s.slice(1)}</option>)}
                              </select>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Fill</label>
                              <input type="color" value={selBlock.fill||'#3b82f6'} onChange={e=>updateBlock(selectedBlockId,{fill:e.target.value})} style={{width:'24px',height:'20px',border:'none',borderRadius:'3px',cursor:'pointer',padding:0}} />
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Border</label>
                              <input type="color" value={selBlock.stroke&&selBlock.stroke!=='transparent'?selBlock.stroke:'#000000'} onChange={e=>updateBlock(selectedBlockId,{stroke:e.target.value})} style={{width:'24px',height:'20px',border:'none',borderRadius:'3px',cursor:'pointer',padding:0}} />
                              <button onClick={()=>updateBlock(selectedBlockId,{stroke:'transparent'})} style={{...btnSm,fontSize:'0.68rem'}}>No Border</button>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>W</label>
                              <input type="number" value={selBlock.strokeWidth||0} min={0} max={20} onChange={e=>updateBlock(selectedBlockId,{strokeWidth:Number(e.target.value)})} style={{width:'38px',padding:'0.18rem 0.3rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'5px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.78rem'}} />
                              {(selBlock.shapeType==='rectangle'||!selBlock.shapeType) && <>
                                <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Round</label>
                                <input type="number" value={selBlock.radius||0} min={0} max={50} onChange={e=>updateBlock(selectedBlockId,{radius:Number(e.target.value)})} style={{width:'38px',padding:'0.18rem 0.3rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'5px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.78rem'}} />
                              </>}
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Opacity</label>
                              <input type="range" min={10} max={100} value={selBlock.opacity!=null?selBlock.opacity:100} onChange={e=>updateBlock(selectedBlockId,{opacity:Number(e.target.value)})} style={{width:'55px',cursor:'pointer',accentColor:'#a78bfa'}} />
                            </>)}
                            {/* Image properties */}
                            {selBlock.type==='image' && <>
                              <button onClick={()=>openImageBrowser(selectedBlockId)} style={{...btnSm,color:'#60a5fa',borderColor:'rgba(96,165,250,0.3)',background:'rgba(96,165,250,0.08)',fontSize:'0.72rem'}}>ðŸ–¼ï¸ Change Image</button>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>Fit</label>
                              {['cover','contain','fill'].map(f=>(
                                <button key={f} onClick={()=>updateBlock(selectedBlockId,{imageFit:f})} style={{...btnSm,fontSize:'0.68rem',color:(selBlock.imageFit||'cover')===f?'#60a5fa':'#8b92b0',background:(selBlock.imageFit||'cover')===f?'rgba(96,165,250,0.15)':'rgba(26,31,58,0.5)'}}>{f}</button>
                              ))}
                              {selBlock.imageUrl && <button onClick={()=>updateBlock(selectedBlockId,{imageUrl:''})} style={{...btnSm,fontSize:'0.68rem',color:'#f87171',borderColor:'rgba(239,68,68,0.3)',background:'rgba(239,68,68,0.06)'}}>Clear</button>}
                            </>}
                            {/* Block BG (all non-shape, non-image) */}
                            {selBlock.type!=='image' && selBlock.type!=='tags' && selBlock.type!=='sources' && selBlock.type!=='shape' && (<>
                              <label style={{fontSize:'0.68rem',color:'#8b92b0'}}>BG</label>
                              <input type="color" value={selBlock.background&&selBlock.background!=='transparent'?selBlock.background:'#000000'} onChange={e=>updateBlock(selectedBlockId,{background:e.target.value})} style={{width:'24px',height:'20px',border:'none',borderRadius:'3px',cursor:'pointer',padding:0}} />
                              <button onClick={()=>updateBlock(selectedBlockId,{background:'transparent'})} style={{...btnSm,fontSize:'0.68rem'}}>Clear BG</button>
                            </>)}
                            {/* Z-order + duplicate */}
                            <div style={{display:'flex',gap:'0.25rem',marginLeft:'auto',alignItems:'center'}}>
                              <button title="Send to back" onClick={()=>moveBlockZ('back')} style={{...btnSm,fontSize:'0.7rem',minWidth:'22px',padding:'0.18rem 0.35rem'}}>â¬‡â¬‡</button>
                              <button title="Move back" onClick={()=>moveBlockZ('bwd')} style={{...btnSm,fontSize:'0.7rem',minWidth:'22px',padding:'0.18rem 0.35rem'}}>â†“</button>
                              <button title="Move forward" onClick={()=>moveBlockZ('fwd')} style={{...btnSm,fontSize:'0.7rem',minWidth:'22px',padding:'0.18rem 0.35rem'}}>â†‘</button>
                              <button title="Bring to front" onClick={()=>moveBlockZ('front')} style={{...btnSm,fontSize:'0.7rem',minWidth:'22px',padding:'0.18rem 0.35rem'}}>â¬†â¬†</button>
                              <button title="Duplicate block" onClick={duplicateBlock} style={{...btnSm,fontSize:'0.72rem',color:'#a78bfa',borderColor:'rgba(167,139,250,0.3)',background:'rgba(167,139,250,0.08)'}}>âŽ˜ Dup</button>
                              <button onClick={()=>removeBlock(selectedBlockId)} style={{...btnSm,color:'#f87171',borderColor:'rgba(239,68,68,0.3)',background:'rgba(239,68,68,0.08)',fontSize:'0.72rem'}}>ðŸ—‘</button>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="empty-state"><div className="empty-state-icon">ðŸŽžï¸</div><p>{activePres.slides.length===0?'Click + to add your first slide.':'Click a slide above to start editing.'}</p></div>
                    )}

                    {/* AI Generation row */}
                    {isPresOwner && (
                      <div style={{display:'flex',gap:'0.55rem',flexWrap:'wrap',alignItems:'center',padding:'0.65rem 0.9rem',background:'rgba(167,139,250,0.07)',border:'1px solid rgba(167,139,250,0.25)',borderRadius:'10px'}}>
                        <span style={{fontWeight:700,color:'#a78bfa',fontSize:'0.8rem',flexShrink:0}}>âš¡ AI Generate</span>
                        {presAiFocuses.map((f,i)=>(
                          <input key={i} value={f} onChange={e=>{const a=[...presAiFocuses];a[i]=e.target.value;setPresAiFocuses(a);}} placeholder={`Focus ${i+1}â€¦`} style={{padding:'0.3rem 0.55rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.8rem',width:'140px',outline:'none'}} />
                        ))}
                        <button onClick={()=>setPresAiFocuses([...presAiFocuses,''])} style={{...btnSm,color:'#a78bfa',borderColor:'rgba(167,139,250,0.3)',background:'rgba(167,139,250,0.08)'}}>+ Focus</button>
                        <select value={presAiDetail} onChange={e=>setPresAiDetail(e.target.value)} style={{padding:'0.3rem 0.5rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.8rem',cursor:'pointer'}}>
                          <option value="brief">Brief</option>
                          <option value="standard">Standard</option>
                          <option value="comprehensive">Comprehensive</option>
                        </select>
                        {/* Select mode toggle */}
                        <button
                          onClick={()=>{ setPresAiSelectMode(!presAiSelectMode); setPresSelectedSlides(new Set()); }}
                          title={presAiSelectMode ? 'Exit selection mode' : 'Select specific slides to regenerate'}
                          style={{...btnSm, color:presAiSelectMode?PRES_ACCENT:'#8b92b0', borderColor:presAiSelectMode?`rgba(212,175,55,0.5)`:'rgba(61,69,99,0.5)', background:presAiSelectMode?'rgba(212,175,55,0.1)':'rgba(26,31,58,0.5)', fontWeight:presAiSelectMode?700:400}}>
                          {presAiSelectMode ? `â˜‘ ${presSelectedSlides.size} selected` : 'â˜ Select'}
                        </button>
                        {presAiSelectMode && presSelectedSlides.size > 0 && (
                          <button onClick={()=>setPresSelectedSlides(new Set())} style={{...btnSm,fontSize:'0.68rem',color:'#8b92b0',borderColor:'rgba(61,69,99,0.4)',background:'none'}}>Clear</button>
                        )}
                        {presAiSelectMode && (
                          <button onClick={()=>setPresSelectedSlides(new Set(activePres.slides.map(s=>s.id)))} style={{...btnSm,fontSize:'0.68rem',color:'#8b92b0',borderColor:'rgba(61,69,99,0.4)',background:'none'}}>All</button>
                        )}
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help'}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',right:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'270px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.78rem',lineHeight:1.6,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <b style={{color:'#a78bfa'}}>AI Presentation Generator</b><br/>
                            Generates new slides from event data. Add focus areas to guide the AI â€” e.g. "CIA involvement" or "timeline of events".<br/><br/>
                            <b style={{color:PRES_ACCENT}}>â˜ Select mode:</b> Click slides in the strip above to mark them for targeted regeneration. Only selected slides are replaced â€” the rest stay untouched.
                          </div>
                        </div>
                        <button
                          onClick={()=> presAiSelectMode && presSelectedSlides.size > 0
                            ? generateAiPresentation(activePres.id, presSelectedSlides)
                            : generateAiPresentation(activePres.id)}
                          disabled={presAiLoading || (presAiSelectMode && presSelectedSlides.size === 0)}
                          style={{padding:'0.35rem 0.9rem',background:presAiLoading||(presAiSelectMode&&presSelectedSlides.size===0)?'rgba(61,69,99,0.4)':presAiSelectMode?`linear-gradient(135deg,${PRES_ACCENT},#b8860b)`:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'8px',color:presAiLoading||(presAiSelectMode&&presSelectedSlides.size===0)?'#8b92b0':'#fff',fontWeight:700,cursor:presAiLoading||(presAiSelectMode&&presSelectedSlides.size===0)?'not-allowed':'pointer',fontFamily:'inherit',fontSize:'0.8rem',flexShrink:0}}>
                          {presAiLoading ? 'Generatingâ€¦' : presAiSelectMode ? (presSelectedSlides.size > 0 ? `Regen ${presSelectedSlides.size} Slide${presSelectedSlides.size>1?'s':''}` : 'Select slides above') : 'Generate All'}
                        </button>
                      </div>
                    )}
                  </div>
                );
              }

              // â”€â”€ LIST VIEW â”€â”€
              const myPresns = presentations.filter(p => p.user_id === currentUser?.username);
              const publicGallery = presentations.filter(p => p.is_public && p.user_id !== currentUser?.username);
              return (
                <div>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1.25rem',gap:'1rem',flexWrap:'wrap'}}>
                    <div>
                      <h2 style={{fontSize:'1.6rem',color:'#e0e6ed',fontFamily:"'Space Mono',monospace",marginBottom:'0.25rem',marginTop:0}}>Presentations</h2>
                      <p style={{color:'#8b92b0',fontSize:'0.85rem',margin:0}}>Build slide-based presentations from your research</p>
                    </div>
                    <button onClick={()=>setShowNewPresentationModal(true)} style={{padding:'0.6rem 1.2rem',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:700,cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem',flexShrink:0}}>+ New Presentation</button>
                  </div>
                  {presentationsLoading && <div style={{color:'#8b92b0',marginBottom:'1rem',fontSize:'0.85rem'}}>Loadingâ€¦</div>}
                  {!presentationsLoading && myPresns.length===0 && (
                    <div className="empty-state" style={{marginBottom:'1.5rem'}}><div className="empty-state-icon">ðŸŽžï¸</div><p>No presentations yet. Create one above.</p></div>
                  )}
                  {myPresns.length>0 && (
                    <div style={{display:'flex',flexDirection:'column',gap:'0.55rem',marginBottom:'1.25rem'}}>
                      {myPresns.map(p=>(
                        <div key={p.id} style={{display:'flex',alignItems:'center',gap:'1rem',padding:'0.8rem 1.1rem',background:'rgba(26,31,58,0.7)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'12px',cursor:'pointer',transition:'border-color 0.15s'}}
                          onClick={()=>{setActivePresentationId(p.id);setEditingSlideId(p.slides[0]?.id||null);}}
                          onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(96,165,250,0.4)'}
                          onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                          <div style={{fontSize:'1.3rem',flexShrink:0}}>ðŸŽžï¸</div>
                          <div style={{flex:1,minWidth:0}}>
                            <div style={{fontWeight:700,color:'#e0e6ed',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</div>
                            <div style={{fontSize:'0.78rem',color:'#8b92b0'}}>{p.slides.length} slide{p.slides.length!==1?'s':''} Â· {new Date(p.updated_at||p.created_at).toLocaleDateString()}</div>
                          </div>
                          <span style={{padding:'0.2rem 0.6rem',borderRadius:'20px',fontSize:'0.7rem',fontWeight:600,flexShrink:0,background:p.is_public?'rgba(16,185,129,0.15)':'rgba(61,69,99,0.3)',color:p.is_public?'#10b981':'#8b92b0',border:`1px solid ${p.is_public?'rgba(16,185,129,0.3)':'rgba(61,69,99,0.5)'}`}}>{p.is_public?'ðŸŒ Public':'ðŸ”’ Private'}</span>
                          <button onClick={ev=>{ev.stopPropagation();deletePresentationById(p.id);}} style={{padding:'0.25rem 0.55rem',background:'rgba(239,68,68,0.12)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:'6px',color:'#f87171',cursor:'pointer',fontSize:'0.78rem',fontFamily:'inherit',flexShrink:0}}>Delete</button>
                        </div>
                      ))}
                    </div>
                  )}
                  {publicGallery.length>0 && (
                    <div style={{marginBottom:'1.25rem'}}>
                      <div style={{marginBottom:'0.6rem',fontSize:'0.72rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600}}>Public Gallery</div>
                      <div style={{display:'flex',flexDirection:'column',gap:'0.55rem'}}>
                        {publicGallery.map(p=>(
                          <div key={p.id} style={{display:'flex',alignItems:'center',gap:'1rem',padding:'0.8rem 1.1rem',background:'rgba(26,31,58,0.7)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'12px',cursor:'pointer',transition:'border-color 0.15s'}}
                            onClick={()=>{setActivePresentationId(p.id);setEditingSlideId(p.slides[0]?.id||null);}}
                            onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(16,185,129,0.4)'}
                            onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                            <div style={{fontSize:'1.3rem',flexShrink:0}}>ðŸŽžï¸</div>
                            <div style={{flex:1,minWidth:0}}>
                              <div style={{fontWeight:700,color:'#e0e6ed',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</div>
                              <div style={{fontSize:'0.78rem',color:'#8b92b0'}}>{p.slides.length} slide{p.slides.length!==1?'s':''} Â· by {p.user_id} Â· {new Date(p.updated_at||p.created_at).toLocaleDateString()}</div>
                            </div>
                            <span style={{padding:'0.2rem 0.6rem',borderRadius:'20px',fontSize:'0.7rem',fontWeight:600,flexShrink:0,background:'rgba(16,185,129,0.15)',color:'#10b981',border:'1px solid rgba(16,185,129,0.3)'}}>ðŸŒ Public</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {/* Filters â€” rendered here for presentations list so they sit directly above the events table */}
                  <FiltersComponent {...filterProps} />

                  {/* Embedded spreadsheet for adding events to a presentation */}
                  <div style={{paddingTop:'1rem',borderTop:'1px solid rgba(61,69,99,0.35)'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.65rem',flexWrap:'wrap'}}>
                      <div style={{fontSize:'0.72rem',color:'#8b92b0',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600}}>Add Events to a Presentation</div>
                      {presSelectedEvents.size>0 && (
                        <div style={{display:'flex',gap:'0.5rem',alignItems:'center',flexWrap:'wrap'}}>
                          <span style={{color:'#a78bfa',fontSize:'0.82rem',fontWeight:600}}>{presSelectedEvents.size} selected</span>
                          {myPresns.length>0 ? (<>
                            <select id="presTargetSelect" style={{padding:'0.3rem 0.5rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.82rem',cursor:'pointer'}}>
                              {myPresns.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <button onClick={()=>{const sel=document.getElementById('presTargetSelect');if(sel?.value){const evts=sortedEvents.filter(e=>presSelectedEvents.has(e.id));addEventsAsSlides(sel.value,evts);}}} style={{padding:'0.32rem 0.8rem',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'7px',color:'#fff',fontWeight:700,cursor:'pointer',fontFamily:'inherit',fontSize:'0.82rem'}}>Add to Presentation</button>
                          </>) : <span style={{color:'#f87171',fontSize:'0.82rem'}}>Create a presentation first.</span>}
                          <button onClick={()=>setPresSelectedEvents(new Set())} style={{...btnSm,fontSize:'0.78rem'}}>Clear</button>
                        </div>
                      )}
                    </div>
                    <div style={{overflowX:'auto'}}>
                      <table className="table">
                        <thead><tr>
                          <th style={{width:'34px',textAlign:'center'}}>
                            <button onClick={()=>{if(presSelectedEvents.size===sortedEvents.length)setPresSelectedEvents(new Set());else setPresSelectedEvents(new Set(sortedEvents.map(e=>e.id)));}} style={{padding:'0.15rem 0.35rem',fontSize:'0.68rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit'}}>{presSelectedEvents.size===sortedEvents.length&&sortedEvents.length>0?'âœ“':'All'}</button>
                          </th>
                          <th>Title</th><th>AI Summary</th><th>Topics</th><th>Level</th><th>Date</th>
                        </tr></thead>
                        <tbody>
                          {sortedEvents.map(e=>(
                            <tr key={e.id} onClick={()=>setPresSelectedEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{cursor:'pointer',background:presSelectedEvents.has(e.id)?'rgba(124,58,237,0.12)':'transparent'}}>
                              <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                                <input type="checkbox" checked={presSelectedEvents.has(e.id)} onChange={()=>setPresSelectedEvents(prev=>{const n=new Set(prev);n.has(e.id)?n.delete(e.id):n.add(e.id);return n;})} style={{width:'14px',height:'14px',cursor:'pointer',accentColor:'#7c3aed'}} />
                              </td>
                              <td style={{fontWeight:600}}>{e.title}</td>
                              <td style={{color:'#8b92b0',fontSize:'0.78rem'}}>{e.aiSummary?(e.aiSummary.substring(0,70)+'â€¦'):'â€”'}</td>
                              <td style={{fontSize:'0.78rem'}}>{(e.topics||[]).slice(0,2).join(', ')}</td>
                              <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                              <td style={{fontSize:'0.78rem'}}>{e.date||'â€”'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* UPLOAD */}
            {activeTab === 'upload' && (
              <div>
                <div className="upload-tabs">
                  <div className={`upload-tab ${uploadTab==='new'?'active':''}`} onClick={()=>setUploadTab('new')}>ðŸ“¤ New Upload</div>
                  <div className={`upload-tab ${uploadTab==='myuploads'?'active':''}`} onClick={()=>setUploadTab('myuploads')}>ðŸ“‚ My Uploads ({myUploads.length})</div>
                </div>

                {uploadTab === 'new' ? (
                  <>
                    <div className="url-input-section">
                      <div className="url-input-header">ðŸ”— Add Website or Video Link</div>
                      <p style={{color:'#8b92b0',marginBottom:'1.5rem'}}>Paste any URL â€” YouTube videos are auto-detected for transcription</p>
                      <div style={{display:'flex',gap:'1rem',alignItems:'flex-end'}}>
                        <div className="url-input-group" style={{flex:1}}>
                          <label className="filter-label">URL</label>
                          <input type="url" placeholder="https://..." value={urlInput} onChange={e=>setUrlInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleUrlSubmit();}} />
                        </div>
                        <button className="btn btn-primary" style={{flexShrink:0}} onClick={handleUrlSubmit}>Add URL</button>
                      </div>
                      <div style={{display:'flex',gap:'0.75rem',alignItems:'center',marginTop:'0.75rem',flexWrap:'wrap'}}>
                        <div style={{display:'flex',flexDirection:'column',gap:'0.3rem'}}>
                          <label className="filter-label" style={{fontSize:'0.75rem'}}>Start time</label>
                          <input type="text" placeholder="0:00 or 1:30:00" value={timestampStart} onChange={e=>setTimestampStart(e.target.value)}
                            style={{padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.9rem',width:'120px'}} />
                        </div>
                        <div style={{display:'flex',flexDirection:'column',gap:'0.3rem'}}>
                          <label className="filter-label" style={{fontSize:'0.75rem'}}>End time</label>
                          <input type="text" placeholder="5:30 or 2:10:00" value={timestampEnd} onChange={e=>setTimestampEnd(e.target.value)}
                            style={{padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.9rem',width:'120px'}} />
                        </div>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginTop:'1.2rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help',flexShrink:0}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'260px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.78rem',lineHeight:1.6,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <b style={{color:'#60a5fa'}}>Timestamp range (optional)</b><br/>
                            Leave both blank to analyze the full video or audio.<br/><br/>
                            Accepts <b>MM:SS</b> (e.g. <code style={{color:'#a78bfa'}}>4:30</code>) or <b>HH:MM:SS</b> (e.g. <code style={{color:'#a78bfa'}}>1:04:30</code>).<br/><br/>
                            Only the transcript and frames within the specified range will be sent to AI for analysis.
                          </div>
                        </div>
                      </div>
                    </div>
                    <input ref={fileInputRef} type="file" style={{display:'none'}} multiple accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" onChange={handleFileUpload} />
                    <div className="upload" onClick={()=>fileInputRef.current.click()}>
                      <div className="upload-icon">ðŸš€</div>
                      <h2 style={{fontSize:'1.75rem',marginBottom:'1rem'}}>Upload Documents</h2>
                      <p style={{fontSize:'1.125rem',marginBottom:'0.5rem',color:'#a78bfa'}}>AI-powered analysis & auto-tagging</p>
                      <p style={{fontSize:'0.875rem',color:'#8b92b0'}}>Excel Â· CSV Â· TXT Â· PDF Â· Word (.docx)</p>
                    </div>
                    {/* â”€â”€ AI Analysis Controls â”€â”€ */}
                    <div style={{display:'flex',gap:'0.75rem',margin:'1rem 0',flexWrap:'wrap',alignItems:'center'}}>
                      <button onClick={()=>setAutoAnalysis(!autoAnalysis)} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:autoAnalysis?'linear-gradient(135deg,#10b981,#059669)':'rgba(61,69,99,0.5)',border:autoAnalysis?'2px solid #10b981':'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit',transition:'all 0.2s'}}>
                        {autoAnalysis ? 'âœ“ Auto AI Analysis: ON' : 'âš¡ Auto AI Analysis: OFF'}
                      </button>
                      <div style={{position:'relative',display:'inline-flex',alignItems:'flex-start',gap:'0.25rem'}}>
                        <textarea
                          placeholder="ðŸ” Analysis focus (optional)"
                          value={analysisSearch}
                          onChange={e=>setAnalysisSearch(e.target.value)}
                          rows={1}
                          style={{padding:'0.72rem 0.9rem',fontSize:'0.88rem',color:'#e0e6ed',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',fontFamily:'inherit',width:'220px',outline:'none',resize:'vertical',minHeight:'42px',lineHeight:1.5}}
                        ></textarea>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginTop:'0.6rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help',flexShrink:0}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'270px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.78rem',lineHeight:1.6,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <b style={{color:'#60a5fa'}}>Analysis focus (optional)</b><br/>
                            Tell the AI what to specifically look for. The analysis will prioritize finding and highlighting anything related to your search.<br/><br/>
                            e.g. <i style={{color:'#a78bfa'}}>"CIA involvement"</i>, <i style={{color:'#a78bfa'}}>"timeline of events"</i>, <i style={{color:'#a78bfa'}}>"financial connections"</i><br/><br/>
                            Applies to both URL and document uploads.
                          </div>
                        </div>
                      </div>
                      <div style={{position:'relative',display:'inline-block'}}>
                        <select value={analysisMode} onChange={e=>{setAnalysisMode(e.target.value);sessionStorage.setItem('hdb_analysisMode',e.target.value);}} style={{padding:'0.75rem 1rem',paddingRight:'2.5rem',fontSize:'0.9rem',fontWeight:600,color:'#e0e6ed',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit'}}>
                          <option value="fast">Fast</option>
                          <option value="quick">Quick</option>
                          <option value="short">Short</option>
                          <option value="long">Long (Detailed)</option>
                        </select>
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',marginLeft:'0.25rem'}}>
                          <span style={{width:'18px',height:'18px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.7rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help'}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',left:'50%',transform:'translateX(-50%)',marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'280px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.75rem',lineHeight:1.5,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#10b981'}}>Fast</b> (~5-10s) â€” Haiku model, transcript only. Best for podcasts & quick tagging.</div>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#60a5fa'}}>Quick</b> (~15-25s) â€” Sonnet model, transcript only. Better quality, no frames.</div>
                            <div style={{marginBottom:'0.4rem'}}><b style={{color:'#a78bfa'}}>Short</b> (~30-45s) â€” Sonnet + frames. Concise summary with visual analysis.</div>
                            <div><b style={{color:'#f59e0b'}}>Long</b> (~45-90s) â€” Sonnet + frames. Detailed analysis with full visual evidence.</div>
                          </div>
                        </div>
                      </div>
                      <label style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.75rem 1rem',background:'rgba(26,31,58,0.8)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontSize:'0.85rem',fontWeight:600,color: skipFrames ? '#6b7394' : '#e0e6ed',userSelect:'none'}}>
                        <input type="checkbox" checked={!skipFrames} onChange={e=>{setSkipFrames(!e.target.checked);sessionStorage.setItem('hdb_skipFrames',String(!e.target.checked));}} style={{accentColor:'#7c3aed'}} />
                        Frames
                        <div className="tooltip-wrapper" style={{display:'inline-flex',alignItems:'center',position:'relative'}}>
                          <span style={{width:'16px',height:'16px',borderRadius:'50%',background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.65rem',fontWeight:700,display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'help'}}>i</span>
                          <div className="tooltip-content" style={{position:'absolute',bottom:'100%',right:0,marginBottom:'8px',background:'rgba(15,18,35,0.97)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'10px',padding:'0.75rem 1rem',width:'240px',zIndex:9999,pointerEvents:'none',opacity:0,transition:'opacity 0.15s',fontSize:'0.75rem',lineHeight:1.5,color:'#c0c7d8',boxShadow:'0 4px 20px rgba(0,0,0,0.5)'}}>
                            Extract screenshots from the video every 30 seconds and include them in the AI analysis. Adds ~15-20s but captures on-screen evidence. Disable for podcasts/audio.
                          </div>
                        </div>
                      </label>
                      <button disabled={isProcessing} onClick={async ()=>{
                        const selected = [...selectedForAnalysis].map(evtId => {
                          const evt = recentUploads.find(e => e.id === evtId);
                          return evt ? { evtId, backendId: evt._backendId } : null;
                        }).filter(x => x && x.backendId);
                        if (selected.length === 0) { alert('Select documents with backend records first (PDF, Word, or Image uploads).'); return; }
                        const alreadyAnalyzed = selected.filter(({evtId}) => recentUploads.find(e=>e.id===evtId)?._aiAnalyzed);
                        if (alreadyAnalyzed.length > 0 && !window.confirm(`${alreadyAnalyzed.length} of ${selected.length} document(s) have already been analyzed. Re-analyze them?`)) return;
                        setIsProcessing(true);
                        setUploadMessage(`Analyzing ${selected.length} document(s) with AI...`);
                        let successCount = 0;
                        let lastAnalyzedEvent = null;
                        for (const { evtId, backendId } of selected) {
                          try {
                            setUploadMessage(`Analyzing document ${successCount + 1} of ${selected.length}...`);
                            const resp = await fetch(`${API_BASE}/api/analyze/${backendId}?mode=${analysisMode}${analysisSearch.trim()?'&search_focus='+encodeURIComponent(analysisSearch.trim()):''}`, { method: 'POST' });
                            if (resp.ok) {
                              const result = await resp.json();
                              const rec = result.record;
                              if (rec) {
                                const updatedEvent = {
                                  ...(data.events.find(e => e.id === evtId) || {}),
                                  aiSummary: rec.summary || '',
                                  description: rec.description || rec.summary || '',
                                  topics: rec.topics && rec.topics.length > 0 ? rec.topics : [],
                                  people: rec.people && rec.people.length > 0 ? rec.people : [],
                                  organizations: rec.organizations && rec.organizations.length > 0 ? rec.organizations : [],
                                  source: rec.source || '',
                                  primarySource: rec.primary_source || '',
                                  mainLink: rec.main_link || '',
                                  _aiAnalyzed: true,
                                  _analysisMode: rec.analysis_mode || '',
                                  _hasFrames: rec.has_frames || false,
                                  _attachments: rec.attachments || [],
                                  _transcriptFile: rec.transcript_file || '',
                                };
                                setData(prev => ({
                                  ...prev,
                                  events: prev.events.map(e => e.id === evtId ? {...e, ...updatedEvent} : e),
                                  people: Array.from(new Set([...prev.people, ...(rec.people||[])])).sort(),
                                  organizations: Array.from(new Set([...prev.organizations, ...(rec.organizations||[])])).sort(),
                                  topics: Array.from(new Set([...prev.topics, ...(rec.topics||[])])).sort(),
                                }));
                                lastAnalyzedEvent = updatedEvent;
                                successCount++;
                              }
                            }
                          } catch(err) {}
                        }
                        setIsProcessing(false);
                        setSelectedForAnalysis(new Set());
                        setUploadMessage(`âœ“ AI Analysis complete: ${successCount} of ${selected.length} document(s) analyzed.`);
                        setTimeout(()=>setUploadMessage(''),5000);
                        if (lastAnalyzedEvent) {
                          openEventModal(lastAnalyzedEvent, 'upload');
                        }
                      }} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:isProcessing?'#6b7394':'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'10px',cursor:isProcessing?'wait':'pointer',fontFamily:'inherit'}}>
                        {isProcessing ? 'â³ Analyzing...' : `ðŸ§  Analyze Selected (${selectedForAnalysis.size})`}
                      </button>
                      {selectedForAnalysis.size > 0 && <button onClick={()=>setShowDownloadPopup('recent')} style={{padding:'0.75rem 1.25rem',fontSize:'0.95rem',fontWeight:700,color:'#fff',background:'rgba(61,69,99,0.5)',border:'2px solid rgba(61,69,99,0.5)',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit'}}>Download Selected ({selectedForAnalysis.size})</button>}
                    </div>

                    {/* â”€â”€ Recent Uploads Section â”€â”€ */}
                    <div style={{background:'rgba(26,31,58,0.6)',padding:'1.5rem',borderRadius:'16px',border:'2px solid rgba(61,69,99,0.5)',marginTop:'0.5rem'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',flexWrap:'wrap',gap:'0.75rem'}}>
                        <h3 style={{color:'#60a5fa',fontSize:'1.25rem',margin:0}}>ðŸ“‹ Recent Uploads</h3>
                        <div style={{display:'flex',gap:'0.75rem',alignItems:'center'}}>
                          <label style={{color:'#8b92b0',fontSize:'0.85rem'}}>Last</label>
                          <select value={recentHoursFilter} onChange={e=>setRecentHoursFilter(Number(e.target.value))} style={{background:'rgba(16,20,40,0.8)',color:'#e0e6ed',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'6px',padding:'0.4rem 0.6rem',fontSize:'0.85rem',fontFamily:'inherit'}}>
                            <option value={1}>1 hour</option>
                            <option value={3}>3 hours</option>
                            <option value={12}>12 hours</option>
                            <option value={24}>24 hours</option>
                            <option value={72}>3 days</option>
                            <option value={168}>7 days</option>
                          </select>
                        </div>
                      </div>
                      {recentUploads.length === 0 ? (
                        <div style={{textAlign:'center',padding:'2rem',color:'#8b92b0'}}>No uploads in the last {recentHoursFilter >= 24 ? `${recentHoursFilter/24} day${recentHoursFilter/24!==1?'s':''}` : `${recentHoursFilter} hour${recentHoursFilter!==1?'s':''}`}.</div>
                      ) : (
                        <div className="spreadsheet" style={{maxHeight:'400px',overflowY:'auto'}}>
                          <table className="table">
                            <thead><tr>
                              <th style={{width:'40px',textAlign:'center'}}>
                                <button onClick={()=>{
                                  if (selectedForAnalysis.size === recentUploads.length) setSelectedForAnalysis(new Set());
                                  else setSelectedForAnalysis(new Set(recentUploads.map(e=>e.id)));
                                }} style={{padding:'0.2rem 0.5rem',fontSize:'0.7rem',color:'#a78bfa',background:'rgba(167,139,250,0.1)',border:'1px solid rgba(167,139,250,0.3)',borderRadius:'4px',cursor:'pointer',fontFamily:'inherit',whiteSpace:'nowrap'}}>
                                  {selectedForAnalysis.size === recentUploads.length && recentUploads.length > 0 ? 'âœ“ All' : 'All'}
                                </button>
                              </th>
                              <th>ID</th>
                              <th>Title</th>
                              <th>AI Summary</th>
                              <th>Topics</th>
                              <th>Level</th>
                              <th>Uploaded</th>
                              <th>Source</th>
                            </tr></thead>
                            <tbody>
                              {recentUploads.map(e=>(
                                <tr key={e.id} style={{cursor:'pointer'}} onClick={()=>openEventModal(e,'upload')}>
                                  <td onClick={ev=>ev.stopPropagation()} style={{textAlign:'center'}}>
                                    <input type="checkbox" checked={selectedForAnalysis.has(e.id)} onChange={()=>{
                                      setSelectedForAnalysis(prev=>{const n=new Set(prev); n.has(e.id)?n.delete(e.id):n.add(e.id); return n;});
                                    }} style={{width:'16px',height:'16px',cursor:'pointer',accentColor:'#7c3aed'}} />
                                  </td>
                                  <td>{e.id}</td>
                                  <td style={{fontWeight:600}}>{e.title}</td>
                                  <td style={{color:'#8b92b0',fontSize:'0.8rem'}}>{e.aiSummary?(e.aiSummary.substring(0,80)+'...'):'â€”'}</td>
                                  <td>{(e.topics||[]).slice(0,2).join(', ')}</td>
                                  <td><span className={`level-${e.researchLevel}`}>L{e.researchLevel}</span></td>
                                  <td style={{fontSize:'0.8rem'}}>{e.dateUploaded ? new Date(e.dateUploaded).toLocaleString() : 'â€”'}</td>
                                  <td>{e.sourceType}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </>
                ) : (
                  <UploadsContent />
                )}
              </div>
            )}

            {/* MY UPLOADS moved to Account Page */}

            {/* RESEARCH SESSIONS PAGE */}
            {activeTab === 'sessions' && <ResearchSessionsPage currentUser={currentUser} />}

            {/* RESEARCH COMPANION PAGE */}
            {activeTab === 'companion' && <CompanionPage />}

            {/* ADMIN PANEL (kept for backward compat but hidden from nav) */}
            {activeTab === 'admin panel' && (currentUser.role === 'admin' || currentUser.role === 'owner') && <AdminPanel />}

            {/* NOTIFICATIONS PAGE */}
            {activeTab === 'notifications' && (() => {
              const filterDefs = [
                {id:'all', label:'All'},
                {id:'unread', label:`Unread${notifUnreadCount>0?' ('+notifUnreadCount+')':''}`},
                {id:'upload_success', label:'ðŸ“¤ Uploads'},
                {id:'ai_analysis', label:'ðŸ¤– AI Analysis'},
                {id:'event_saved', label:'ðŸ’¾ Events'},
                {id:'system_health', label:'ðŸ›¡ï¸ System'},
                {id:'new_user', label:'ðŸ‘¤ Users'},
              ];
              const filteredNotifs = notifications.filter(n => {
                if (notifFilter === 'unread') return !(n.read_by||[]).includes(currentUser.username);
                if (notifFilter === 'all') return true;
                if (notifFilter === 'upload_success') return n.type === 'upload_success' || n.type === 'upload_error';
                if (notifFilter === 'ai_analysis') return n.type === 'ai_analysis' || n.type === 'ai_error';
                if (notifFilter === 'event_saved') return n.type === 'event_saved' || n.type === 'event_deleted';
                return n.type === notifFilter;
              });
              return (
                <div style={{maxWidth:'820px',margin:'0 auto',padding:'0 0.5rem'}}>
                  {/* Header row */}
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
                    <div>
                      <h2 style={{color:'#e0e6ed',fontFamily:"'Space Mono',monospace",margin:0,fontSize:'1.35rem',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                        ðŸ”” Notifications
                        {notifUnreadCount > 0 && <span style={{background:'rgba(96,165,250,0.2)',border:'1px solid rgba(96,165,250,0.4)',color:'#60a5fa',fontSize:'0.75rem',fontWeight:700,padding:'0.15rem 0.6rem',borderRadius:'12px'}}>{notifUnreadCount} unread</span>}
                      </h2>
                      <div style={{color:'#5a6080',fontSize:'0.8rem',marginTop:'0.35rem'}}>Notifications are visible based on your role</div>
                    </div>
                    <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                      {notifUnreadCount > 0 && (
                        <button className="btn btn-secondary" style={{fontSize:'0.8rem',padding:'0.4rem 0.9rem'}} onClick={markAllNotificationsRead}>âœ“ Mark all read</button>
                      )}
                      {notifications.length > 0 && (
                        <button className="btn btn-danger" style={{fontSize:'0.8rem',padding:'0.4rem 0.9rem'}} onClick={()=>{if(window.confirm('Clear all notifications from your view?'))clearAllNotifications();}}>ðŸ—‘ Clear all</button>
                      )}
                      <button className="btn btn-secondary" style={{fontSize:'0.8rem',padding:'0.4rem 0.9rem'}} onClick={loadNotifications}>ðŸ”„ Refresh</button>
                    </div>
                  </div>

                  {/* Filter chips */}
                  <div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap',marginBottom:'1.25rem'}}>
                    {filterDefs.map(f => (
                      <button key={f.id} className="notif-filter-btn" onClick={()=>setNotifFilter(f.id)}
                        style={{
                          border: notifFilter===f.id ? '2px solid #60a5fa' : '1px solid rgba(61,69,99,0.5)',
                          background: notifFilter===f.id ? 'rgba(96,165,250,0.15)' : 'rgba(26,31,58,0.5)',
                          color: notifFilter===f.id ? '#60a5fa' : '#8b92b0',
                          fontWeight: notifFilter===f.id ? 700 : 500,
                        }}>
                        {f.label}
                      </button>
                    ))}
                  </div>

                  {/* Content */}
                  {!notifsLoaded ? (
                    <div style={{textAlign:'center',padding:'4rem 2rem',color:'#8b92b0'}}>
                      <div style={{fontSize:'2rem',marginBottom:'0.75rem'}}>â³</div>
                      Loading notificationsâ€¦
                    </div>
                  ) : filteredNotifs.length === 0 ? (
                    <div className="empty-state" style={{padding:'4rem 2rem'}}>
                      <div className="empty-state-icon">ðŸ””</div>
                      <p style={{color:'#5a6080'}}>{notifFilter==='unread' ? 'No unread notifications â€” you\'re all caught up!' : 'No notifications yet. Actions like uploads, AI analysis, and edits will appear here.'}</p>
                    </div>
                  ) : (
                    <div>
                      {filteredNotifs.map(n => {
                        const isUnread = !(n.read_by||[]).includes(currentUser.username);
                        const meta = NOTIF_META[n.type] || {icon:'ðŸ””',color:'#60a5fa'};
                        const hasEvent = !!n.event_id;
                        const showCreator = (currentUser.role==='owner'||currentUser.role==='admin') && n.created_by !== currentUser.username;
                        return (
                          <div key={n.id}
                            className={`notif-item${isUnread?' unread':''}`}
                            onClick={async()=>{
                              await markNotificationRead(n.id);
                              if (n.event_id) {
                                const ev = data.events.find(e=>e.id===n.event_id);
                                if (ev) openEventModal(ev,'notifications');
                              }
                            }}>
                            {/* Left: type icon */}
                            <div className="notif-icon-wrap" style={{color:meta.color}}>{meta.icon}</div>
                            {/* Center: content */}
                            <div className="notif-content">
                              <div className="notif-title">{n.title}</div>
                              <div className="notif-message">{n.message}</div>
                              <div className="notif-meta">
                                {getRelativeTime(n.created_at)}
                                {showCreator && <span style={{marginLeft:'0.5rem'}}>Â· by <span style={{color:'#8b92b0'}}>{n.created_by}</span></span>}
                                {hasEvent && <span style={{marginLeft:'0.5rem',color:'rgba(96,165,250,0.7)',fontSize:'0.7rem'}}>Â· click to view event</span>}
                              </div>
                            </div>
                            {/* Right: unread dot + dismiss */}
                            <div style={{display:'flex',alignItems:'center',gap:'0.4rem',flexShrink:0}}>
                              {isUnread && <div className="notif-unread-dot"></div>}
                              <button className="notif-dismiss" title="Dismiss"
                                onClick={ev=>{ev.stopPropagation();dismissNotification(n.id);}}>Ã—</button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })()}

          </main>

          {showModal && modalData && modalViewJSX}
          {entityProfileModalJSX}

          {/* FULLSCREEN PRESENTATION MODE */}
          {presentationMode && (() => {
            const pres = presentations.find(p => p.id === presentationMode.pId);
            if (!pres || !pres.slides || pres.slides.length === 0) return null;
            const curIdx = presentationMode.idx;
            const slide = pres.slides[curIdx];
            const totalSlides = pres.slides.length;
            const isDark = presentationTheme === 'dark';
            const slideBg = slide?.bg || '#0a0d1e';
            return (
              <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:9999,background:isDark?'#05070f':'#c8cdd8',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',overflow:'hidden'}}>
                {/* Top bar */}
                <div style={{position:'absolute',top:0,left:0,right:0,padding:'0.55rem 1rem',display:'flex',alignItems:'center',justifyContent:'space-between',zIndex:1,background:isDark?'rgba(0,0,0,0.5)':'rgba(255,255,255,0.5)',backdropFilter:'blur(8px)'}}>
                  <div style={{color:isDark?'#8b92b0':'#555',fontSize:'0.78rem',fontFamily:"'Space Mono',monospace",overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:'40%'}}>{pres.name}</div>
                  <div style={{display:'flex',gap:'0.5rem'}}>
                    <button onClick={()=>setPresentationTheme(isDark?'light':'dark')} style={{padding:'0.3rem 0.75rem',borderRadius:'7px',border:`1px solid ${isDark?'rgba(255,255,255,0.2)':'rgba(0,0,0,0.15)'}`,background:isDark?'rgba(255,255,255,0.08)':'rgba(0,0,0,0.07)',color:isDark?'#e0e6ed':'#333',cursor:'pointer',fontFamily:'inherit',fontSize:'0.78rem',fontWeight:600}}>
                      {isDark?'â˜€ Light':'ðŸŒ™ Dark'}
                    </button>
                    <button onClick={()=>setPresentationMode(null)} style={{padding:'0.3rem 0.7rem',borderRadius:'7px',border:'1px solid rgba(239,68,68,0.4)',background:'rgba(239,68,68,0.1)',color:'#f87171',cursor:'pointer',fontWeight:700,fontSize:'0.95rem',lineHeight:1}}>âœ•</button>
                  </div>
                </div>
                {/* 16:9 slide canvas */}
                <div style={{position:'relative',width:'min(88vw,calc(80vh*(16/9)))',aspectRatio:'16/9',background:slideBg,boxShadow:isDark?'0 20px 60px rgba(0,0,0,0.8)':'0 10px 40px rgba(0,0,0,0.2)',borderRadius:'6px',overflow:'hidden'}}>
                  {(slide?.blocks||[]).map(b => {
                    const isImg    = b.type === 'image';
                    const isTags   = b.type === 'tags';
                    const isSrc    = b.type === 'sources';
                    const isShape  = b.type === 'shape';
                    const isCallout= b.type === 'callout';
                    return (
                      <div key={b.id} style={{
                        position:'absolute',
                        left:`${b.x}%`, top:`${b.y}%`,
                        width:`${b.w}%`, height:`${b.h}%`,
                        background: (isShape||isImg) ? 'transparent' : (b.background || 'transparent'),
                        overflow:'hidden',
                        display:'flex', alignItems:'flex-start',
                        boxSizing:'border-box',
                        padding: (isImg || isTags || isSrc || isShape || isCallout) ? 0 : '2% 3%',
                      }}>
                        {isShape ? (
                          <div style={{width:'100%',height:'100%',opacity:b.opacity!=null?b.opacity/100:1}}>{renderShapeSVG(b)}</div>
                        ) : isImg ? (
                          b.imageUrl ? <img src={b.imageUrl} alt="" style={{width:'100%',height:'100%',objectFit:b.imageFit||'cover',display:'block'}} /> : null
                        ) : isCallout ? (
                          <div style={{width:'100%',height:'100%',display:'flex',gap:'4%',alignItems:'stretch',padding:'2% 3%',boxSizing:'border-box',background:b.background||'rgba(245,158,11,0.08)'}}>
                            <div style={{width:'3px',flexShrink:0,borderRadius:'2px',background:b.accentColor||'#f59e0b'}}/>
                            <div style={{flex:1,color:b.color||'#f0f4ff',fontSize:`clamp(9px,${(b.fontSize||15)*0.065}vw,${(b.fontSize||15)*1.4}px)`,fontWeight:b.fontWeight||'normal',fontStyle:b.fontStyle||'italic',textAlign:b.textAlign||'left',lineHeight:1.45,whiteSpace:'pre-wrap',wordBreak:'break-word'}}>{b.text||''}</div>
                          </div>
                        ) : isTags ? (
                          <div style={{width:'100%',height:'100%',padding:'4% 5%',overflow:'hidden',display:'flex',flexDirection:'column',gap:'0.45em',fontSize:`clamp(8px,1.25vw,13px)`}}>
                            {b.topics?.length>0 && (<>
                              <div style={{color:'#a78bfa',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>Topics</div>
                              <div style={{display:'flex',flexWrap:'wrap',gap:'0.3em',marginBottom:'0.25em'}}>
                                {b.topics.map(t=><span key={t} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(124,58,237,0.2)',color:'#c4b5fd',border:'1px solid rgba(124,58,237,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{t}</span>)}
                              </div>
                            </>)}
                            {b.people?.length>0 && (<>
                              <div style={{color:'#60a5fa',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>People</div>
                              <div style={{display:'flex',flexWrap:'wrap',gap:'0.3em',marginBottom:'0.25em'}}>
                                {b.people.map(p=><span key={p} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(96,165,250,0.15)',color:'#93c5fd',border:'1px solid rgba(96,165,250,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{p}</span>)}
                              </div>
                            </>)}
                            {b.orgs?.length>0 && (<>
                              <div style={{color:'#34d399',fontWeight:700,fontSize:'0.72em',letterSpacing:'0.8px',textTransform:'uppercase',marginBottom:'0.1em'}}>Organizations</div>
                              <div style={{display:'flex',flexWrap:'wrap',gap:'0.3em'}}>
                                {b.orgs.map(o=><span key={o} style={{padding:'0.15em 0.55em',borderRadius:'4px',background:'rgba(16,185,129,0.15)',color:'#6ee7b7',border:'1px solid rgba(16,185,129,0.3)',fontSize:'0.9em',whiteSpace:'nowrap'}}>{o}</span>)}
                              </div>
                            </>)}
                          </div>
                        ) : isSrc ? (
                          <div style={{width:'100%',height:'100%',padding:'0 3%',display:'flex',alignItems:'center',gap:'0.6em',flexWrap:'wrap',borderTop:'1px solid rgba(96,165,250,0.12)'}}>
                            {(b.items||[]).map((item,i) => item.eventId ? (
                              <button key={i} onClick={()=>{const ev=data.events.find(e=>e.id===item.eventId);if(ev){setPresentationMode(null);setTimeout(()=>setModalData(ev),50);}}} style={{padding:'0.2em 0.85em',borderRadius:'6px',background:'rgba(96,165,250,0.15)',border:'1px solid rgba(96,165,250,0.4)',color:'#93c5fd',cursor:'pointer',fontFamily:'inherit',fontSize:`clamp(8px,1.15vw,12px)`,fontWeight:600,lineHeight:1.5}}>â†’ {item.label}</button>
                            ) : (
                              <a key={i} href={item.url} target="_blank" rel="noopener noreferrer" style={{padding:'0.2em 0.85em',borderRadius:'6px',background:'rgba(16,185,129,0.12)',border:'1px solid rgba(16,185,129,0.35)',color:'#6ee7b7',textDecoration:'none',fontSize:`clamp(8px,1.15vw,12px)`,fontWeight:600,lineHeight:1.5}}>ðŸ”— {item.label}</a>
                            ))}
                          </div>
                        ) : (
                          <div style={{
                            fontSize:`clamp(9px, ${(b.fontSize||16) * 0.065}vw, ${(b.fontSize||16) * 1.4}px)`,
                            fontWeight: b.fontWeight || (b.type==='heading' ? 700 : 400),
                            fontStyle: b.fontStyle || 'normal',
                            color: b.color || (isDark ? '#e0e6ed' : '#111'),
                            textAlign: b.textAlign || 'left',
                            lineHeight: 1.45,
                            whiteSpace: 'pre-wrap',
                            wordBreak: 'break-word',
                            width: '100%',
                            overflow: 'hidden',
                          }}>{b.text||''}</div>
                        )}
                      </div>
                    );
                  })}
                </div>
                {/* Bottom nav */}
                <div style={{position:'absolute',bottom:0,left:0,right:0,padding:'0.55rem 1rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'1.5rem',zIndex:1,background:isDark?'rgba(0,0,0,0.5)':'rgba(255,255,255,0.5)',backdropFilter:'blur(8px)'}}>
                  <button onClick={()=>setPresentationMode(prev=>({...prev,idx:Math.max(0,prev.idx-1)}))} disabled={curIdx===0} style={{padding:'0.45rem 1.5rem',borderRadius:'9px',border:`1px solid ${isDark?'rgba(96,165,250,0.3)':'rgba(0,0,0,0.15)'}`,background:curIdx===0?'transparent':(isDark?'rgba(96,165,250,0.1)':'#fff'),color:curIdx===0?(isDark?'#3d4563':'#bbb'):(isDark?'#60a5fa':'#2563eb'),cursor:curIdx===0?'not-allowed':'pointer',fontSize:'1.2rem',fontWeight:700,lineHeight:1}}>â†</button>
                  <span style={{color:isDark?'#8b92b0':'#555',fontSize:'0.85rem',fontFamily:"'Space Mono',monospace",minWidth:'60px',textAlign:'center'}}>{curIdx+1} / {totalSlides}</span>
                  <button onClick={()=>setPresentationMode(prev=>({...prev,idx:Math.min(totalSlides-1,prev.idx+1)}))} disabled={curIdx===totalSlides-1} style={{padding:'0.45rem 1.5rem',borderRadius:'9px',border:`1px solid ${isDark?'rgba(96,165,250,0.3)':'rgba(0,0,0,0.15)'}`,background:curIdx===totalSlides-1?'transparent':(isDark?'rgba(96,165,250,0.1)':'#fff'),color:curIdx===totalSlides-1?(isDark?'#3d4563':'#bbb'):(isDark?'#60a5fa':'#2563eb'),cursor:curIdx===totalSlides-1?'not-allowed':'pointer',fontSize:'1.2rem',fontWeight:700,lineHeight:1}}>â†’</button>
                </div>
              </div>
            );
          })()}

          {/* NEW PRESENTATION MODAL */}
          {showNewPresentationModal && (
            <div className="modal" onClick={()=>setShowNewPresentationModal(false)}>
              <div className="modal-content" onClick={ev=>ev.stopPropagation()} style={{maxWidth:'420px'}}>
                <h3 style={{marginBottom:'0.5rem',color:'#e0e6ed',fontFamily:"'Space Mono',monospace"}}>New Presentation</h3>
                <p style={{color:'#8b92b0',fontSize:'0.83rem',marginBottom:'1.25rem'}}>Give your presentation a title.</p>
                <div style={{marginBottom:'1.25rem'}}>
                  <label className="filter-label">Name</label>
                  <input type="text" value={newPresentationName} onChange={e=>setNewPresentationName(e.target.value)}
                    onKeyDown={e=>{if(e.key==='Enter'&&newPresentationName.trim()){createPresentation(newPresentationName);setNewPresentationName('');setShowNewPresentationModal(false);}else if(e.key==='Escape'){setShowNewPresentationModal(false);}}}
                    placeholder="e.g. JFK Assassination Overview"
                    style={{width:'100%',padding:'0.65rem 0.9rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.9rem',boxSizing:'border-box',outline:'none'}} autoFocus />
                </div>
                <div style={{display:'flex',gap:'0.75rem',justifyContent:'flex-end'}}>
                  <button onClick={()=>{setShowNewPresentationModal(false);setNewPresentationName('');}} style={{padding:'0.5rem 1.2rem',background:'none',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#8b92b0',cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem'}}>Cancel</button>
                  <button onClick={()=>{if(newPresentationName.trim()){createPresentation(newPresentationName);setNewPresentationName('');setShowNewPresentationModal(false);}}} disabled={!newPresentationName.trim()} style={{padding:'0.5rem 1.2rem',background:'linear-gradient(135deg,#7c3aed,#2563eb)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:700,cursor:newPresentationName.trim()?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'0.85rem',opacity:newPresentationName.trim()?1:0.5}}>Create</button>
                </div>
              </div>
            </div>
          )}

          {/* IMAGE BROWSER MODAL */}
          {showImageBrowser && (
            <div className="modal" onClick={()=>{setShowImageBrowser(null);setImagePasteUrl('');}}>
              <div className="modal-content" onClick={ev=>ev.stopPropagation()} style={{maxWidth:'700px',maxHeight:'82vh',display:'flex',flexDirection:'column',padding:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',flexShrink:0}}>
                  <h3 style={{color:'#e0e6ed',margin:0,fontFamily:"'Space Mono',monospace",fontSize:'1.1rem'}}>Add Image</h3>
                  <button onClick={()=>{setShowImageBrowser(null);setImagePasteUrl('');}} style={{background:'none',border:'none',color:'#8b92b0',fontSize:'1.5rem',cursor:'pointer',lineHeight:1,padding:'0 0.25rem'}}>Ã—</button>
                </div>

                {/* URL paste */}
                <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem',flexShrink:0}}>
                  <input
                    type="url"
                    placeholder="Paste image URL (https://â€¦)"
                    value={imagePasteUrl}
                    onChange={e=>setImagePasteUrl(e.target.value)}
                    onKeyDown={e=>{if(e.key==='Enter'&&imagePasteUrl.trim()){updateBlock(showImageBrowser,{imageUrl:imagePasteUrl.trim()});setShowImageBrowser(null);setImagePasteUrl('');}}}
                    style={{flex:1,padding:'0.5rem 0.75rem',background:'rgba(26,31,58,0.8)',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#e0e6ed',fontFamily:'inherit',fontSize:'0.85rem',outline:'none'}}
                  />
                  <button onClick={()=>{if(imagePasteUrl.trim()){updateBlock(showImageBrowser,{imageUrl:imagePasteUrl.trim()});setShowImageBrowser(null);setImagePasteUrl('');}}} disabled={!imagePasteUrl.trim()} style={{padding:'0.5rem 1rem',background:'linear-gradient(135deg,#3b82f6,#2563eb)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:700,cursor:imagePasteUrl.trim()?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'0.85rem',opacity:imagePasteUrl.trim()?1:0.5,flexShrink:0}}>Use URL</button>
                </div>

                {/* Local file upload + drag zone */}
                <div
                  onDragOver={e=>{e.preventDefault();e.currentTarget.style.borderColor='rgba(96,165,250,0.7)';e.currentTarget.style.background='rgba(96,165,250,0.08)';}}
                  onDragLeave={e=>{e.currentTarget.style.borderColor='rgba(61,69,99,0.4)';e.currentTarget.style.background='rgba(26,31,58,0.3)';}}
                  onDrop={e=>{
                    e.preventDefault();
                    e.currentTarget.style.borderColor='rgba(61,69,99,0.4)';
                    e.currentTarget.style.background='rgba(26,31,58,0.3)';
                    const files=e.dataTransfer.files;
                    if(files?.length>0){
                      const f=files[0];
                      if(f.type.startsWith('image/')||/\.(png|jpe?g|gif|webp|svg|bmp|tiff?|avif|ico)$/i.test(f.name)){
                        const reader=new FileReader();
                        reader.onload=ev=>{updateBlock(showImageBrowser,{imageUrl:ev.target.result});setShowImageBrowser(null);setImagePasteUrl('');};
                        reader.readAsDataURL(f);
                        return;
                      }
                    }
                    const url=(e.dataTransfer.getData('text/uri-list')||e.dataTransfer.getData('text/plain')||'').trim();
                    if(url&&/^https?:\/\//i.test(url)){updateBlock(showImageBrowser,{imageUrl:url});setShowImageBrowser(null);setImagePasteUrl('');}
                  }}
                  style={{border:'1px dashed rgba(61,69,99,0.4)',borderRadius:'10px',padding:'0.9rem 1rem',background:'rgba(26,31,58,0.3)',display:'flex',alignItems:'center',gap:'1rem',marginBottom:'0.75rem',flexShrink:0,transition:'border-color 0.15s,background 0.15s'}}>
                  <span style={{fontSize:'1.5rem',flexShrink:0}}>ðŸ“</span>
                  <div style={{flex:1,fontSize:'0.82rem',color:'#8b92b0',lineHeight:1.5}}>
                    Drop an image file here, or drag one from the web
                    <br/><span style={{fontSize:'0.75rem',color:'#5a6180'}}>PNG, JPG, GIF, WebP, SVG, BMP, TIFF, AVIF, ICO</span>
                  </div>
                  <label style={{padding:'0.4rem 0.9rem',background:'rgba(61,69,99,0.4)',border:'1px solid rgba(96,165,250,0.3)',borderRadius:'7px',color:'#60a5fa',cursor:'pointer',fontFamily:'inherit',fontSize:'0.82rem',fontWeight:600,flexShrink:0,whiteSpace:'nowrap'}}>
                    ðŸ“‚ Browse Files
                    <input type="file" accept="image/png,image/jpeg,image/gif,image/webp,image/svg+xml,image/bmp,image/tiff,image/avif,image/x-icon,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp,.tif,.tiff,.avif,.ico" style={{display:'none'}} onChange={e=>{
                      const f=e.target.files?.[0];
                      if(!f)return;
                      const reader=new FileReader();
                      reader.onload=ev=>{updateBlock(showImageBrowser,{imageUrl:ev.target.result});setShowImageBrowser(null);setImagePasteUrl('');};
                      reader.readAsDataURL(f);
                      e.target.value='';
                    }} />
                  </label>
                </div>

                {/* Divider */}
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.75rem',flexShrink:0}}>
                  <div style={{flex:1,height:'1px',background:'rgba(61,69,99,0.4)'}}/>
                  <span style={{fontSize:'0.72rem',color:'#5a6180',textTransform:'uppercase',letterSpacing:'1px'}}>or pick from library</span>
                  <div style={{flex:1,height:'1px',background:'rgba(61,69,99,0.4)'}}/>
                </div>

                {/* Backend image library */}
                {imageBrowserFiles.length === 0 ? (
                  <div className="empty-state" style={{flex:1}}><div className="empty-state-icon">ðŸ–¼ï¸</div><p>No images in library. Analyze videos or upload attachments to populate this.</p></div>
                ) : (
                  <div style={{overflowY:'auto',flex:1,display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(140px,1fr))',gap:'0.6rem'}}>
                    {imageBrowserFiles.map(f => (
                      <div key={f.url} onClick={()=>{updateBlock(showImageBrowser,{imageUrl:f.url});setShowImageBrowser(null);setImagePasteUrl('');}}
                        style={{cursor:'pointer',borderRadius:'8px',overflow:'hidden',border:'1px solid rgba(61,69,99,0.5)',aspectRatio:'16/9',background:'rgba(26,31,58,0.7)',position:'relative'}}
                        onMouseEnter={ev=>ev.currentTarget.style.borderColor='rgba(96,165,250,0.6)'}
                        onMouseLeave={ev=>ev.currentTarget.style.borderColor='rgba(61,69,99,0.5)'}>
                        <img src={f.url} alt={f.name||''} style={{width:'100%',height:'100%',objectFit:'cover',display:'block'}} />
                        {f.name && <div style={{position:'absolute',bottom:0,left:0,right:0,padding:'0.25rem 0.4rem',background:'rgba(0,0,0,0.6)',color:'#c0c7d8',fontSize:'0.65rem',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{f.name}</div>}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Download Format Popup */}
          {showDownloadPopup && (
            <div className="modal" onClick={()=>setShowDownloadPopup(null)}>
              <div className="modal-content" onClick={ev=>ev.stopPropagation()} style={{maxWidth:'550px',textAlign:'center'}}>
                <h3 style={{marginBottom:'1.5rem',color:'#e0e6ed'}}>Download Format</h3>
                <div style={{display:'flex',gap:'1rem',justifyContent:'center',flexWrap:'wrap'}}>
                  {['csv','excel','json','pdf','word'].map(fmt=>{
                    const colors = {csv:'#10b981',excel:'#2563eb',json:'#7c3aed',pdf:'#ef4444',word:'#3b82f6'};
                    const labels = {csv:'CSV',excel:'Excel (.xlsx)',json:'JSON',pdf:'PDF',word:'Word (.doc)'};
                    return (
                    <button key={fmt} onClick={()=>{
                      let events;
                      if (showDownloadPopup==='spreadsheet') events = sortedEvents.filter(e=>selectedEvents.has(e.id));
                      else if (showDownloadPopup==='myuploads') events = mySortedEvents.filter(e=>selectedMyEvents.has(e.id));
                      else if (showDownloadPopup==='recent') events = recentUploads.filter(e=>selectedForAnalysis.has(e.id));
                      else events = [];
                      downloadEvents(events, fmt);
                    }} style={{padding:'0.75rem 1.5rem',fontSize:'0.9rem',fontWeight:700,color:'#fff',background:colors[fmt],border:'none',borderRadius:'10px',cursor:'pointer',fontFamily:'inherit',minWidth:'90px'}}>
                      {labels[fmt]}
                    </button>
                    );
                  })}
                </div>
                <button onClick={()=>setShowDownloadPopup(null)} style={{marginTop:'1.5rem',padding:'0.5rem 1.5rem',color:'#8b92b0',background:'none',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',cursor:'pointer',fontFamily:'inherit'}}>Cancel</button>
              </div>
            </div>
          )}

          {isProcessing && (
            <div className="processing-overlay">
              <div className="processing-card">
                <div className="processing-spinner"></div>
                <h3 style={{marginBottom:'1rem',color:'#60a5fa'}}>Processing...</h3>
                <p style={{marginBottom:'1.5rem',color:'#8b92b0'}}>Analyzing your files with AI</p>
                <button className="btn btn-cancel" onClick={cancelProcessing}>Cancel</button>
              </div>
            </div>
          )}

          {presAiLoading && (
            <div className="processing-overlay">
              <div className="processing-card">
                <div className="processing-spinner" style={{borderTopColor:'#a78bfa',borderColor:'rgba(167,139,250,0.2)'}}></div>
                <h3 style={{marginBottom:'1rem',color:'#a78bfa'}}>Generating Slidesâ€¦</h3>
                <p style={{marginBottom:'0.5rem',color:'#8b92b0'}}>The AI is analyzing your events and building presentation slides.</p>
                <p style={{color:'#8b92b0',fontSize:'0.82rem'}}>This may take 15â€“30 seconds.</p>
              </div>
            </div>
          )}

          {/* EXPORT PRESENTATION MODAL */}
          {showExportModal && (
            <div className="modal" onClick={()=>setShowExportModal(false)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()} style={{maxWidth:'500px'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                  <h3 style={{color:'#e0e6ed',margin:0,fontFamily:"'Space Mono',monospace",fontSize:'1.1rem'}}>Export Presentation</h3>
                  <button onClick={()=>setShowExportModal(false)} style={{background:'none',border:'none',color:'#8b92b0',fontSize:'1.5rem',cursor:'pointer',lineHeight:1,padding:'0 0.25rem'}}>Ã—</button>
                </div>
                <p style={{color:'#8b92b0',fontSize:'0.82rem',marginBottom:'1.4rem',lineHeight:1.5}}>Choose a format to download your presentation. PowerPoint exports produce fully editable elements recognized by PowerPoint and Google Slides.</p>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.75rem',marginBottom:'1.25rem'}}>
                  {[
                    {fmt:'pptx',label:'PowerPoint',icon:'ðŸ“Š',desc:'Editable text, shapes & images in PowerPoint & Google Slides',color:'rgba(16,185,129,0.12)',border:'rgba(16,185,129,0.4)',textColor:'#10b981'},
                    {fmt:'pdf', label:'PDF',        icon:'ðŸ“„',desc:'All slides compiled into a single PDF document',           color:'rgba(239,68,68,0.1)', border:'rgba(239,68,68,0.35)',textColor:'#f87171'},
                    {fmt:'png', label:'PNG Images', icon:'ðŸ–¼',desc:'Each slide as a high-quality PNG (one file per slide)',     color:'rgba(96,165,250,0.1)',border:'rgba(96,165,250,0.35)',textColor:'#60a5fa'},
                    {fmt:'jpeg',label:'JPEG Images',icon:'ðŸŒ…',desc:'Each slide as a compressed JPEG (one file per slide)',      color:'rgba(167,139,250,0.1)',border:'rgba(167,139,250,0.35)',textColor:'#a78bfa'},
                  ].map(({fmt,label,icon,desc,color,border,textColor})=>(
                    <button key={fmt} onClick={()=>exportPresentation(fmt)}
                      style={{padding:'1rem',background:color,border:`1px solid ${border}`,borderRadius:'12px',cursor:'pointer',textAlign:'left',display:'flex',flexDirection:'column',gap:'0.4rem',fontFamily:'inherit',transition:'all 0.15s'}}
                      onMouseEnter={e=>{e.currentTarget.style.transform='scale(1.03)';e.currentTarget.style.boxShadow=`0 6px 20px rgba(0,0,0,0.3)`;}}
                      onMouseLeave={e=>{e.currentTarget.style.transform='scale(1)';e.currentTarget.style.boxShadow='none';}}>
                      <div style={{fontSize:'1.7rem',lineHeight:1}}>{icon}</div>
                      <div style={{color:textColor,fontWeight:700,fontSize:'0.88rem'}}>{label}</div>
                      <div style={{color:'#8b92b0',fontSize:'0.74rem',lineHeight:1.4}}>{desc}</div>
                    </button>
                  ))}
                </div>
                <button onClick={()=>setShowExportModal(false)} style={{width:'100%',padding:'0.55rem',background:'none',border:'1px solid rgba(61,69,99,0.5)',borderRadius:'8px',color:'#8b92b0',cursor:'pointer',fontFamily:'inherit',fontSize:'0.85rem'}}>Cancel</button>
              </div>
            </div>
          )}

          {/* EXPORT PROGRESS OVERLAY */}
          {isExporting && (
            <div className="processing-overlay">
              <div className="processing-card">
                <div className="processing-spinner" style={{borderTopColor:'#10b981',borderColor:'rgba(16,185,129,0.2)'}}></div>
                <h3 style={{marginBottom:'0.75rem',color:'#10b981'}}>Exportingâ€¦</h3>
                <p style={{color:'#8b92b0',marginBottom:'1rem',fontSize:'0.85rem'}}>Slide {exportProgress} of {exportTotal}</p>
                <div style={{width:'220px',height:'6px',background:'rgba(61,69,99,0.5)',borderRadius:'3px',overflow:'hidden'}}>
                  <div style={{width:`${exportTotal>0?Math.round(exportProgress/exportTotal*100):0}%`,height:'100%',background:'linear-gradient(90deg,#10b981,#34d399)',borderRadius:'3px',transition:'width 0.35s ease'}}/>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
